<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>电镀毛坯与成品往来管理系统</title>
    <!-- Tailwind CSS v3 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- Chart.js -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
        
        <!-- 页面唯一标识符，确保不同页面数据独立 -->
        <script>
            // 为当前页面设置唯一标识符
            window.pageIdentifier = 'electroplate_management_system';
            // 存储前缀，确保localStorage中的键名唯一
            window.storagePrefix = window.pageIdentifier + '_';
            
            // 根据电镀厂名称返回带有样式的HTML
            function getStyledFactoryHTML(factoryName) {
                if (!factoryName) return '';
                if (factoryName.includes('宣城沃新')) {
                    return `<span class="factory-xuancheng">${factoryName}</span>`;
                } else if (factoryName.includes('丹阳裕丰')) {
                    return `<span class="factory-danyang">${factoryName}</span>`;
                }
                return factoryName;
            }
        </script>
    <!-- 统一的 Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1E88E5',
                        secondary: '#64B5F6',
                        accent: '#0D47A1',
                        success: '#4CAF50',
                        warning: '#FF9800',
                        danger: '#F44336',
                        light: '#F5F7FA',
                        dark: '#333333',
                        'gray-medium': '#666666',
                        'gray-light': '#999999'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    boxShadow: {
                        'card': '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)',
                        'card-hover': '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)',
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .sticky-left {
                position: sticky;
                left: 0;
                z-index: 10;
            }
            .content-auto {
                content-visibility: auto;
            }
            .transition-all-300 {
                transition: all 300ms ease-in-out;
            }
            .nav-item {
                @apply flex items-center gap-3 px-4 py-3 text-gray-medium hover:bg-primary hover:bg-opacity-10 hover:text-primary rounded-lg transition-all-300;
            }
            .nav-item.active {
                @apply bg-success text-white font-medium shadow-md transform transition-all duration-300 ease-in-out;
            }
            .hidden {
                display: none !important;
            }
            .btn {
                @apply px-4 py-2 rounded-lg font-medium transition-all-300 flex items-center justify-center gap-2;
            }
            .btn-primary {
                @apply bg-primary text-white hover:bg-opacity-90 hover:shadow-md;
            }
            .btn-secondary {
                @apply bg-light text-dark hover:bg-gray-200;
            }
            .btn-success {
                @apply bg-success text-white hover:bg-opacity-90;
            }
            .btn-warning {
                @apply bg-warning text-white hover:bg-opacity-90;
            }
            .btn-danger {
                @apply bg-danger text-white hover:bg-opacity-90;
            }
            .card {
                @apply bg-white rounded-xl shadow-card p-6 transition-all-300 hover:shadow-card-hover;
            }
            .input-field {
                @apply w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent;
            }
            .input-field-centered {
                @apply text-center;
            }
            .table-header {
                @apply px-6 py-2 text-left text-xs font-medium text-gray-medium uppercase tracking-wider;
                position: sticky;
                top: 0;
                background-color: #f9fafb;
                z-index: 10;
            }
            /* 电镀厂背景色样式 */
            .factory-xuancheng {
                @apply bg-blue-100 text-blue-800 px-2 py-1 rounded-md;
            }
            .factory-danyang {
                @apply bg-green-100 text-green-800 px-2 py-1 rounded-md;
            }
            .table-cell {
                @apply px-6 py-2 whitespace-nowrap text-sm text-gray-medium;
            }
            /* 冻结表头 */
            #delivery-module thead {
                position: sticky;
                top: 0;
                z-index: 10;
            }
            #delivery-module thead th {
                background-color: #f9fafb;
                position: sticky;
                top: 0;
                z-index: 10;
            }
            /* 冻结复选框列 */
            #delivery-module th:first-child,
            #delivery-module td:first-child {
                position: sticky;
                left: 0;
                background-color: #f9fafb;
                z-index: 20;
            }
            /* 冻结订单编号列 */
            #delivery-module th:nth-child(2),
            #delivery-module td:nth-child(2) {
                position: sticky;
                left: 48px;
                background-color: #f9fafb;
                z-index: 15;
            }
            /* 确保合计行也能正确冻结 */
            #delivery-module tbody tr:last-child td:first-child,
            #delivery-module tbody tr:last-child td:nth-child(2) {
                background-color: #e3f2fd;
            }
            .badge {
                @apply px-2 py-1 text-xs font-medium rounded-full;
            }
            .badge-success {
                @apply bg-green-100 text-green-800;
            }
            .badge-warning {
                @apply bg-yellow-100 text-yellow-800;
            }
            .badge-danger {
                @apply bg-red-100 text-red-800;
            }
            .badge-info {
                @apply bg-blue-100 text-blue-800;
            }
            /* 电镀付款状态样式 */
            .status-badge {
                @apply px-3 py-1 text-sm font-semibold rounded-full transition-all duration-300 transform hover:scale-105 shadow-sm;
            }
            .status-completed {
                @apply bg-success text-white border-2 border-green-600;
            }
            .status-failed {
                @apply bg-danger text-white border-2 border-red-600;
            }
            .status-pending {
                @apply bg-warning text-white border-2 border-yellow-600;
            }
            .stat-card {
                @apply flex flex-col p-6 bg-white rounded-xl shadow-card;
            }
            .stat-value {
                @apply text-2xl font-bold text-dark mt-2;
            }
            .stat-label {
                @apply text-sm text-gray-medium;
            }
            .stat-icon {
                @apply w-10 h-10 rounded-lg flex items-center justify-center text-white;
            }
        }
    </style>
</head>
<body class="bg-light min-h-screen">
    <div class="flex h-screen overflow-hidden">
        <!-- 侧边导航栏 -->
        <aside class="w-64 bg-gray-50 shadow-lg flex flex-col">
            <!-- Logo -->
            <div class="p-4 border-b flex items-center gap-3">
                <div class="w-10 h-10 bg-primary text-white rounded-lg flex items-center justify-center">
                    <i class="fa fa-cogs text-xl"></i>
                </div>
                <div>
                    <h1 class="font-bold text-lg text-dark">普利美电镀管理系统</h1>
                    <p class="text-xs text-gray-medium">毛坯与成品往来管理</p>
                </div>
            </div>
            
            <!-- 快速操作按钮 -->
            <div class="p-4 pb-2">
                <h3 class="text-xs font-semibold text-gray-medium uppercase tracking-wider mb-3">快速操作</h3>
                <div class="grid grid-cols-2 gap-2">
                    <button id="quick-create-order" class="btn btn-primary text-sm py-2 px-3 rounded-lg flex flex-col items-center justify-center gap-1 shadow-md">
                        <i class="fa fa-plus-circle"></i>
                        <span>新建订单</span>
                    </button>
                    <button id="quick-create-delivery" class="btn btn-secondary text-sm py-2 px-3 rounded-lg flex flex-col items-center justify-center gap-1">
                        <i class="fa fa-truck"></i>
                        <span>新建发货单</span>
                    </button>
                    <button id="quick-create-receipt" class="btn btn-secondary text-sm py-2 px-3 rounded-lg flex flex-col items-center justify-center gap-1">
                        <i class="fa fa-archive"></i>
                        <span>新建收货单</span>
                    </button>
                    <a href="index.html" class="btn btn-secondary text-sm py-2 px-3 rounded-lg flex flex-col items-center justify-center gap-1">
                        <i class="fa fa-arrow-left"></i>
                        <span>返回计件管理</span>
                    </a>
                </div>
            </div>
            
            <!-- 导航菜单 -->
            <nav class="flex-1 overflow-y-auto p-4 space-y-1">
                <a href="#dashboard" class="nav-item active" data-module="dashboard">
                    <i class="fa fa-dashboard w-5 text-center"></i>
                    <span>数据概览</span>
                </a>
                <a href="#orders" class="nav-item" data-module="orders">
                    <i class="fa fa-shopping-cart w-5 text-center"></i>
                    <span>订单计划</span>
                </a>
                <a href="#delivery" class="nav-item" data-module="delivery">
                    <i class="fa fa-truck w-5 text-center"></i>
                    <span>发货管理</span>
                </a>
                <a href="#receipt" class="nav-item" data-module="receipt">
                    <i class="fa fa-archive w-5 text-center"></i>
                    <span>收货管理</span>
                </a>
                <a href="#summary" class="nav-item" data-module="summary">
                    <i class="fa fa-bar-chart w-5 text-center"></i>
                    <span>订单汇总</span>
                </a>
                <a href="#finance" class="nav-item" data-module="finance">
                    <i class="fa fa-money w-5 text-center"></i>
                    <span>结算对账</span>
                </a>
            </nav>
            

        </aside>
        
        <!-- 主内容区 -->
        <main class="flex-1 overflow-y-auto bg-light">
            <!-- 顶部状态栏 -->
            <header class="bg-white shadow-sm p-4 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <button id="mobile-menu-button" class="lg:hidden text-gray-medium">
                        <i class="fa fa-bars"></i>
                    </button>
                    <h2 class="text-xl font-bold text-dark" id="page-title">数据概览</h2>
                </div>
                <div class="flex items-center gap-4">
                    <div class="hidden md:flex items-center gap-2">
                        <span class="text-sm text-gray-medium">今天: </span>
                        <span class="text-sm font-medium text-dark" id="current-date"></span>
                    </div>

                </div>
            </header>
            
            <!-- 内容区域 -->
            <div class="p-6">
                <!-- 数据概览模块 -->
                <div id="dashboard-module" class="module-content">
                    <!-- 总体统计栏 -->
                    <div class="bg-white rounded-xl shadow-card p-6 mb-6">
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                            <div class="flex items-center gap-4">
                                <div class="stat-icon bg-primary">
                                    <i class="fa fa-list-alt"></i>
                                </div>
                                <div>
                                    <p class="stat-label text-sm">订单总数</p>
                                    <p class="stat-value" id="total-order-count">0</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-4">
                                <div class="stat-icon bg-info">
                                    <i class="fa fa-cubes"></i>
                                </div>
                                <div>
                                    <p class="stat-label text-sm">订单数量</p>
                                    <p class="stat-value" id="total-order-quantity">0</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-4">
                                <div class="stat-icon bg-success">
                                    <i class="fa fa-check-square-o"></i>
                                </div>
                                <div>
                                    <p class="stat-label text-sm">良品总数</p>
                                    <p class="stat-value" id="total-good-product-count">0</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-4">
                                <div class="stat-icon bg-secondary">
                                    <i class="fa fa-archive"></i>
                                </div>
                                <div>
                                    <p class="stat-label text-sm">库存数量</p>
                                    <p class="stat-value" id="total-inventory-count">0</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-4">
                                <div class="stat-icon bg-warning">
                                    <i class="fa fa-exclamation-triangle"></i>
                                </div>
                                <div>
                                    <p class="stat-label text-sm">滞留数量</p>
                                    <p class="stat-value" id="total-stay-count">0</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-4">
                                <div class="stat-icon bg-danger">
                                    <i class="fa fa-times-circle"></i>
                                </div>
                                <div>
                                    <p class="stat-label text-sm">报废数量</p>
                                    <p class="stat-value" id="total-scrap-count">0</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 统计卡片部分已移除 -->
                    
                    <!-- 最近订单 -->
                    <div class="card">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="font-bold text-dark">最近订单</h3>
                            <a href="#orders" class="btn btn-primary text-sm py-1" data-navigate="orders">
                                查看全部
                                <i class="fa fa-arrow-right"></i>
                            </a>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead>
                                    <tr>
                                        <th class="table-header sticky-top sticky-left bg-white z-20">订单编号</th>
                                        <th class="table-header">客户名称</th>
                                        <th class="table-header">产品</th>
                                        <th class="table-header">数量</th>
                                        <th class="table-header">加工单价</th>
                                        <th class="table-header">交货期</th>
                                        <th class="table-header">电镀厂</th>
                                        <th class="table-header">备注</th>
                                        <th class="table-header">操作</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200" id="recentOrdersTableBody">
                                    <!-- 订单数据将通过JavaScript动态加载 -->
                                    <tr class="text-center text-gray-500">
                                        <td colspan="9" class="table-cell">暂无订单数据</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- 记录统计和分页 - 记录统计已移除 -->
                        <div class="flex justify-end items-center mt-6">
                            
                        </div><!-- 分页功能已移除 -->
                    </div>
                    
                    <!-- 图表区域 -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="card">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="font-bold text-dark">年度产品数量统计</h3>
                                <div class="flex gap-2">
                                    <button class="btn btn-primary text-sm py-1" id="product-stat-btn">产品统计</button>
                                    <button class="btn btn-secondary text-sm py-1" id="quantity-stat-btn">数量统计</button>
                                </div>
                            </div>
                            <div class="h-64">
                                <canvas id="orderTrendChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="font-bold text-dark">订单状态分布</h3>
                                <button class="btn btn-secondary text-sm py-1">
                                    <i class="fa fa-refresh"></i>
                                </button>
                            </div>
                            <div class="h-64">
                                <canvas id="orderStatusChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <script>
                    // 加载最近订单数据
                    function loadRecentOrders() {
                        const orders = JSON.parse(localStorage.getItem(window.storagePrefix + "orders")) || [];
                        const recentOrdersTableBody = document.getElementById('recentOrdersTableBody');
                        
                        if (localStorage.getItem(window.storagePrefix + "ordersCleared") === 'true' || orders.length === 0) {
                            recentOrdersTableBody.innerHTML = '<tr class="text-center text-gray-500"><td colspan="9">暂无订单数据</td></tr>';
                            return;
                        }
                        
                        // 按交货期倒序排序，只显示最近5条订单
                        const sortedOrders = [...orders].sort((a, b) => {
                            return new Date(b.deliveryDate) - new Date(a.deliveryDate);
                        }).slice(0, 5);
                        
                        // 清空表格并添加排序后的数据
                        recentOrdersTableBody.innerHTML = '';
                        sortedOrders.forEach(order => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td class="table-cell">
                                    <input type="checkbox" class="order-checkbox rounded text-primary focus:ring-primary" data-id="${order.orderId}">
                                </td>
                                <td class="table-cell">${order.orderId}</td>
                                <td class="table-cell">${order.customer}</td>
                                <td class="table-cell">${order.product || ''}</td>
                                <td class="table-cell">${order.quantity}</td>
                                <td class="table-cell">${order.unitPrice || ''}</td>
                                <td class="table-cell">${order.deliveryDate}</td>
                                <td class="table-cell">${getStyledFactoryHTML(order.electroplatingFactory)}</td>
                                <td class="table-cell">${order.remark || ''}</td>
                                <td class="table-cell">
                                    <div class="flex gap-2">
                                        <button class="text-primary hover:text-accent view-order" data-id="${order.orderId}">
                                            <i class="fa fa-eye"></i>
                                        </button>
                                        <button class="text-gray-medium hover:text-primary edit-order" data-id="${order.orderId}">
                                            <i class="fa fa-edit"></i>
                                        </button>
                                        <button class="text-gray-medium hover:text-danger delete-order" data-id="${order.orderId}">
                                            <i class="fa fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            `;
                            recentOrdersTableBody.appendChild(row);
                        });
                        
                        // 添加事件监听器
                        document.querySelectorAll('#recentOrdersTableBody .view-order').forEach(btn => {
                            btn.addEventListener('click', function() {
                                const orderId = this.getAttribute('data-id');
                                viewOrderDetails(orderId);
                            });
                        });
                        
                        document.querySelectorAll('#recentOrdersTableBody .edit-order').forEach(btn => {
                            btn.addEventListener('click', function() {
                                const orderId = this.getAttribute('data-id');
                                editOrder(orderId);
                            });
                        });
                        
                        document.querySelectorAll('#recentOrdersTableBody .delete-order').forEach(btn => {
                            btn.addEventListener('click', function() {
                                const orderId = this.getAttribute('data-id');
                                deleteOrder(orderId);
                            });
                        });
                    }
                    
                    // 添加统计类型切换功能
                    function initStatToggleButtons() {
                        const productStatBtn = document.getElementById('product-stat-btn');
                        const quantityStatBtn = document.getElementById('quantity-stat-btn');
                        
                        if (productStatBtn && quantityStatBtn) {
                            productStatBtn.addEventListener('click', function() {
                                currentStatType = 'product';
                                productStatBtn.classList.remove('btn-secondary');
                                productStatBtn.classList.add('btn-primary');
                                quantityStatBtn.classList.remove('btn-primary');
                                quantityStatBtn.classList.add('btn-secondary');
                                initCharts();
                            });
                            
                            quantityStatBtn.addEventListener('click', function() {
                                currentStatType = 'quantity';
                                quantityStatBtn.classList.remove('btn-secondary');
                                quantityStatBtn.classList.add('btn-primary');
                                productStatBtn.classList.remove('btn-primary');
                                productStatBtn.classList.add('btn-secondary');
                                initCharts();
                            });
                        }
                    }
                    
                    // 页面加载时调用
                    document.addEventListener('DOMContentLoaded', function() {
                        // 快速操作按钮事件监听
                        const quickCreateOrderBtn = document.getElementById('quick-create-order');
                        const quickCreateDeliveryBtn = document.getElementById('quick-create-delivery');
                        const quickCreateReceiptBtn = document.getElementById('quick-create-receipt');

                        
                        if (quickCreateOrderBtn) {
                            quickCreateOrderBtn.addEventListener('click', function() {
                                // 先切换到订单计划模块
                                const orderNavItem = document.querySelector('.nav-item[data-module="orders"]');
                                if (orderNavItem) {
                                    orderNavItem.click();
                                }
                                // 延迟打开模态框，确保模块已加载
                                setTimeout(() => {
                                    const createOrderBtn = document.getElementById('create-order-btn');
                                    if (createOrderBtn) {
                                        createOrderBtn.click();
                                    }
                                }, 300);
                            });
                        }
                        
                        if (quickCreateDeliveryBtn) {
                            quickCreateDeliveryBtn.addEventListener('click', function() {
                                // 先切换到发货管理模块
                                const deliveryNavItem = document.querySelector('.nav-item[data-module="delivery"]');
                                if (deliveryNavItem) {
                                    deliveryNavItem.click();
                                }
                                // 延迟打开模态框，确保模块已加载
                                setTimeout(() => {
                                    const createDeliveryBtn = document.getElementById('create-delivery-btn');
                                    if (createDeliveryBtn) {
                                        createDeliveryBtn.click();
                                    }
                                }, 300);
                            });
                        }
                        
                        if (quickCreateReceiptBtn) {
                            quickCreateReceiptBtn.addEventListener('click', function() {
                                // 先切换到收货管理模块
                                const receiptNavItem = document.querySelector('.nav-item[data-module="receipt"]');
                                if (receiptNavItem) {
                                    receiptNavItem.click();
                                }
                                // 延迟打开模态框，确保模块已加载
                                setTimeout(() => {
                                    const createReceiptBtn = document.getElementById('create-receipt-btn');
                                    if (createReceiptBtn) {
                                        createReceiptBtn.click();
                                    }
                                }, 300);
                            });
                        }
                        
                        // 初始化统计切换按钮
                        initStatToggleButtons();
                        
                        // 当切换到数据概览模块时，加载最近订单数据和初始化图表
                        const dashboardNav = document.querySelector('[data-module="dashboard"]');
                        if (dashboardNav) {
                            dashboardNav.addEventListener('click', function() {
                                setTimeout(() => {
                                    loadRecentOrders();
                                    updateDashboardStatistics();
                                    initCharts();
                                }, 100); // 延迟执行，确保模块已显示
                            });
                        }
                        
                        // 直接为每个导航项添加点击事件监听器
                        const navItems = document.querySelectorAll('.nav-item');
                        navItems.forEach(item => {
                            item.addEventListener('click', function(e) {
                                e.preventDefault();
                                
                                const targetModule = this.getAttribute('data-module');
                                const pageTitle = document.getElementById('page-title');
                                const moduleContents = document.querySelectorAll('.module-content');
                                
                                // 更新导航状态
                                navItems.forEach(nav => nav.classList.remove('active'));
                                this.classList.add('active');
                                
                                // 更新页面标题
                                if (pageTitle) {
                                    const titleText = this.querySelector('span')?.textContent || '未知页面';
                                    pageTitle.textContent = titleText;
                                }
                                
                                // 隐藏所有模块
                                moduleContents.forEach(content => {
                                    content.classList.add('hidden');
                                    content.style.display = 'none';
                                });
                                
                                // 显示目标模块
                                const targetModuleElement = document.getElementById(`${targetModule}-module`);
                                if (targetModuleElement) {
                                    targetModuleElement.style.display = 'block';
                                    targetModuleElement.classList.remove('hidden');
                                    
                                    // 特殊处理财务模块
                                    if (targetModule === 'finance' && typeof initReconciliationSubmodules === 'function') {
                                        initReconciliationSubmodules();
                                    }
                                }
                            });
                        });
                        
                        // 初始加载
                        if (dashboardNav && dashboardNav.classList.contains('active')) {
                            loadRecentOrders();
                            // 检查函数是否存在再调用
                            if (typeof updateDashboardStats === 'function') {
                                updateDashboardStats();
                            } else if (typeof updateDashboardStatistics === 'function') {
                                updateDashboardStatistics();
                            }
                            // 延迟初始化图表，确保数据已准备好
                            setTimeout(() => {
                                try {
                                    initCharts();
                                } catch (e) {
                                    console.log('图表初始化失败:', e);
                                }
                            }, 100);
                        }
                    });
                    
                    // 监听localStorage变化，实时更新图表和财务统计
                    window.addEventListener('storage', function(e) {
                        if (e.key === 'orders' || e.key === 'ordersCleared') {
                            updateDashboardStatistics();
                            updateCharts();
                        }
                        // 当账单或付款数据变化时，更新结算对账统计
                        if (e.key === 'bills' || e.key === 'payments') {
                            updateFinanceStatistics();
                        }
                    });
                    
                    // 更新结算对账模块的统计卡片
                    function updateFinanceStatistics() {
                        // 获取账单和付款数据
                        const bills = JSON.parse(localStorage.getItem(window.storagePrefix + "bills")) || [];
                        const payments = JSON.parse(localStorage.getItem(window.storagePrefix + "payments")) || [];
                        
                        // 计算统计数据
                        const totalBillCount = bills.length;
                        const totalDeduction = bills.reduce((sum, bill) => sum + parseFloat(bill.deduction || 0), 0);
                        const totalSettlementAmount = bills.reduce((sum, bill) => sum + parseFloat(bill.amount || 0), 0);
                        const totalPaidAmount = bills.filter(bill => bill.billStatus === 'paid').reduce((sum, bill) => sum + parseFloat(bill.amount || 0), 0);
                        
                        // 获取统计卡片元素
                        function findCardByLabel(text) {
                            const allCards = document.querySelectorAll('.stat-card');
                            for (const card of allCards) {
                                const label = card.querySelector('.stat-label');
                                if (label && label.textContent.trim() === text) {
                                    return card;
                                }
                            }
                            return null;
                        }
                        
                        const settlementCountCard = findCardByLabel('结算数量');
                        const deductionAmountCard = findCardByLabel('扣款金额');
                        const settlementAmountCard = findCardByLabel('结算金额');
                        const paidAmountCard = findCardByLabel('已付款金额');
                        
                        // 更新统计卡片
                        if (settlementCountCard) {
                            const valueElement = settlementCountCard.querySelector('.stat-value');
                            if (valueElement) {
                                valueElement.textContent = totalBillCount;
                            }
                            const infoElement = settlementCountCard.querySelector('.text-xs');
                            if (infoElement) {
                                infoElement.innerHTML = totalBillCount > 0 ? `共 ${totalBillCount} 个账单` : '<span class="text-gray-medium">暂无数据</span>';
                            }
                        }
                        
                        if (deductionAmountCard) {
                            const valueElement = deductionAmountCard.querySelector('.stat-value');
                            if (valueElement) {
                                valueElement.textContent = `¥${totalDeduction.toFixed(2)}`;
                            }
                            const infoElement = deductionAmountCard.querySelector('.text-xs');
                            if (infoElement) {
                                infoElement.innerHTML = totalDeduction > 0 ? `累计扣款 ¥${totalDeduction.toFixed(2)}` : '<span class="text-gray-medium">暂无扣款</span>';
                            }
                        }
                        
                        if (settlementAmountCard) {
                            const valueElement = settlementAmountCard.querySelector('.stat-value');
                            if (valueElement) {
                                valueElement.textContent = `¥${totalSettlementAmount.toFixed(2)}`;
                            }
                            const infoElement = settlementAmountCard.querySelector('.text-xs');
                            if (infoElement) {
                                infoElement.innerHTML = totalSettlementAmount > 0 ? `总结算金额 ¥${totalSettlementAmount.toFixed(2)}` : '<span class="text-gray-medium">暂无数据</span>';
                            }
                        }
                        
                        if (paidAmountCard) {
                            const valueElement = paidAmountCard.querySelector('.stat-value');
                            if (valueElement) {
                                valueElement.textContent = `¥${totalPaidAmount.toFixed(2)}`;
                            }
                            const infoElement = paidAmountCard.querySelector('.text-xs');
                            if (infoElement) {
                                const paidPercentage = totalSettlementAmount > 0 ? Math.round((totalPaidAmount / totalSettlementAmount) * 100) : 0;
                                infoElement.innerHTML = totalPaidAmount > 0 ? `已付款 ${paidPercentage}%` : '<span class="text-gray-medium">暂无数据</span>';
                            }
                        }
                    }
                    
                    // 当切换到结算对账模块时，更新统计数据
                    const financeNav = document.querySelector('[data-module="finance"]');
                    if (financeNav) {
                        financeNav.addEventListener('click', function() {
                            setTimeout(() => {
                                updateFinanceStatistics();
                            }, 100); // 延迟执行，确保模块已显示
                        });
                    }
                    
                    // 页面加载完成时，如果当前在结算对账模块，初始化统计数据
                    document.addEventListener('DOMContentLoaded', function() {
                        if (financeNav && financeNav.classList.contains('active')) {
                            setTimeout(() => {
                                updateFinanceStatistics();
                            }, 100);
                        }
                    });
                    
                    // 添加一个全局函数用于强制更新财务统计
                    window.forceUpdateFinanceStats = function() {
                        updateFinanceStatistics();
                    };
                    </script>
                </div>
                
                <!-- 订单计划模块 -->
                <div id="orders-module" class="module-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                        <h2 class="text-xl font-bold text-dark">订单计划</h2>
                        <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
                            <div class="relative">
                                <input type="text" placeholder="搜索订单..." id="order-search-input" class="input-field pl-10 input-field-centered">
                                <i class="fa fa-search absolute left-3 top-3 text-gray-medium"></i>
                            </div>
                            <button class="btn btn-primary" id="create-order-btn">
                                <i class="fa fa-plus"></i>
                                新建计划
                            </button>
                            <button class="btn btn-success" id="generate-plating-plan-btn">
                                <i class="fa fa-file-text-o"></i>
                                生成电镀计划
                            </button>
                            <button class="btn btn-secondary" id="import-orders-btn">
                                <i class="fa fa-upload"></i>
                                导入数据
                            </button>
                            <button class="btn btn-secondary" id="export-orders-btn">
                                <i class="fa fa-download"></i>
                                导出数据
                            </button>
                            <input type="file" id="receipt-import-input" accept=".csv" class="hidden">
                            <input type="file" id="delivery-import-input" accept=".csv" class="hidden">
                            <button class="btn btn-danger" id="clear-orders-btn">
                            <i class="fa fa-trash"></i>
                            清空
                        </button>
                        <!-- 隐藏的文件上传input -->
                        <input type="file" id="order-import-input" accept=".csv" class="hidden">
                        </div>
                    </div>
                    

                    
                    <!-- 订单列表 -->
                    <div class="card">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead>
                                    <tr>
                                        <th class="table-header">
                                            <input type="checkbox" id="select-all-orders" class="rounded text-primary focus:ring-primary">
                                        </th>
                                        <th class="table-header">订单编号</th>
                                        <th class="table-header">客户名称</th>
                                        <th class="table-header">产品</th>
                                        <th class="table-header">数量</th>
                                        <th class="table-header">加工单价</th>
                                        <th class="table-header">交货期</th>
                                        <th class="table-header">电镀厂</th>
                                        <th class="table-header">备注</th>
                                        <th class="table-header">操作</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200" id="orderTableBody">
                                    <!-- 订单数据将通过JavaScript动态加载 -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- 统计条数功能已移除 -->
                    
                    <!-- 分页控制 -->
                    <!-- 分页功能已移除 -->
                    </div>
                </div>
                
                <!-- 发货管理模块 -->
                <div id="delivery-module" class="module-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                        <h2 class="text-xl font-bold text-dark">发货管理</h2>
                        <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
                            <div class="relative">
                                <input type="text" id="delivery-search" placeholder="搜索发货单..." class="input-field pl-10" style="text-align: center; font-size: 14px;">
                                <i class="fa fa-search absolute left-3 top-3 text-gray-medium"></i>
                            </div>
                            <button class="btn btn-primary" id="create-delivery-btn" style="font-size: 14px;">
                                <i class="fa fa-plus"></i>
                                新建发货单
                            </button>
                            <button class="btn btn-success" id="generate-delivery-btn" style="font-size: 14px;">
                                        <i class="fa fa-file-text-o"></i>
                                        生成发货单
                                    </button>
                                    <button class="btn btn-secondary" id="import-deliveries-btn" style="font-size: 14px;">
                                        <i class="fa fa-upload"></i>
                                        导入数据
                                    </button>
                                    <button class="btn btn-secondary" id="export-deliveries-btn" style="font-size: 14px;">
                                    <i class="fa fa-download"></i>
                                    导出数据
                                </button>
                                
                        </div>
                    </div>
                    
                    <!-- 日期区间筛选和统计区域 -->
                    <div class="bg-white rounded-xl shadow-card p-4 mb-6">
                        <div class="flex flex-wrap gap-3 mb-4 items-center">
                            <div class="flex items-center gap-2">
                                <label class="text-gray-medium" style="font-size: 14px;">开始日期</label>
                                <input type="date" id="start-date" class="input-field" style="width: 150px;">
                            </div>
                            <div class="flex items-center gap-2">
                                <label class="text-gray-medium" style="font-size: 14px;">结束日期</label>
                                <input type="date" id="end-date" class="input-field" style="width: 150px;">
                            </div>
                            <div class="flex items-center gap-2">
                                <label class="text-gray-medium" style="font-size: 14px;">电镀厂</label>
                                <select id="plating-plant" class="input-field">
                                    <option value="">全部</option>
                                    <option value="宣城沃新">宣城沃新</option>
                                    <option value="丹阳裕丰">丹阳裕丰</option>
                                </select>
                            </div>
                            <button class="btn btn-primary" id="filter-by-date-btn" style="font-size: 14px;">
                                <i class="fa fa-filter"></i>
                                筛选
                            </button>
                            <button class="btn btn-secondary" id="reset-filter-btn" style="font-size: 14px;">
                                <i class="fa fa-refresh"></i>
                                重置
                            </button>
                            <button class="btn btn-warning" id="download-html-btn" style="font-size: 14px;">
                                <i class="fa fa-file-code-o"></i>
                                生成报表
                            </button>
                        </div>
                        <!-- 统计信息 -->
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 p-3 bg-light rounded-lg">
                            <div class="text-center">
                                <p class="text-gray-medium" style="font-size: 14px;">毛坯数量总计</p>
                                <p class="font-bold text-dark" id="delivery-total-raw" style="font-size: 14px;">0</p>
                            </div>
                            <div class="text-center">
                                <p class="text-gray-medium" style="font-size: 14px;">返镀数量总计</p>
                                <p class="font-bold text-dark" id="delivery-total-rework" style="font-size: 14px;">0</p>
                            </div>
                            <div class="text-center">
                                <p class="text-gray-medium" style="font-size: 14px;">报废数量总计</p>
                                <p class="font-bold text-dark" id="delivery-total-scrap" style="font-size: 14px;">0</p>
                            </div>
                            <div class="text-center">
                                <p class="text-gray-medium" style="font-size: 14px;">合计数量</p>
                                <p class="font-bold text-dark" id="delivery-total-quantity" style="font-size: 14px;">0</p>
                            </div>
                            <div class="text-center">
                                <p class="text-gray-medium" style="font-size: 14px;">发货件数总计</p>
                                <p class="font-bold text-dark" id="delivery-total-packages" style="font-size: 14px;">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 发货单列表 -->
                    <script>
                    // 等待DOM加载完成后再绑定事件
                    document.addEventListener('DOMContentLoaded', function() {
                        // 全选/取消全选功能
                        const selectAllCheckbox = document.getElementById('select-all');
                        // 订单计划全选功能
                        const selectAllOrdersCheckbox = document.getElementById('select-all-orders');
                        if (selectAllOrdersCheckbox) {
                            selectAllOrdersCheckbox.addEventListener('change', function() {
                                const isChecked = this.checked;
                                document.querySelectorAll('.order-checkbox').forEach(checkbox => {
                                    checkbox.checked = isChecked;
                                });
                            });
                        }
                        
                        // 生成电镀计划按钮功能
                        const generatePlatingPlanBtn = document.getElementById('generate-plating-plan-btn');
                        if (generatePlatingPlanBtn) {
                            generatePlatingPlanBtn.addEventListener('click', function() {
                                // 获取所有选中的订单复选框
                                const checkedCheckboxes = document.querySelectorAll('.order-checkbox:checked');
                                
                                if (checkedCheckboxes.length === 0) {
                                    alert('请至少选择一个订单！');
                                    return;
                                }
                                
                                // 从localStorage获取所有订单数据
                                const allOrders = JSON.parse(localStorage.getItem(window.storagePrefix + "orders")) || [];
                                
                                // 收集选中的订单信息
                                const selectedOrders = [];
                                checkedCheckboxes.forEach(checkbox => {
                                    const orderId = checkbox.dataset.id;
                                    // 在所有订单中查找对应的订单信息
                                    const order = allOrders.find(o => o.orderId === orderId);
                                    if (order) {
                                        selectedOrders.push({
                                            customer: order.customer || '',
                                            orderId: order.orderId || '',
                                            product: order.product || '',
                                            quantity: order.quantity || '',
                                            deliveryDate: order.deliveryDate || '',
                                            remark: order.remark || ''
                                        });
                                    }
                                });
                                
                                // 将订单信息转换为JSON字符串并编码
                                const ordersJson = encodeURIComponent(JSON.stringify(selectedOrders));
                                
                                // 跳转到电镀计划表页面并传递数据
                                window.open(`电镀计划表.html?orders=${ordersJson}`, '_blank');
                            });
                        }
                        if (selectAllCheckbox) {
                            // 点击表头复选框时全选/取消全选所有发货记录
                            selectAllCheckbox.addEventListener('change', function() {
                                const isChecked = this.checked;
                                // 查找所有的发货记录复选框并设置其选中状态
                                document.querySelectorAll('.delivery-checkbox').forEach(checkbox => {
                                    checkbox.checked = isChecked;
                                });
                            });
                        }
                        
                        // 生成发货单按钮点击事件
                        const generateDeliveryBtn = document.getElementById('generate-delivery-btn');
                        if (generateDeliveryBtn) {
                            generateDeliveryBtn.addEventListener('click', function() {
                                console.log('生成发货单按钮被点击');
                                
                                // 获取所有选中的记录ID
                                const selectedCheckboxes = document.querySelectorAll('.delivery-checkbox:checked');
                                console.log('选中的复选框数量:', selectedCheckboxes.length);
                                
                                const selectedIds = Array.from(selectedCheckboxes)
                                    .map(checkbox => checkbox.dataset.id);
                                console.log('选中的记录ID:', selectedIds);
                                
                                if (selectedIds.length === 0) {
                                    alert('请至少选择一条发货记录');
                                    return;
                                }
                                
                                // 从localStorage获取所有发货单数据
                                const deliveriesData = localStorage.getItem(window.storagePrefix + "deliveries");
                                console.log('localStorage中的发货单数据:', deliveriesData);
                                
                                const allDeliveries = JSON.parse(deliveriesData) || [];
                                console.log('解析后的发货单数据数量:', allDeliveries.length);
                                
                                // 筛选选中的记录
                                const selectedDeliveries = allDeliveries.filter(delivery => 
                                    selectedIds.includes(delivery.deliveryId)
                                );
                                console.log('筛选后的记录数量:', selectedDeliveries.length);
                                
                                // 将选中的记录存储在sessionStorage中，供发货单页面使用
                                sessionStorage.setItem('selectedDeliveries', JSON.stringify(selectedDeliveries));
                                console.log('已将选中记录存储到sessionStorage');
                                
                                // 打开电镀产品发货单.html文件
                                console.log('准备打开发货单页面');
                                window.open('电镀产品发货单.html', '_blank');
                            });
                        }
                        
                        // 日期和电镀厂筛选功能
                        const filterByDateBtn = document.getElementById('filter-by-date-btn');
                        const resetFilterBtn = document.getElementById('reset-filter-btn');
                        const startDateInput = document.getElementById('start-date');
                        const endDateInput = document.getElementById('end-date');
                        const platingPlantSelect = document.getElementById('plating-plant');
                        
                        if (filterByDateBtn) {
                            filterByDateBtn.addEventListener('click', function() {
                                const startDate = startDateInput.value;
                                const endDate = endDateInput.value;
                                const platingPlant = platingPlantSelect.value;
                                
                                // 验证日期格式
                                if (startDate && endDate && new Date(startDate) > new Date(endDate)) {
                                    alert('开始日期不能晚于结束日期');
                                    return;
                                }
                                
                                filterDeliveriesByDateAndPlant(startDate, endDate, platingPlant);
                            });
                        }
                        
                        if (resetFilterBtn) {
                            resetFilterBtn.addEventListener('click', function() {
                                startDateInput.value = '';
                                endDateInput.value = '';
                                platingPlantSelect.value = '';
                                filterDeliveriesByDateAndPlant('', '', ''); // 重置筛选，显示所有数据
                            });
                        }
                        
                        // HTML下载功能
                        const downloadHtmlBtn = document.getElementById('download-html-btn');
                        if (downloadHtmlBtn) {
                            downloadHtmlBtn.addEventListener('click', downloadDeliveriesAsHtml);
                        }
                        
                        // 初始加载时计算统计数据
                        updateDeliveryStatistics();
                    });
                    
                    // 根据日期和电镀厂筛选发货记录
                    function filterDeliveriesByDateAndPlant(startDate, endDate, platingPlant) {
                        const rows = document.querySelectorAll('#delivery-module tbody tr');
                        
                        if (rows.length === 1 && rows[0].querySelector('td').colSpan > 1) {
                            // 如果只有"暂无数据"的行，不进行筛选
                            return;
                        }
                        
                        let hasVisibleRows = false;
                        
                        rows.forEach(row => {
                            const deliveryDateCell = row.querySelector('td:nth-child(11)'); // 发货日期列
                            if (!deliveryDateCell) return;
                            
                            const deliveryDateText = deliveryDateCell.textContent.trim();
                            
                            // 检查日期和电镀厂是否在筛选范围内
                            let showRow = true;
                            
                            // 日期筛选
                            if (startDate && deliveryDateText) {
                                const deliveryDate = new Date(deliveryDateText);
                                const start = new Date(startDate);
                                showRow = deliveryDate >= start;
                            }
                            
                            if (showRow && endDate && deliveryDateText) {
                                const deliveryDate = new Date(deliveryDateText);
                                const end = new Date(endDate);
                                end.setHours(23, 59, 59, 999); // 设置为当天结束时间
                                showRow = deliveryDate <= end;
                            }
                            
                            // 电镀厂筛选
                            if (showRow && platingPlant) {
                                const plantCell = row.querySelector('td:nth-child(10)'); // 假设电镀厂在第10列
                                if (plantCell) {
                                    const plantText = plantCell.textContent.trim();
                                    showRow = plantText.includes(platingPlant);
                                }
                            }
                            
                            row.style.display = showRow ? '' : 'none';
                            if (showRow) {
                                hasVisibleRows = true;
                            }
                        });
                        
                        // 更新统计数据
                        updateDeliveryStatistics();
                        
                        // 如果没有可见行，显示提示信息
                        const emptyMessageRow = document.querySelector('#delivery-module tbody tr.empty-message');
                        if (!hasVisibleRows && !emptyMessageRow) {
                            const tbody = document.querySelector('#delivery-module tbody');
                            const emptyRow = document.createElement('tr');
                            emptyRow.className = 'empty-message';
                            emptyRow.innerHTML = '<td colspan="14" class="table-cell text-center py-8 text-gray-medium">在选定的日期范围内暂无发货单数据</td>';
                            tbody.appendChild(emptyRow);
                        } else if (hasVisibleRows && emptyMessageRow) {
                            emptyMessageRow.remove();
                        }
                    }
                    
                    // 更新发货统计数据
                    function updateDeliveryStatistics() {
                        const rows = document.querySelectorAll('#delivery-module tbody tr');
                        
                        let totalRawQuantity = 0;
                        let totalReworkQuantity = 0;
                        let totalScrapQuantity = 0;
                        let totalQuantity = 0;
                        let totalPackages = 0;
                        
                        rows.forEach(row => {
                            // 跳过隐藏的行和空数据行
                            if (row.style.display === 'none' || row.querySelector('td').colSpan > 1) {
                                return;
                            }
                            
                            // 获取各列数据
                            const rawQuantityText = row.querySelector('td:nth-child(5)')?.textContent.trim() || '0';
                            const reworkQuantityText = row.querySelector('td:nth-child(6)')?.textContent.trim() || '0';
                            const scrapQuantityText = row.querySelector('td:nth-child(7)')?.textContent.trim() || '0';
                            const quantityText = row.querySelector('td:nth-child(8)')?.textContent.trim() || '0';
                            const packagesText = row.querySelector('td:nth-child(9)')?.textContent.trim() || '0';
                            
                            // 累加统计
                            totalRawQuantity += parseInt(rawQuantityText) || 0;
                            totalReworkQuantity += parseInt(reworkQuantityText) || 0;
                            totalScrapQuantity += parseInt(scrapQuantityText) || 0;
                            totalQuantity += parseInt(quantityText) || 0;
                            totalPackages += parseInt(packagesText) || 0;
                        });
                        
                        // 更新统计显示
                          document.getElementById('delivery-total-raw').textContent = totalRawQuantity;
                          document.getElementById('delivery-total-rework').textContent = totalReworkQuantity;
                          document.getElementById('delivery-total-scrap').textContent = totalScrapQuantity;
                          document.getElementById('delivery-total-quantity').textContent = totalQuantity;
                          document.getElementById('delivery-total-packages').textContent = totalPackages;
                    }
                    
                    // 下载HTML格式的查询结果
                    function downloadDeliveriesAsHtml() {
                        // 获取筛选后的可见行
                        const visibleRows = Array.from(document.querySelectorAll('#delivery-module tbody tr'))
                            .filter(row => row.style.display !== 'none' && row.querySelector('td').colSpan <= 1);
                        
                        if (visibleRows.length === 0) {
                            alert('当前没有可下载的数据');
                            return;
                        }
                        
                        // 创建HTML内容
                        const startDate = document.getElementById('start-date').value;
                        const endDate = document.getElementById('end-date').value;
                        const currentDate = new Date().toLocaleDateString('zh-CN');
                        
                        let htmlContent = `<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>发货管理查询结果 - ${currentDate}</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            color: #333;
        }
        h1 {
            text-align: center;
            color: #1E88E5;
            margin-bottom: 20px;
        }
        .filter-info {
            background-color: #f5f5f5;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .statistics {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .stat-item {
            text-align: center;
            padding: 10px;
            background-color: #f0f7ff;
            border-radius: 5px;
            margin: 5px;
            min-width: 150px;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #1E88E5;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #1E88E5;
            color: white;
            font-weight: bold;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
    </style>
</head>
<body>
    <h1>发货管理查询结果</h1>
    <div class="filter-info">
        <p>查询时间：${currentDate}</p>
        <p>日期范围：${startDate || '无'} 至 ${endDate || '无'}</p>
    </div>
    <div class="statistics">
        <div class="stat-item">
            <div class="stat-value">${document.getElementById('delivery-total-raw').textContent}</div>
            <div>毛坯数量总计</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">${document.getElementById('delivery-total-rework').textContent}</div>
            <div>返镀数量总计</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">${document.getElementById('delivery-total-scrap').textContent}</div>
            <div>报废数量总计</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">${document.getElementById('delivery-total-quantity').textContent}</div>
            <div>合计数量</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">${document.getElementById('delivery-total-packages').textContent}</div>
            <div>发货件数总计</div>
        </div>
    </div>
    <table>
        <thead>
            <tr>
                <th>订单编号</th>
                <th>客户名称</th>
                <th>产品</th>
                <th>毛坯数量</th>
                <th>返镀数量</th>
                <th>报废数量</th>
                <th>合计</th>
                <th>发货件数</th>
                <th>电镀厂</th>
                <th>发货日期</th>
                <th>要求送回日期</th>
                <th>备注</th>
            </tr>
        </thead>
        <tbody>`;
        
        // 添加表格数据
        visibleRows.forEach(row => {
            htmlContent += '<tr>';
            // 跳过复选框列和操作列
            const cells = row.querySelectorAll('td:nth-child(n+2):nth-child(-n+13)');
            cells.forEach(cell => {
                htmlContent += `<td>${cell.textContent.trim()}</td>`;
            });
            htmlContent += '</tr>';
        });
        
        htmlContent += `        </tbody>
    </table>
</body>
</html>`;
        
        // 创建下载链接
        const blob = new Blob([htmlContent], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `发货管理查询结果_${currentDate.replace(/\//g, '-')}.html`;
        document.body.appendChild(a);
        a.click();
        
        // 清理
        setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }, 100);
    }
                    
                    // 发货管理搜索功能 - 模糊查找发货记录中产品的所有信息
                    document.getElementById('delivery-search').addEventListener('input', function(e) {
                        const searchTerm = e.target.value.toLowerCase();
                        const rows = document.querySelectorAll('#delivery-module tbody tr');
                        
                        if (rows.length === 1 && rows[0].querySelector('td').colSpan > 1) {
                            // 如果只有"暂无数据"的行，不进行筛选
                            return;
                        }
                        
                        rows.forEach(row => {
                            // 获取行中所有单元格的文本内容
                            const cells = row.querySelectorAll('td');
                            let found = false;
                            
                            // 遍历所有单元格，检查是否包含搜索词
                            cells.forEach(cell => {
                                const cellText = cell.textContent.toLowerCase();
                                if (cellText.includes(searchTerm)) {
                                    found = true;
                                }
                            });
                            
                            // 根据搜索结果显示或隐藏行
                            row.style.display = found ? '' : 'none';
                        });
                        
                        // 更新统计数据
                        updateDeliveryStatistics();
                    });
                    </script>
                    <div class="card">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead>
                                    <tr>
                                        <th class="table-header w-12"><input type="checkbox" id="select-all" class="form-checkbox rounded"></th>
                                        <th class="table-header">订单编号</th>
                                        <th class="table-header">客户名称</th>
                                        <th class="table-header">产品</th>
                                        <th class="table-header">毛坯数量</th>
                                        <th class="table-header">返镀数量</th>
                                        <th class="table-header">报废数量</th>
                                        <th class="table-header">合计</th>
                                        <th class="table-header">发货件数</th>
                                        <th class="table-header">电镀厂</th>
                                        <th class="table-header">发货日期</th>
                                        <th class="table-header">要求送回日期</th>
                                        <th class="table-header">备注</th>
                                        <th class="table-header">操作</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    <!-- 暂无数据 -->
                                    <tr>
                                        <td colspan="13" class="table-cell text-center py-8 text-gray-medium">
                                            暂无发货单数据
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        

                    </div>
                </div>
                
                <!-- 收货管理模块 -->
                <div id="receipt-module" class="module-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                        <h2 class="text-xl font-bold text-dark">收货管理</h2>
                        <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
                            <div class="relative">
                                <input type="text" placeholder="搜索收货单..." id="receipt-search" class="input-field pl-10 input-field-centered">
                                <i class="fa fa-search absolute left-3 top-3 text-gray-medium"></i>
                            </div>
                            <button class="btn btn-primary" id="create-receipt-btn">
                                        <i class="fa fa-plus"></i>
                                        新建收货单
                                    </button>
                                    <button class="btn btn-secondary" id="import-receipts-btn">
                                        <i class="fa fa-upload"></i>
                                        导入数据
                                    </button>
                                    <button class="btn btn-secondary" id="export-receipts-btn">
                                    <i class="fa fa-download"></i>
                                    导出数据
                                </button>
                                <!-- 下载HTML按钮已移至重置按钮后 -->
                        </div>
                    </div>
                    
                    <!-- 日期筛选区域 -->
                    <div class="bg-white rounded-xl shadow-card p-4 mb-6">
                        <div class="flex flex-wrap gap-3 mb-4 items-center">
                            <div class="flex items-center gap-2">
                                <label class="text-gray-medium" style="font-size: 14px;">开始日期</label>
                                <input type="date" id="receipt-start-date" class="input-field" style="width: 150px;">
                            </div>
                            <div class="flex items-center gap-2">
                                <label class="text-gray-medium" style="font-size: 14px;">结束日期</label>
                                <input type="date" id="receipt-end-date" class="input-field" style="width: 150px;">
                            </div>
                            <div class="flex items-center gap-2">
                                <label class="text-gray-medium" style="font-size: 14px;">电镀厂</label>
                                <select id="receipt-plating-plant" class="input-field">
                                    <option value="">全部</option>
                                    <option value="宣城沃新">宣城沃新</option>
                                    <option value="丹阳裕丰">丹阳裕丰</option>
                                </select>
                            </div>
                            <button id="receipt-filter-btn" class="btn btn-primary" style="font-size: 14px;">
                                <i class="fa fa-filter"></i>
                                筛选
                            </button>
                            <button id="receipt-reset-btn" class="btn btn-secondary" style="font-size: 14px;">
                                <i class="fa fa-refresh"></i>
                                重置
                            </button>
                            <button class="btn btn-warning" id="download-receipts-html" style="font-size: 14px;">
                                <i class="fa fa-file-code-o"></i>
                                生成报表
                            </button>
                        </div>
                    </div>
                    
                    <!-- 统计信息区域 -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-light">
                            <div class="text-sm text-gray-medium">成品数量总计</div>
                            <div class="text-2xl font-bold text-primary" id="receipt-total-finished">0</div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-light">
                            <div class="text-sm text-gray-medium">返修数量总计</div>
                            <div class="text-2xl font-bold text-primary" id="receipt-total-rework">0</div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-light">
                            <div class="text-sm text-gray-medium">报废数量总计</div>
                            <div class="text-2xl font-bold text-primary" id="receipt-total-scrap">0</div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-light">
                            <div class="text-sm text-gray-medium">合计数量</div>
                            <div class="text-2xl font-bold text-primary" id="receipt-total-quantity">0</div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-light">
                            <div class="text-sm text-gray-medium">件数总计</div>
                            <div class="text-2xl font-bold text-primary" id="receipt-total-packages">0</div>
                        </div>
                    </div>
                    
                    <!-- 筛选条件已移除 -->
                    
                    <!-- 收货单列表 -->
                    <script>
                    // 收货管理功能实现
                    document.addEventListener('DOMContentLoaded', function() {
                        // 日期和电镀厂筛选功能
                        const receiptFilterBtn = document.getElementById('receipt-filter-btn');
                        const receiptResetBtn = document.getElementById('receipt-reset-btn');
                        const receiptStartDate = document.getElementById('receipt-start-date');
                        const receiptEndDate = document.getElementById('receipt-end-date');
                        const receiptPlatingPlant = document.getElementById('receipt-plating-plant');
                        const receiptSearch = document.getElementById('receipt-search');
                        const downloadReceiptsHtmlBtn = document.getElementById('download-receipts-html');
                        
                        // 筛选按钮事件
                        if (receiptFilterBtn) {
                            receiptFilterBtn.addEventListener('click', function() {
                                const startDate = receiptStartDate.value;
                                const endDate = receiptEndDate.value;
                                const platingPlant = receiptPlatingPlant.value;
                                filterReceiptsByDateAndPlant(startDate, endDate, platingPlant);
                            });
                        }
                        
                        // 重置按钮事件
                        if (receiptResetBtn) {
                            receiptResetBtn.addEventListener('click', function() {
                                receiptStartDate.value = '';
                                receiptEndDate.value = '';
                                receiptPlatingPlant.value = '';
                                
                                // 重置所有行显示
                                const rows = document.querySelectorAll('#receipt-module tbody tr');
                                rows.forEach(row => {
                                    row.style.display = '';
                                });
                                
                                // 移除空数据提示行
                                const emptyMessageRow = document.querySelector('#receipt-module tbody tr.empty-message');
                                if (emptyMessageRow) {
                                    emptyMessageRow.remove();
                                }
                                
                                // 更新统计数据
                                updateReceiptStatistics();
                            });
                        }
                        
                        // 搜索功能
                        if (receiptSearch) {
                            receiptSearch.addEventListener('input', function(e) {
                                const searchTerm = e.target.value.toLowerCase();
                                const rows = document.querySelectorAll('#receipt-module tbody tr');
                                
                                if (rows.length === 1 && rows[0].querySelector('td').colSpan > 1) {
                                    // 如果只有"暂无数据"的行，不进行筛选
                                    return;
                                }
                                
                                rows.forEach(row => {
                                    // 获取行中所有单元格的文本内容
                                    const cells = row.querySelectorAll('td');
                                    let found = false;
                                    
                                    // 遍历所有单元格，检查是否包含搜索词
                                    cells.forEach(cell => {
                                        const cellText = cell.textContent.toLowerCase();
                                        if (cellText.includes(searchTerm)) {
                                            found = true;
                                        }
                                    });
                                    
                                    // 根据搜索结果显示或隐藏行
                                    row.style.display = found ? '' : 'none';
                                });
                                
                                // 更新统计数据
                                updateReceiptStatistics();
                            });
                        }
                        
                        // 下载HTML按钮事件
                        if (downloadReceiptsHtmlBtn) {
                            downloadReceiptsHtmlBtn.addEventListener('click', downloadReceiptsAsHtml);
                        }
                        
                        // 按日期和电镀厂筛选收货记录
                        function filterReceiptsByDateAndPlant(startDate, endDate, platingPlant) {
                            const rows = document.querySelectorAll('#receipt-module tbody tr');
                            let hasVisibleRows = false;
                            
                            // 日期验证
                            if (startDate && endDate && new Date(startDate) > new Date(endDate)) {
                                alert('开始日期不能晚于结束日期');
                                return;
                            }
                            
                            // 筛选行
                            rows.forEach(row => {
                                // 跳过空数据提示行
                                if (row.querySelector('td').colSpan > 1) {
                                    row.style.display = 'none';
                                    return;
                                }
                                
                                let showRow = true;
                                const receiptDateText = row.querySelector('td:nth-child(10)')?.textContent.trim() || '';
                                
                                // 日期筛选
                                if (receiptDateText && (startDate || endDate)) {
                                    try {
                                        const receiptDate = new Date(receiptDateText);
                                        
                                        if (startDate) {
                                            const start = new Date(startDate);
                                            showRow = receiptDate >= start;
                                        }
                                        
                                        if (endDate && showRow) {
                                            const end = new Date(endDate);
                                            end.setHours(23, 59, 59, 999); // 设置为当天结束时间
                                            showRow = receiptDate <= end;
                                        }
                                    } catch (e) {
                                        // 日期解析错误，默认显示
                                        console.error('日期解析错误:', e);
                                    }
                                }
                                
                                // 电镀厂筛选
                                if (showRow && platingPlant) {
                                    const plantCell = row.querySelector('td:nth-child(9)'); // 假设电镀厂在第9列
                                    if (plantCell) {
                                        const plantText = plantCell.textContent.trim();
                                        showRow = plantText.includes(platingPlant);
                                    }
                                }
                                
                                row.style.display = showRow ? '' : 'none';
                                if (showRow) {
                                    hasVisibleRows = true;
                                }
                            });
                            
                            // 更新统计数据
                            updateReceiptStatistics();
                            
                            // 如果没有可见行，显示提示信息
                            const emptyMessageRow = document.querySelector('#receipt-module tbody tr.empty-message');
                            if (!hasVisibleRows && !emptyMessageRow) {
                                const tbody = document.querySelector('#receipt-module tbody');
                                const emptyRow = document.createElement('tr');
                                emptyRow.className = 'empty-message';
                                emptyRow.innerHTML = '\u003ctd colspan="11" class="table-cell text-center py-8 text-gray-medium">在选定的日期范围内暂无收货单数据\u003c/td\u003e';
                                tbody.appendChild(emptyRow);
                            } else if (hasVisibleRows && emptyMessageRow) {
                                emptyMessageRow.remove();
                            }
                        }
                        
                        // 更新收货统计数据
                        function updateReceiptStatistics() {
                            const rows = document.querySelectorAll('#receipt-module tbody tr');
                            
                            let totalFinishedQuantity = 0;
                            let totalReworkQuantity = 0;
                            let totalScrapQuantity = 0;
                            let totalQuantity = 0;
                            let totalPackages = 0;
                            
                            rows.forEach(row => {
                                // 跳过隐藏的行和空数据行
                                if (row.style.display === 'none' || row.querySelector('td').colSpan > 1) {
                                    return;
                                }
                                
                                // 获取各列数据
                                const finishedQuantityText = row.querySelector('td:nth-child(4)')?.textContent.trim() || '0';
                                const reworkQuantityText = row.querySelector('td:nth-child(5)')?.textContent.trim() || '0';
                                const scrapQuantityText = row.querySelector('td:nth-child(6)')?.textContent.trim() || '0';
                                const quantityText = row.querySelector('td:nth-child(7)')?.textContent.trim() || '0';
                                const packagesText = row.querySelector('td:nth-child(8)')?.textContent.trim() || '0';
                                
                                // 累加统计
                                totalFinishedQuantity += parseInt(finishedQuantityText) || 0;
                                totalReworkQuantity += parseInt(reworkQuantityText) || 0;
                                totalScrapQuantity += parseInt(scrapQuantityText) || 0;
                                totalQuantity += parseInt(quantityText) || 0;
                                totalPackages += parseInt(packagesText) || 0;
                            });
                            
                            // 更新统计显示
                            document.getElementById('receipt-total-finished').textContent = totalFinishedQuantity;
                            document.getElementById('receipt-total-rework').textContent = totalReworkQuantity;
                            document.getElementById('receipt-total-scrap').textContent = totalScrapQuantity;
                            document.getElementById('receipt-total-quantity').textContent = totalQuantity;
                            document.getElementById('receipt-total-packages').textContent = totalPackages;
                        }
                        
                        // 下载HTML格式的查询结果
                        function downloadReceiptsAsHtml() {
                            // 获取筛选后的可见行
                            const visibleRows = Array.from(document.querySelectorAll('#receipt-module tbody tr'))
                                .filter(row => row.style.display !== 'none' && row.querySelector('td').colSpan <= 1);
                            
                            if (visibleRows.length === 0) {
                                alert('当前没有可下载的数据');
                                return;
                            }
                            
                            // 创建HTML内容
                            const startDate = receiptStartDate.value;
                            const endDate = receiptEndDate.value;
                            const currentDate = new Date().toLocaleDateString('zh-CN');
                            
                            let htmlContent = `<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>收货管理查询结果 - ${currentDate}</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            color: #333;
        }
        h1 {
            text-align: center;
            color: #1E88E5;
            margin-bottom: 20px;
        }
        .filter-info {
            background-color: #f5f5f5;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .statistics {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .stat-item {
            text-align: center;
            padding: 10px;
            background-color: #f0f7ff;
            border-radius: 5px;
            margin: 5px;
            min-width: 150px;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #1E88E5;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #1E88E5;
            color: white;
            font-weight: bold;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
    </style>
</head>
<body>
    <h1>收货管理查询结果</h1>
    <div class="filter-info">
        <p>查询时间：${currentDate}</p>
        <p>日期范围：${startDate || '无'} 至 ${endDate || '无'}</p>
    </div>
    <div class="statistics">
        <div class="stat-item">
            <div class="stat-value">${document.getElementById('receipt-total-finished').textContent}</div>
            <div>成品数量总计</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">${document.getElementById('receipt-total-rework').textContent}</div>
            <div>返修数量总计</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">${document.getElementById('receipt-total-scrap').textContent}</div>
            <div>报废数量总计</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">${document.getElementById('receipt-total-quantity').textContent}</div>
            <div>合计数量</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">${document.getElementById('receipt-total-packages').textContent}</div>
            <div>件数总计</div>
        </div>
    </div>
    <table>
        <thead>
            <tr>
                <th>订单编号</th>
                <th>客户名称</th>
                <th>产品</th>
                <th>成品数量</th>
                <th>返修数量</th>
                <th>报废数量</th>
                <th>合计</th>
                <th>件数</th>
                <th>电镀厂</th>
                <th>收货日期</th>
                <th>备注</th>
            </tr>
        </thead>
        <tbody>`;
        
        // 添加表格数据
        visibleRows.forEach(row => {
            htmlContent += '\u003ctr\u003e';
            // 跳过操作列
            const cells = row.querySelectorAll('td:nth-child(n+1):nth-child(-n+11)');
            cells.forEach(cell => {
                htmlContent += `\u003ctd\u003e${cell.textContent.trim()}\u003c/td\u003e`;
            });
            htmlContent += '\u003c/tr\u003e';
        });
        
        htmlContent += `        \u003c/tbody\u003e
    \u003c/table\u003e
\u003c/body\u003e
\u003c/html\u003e`;
        
        // 创建下载链接
        const blob = new Blob([htmlContent], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `收货管理查询结果_${currentDate.replace(/\//g, '-')}.html`;
        document.body.appendChild(a);
        a.click();
        
        // 清理
        setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }, 100);
    }
                    });
                    </script>
                    <div class="card">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead>
                                    <tr>
                                        <th class="table-header sticky-top sticky-left bg-white z-20">订单编号</th>
                                        <th class="table-header sticky-top bg-white z-10">客户名称</th>
                                        <th class="table-header sticky-top bg-white z-10">产品</th>
                                        <th class="table-header sticky-top bg-white z-10">成品数量</th>
                                        <th class="table-header sticky-top bg-white z-10">返修数量</th>
                                        <th class="table-header sticky-top bg-white z-10">报废数量</th>
                                        <th class="table-header sticky-top bg-white z-10">合计</th>
                                        <th class="table-header sticky-top bg-white z-10">件数</th>
                                        <th class="table-header sticky-top bg-white z-10">电镀厂</th>
                                        <th class="table-header sticky-top bg-white z-10">收货日期</th>
                                        <th class="table-header sticky-top bg-white z-10">备注</th>
                                        <th class="table-header sticky-top bg-white z-10">操作</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    <tr>
                                        <td class="table-cell sticky-left bg-white z-10"></td>
                                        <td colspan="10" class="table-cell text-center py-8 text-gray-medium">
                                            暂无收货单数据
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- 分页 - 记录统计已移除 -->
                        <div class="flex justify-center items-center mt-6">
                            <!-- 记录条数统计已移除 -->
                            <!-- 分页功能已移除 -->
                        </div>
                    </div>
                </div>
                
                <!-- 订单汇总模块 -->
                <div id="summary-module" class="module-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                        <h2 class="text-xl font-bold text-dark">订单汇总</h2>
                        <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
                            <div class="relative">
                                <input type="text" placeholder="搜索汇总..." id="summary-search" class="input-field pl-10 input-field-centered">
                                <i class="fa fa-search absolute left-3 top-3 text-gray-medium"></i>
                            </div>
                            <button class="btn btn-primary" id="export-summary-btn">
                                <i class="fa fa-download"></i>
                                导出报表
                            </button>
                            <label class="btn btn-secondary cursor-pointer">
                                <i class="fa fa-upload"></i>
                                导入报表
                                <input type="file" id="import-summary-file" accept=".csv" class="hidden">
                            </label>
                        </div>
                    </div>
                    
                    
                    
                    <!-- 统计卡片 -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div class="stat-card">
                            <div class="flex justify-between items-start">
                                <div class="stat-icon bg-danger">
                                    <i class="fa fa-clock-o"></i>
                                </div>
                                <div class="text-right">
                                    <p class="stat-value" id="pending-plating-count">0</p>
                                    <p class="stat-label">待电镀</p>
                                </div>
                            </div>
                            <div class="mt-4 flex items-center text-xs">
                                <span class="text-gray-medium">共 <span id="pending-plating-amount">0</span> 件产品</span>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="flex justify-between items-start">
                                <div class="stat-icon bg-warning">
                                    <i class="fa fa-cogs"></i>
                                </div>
                                <div class="text-right">
                                    <p class="stat-value" id="plating-count">0</p>
                                    <p class="stat-label">电镀中</p>
                                </div>
                            </div>
                            <div class="mt-4 flex items-center text-xs">
                                <span class="text-gray-medium">共 <span id="plating-amount">0</span> 件产品</span>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="flex justify-between items-start">
                                <div class="stat-icon bg-success">
                                    <i class="fa fa-check-circle"></i>
                                </div>
                                <div class="text-right">
                                    <p class="stat-value" id="completed-count">0</p>
                                    <p class="stat-label">已完成</p>
                                </div>
                            </div>
                            <div class="mt-4 flex items-center text-xs">
                                <span class="text-gray-medium">共 <span id="completed-amount">0</span> 件产品</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 订单汇总表格 -->
                    <div class="card mb-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="font-bold text-dark">订单汇总详情</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead>
                                    <tr>
                                        <th class="table-header w-10">
                                            <input type="checkbox" class="rounded text-primary focus:ring-primary" id="select-all-summary">
                                        </th>
                                        <th class="table-header">电镀厂</th>
                                        <th class="table-header">订单号</th>
                                        <th class="table-header">客户名称</th>
                                        <th class="table-header">产品</th>
                                        <th class="table-header">订单数量</th>
                                        <th class="table-header">交货期</th>
                                        <th class="table-header">毛坯数量</th>
                                        <th class="table-header">良品数量</th>
                                        <th class="table-header">库存数量</th>
                                        <th class="table-header">报废数量</th>
                                        <th class="table-header">滞留数量</th>
                                        <th class="table-header">结算数量</th>
                                        <th class="table-header">状态</th>
                                        <th class="table-header">备注</th>
                                        <th class="table-header"></th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    <tr>
                                        <td colspan="13" class="table-cell text-center py-8 text-gray-medium">
                                            暂无订单汇总数据
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- 分页和统计控件 -->
                        <div class="mt-4 flex flex-col sm:flex-row justify-between items-center gap-4">

                            

                        </div>
                    </div>
                    
                    <!-- 图表区域 -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="card">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="font-bold text-dark">订单类型分布</h3>
                                <div class="flex gap-2">
                                    <button class="btn btn-secondary text-sm py-1" onclick="updateChartsByTimeRange('month')">本月</button>
                                    <button class="btn btn-primary text-sm py-1" onclick="updateChartsByTimeRange('quarter')">季度</button>
                                    <button class="btn btn-secondary text-sm py-1" onclick="updateChartsByTimeRange('year')">年度</button>
                                </div>
                            </div>
                            <div class="h-64">
                                <canvas id="orderTypeChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="font-bold text-dark">客户订单排行</h3>
                                <button class="btn btn-secondary text-sm py-1" onclick="updateCharts()">
                                    <i class="fa fa-refresh"></i>
                                </button>
                            </div>
                            <div class="h-64">
                                <canvas id="customerOrderChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 结算对账模块 -->
                <div id="finance-module" class="module-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                        <h2 class="text-xl font-bold text-dark">结算对账</h2>
                    </div>
                    
                    <!-- 统计卡片 -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                        <!-- 结算数量 -->
                        <div class="stat-card">
                            <div class="flex justify-between items-start">
                                <div class="stat-icon bg-primary">
                                    <i class="fa fa-file-text-o"></i>
                                </div>
                                <div class="text-right">
                                    <p class="stat-value">0</p>
                                    <p class="stat-label">结算数量</p>
                                </div>
                            </div>
                            <div class="mt-4 flex items-center text-xs">
                                <span class="text-gray-medium">暂无数据</span>
                            </div>
                        </div>
                        
                        <!-- 扣款金额 -->
                        <div class="stat-card">
                            <div class="flex justify-between items-start">
                                <div class="stat-icon bg-danger">
                                    <i class="fa fa-minus-circle"></i>
                                </div>
                                <div class="text-right">
                                    <p class="stat-value">¥0</p>
                                    <p class="stat-label">扣款金额</p>
                                </div>
                            </div>
                            <div class="mt-4 flex items-center text-xs">
                                <span class="text-gray-medium">暂无数据</span>
                            </div>
                        </div>
                        
                        <!-- 结算金额 -->
                        <div class="stat-card">
                            <div class="flex justify-between items-start">
                                <div class="stat-icon bg-success">
                                    <i class="fa fa-cny"></i>
                                </div>
                                <div class="text-right">
                                    <p class="stat-value">¥0</p>
                                    <p class="stat-label">结算金额</p>
                                </div>
                            </div>
                            <div class="mt-4 flex items-center text-xs">
                                <span class="text-gray-medium">暂无数据</span>
                            </div>
                        </div>
                        
                        <!-- 已付款金额 -->
                        <div class="stat-card">
                            <div class="flex justify-between items-start">
                                <div class="stat-icon bg-success">
                                    <i class="fa fa-money"></i>
                                </div>
                                <div class="text-right">
                                    <p class="stat-value">¥0</p>
                                    <p class="stat-label">已付款金额</p>
                                </div>
                            </div>
                            <div class="mt-4 flex items-center text-xs">
                                <span class="text-gray-medium">暂无数据</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 子导航 -->
                    <div class="flex mb-6 border-b">
                        <button class="nav-subitem active px-4 py-2 text-primary border-b-2 border-primary" data-submodule="payments">
                            电镀付款
                        </button>
                        <button class="nav-subitem px-4 py-2 text-gray-medium hover:text-primary" data-submodule="bills">
                            账单管理
                        </button>
                        <button class="nav-subitem px-4 py-2 text-gray-medium hover:text-primary" data-submodule="reconciliation">
                            对账差异
                        </button>
                    </div>
                    
                    <!-- 账单管理子模块 -->
                    <div id="bills-submodule" class="submodule-content">
                        <div class="card mb-6">
                            <div>
                                <div class="flex justify-between items-center mb-4">
                                        <h3 class="font-bold text-dark">账单管理</h3>
                                        <div class="flex gap-2">
                                            <button id="batch-payment-btn" class="btn btn-primary text-sm py-1 px-3">
                                                <i class="fa fa-money"></i>
                                                批量付款
                                            </button>
                                            <button id="sync-orders-btn" class="btn btn-primary text-sm py-1 px-3">
                                                <i class="fa fa-sync"></i>
                                                同步
                                            </button>
                                            <script>
                                            document.getElementById('sync-orders-btn').addEventListener('click', function() {
                                                try {
                                                    // 尝试直接调用syncCompletedOrdersToBills函数
                                                    let syncedCount = 0;
                                                    
                                                    // 从localStorage获取数据
                                                    const orders = JSON.parse(localStorage.getItem(window.storagePrefix + "orders")) || [];
                                                    const deliveries = JSON.parse(localStorage.getItem(window.storagePrefix + "deliveries")) || [];
                                                    const receipts = JSON.parse(localStorage.getItem(window.storagePrefix + "receipts")) || [];
                                                    let bills = JSON.parse(localStorage.getItem(window.storagePrefix + "bills")) || [];
                                                    
                                                    // 对发货记录中的毛坯数量按订单编号进行汇总
                                                    const rawQuantitySummary = {};
                                                    deliveries.forEach(delivery => {
                                                        const orderNumber = delivery.orderNumber || '';
                                                        const rawQty = parseInt(delivery.rawQuantity || 0);
                                                        if (orderNumber && !isNaN(rawQty)) {
                                                            if (!rawQuantitySummary[orderNumber]) rawQuantitySummary[orderNumber] = 0;
                                                            rawQuantitySummary[orderNumber] += rawQty;
                                                        }
                                                    });
                                                    
                                                    // 对收货记录中的成品数量按订单编号进行汇总
                                                    const finishedQuantitySummary = {};
                                                    receipts.forEach(receipt => {
                                                        const orderNumber = receipt.orderNumber || '';
                                                        const finishedQty = parseInt(receipt.finishedQuantity || 0);
                                                        if (orderNumber && !isNaN(finishedQty)) {
                                                            if (!finishedQuantitySummary[orderNumber]) finishedQuantitySummary[orderNumber] = 0;
                                                            finishedQuantitySummary[orderNumber] += finishedQty;
                                                        }
                                                    });
                                                    
                                                    // 筛选已完成订单并添加到账单
                                                    orders.forEach(order => {
                                                        const orderNumber = order.orderNumber || order.orderId || '';
                                                        const totalRawQuantity = rawQuantitySummary[orderNumber] || 0;
                                                        const goodProductQuantity = finishedQuantitySummary[orderNumber] || 0;
                                                        const orderQuantity = parseInt(order.quantity || 0);
                                                        
                                                        // 计算订单状态
                                                        let status = '';
                                                        if (totalRawQuantity === 0) {
                                                            status = '待电镀';
                                                        } else if (goodProductQuantity < orderQuantity) {
                                                            status = '电镀中';
                                                        } else {
                                                            status = '已完成';
                                                        }
                                                        
                                                        // 只处理已完成订单且未同步过的
                                                        if (status === '已完成') {
                                                            const existingBill = bills.find(bill => bill.orderNumber === orderNumber);
                                                            if (!existingBill) {
                                                                // 创建新账单
                                                                const newBill = {
                                                                    id: 'BILL-' + Date.now() + '-' + Math.floor(Math.random() * 1000),
                                                                    electroplatingFactory: order.electroplatingFactory || '',
                                                                    orderNumber: orderNumber,
                                                                    customer: order.customer || '',
                                                                    product: order.product || '',
                                                                    settlementQuantity: goodProductQuantity > orderQuantity ? orderQuantity : goodProductQuantity,
                                                                    unitPrice: order.unitPrice || 0,
                                                                    deduction: 0,
                                                                    amount: (goodProductQuantity > orderQuantity ? orderQuantity : goodProductQuantity) * (order.unitPrice || 0),
                                                                    orderStatus: status,
                                                                    billStatus: 'unpaid',
                                                                    invoiceDate: '',
                                                                    invoiceNumber: '',
                                                                    remark: order.remark || '',
                                                                    createDate: new Date().toISOString().split('T')[0]
                                                                };
                                                                bills.push(newBill);
                                                                syncedCount++;
                                                            }
                                                        }
                                                    });
                                                    
                                                    // 保存数据
                                                    localStorage.setItem(window.storagePrefix + "bills", JSON.stringify(bills));
                                                    
                                                    // 刷新表格
                                                    if (typeof loadBillsTable === 'function') {
                                                        loadBillsTable();
                                                    }
                                                    
                                                    alert(`已成功同步 ${syncedCount} 个已完成订单到账单管理！`);
                                                } catch (error) {
                                                    alert('同步过程中出现错误: ' + error.message);
                                                    console.error('同步错误:', error);
                                                }
                                            });
                                            </script>
                                        </div>
                                    </div>

                                    <div class="flex gap-3 mb-6">
                                    <div class="relative">
                                        <input id="bill-search-input" type="text" placeholder="搜索账单/发票..." class="input-field pl-10 py-2 h-10 w-64 text-center">
                                        <i class="fa fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-medium"></i>
                                    </div>
                                    <script>
                                        // 账单管理搜索功能 - 模糊查找表格中的所有信息
                                        document.addEventListener('DOMContentLoaded', function() {
                                            const searchInput = document.getElementById('bill-search-input');
                                            if (searchInput) {
                                                searchInput.addEventListener('input', function(e) {
                                                    const searchTerm = e.target.value.toLowerCase().trim();
                                                    const billRows = document.querySelectorAll('#bills-submodule tbody tr');
                                                    
                                                    billRows.forEach(row => {
                                                        // 跳过"暂无数据"的行
                                                        if (row.querySelector('td[colspan]')) {
                                                            return;
                                                        }
                                                        
                                                        // 获取行中所有单元格的文本内容
                                                        const cells = row.querySelectorAll('td:not(:first-child):not(:last-child)'); // 排除复选框和操作列
                                                        let found = false;
                                                        
                                                        // 遍历所有单元格，检查是否包含搜索词
                                                        cells.forEach(cell => {
                                                            const cellText = cell.textContent.toLowerCase().trim();
                                                            if (cellText.includes(searchTerm)) {
                                                                found = true;
                                                            }
                                                        });
                                                        
                                                        // 根据搜索结果显示或隐藏行
                                                        row.style.display = found ? '' : 'none';
                                                    });
                                                });
                                            }
                                        });
                                    </script>
                                    <select id="bill-status-filter" class="input-field py-2 px-2 text-sm w-24 h-10">
                                        <option value="all">全部状态</option>
                                        <option value="unpaid">待支付</option>
                                        <option value="paid">已支付</option>
                                        <option value="overdue">逾期</option>
                                    </select>
                                    <script>
                                        // 账单状态筛选功能
                                        document.addEventListener('DOMContentLoaded', function() {
                                            const statusFilter = document.getElementById('bill-status-filter');
                                            if (statusFilter) {
                                                statusFilter.addEventListener('change', function() {
                                                    const selectedStatus = this.value;
                                                    const billRows = document.querySelectorAll('#bills-submodule tbody tr');
                                                    
                                                    billRows.forEach(row => {
                                                        // 跳过"暂无数据"的行
                                                        if (row.querySelector('td[colspan]')) {
                                                            return;
                                                        }
                                                        
                                                        // 获取账单状态列的文本
                                                        const statusCell = row.querySelector('td:nth-child(11)'); // 第11列是账单状态
                                                        if (statusCell) {
                                                            const statusText = statusCell.textContent.trim().toLowerCase();
                                                            
                                                            // 根据选择的状态筛选
                                                            if (selectedStatus === 'all' || 
                                                                (selectedStatus === 'unpaid' && statusText.includes('待支付')) ||
                                                                (selectedStatus === 'paid' && statusText.includes('已支付')) ||
                                                                (selectedStatus === 'overdue' && statusText.includes('逾期'))) {
                                                                row.style.display = '';
                                                            } else {
                                                                row.style.display = 'none';
                                                            }
                                                        }
                                                    });
                                                });
                                            }
                                        });
                                    </script>
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead>
                                        <tr>
                                            <th class="table-header">
                                                <input type="checkbox" id="select-all-bills" class="rounded border-gray-300 text-primary focus:ring-primary">
                                            </th>
                                            <th class="table-header">电镀厂</th>
                                            <th class="table-header">订单号</th>
                                            <th class="table-header">客户名称</th>
                                            <th class="table-header">产品</th>
                                            <th class="table-header">结算数量</th>
                                            <th class="table-header">单价</th>
                                            <th class="table-header">扣款</th>
                                            <th class="table-header">金额</th>
                                            <th class="table-header">订单状态</th>
                                            <th class="table-header">账单状态</th>
                                            <th class="table-header">开票日期</th>
                                            <th class="table-header">发票号</th>
                                            <th class="table-header">备注</th>
                                            <th class="table-header">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        <tr>
                                            <td colspan="15" class="table-cell text-center py-8 text-gray-medium">
                                                暂无账单数据
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            

                        </div>
                    </div>
                    
                    <!-- 电镀付款子模块 -->
                    <div id="payments-submodule" class="submodule-content hidden">
                        <div class="card mb-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="font-bold text-dark">电镀付款管理</h3>
                                <div class="flex gap-3">
                                    <button id="export-payments-btn" class="btn btn-primary text-sm py-1 px-3">
                                        <i class="fa fa-download"></i>
                                        导出Excel
                                    </button>
                                    <button id="import-payments-btn" class="btn btn-secondary text-sm py-1 px-3">
                                        <i class="fa fa-upload"></i>
                                        导入Excel
                                    </button>
                                    <input type="file" id="payments-file-input" accept=".csv,.xlsx,.xls" style="display: none;" />
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead>
                                        <tr>
                                            <th class="table-header">电镀厂</th>
                                            <th class="table-header">发票号</th>
                                            <th class="table-header">应付金额</th>
                                            <th class="table-header">付款金额</th>
                                            <th class="table-header">创建日期</th>
                                            <th class="table-header">实际付款日期</th>
                                            <th class="table-header">状态</th>
                                            <th class="table-header">备注</th>
                                            <th class="table-header">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        <tr>
                                            <td colspan="10" class="table-cell text-center py-8 text-gray-medium">
                                                暂无电镀付款数据
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            

                        </div>
                    </div>
                    
                    <!-- 对账差异子模块 -->
                    <div id="reconciliation-submodule" class="submodule-content hidden">
                        <div class="card">
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                                <h3 class="font-bold text-dark">对账差异</h3>
                                <div class="flex flex-wrap gap-3 w-full md:w-auto">
                                    <div class="flex gap-2 items-center">
                                        <label for="reconcile-type" class="text-sm font-medium">对账类型:</label>
                                        <select id="reconcile-type" class="input-field py-1 px-2 text-sm">
                                            <option value="all">全部类型</option>
                                            <option value="customer">客户收款对账</option>
                                            <option value="factory">电镀厂付款对账</option>
                                        </select>
                                    </div>
                                    <div class="flex gap-2 items-center">
                                        <label for="reconcile-period" class="text-sm font-medium">对账周期:</label>
                                        <select id="reconcile-period" class="input-field py-1 px-2 text-sm">
                                            <option value="month">本月</option>
                                            <option value="quarter">本季度</option>
                                            <option value="year">本年</option>
                                            <option value="custom">自定义</option>
                                        </select>
                                    </div>
                                    <div class="flex gap-2 items-center" id="custom-date-range" style="display: none;">
                                        <input type="date" id="start-date" class="input-field py-1 px-2 text-sm">
                                        <span class="text-sm">至</span>
                                        <input type="date" id="end-date" class="input-field py-1 px-2 text-sm">
                                    </div>
                                    <button class="btn btn-primary text-sm py-1" id="reconcile-btn">
                                        <i class="fa fa-refresh"></i>
                                        开始对账
                                    </button>
                                    <button class="btn btn-secondary text-sm py-1" id="export-reconcile-btn">
                                        <i class="fa fa-download"></i>
                                        导出差异
                                    </button>
                                </div>
                            </div>
                            
                            <!-- 对账结果统计 -->
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 p-4 bg-gray-light rounded-lg">
                                <div class="text-center">
                                    <p class="text-sm text-gray-medium">对账交易总数</p>
                                    <p class="text-lg font-bold text-dark" id="total-reconciled">0</p>
                                </div>
                                <div class="text-center">
                                    <p class="text-sm text-gray-medium">差异记录数</p>
                                    <p class="text-lg font-bold text-danger" id="diff-records">0</p>
                                </div>
                                <div class="text-center">
                                    <p class="text-sm text-gray-medium">总差异金额</p>
                                    <p class="text-lg font-bold text-warning" id="total-diff-amount">¥0.00</p>
                                </div>
                                <div class="text-center">
                                    <p class="text-sm text-gray-medium">差异处理率</p>
                                    <p class="text-lg font-bold text-success" id="diff-handle-rate">0%</p>
                                </div>
                            </div>
                            
                            <!-- 筛选区域 -->
                            <div class="flex flex-wrap gap-3 mb-4">
                                <select id="diff-status-filter" class="input-field py-1 px-2 text-sm">
                                    <option value="all">全部状态</option>
                                    <option value="unhandled">未处理</option>
                                    <option value="handled">已处理</option>
                                    <option value="partially-handled">部分处理</option>
                                </select>
                                <select id="diff-type-filter" class="input-field py-1 px-2 text-sm">
                                    <option value="all">全部类型</option>
                                    <option value="overpayment">多付(收款)/少收(付款)</option>
                                    <option value="underpayment">少付(收款)/多收(付款)</option>
                                    <option value="no-payment">未付款/未收款</option>
                                </select>
                                <select id="diff-party-filter" class="input-field py-1 px-2 text-sm">
                                    <option value="all">全部关联方</option>
                                </select>
                                <button class="btn btn-secondary text-sm py-1" id="filter-reconcile-btn">
                                    <i class="fa fa-filter"></i>
                                    筛选
                                </button>
                                <button class="btn btn-secondary text-sm py-1" id="reset-filter-btn">
                                    <i class="fa fa-undo"></i>
                                    重置
                                </button>
                            </div>
                            
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead>
                                        <tr>
                                            <th class="table-header w-12">
                                                <label class="flex items-center gap-2 cursor-pointer justify-center">
                                                    <input type="checkbox" id="select-all-diff">
                                                </label>
                                            <th class="table-header">类型</th>
                                            <th class="table-header">订单编号</th>
                                            <th class="table-header">关联方</th>
                                            <th class="table-header">账单编号/发票号</th>
                                            <th class="table-header">系统金额</th>
                                            <th class="table-header">实际金额</th>
                                            <th class="table-header">差异金额</th>
                                            <th class="table-header">差异类型</th>
                                            <th class="table-header">创建日期</th>
                                            <th class="table-header">最后交易日期</th>
                                            <th class="table-header">原因分析</th>
                                            <th class="table-header">处理状态</th>
                                            <th class="table-header">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200" id="reconcile-table-body">
                                        <tr>
                                            <td colspan="14" class="table-cell text-center py-8 text-gray-medium">
                                                暂无对账数据，请点击"开始对账"按钮
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- 批量操作 -->
                            <div class="flex justify-between items-center mt-6" id="batch-actions" style="display: none;">
                                <div class="text-sm text-gray-medium">
                                    已选择 <span id="selected-count">0</span> 条记录
                                </div>
                                <div class="flex gap-2">
                                    <button class="btn btn-secondary text-sm py-1" id="batch-handle-btn">
                                        <i class="fa fa-check-circle"></i>
                                        批量标记已处理
                                    </button>
                                    <button class="btn btn-danger text-sm py-1" id="batch-export-btn">
                                        <i class="fa fa-file-text-o"></i>
                                        导出选中
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- 模态框 - 新建计划 -->
    <div id="create-order-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-dark">新建计划</h3>
                    <button class="close-modal text-gray-medium hover:text-dark">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <form id="create-order-form">
                    <div class="space-y-6 mb-6">
                        <!-- 第一行：客户和订单编号 -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="relative">
                                <label class="block text-sm font-medium text-gray-medium mb-1">客户 <span class="text-danger">*</span></label>
                                <input type="text" id="order-customer-input" class="input-field" placeholder="请输入国家/客户或从下拉列表选择" required autocomplete="off">
                                <div id="customer-dropdown" class="absolute left-0 right-0 mt-1 bg-white border border-gray-300 rounded-md shadow-lg z-10 hidden max-h-60 overflow-y-auto">
                                    <div class="py-1">
                                        <div class="px-4 py-2 hover:bg-gray-100 cursor-pointer">德国KBA</div>
                                        <div class="px-4 py-2 hover:bg-gray-100 cursor-pointer">德国EPCCS</div>
                                        <div class="px-4 py-2 hover:bg-gray-100 cursor-pointer">美国PERM</div>
                                        <div class="px-4 py-2 hover:bg-gray-100 cursor-pointer">西班牙INGHOR</div>
                                        <div class="px-4 py-2 hover:bg-gray-100 cursor-pointer">葡萄牙COLEPKK</div>
                                        <div class="px-4 py-2 hover:bg-gray-100 cursor-pointer">丹麦CC</div>
                                        <div class="px-4 py-2 hover:bg-gray-100 cursor-pointer">泰国SWAN</div>
                                        <div class="px-4 py-2 hover:bg-gray-100 cursor-pointer">泰国APK</div>
                                        <div class="px-4 py-2 hover:bg-gray-100 cursor-pointer">泰国CROWN</div>
                                        <div class="px-4 py-2 hover:bg-gray-100 cursor-pointer">泰国STANDARD</div>
                                        <div class="px-4 py-2 hover:bg-gray-100 cursor-pointer">台湾泰元</div>
                                        <div class="px-4 py-2 hover:bg-gray-100 cursor-pointer">马来西亚KJCF</div>
                                    </div>
                                </div>
                            </div>
                            <div class="relative">
                                <label class="block text-sm font-medium text-gray-medium mb-1">订单编号 <span class="text-danger">*</span></label>
                                <input type="text" id="order-number-input" class="input-field" placeholder="请输入订单编号" required>
                                <div id="order-number-dropdown" class="absolute left-0 right-0 mt-1 bg-white border border-gray-300 rounded-md shadow-lg z-10 hidden max-h-60 overflow-y-auto">
                                    <!-- 订单编号选项将通过JavaScript动态填充 -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- 第二行：产品、数量、加工单价 -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-medium mb-1">产品 <span class="text-danger">*</span></label>
                                <select id="product-select" class="input-field" required>
                                    <option value="">请选择产品</option>
                                    <option value="槽钢炉架">槽钢炉架</option>
                                    <option value="槽钢带轴炉架">槽钢带轴炉架</option>
                                    <option value="扁铁炉架">扁铁炉架</option>
                                    <option value="扁铁带轴炉架">扁铁带轴炉架</option>
                                    <option value="管子炉架">管子炉架</option>
                                    <option value="特殊炉架">特殊炉架</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-medium mb-1">数量 <span class="text-danger">*</span></label>
                                <input type="number" class="input-field" placeholder="请输入数量" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-medium mb-1">加工单价</label>
                                <input type="number" step="0.01" class="input-field" placeholder="请输入加工单价">
                            </div>
                        </div>
                        
                        <!-- 第三行：交货期和电镀厂 -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-medium mb-1">交货期 <span class="text-danger">*</span></label>
                                <input type="date" class="input-field" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-medium mb-1">电镀厂 <span class="text-danger">*</span></label>
                                <select id="electroplating-factory-select" class="input-field" required>
                                    <option value="">请选择电镀厂</option>
                                    <option value="宣城沃新" selected>宣城沃新</option>
                                    <option value="丹阳裕丰">丹阳裕丰</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-medium mb-1">备注</label>
                        <textarea class="input-field" rows="3" placeholder="请输入备注信息"></textarea>
                    </div>
                    <div class="flex justify-end gap-3">
                        <button type="button" class="btn btn-secondary close-modal">
                            取消
                        </button>
                        <button type="submit" class="btn btn-primary">
                            保存
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- 模态框 - 新建电镀付款 -->
    <div id="create-payment-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-3xl max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h3 id="create-payment-modal-title" class="text-xl font-bold text-dark">新建电镀付款</h3>
                    <button class="close-modal text-gray-medium hover:text-dark">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <form id="create-payment-form">
                    <!-- 隐藏的付款ID字段 -->
                    <input type="hidden" id="payment-id-input" value="">
                    
                    <!-- 选中的发票信息区域（批量付款时使用） -->
                    <div id="selected-invoices-section" class="mb-6 border border-gray-200 rounded-lg p-4 bg-light hidden">
                        <h4 class="text-sm font-medium text-dark mb-3">已选择的发票</h4>
                        <div id="selected-invoices-container" class="mb-3 max-h-40 overflow-y-auto">
                            <p class="text-gray-medium text-sm">未选择任何发票</p>
                        </div>
                        <div class="flex justify-between items-center">
                            <div>
                                <span class="text-sm text-gray-medium">总计:</span>
                                <span id="total-amount" class="text-lg font-bold text-primary ml-2">¥0.00</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 基本付款信息，按照表格表头重新设计 -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-medium mb-1">电镀厂 <span class="text-danger">*</span></label>
                            <input type="text" id="payment-factory" class="input-field bg-gray-100" readonly required placeholder="自动填充电镀厂">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-medium mb-1">发票号</label>
                            <input type="text" id="payment-invoice-number" class="input-field" placeholder="请输入发票号">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-medium mb-1">应付金额 <span class="text-danger">*</span></label>
                            <input type="number" id="payment-amount" class="input-field bg-gray-100" step="0.01" min="0" placeholder="应付金额" required readonly>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-medium mb-1">付款金额 <span class="text-danger">*</span></label>
                            <input type="number" id="payment-paid-amount" class="input-field" step="0.01" min="0" placeholder="请输入付款金额" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-medium mb-1">创建日期</label>
                            <input type="text" id="payment-create-date" class="input-field bg-gray-100" readonly>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-medium mb-1">实际付款日期 <span class="text-danger">*</span></label>
                            <input type="date" id="payment-date" class="input-field" required value="">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-medium mb-1">付款方式 <span class="text-danger">*</span></label>
                            <select id="payment-method" class="input-field" required>
                                <option value="">请选择付款方式</option>
                                <option value="bank">银行转账</option>
                                <option value="alipay">支付宝</option>
                                <option value="wechat">微信支付</option>
                                <option value="other">其他</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-medium mb-1">付款状态 <span class="text-danger">*</span></label>
                            <select id="payment-status" class="input-field" required>
                                <option value="pending">待处理</option>
                                <option value="completed" selected>已完成</option>
                                <option value="failed">失败</option>
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-medium mb-1">备注</label>
                            <textarea id="payment-remark" class="input-field" rows="3" placeholder="请输入备注信息"></textarea>
                        </div>
                    </div>
                    <div class="flex justify-end gap-3">
                        <button type="button" class="btn btn-secondary close-modal">
                            取消
                        </button>
                        <button type="submit" class="btn btn-primary">
                            保存
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- 模态框 - 新建发货单 -->
    <div id="create-delivery-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-dark">新建发货单</h3>
                    <button class="close-modal text-gray-medium hover:text-dark">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <form id="create-delivery-form">
                    <!-- 第一行：订单信息 -->
                    <div class="mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-medium mb-1">订单编号 <span class="text-danger">*</span></label>
                                <select id="delivery-order-number-select" class="input-field w-full" required>
                                    <option value="" disabled selected>请选择订单编号</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-medium mb-1">客户 <span class="text-danger">*</span></label>
                                <input type="text" id="delivery-customer-input" class="input-field w-full" list="customer-options" value="德国KBA" required>
                                <datalist id="customer-options">
                                    <option value="德国KBA">
                                    <option value="德国EPCCS">
                                    <option value="美国PERM">
                                    <option value="西班牙INGHOR">
                                    <option value="葡萄牙COLEPKK">
                                    <option value="丹麦CC">
                                    <option value="泰国SWAN">
                                    <option value="泰国APK">
                                    <option value="泰国CROWN">
                                    <option value="泰国STANDARD">
                                    <option value="台湾泰元">
                                    <option value="马来西亚KJCF">
                                </datalist>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-medium mb-1">产品 <span class="text-danger">*</span></label>
                                <input type="text" id="delivery-product-input" class="input-field w-full" placeholder="请输入产品名称" required>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 第二行：数量信息 -->
                    <div class="mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-medium mb-1">毛坯数量 <span class="text-danger">*</span></label>
                                <input type="number" class="input-field w-full" placeholder="请输入毛坯数量" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-medium mb-1">返镀数量 <span class="text-danger">*</span></label>
                                <input type="number" class="input-field w-full" placeholder="请输入返镀数量" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-medium mb-1">报废数量 <span class="text-danger">*</span></label>
                                <input type="number" class="input-field w-full" placeholder="请输入报废数量" required>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 第三行：其他信息（两列布局） -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-medium mb-1">发货件数 <span class="text-danger">*</span></label>
                            <input type="number" class="input-field w-full" placeholder="请输入发货件数" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-medium mb-1">电镀厂 <span class="text-danger">*</span></label>
                            <select id="delivery-factory-input" class="input-field w-full" placeholder="请输入电镀厂名称" required autocomplete="off">
                                <option value="">请选择电镀厂</option>
                                <option value="宣城沃新" selected>宣城沃新</option>
                                <option value="丹阳裕丰">丹阳裕丰</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-medium mb-1">发货日期 <span class="text-danger">*</span></label>
                            <input type="date" class="input-field w-full" id="delivery-date" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-medium mb-1">要求送回日期 <span class="text-danger">*</span></label>
                            <input type="date" class="input-field w-full" required>
                        </div>
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-medium mb-1">备注</label>
                        <textarea class="input-field" rows="3" placeholder="请输入备注信息"></textarea>
                    </div>
                    <div class="flex justify-end gap-3">
                        <button type="button" class="btn btn-secondary close-modal">
                            取消
                        </button>
                        <button type="submit" class="btn btn-primary">
                            保存
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- 模态框 - 新建收货单 -->
    <div id="create-receipt-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-dark">新建收货单</h3>
                    <button class="close-modal text-gray-medium hover:text-dark">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <form id="create-receipt-form">
                    <!-- 第一行：订单信息 -->
                    <div class="mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-medium mb-1">订单编号 <span class="text-danger">*</span></label>
                                <select class="input-field w-full" required>
                                    <option value="">请选择订单</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-medium mb-1">客户 <span class="text-danger">*</span></label>
                                <input type="text" class="input-field w-full" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-medium mb-1">产品 <span class="text-danger">*</span></label>
                                <input type="text" class="input-field w-full" required>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 第二行：数量信息 -->
                    <div class="mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-medium mb-1">成品数量 <span class="text-danger">*</span></label>
                                <input type="number" class="input-field w-full" placeholder="请输入成品数量" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-medium mb-1">返修数量</label>
                                <input type="number" class="input-field w-full" placeholder="请输入返修数量">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-medium mb-1">报废数量</label>
                                <input type="number" class="input-field w-full" placeholder="请输入报废数量">
                            </div>
                        </div>
                    </div>
                    
                    <!-- 第三行：其他信息 -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-medium mb-1">件数 <span class="text-danger">*</span></label>
                            <input type="number" class="input-field w-full" placeholder="请输入件数" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-medium mb-1">电镀厂 <span class="text-danger">*</span></label>
                            <select class="input-field w-full" required>
                                <option value="">请选择电镀厂</option>
                                <option value="宣城沃新" selected>宣城沃新</option>
                                <option value="丹阳裕丰">丹阳裕丰</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-medium mb-1">收货日期 <span class="text-danger">*</span></label>
                            <input type="date" class="input-field w-full" required>
                        </div>
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-medium mb-1">备注</label>
                        <textarea class="input-field" rows="3" placeholder="请输入备注信息"></textarea>
                    </div>
                    <div class="flex justify-end gap-3">
                        <button type="button" class="btn btn-secondary close-modal">
                            取消
                        </button>
                        <button type="submit" class="btn btn-primary">
                            保存
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- 模态框 - 新建账单 -->
    <div id="create-invoice-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-dark">新建账单</h3>
                    <button class="close-modal text-gray-medium hover:text-dark">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <form id="create-invoice-form">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-medium mb-1">电镀厂 <span class="text-danger">*</span></label>
                            <select class="input-field" required>
                                <option value="">请选择电镀厂</option>
                                <option value="宣城沃新" selected>宣城沃新</option>
                                <option value="丹阳裕丰">丹阳裕丰</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-medium mb-1">创建日期 <span class="text-danger">*</span></label>
                            <input type="date" class="input-field" required id="invoice-create-date">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-medium mb-1">Due日期 <span class="text-danger">*</span></label>
                            <input type="date" class="input-field" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-medium mb-1">账单状态 <span class="text-danger">*</span></label>
                            <select class="input-field" required>
                                <option value="unpaid">待支付</option>
                                <option value="paid">已支付</option>
                                <option value="overdue">逾期</option>
                            </select>
                        </div>
                        <!-- 新增发票相关字段 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-medium mb-1">发票号</label>
                            <input type="text" class="input-field" placeholder="请输入发票号">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-medium mb-1">发票日期</label>
                            <input type="date" class="input-field">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-medium mb-1">发票类型</label>
                            <select class="input-field">
                                <option value="">请选择发票类型</option>
                                <option value="normal">增值税普通发票</option>
                                <option value="special">增值税专用发票</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-medium mb-1">税率(%)</label>
                            <input type="number" class="input-field" min="0" max="100" step="0.01" placeholder="请输入税率">
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-medium mb-1">选择订单 <span class="text-danger">*</span></label>
                        <div class="border rounded-lg p-4 max-h-60 overflow-y-auto">
                            <div class="text-center py-4 text-gray-medium">
                                暂无可选订单
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <div class="bg-light rounded-lg p-4">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm text-gray-medium">订单数量:</span>
                                <span class="text-sm font-medium text-dark">0</span>
                            </div>
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm text-gray-medium">总金额:</span>
                                <span class="text-sm font-medium text-dark">¥0.00</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-medium">优惠金额:</span>
                                <input type="number" class="w-20 input-field py-1 text-sm" placeholder="0.00">
                            </div>
                            <div class="border-t mt-2 pt-2 flex justify-between items-center">
                                <span class="text-sm font-medium text-dark">应付金额:</span>
                                <span class="text-lg font-bold text-primary">¥0.00</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-medium mb-1">备注</label>
                        <textarea class="input-field" rows="3" placeholder="请输入备注信息"></textarea>
                    </div>
                    
                    <div class="flex justify-end gap-3">
                        <button type="button" class="btn btn-secondary close-modal">
                            取消
                        </button>
                        <button type="submit" class="btn btn-primary">
                            保存
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- 模态框 - 订单详情 -->
    <div id="order-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-dark">订单详情</h3>
                    <button class="close-modal text-gray-medium hover:text-dark">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <p class="text-sm text-gray-medium">订单编号</p>
                        <p class="font-medium text-dark">ORD-2025-001</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-medium">客户</p>
                        <p class="font-medium text-dark">上海电子科技有限公司</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-medium">电镀类型</p>
                        <p class="font-medium text-dark">镀金</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-medium">产品</p>
                        <p class="font-medium text-dark">500件</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-medium">数量</p>
                        <p class="font-medium text-dark">¥25.00</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-medium">金额</p>
                        <p class="font-medium text-dark">¥12,500.00</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-medium">创建时间</p>
                        <p class="font-medium text-dark">2025-01-05 10:30:00</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-medium">交货期</p>
                        <p class="font-medium text-dark">2025-01-10 18:00:00</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-medium">实际完成时间</p>
                        <p class="font-medium text-dark">2025-01-10 16:45:00</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-medium">电镀厂</p>
                        <p class="font-medium text-dark">宣城沃新</p>
                    </div>
                </div>
                
                <div class="mb-6">
                    <p class="text-sm text-gray-medium mb-1">备注</p>
                    <p class="font-medium text-dark">客户要求加急处理，产品需要符合RoHS标准。</p>
                </div>
                
                <div class="border-t pt-6">
                    <h4 class="font-bold text-dark mb-4">订单进度</h4>
                    <div class="relative">
                        <div class="absolute left-4 top-0 h-full w-0.5 bg-gray-200"></div>
                        <div class="space-y-6 relative">
                            <div class="flex">
                                <div class="flex-shrink-0 w-8 h-8 rounded-full bg-success text-white flex items-center justify-center z-10">
                                    <i class="fa fa-check"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-dark">订单创建</p>
                                    <p class="text-xs text-gray-medium">2025-01-05 10:30:00</p>
                                    <p class="text-sm text-gray-medium mt-1">订单已创建并分配给生产部门</p>
                                </div>
                            </div>
                            <div class="flex">
                                <div class="flex-shrink-0 w-8 h-8 rounded-full bg-success text-white flex items-center justify-center z-10">
                                    <i class="fa fa-check"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-dark">生产开始</p>
                                    <p class="text-xs text-gray-medium">2025-01-06 08:15:00</p>
                                    <p class="text-sm text-gray-medium mt-1">生产部门已开始加工</p>
                                </div>
                            </div>
                            <div class="flex">
                                <div class="flex-shrink-0 w-8 h-8 rounded-full bg-success text-white flex items-center justify-center z-10">
                                    <i class="fa fa-check"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-dark">生产完成</p>
                                    <p class="text-xs text-gray-medium">2025-01-10 16:45:00</p>
                                    <p class="text-sm text-gray-medium mt-1">产品加工完成并通过质检</p>
                                </div>
                            </div>
                            <div class="flex">
                                <div class="flex-shrink-0 w-8 h-8 rounded-full bg-success text-white flex items-center justify-center z-10">
                                    <i class="fa fa-check"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-dark">已发货</p>
                                    <p class="text-xs text-gray-medium">2025-01-10 18:30:00</p>
                                    <p class="text-sm text-gray-medium mt-1">产品已发货，物流单号：SF1234567890</p>
                                </div>
                            </div>
                            <div class="flex">
                                <div class="flex-shrink-0 w-8 h-8 rounded-full bg-success text-white flex items-center justify-center z-10">
                                    <i class="fa fa-check"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-dark">已送达</p>
                                    <p class="text-xs text-gray-medium">2025-01-12 14:20:00</p>
                                    <p class="text-sm text-gray-medium mt-1">客户已签收</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end gap-3 mt-6">
                    <button class="btn btn-secondary close-modal">
                        关闭
                    </button>
                    <button class="btn btn-primary">
                        <i class="fa fa-print"></i>
                        打印订单
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // 获取当前日期
        document.addEventListener('DOMContentLoaded', function() {
            const currentDateEl = document.getElementById('current-date');
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
            currentDateEl.textContent = now.toLocaleDateString('zh-CN', options);
            
            // 初始化图表
            try {
                initCharts();
            } catch (e) {
                console.log('图表初始化失败:', e);
            }
            
            // 初始化收货单列表
            updateReceiptList();
            
            // 初始化结算对账模块子导航切换
            initReconciliationSubmodules();
            
            // 定义结算对账模块子导航初始化函数
            function initReconciliationSubmodules() {
                // 子模块切换事件绑定 - 使用data-submodule属性选择器
                const billsTab = document.querySelector('.nav-subitem[data-submodule="bills"]');
                const paymentsTab = document.querySelector('.nav-subitem[data-submodule="payments"]');
                const reconciliationTab = document.querySelector('.nav-subitem[data-submodule="reconciliation"]');
                
                if (billsTab) {
                    billsTab.addEventListener('click', function() {
                        switchSubmodule('bills');
                    });
                }
                
                // 默认显示电镀付款子模块
                switchSubmodule('payments');
                
                if (paymentsTab) {
                    paymentsTab.addEventListener('click', function() {
                        switchSubmodule('payments');
                    });
                }
                
                if (reconciliationTab) {
                    reconciliationTab.addEventListener('click', function() {
                        switchSubmodule('reconciliation');
                    });
                }
                
                // 全局变量，用于存储当前选中的发票
                let selectedBills = [];
                
                // 批量付款按钮事件
                const batchPaymentBtn = document.getElementById('batch-payment-btn');
                if (batchPaymentBtn) {
                    batchPaymentBtn.addEventListener('click', function() {
                        // 获取选中的账单
                        const checkedCheckboxes = document.querySelectorAll('.bill-checkbox:checked');
                        if (checkedCheckboxes.length === 0) {
                            alert('请至少选择一个发票进行付款');
                            return;
                        }
                        
                        // 收集选中的发票信息
                        const bills = JSON.parse(localStorage.getItem(window.storagePrefix + "bills")) || [];
                        selectedBills = [];
                        
                        checkedCheckboxes.forEach(checkbox => {
                            const index = parseInt(checkbox.getAttribute('data-index'));
                            if (bills[index] && bills[index].billStatus !== 'paid') {
                                selectedBills.push(bills[index]);
                            }
                        });
                        
                        if (selectedBills.length === 0) {
                            alert('请选择未付款的发票');
                            return;
                        }
                        
                        // 显示新建电镀付款模态框并更新发票信息
                        showPaymentModal();
                    });
                }
                

                
                
                
                // 显示付款模态框并更新发票信息
                function showPaymentModal() {
                    const paymentModal = document.getElementById('create-payment-modal');
                    const selectedInvoicesSection = document.getElementById('selected-invoices-section');
                    const modalTitle = document.getElementById('create-payment-modal-title');
                    
                    if (paymentModal) {
                        // 设置默认日期为今天
                        const today = new Date().toISOString().split('T')[0];
                        const formattedToday = new Date().toLocaleDateString('zh-CN');
                        document.getElementById('payment-date').value = today;
                        
                        // 设置创建日期为今日（格式化显示）
                        const createDateInput = document.getElementById('payment-create-date');
                        if (createDateInput) {
                            createDateInput.value = formattedToday;
                        }
                        
                        // 根据是否有选中的发票决定是否显示发票选择区域
                        if (selectedBills.length > 0) {
                            if (selectedInvoicesSection) {
                                selectedInvoicesSection.classList.remove('hidden');
                            }
                            modalTitle.textContent = '批量付款';
                        } else {
                            if (selectedInvoicesSection) {
                                selectedInvoicesSection.classList.add('hidden');
                            }
                            modalTitle.textContent = '新建电镀付款';
                        }
                        
                        // 更新模态框中的发票信息
                        updateModalInvoiceDisplay();
                        
                        // 显示模态框
                        paymentModal.classList.remove('hidden');
                    }
                }
                
                // 更新模态框中的发票信息显示
                function updateModalInvoiceDisplay() {
                    const container = document.getElementById('selected-invoices-container');
                    const totalAmountEl = document.getElementById('total-amount');
                    const selectedInvoicesSection = document.getElementById('selected-invoices-section');
                    
                    if (selectedBills.length === 0) {
                        if (container) container.innerHTML = '<p class="text-gray-medium text-sm">未选择任何发票</p>';
                        if (totalAmountEl) totalAmountEl.textContent = '¥0.00';
                        if (selectedInvoicesSection) selectedInvoicesSection.classList.add('hidden');
                        return;
                    }
                    
                    if (selectedInvoicesSection) {
                        selectedInvoicesSection.classList.remove('hidden');
                    }
                    
                    // 计算总金额
                    const totalAmount = selectedBills.reduce((sum, bill) => sum + parseFloat(bill.amount || 0), 0);
                    
                    // 更新发票列表
                    let html = '<div class="space-y-2">';
                    selectedBills.forEach((bill, index) => {
                        html += `
                            <div class="flex justify-between items-center p-2 border border-gray-200 rounded bg-white">
                                <div>
                                    <div class="text-sm font-medium">${bill.invoiceNumber || `发票 ${index + 1}`}</div>
                                    <div class="text-xs text-gray-medium">订单号: ${bill.orderNumber}, 电镀厂: ${bill.electroplatingFactory}</div>
                                </div>
                                <div class="text-sm font-bold text-dark">¥${parseFloat(bill.amount || 0).toFixed(2)}</div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    
                    if (container) container.innerHTML = html;
                    if (totalAmountEl) totalAmountEl.textContent = `¥${totalAmount.toFixed(2)}`;
                    
                    // 自动填充付款金额为总金额
                    const amountInput = document.getElementById('payment-amount');
                    const paidAmountInput = document.getElementById('payment-paid-amount');
                    if (amountInput) amountInput.value = totalAmount.toFixed(2);
                    if (paidAmountInput) paidAmountInput.value = totalAmount.toFixed(2);
                    
                    // 自动填充电镀厂 - 直接调用账单中的电镀厂名
                    const factoryInput = document.getElementById('payment-factory');
                    if (selectedBills.length > 0 && factoryInput) {
                        // 如果所有选中的发票来自同一电镀厂，使用该电镀厂名
                        const factories = [...new Set(selectedBills.map(bill => bill.electroplatingFactory))];
                        if (factories.length === 1 && factories[0]) {
                            factoryInput.value = factories[0];
                        } else if (selectedBills[0] && selectedBills[0].electroplatingFactory) {
                            // 如果是不同电镀厂，使用第一个发票的电镀厂
                            factoryInput.value = selectedBills[0].electroplatingFactory;
                        }
                        // 如果还是没有值，尝试从所有发票中获取第一个有值的电镀厂
                        if (!factoryInput.value) {
                            for (let i = 0; i < selectedBills.length; i++) {
                                if (selectedBills[i] && selectedBills[i].electroplatingFactory) {
                                    factoryInput.value = selectedBills[i].electroplatingFactory;
                                    break;
                                }
                            }
                        }
                    }
                    
                    // 自动填写发票号 - 使用选中的发票号（如果是多个，用逗号分隔）
                    const invoiceNumberInput = document.getElementById('payment-invoice-number');
                    if (invoiceNumberInput) {
                        const invoiceNumbers = selectedBills.map(bill => bill.invoiceNumber).filter(num => num).join(', ');
                        invoiceNumberInput.value = invoiceNumbers || '批量付款';
                    }
                }
                
                // 为新建电镀付款表单添加提交处理
                const createPaymentForm = document.getElementById('create-payment-form');
                if (createPaymentForm) {
                    createPaymentForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        
                        // 获取paymentId，如果存在则表示编辑操作
                        const paymentIdInput = document.getElementById('payment-id-input');
                        const isEditMode = paymentIdInput && paymentIdInput.value.trim() !== '';
                        const paymentId = isEditMode ? paymentIdInput.value.trim() : generatePaymentId();
                        
                        // 获取表单数据
                        const paymentData = {
                            paymentId: paymentId,
                            factory: document.getElementById('payment-factory').value,
                            invoiceNumber: document.getElementById('payment-invoice-number').value,
                            paymentDate: document.getElementById('payment-date').value,
                            amount: parseFloat(document.getElementById('payment-amount').value),
                            paidAmount: parseFloat(document.getElementById('payment-paid-amount').value),
                            paymentMethod: document.getElementById('payment-method').value,
                            status: document.getElementById('payment-status').value,
                            remark: document.getElementById('payment-remark').value,
                            createDate: new Date().toISOString() // 直接使用当前日期的ISO格式
                        };
                        
                        // 如果有选中的发票，添加关联的发票信息
                        if (selectedBills.length > 0) {
                            paymentData.relatedInvoices = selectedBills.map(bill => ({
                                invoiceNumber: bill.invoiceNumber,
                                orderNumber: bill.orderNumber,
                                amount: parseFloat(bill.amount || 0)
                            }));
                        }
                        
                        // 获取现有付款数据
                        let payments = JSON.parse(localStorage.getItem(window.storagePrefix + "payments")) || [];
                        
                        if (isEditMode) {
                            // 编辑模式：更新现有记录
                            const index = payments.findIndex(p => p.paymentId === paymentId);
                            if (index !== -1) {
                                payments[index] = paymentData;
                            }
                        } else {
                            // 创建模式：添加新记录
                            payments.push(paymentData);
                        }
                        
                        // 保存到localStorage
                        localStorage.setItem(window.storagePrefix + "payments", JSON.stringify(payments));
                        updateFinanceStatistics();
                        
                        // 如果付款状态是已完成，更新相关账单的状态
                        if (paymentData.status === 'completed') {
                            updateBillStatuses();
                        }
                        
                        // 更新付款列表
                        updatePaymentList();
                        
                        // 更新账单列表
                      loadBillsTable();
                      // 确保统计卡片更新
                      if (typeof updateFinanceStatistics === 'function') {
                          updateFinanceStatistics();
                      }
                        
                        // 提示成功并关闭模态框
                        alert(isEditMode ? '电镀付款更新成功！' : '电镀付款创建成功！');
                        this.reset();
                        const modal = this.closest('.fixed');
                        if (modal) modal.classList.add('hidden');
                        
                        // 重置paymentId输入框
                        if (paymentIdInput) paymentIdInput.value = '';
                        
                        // 重置选中的发票
                        selectedBills = [];
                    });
                }
                
                // 更新已付款的账单状态
                function updateBillStatuses() {
                    let bills = JSON.parse(localStorage.getItem(window.storagePrefix + "bills")) || [];
                    
                    bills = bills.map(bill => {
                        // 检查是否是选中的发票
                        const isSelectedInvoice = selectedBills.some(selectedBill => 
                            selectedBill.invoiceNumber === bill.invoiceNumber
                        );
                        
                        // 如果是选中的发票且未付款，更新为已付款状态
                        if (isSelectedInvoice && bill.billStatus !== 'paid') {
                            return {
                                ...bill,
                                billStatus: 'paid' // 更新为已付款状态
                            };
                        }
                        
                        return bill;
                    });
                    
                    // 保存更新后的账单数据
                    localStorage.setItem(window.storagePrefix + "bills", JSON.stringify(bills));
            updateFinanceStatistics();
                updateFinanceStatistics();
                updateFinanceStatistics();
                    updateFinanceStatistics();
                }
                
                // 生成付款编号
                function generatePaymentId() {
                    const payments = JSON.parse(localStorage.getItem(window.storagePrefix + "payments")) || [];
                    const date = new Date();
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const dateStr = `${year}${month}${day}`;
                    
                    // 查找当天最大的序号
                    let maxSeq = 0;
                    payments.forEach(payment => {
                        if (payment.paymentId && payment.paymentId.startsWith(`P${dateStr}`)) {
                            const seq = parseInt(payment.paymentId.slice(-3));
                            if (!isNaN(seq) && seq > maxSeq) {
                                maxSeq = seq;
                            }
                        }
                    });
                    
                    // 生成新序号
                    const newSeq = String(maxSeq + 1).padStart(3, '0');
                    return `P${dateStr}${newSeq}`;
                }
                
                // 更新电镀付款列表
                function updatePaymentList() {
                    const paymentTableBody = document.querySelector('#payments-submodule tbody');
                    const payments = JSON.parse(localStorage.getItem(window.storagePrefix + "payments")) || [];
                    

                    
                    if (paymentTableBody) {
                        // 清空现有内容
                        paymentTableBody.innerHTML = '';
                        
                        if (payments.length === 0) {
                            // 显示空状态
                            const emptyRow = document.createElement('tr');
                            emptyRow.innerHTML = `
                                <td colspan="9" class="table-cell text-center py-8 text-gray-medium">
                                    暂无电镀付款数据
                                </td>
                            `;
                            paymentTableBody.appendChild(emptyRow);
                        } else {
                            // 添加付款记录
                            payments.forEach(payment => {
                                const row = document.createElement('tr');
                                row.innerHTML = `
                                    <td class="table-cell">${getStyledFactoryHTML(payment.factory || '') || '-'}</td>
                                    <td class="table-cell">${payment.invoiceNumber || '-'}</td>
                                    <td class="table-cell">¥${payment.amount ? payment.amount.toFixed(2) : '0.00'}</td>
                                    <td class="table-cell">¥${payment.paidAmount ? payment.paidAmount.toFixed(2) : '0.00'}</td>
                                    <td class="table-cell">${payment.createDate ? new Date(payment.createDate).toLocaleDateString() : '-'}</td>
                                    <td class="table-cell">${payment.paymentDate || '-'}</td>
                                    <td class="table-cell">
                                        <span class="status-badge ${getStatusClass(payment.status)}">
                                            ${getStatusText(payment.status)}
                                        </span>
                                    </td>
                                    <td class="table-cell">${payment.remark || '-'}</td>
                                    <td class="table-cell">
                                        <div class="flex gap-2">
                                            <button class="btn btn-sm btn-primary view-payment" data-id="${payment.paymentId}">
                                                查看
                                            </button>
                                            <button class="btn btn-sm btn-secondary edit-payment" data-id="${payment.paymentId}">
                                                编辑
                                            </button>
                                            <button class="btn btn-sm btn-danger delete-payment" data-id="${payment.paymentId}">
                                                删除
                                            </button>
                                        </div>
                                    </td>
                                `;
                                paymentTableBody.appendChild(row);
                            });
                        }
                    }
                }
                
                // 根据状态获取样式类
                function getStatusClass(status) {
                    switch(status) {
                        case 'completed':
                            return 'status-completed';
                        case 'failed':
                            return 'status-failed';
                        default:
                            return 'status-pending';
                    }
                }
                
                // 根据状态获取文本
                function getStatusText(status) {
                    switch(status) {
                        case 'completed':
                            return '已完成';
                        case 'failed':
                            return '失败';
                        case 'pending':
                            return '待处理';
                        default:
                            return status || '未知';
                    }
                }
                
                // 导出电镀付款记录为Excel（CSV格式）
                function exportPaymentsToExcel() {
                    const payments = JSON.parse(localStorage.getItem(window.storagePrefix + "payments")) || [];
                    
                    if (payments.length === 0) {
                        alert('没有可导出的电镀付款数据！');
                        return;
                    }
                    
                    // CSV表头
                    const headers = ['电镀厂', '发票号', '应付金额', '付款金额', '创建日期', '实际付款日期', '状态', '备注'];
                    
                    // 生成CSV内容
                    let csvContent = '\uFEFF' + headers.join(',') + '\n'; // 添加BOM以支持中文
                    
                    payments.forEach(payment => {
                        const row = [
                            '"' + (payment.factory || '').replace(/"/g, '""') + '"',
                            '"' + (payment.invoiceNumber || '').replace(/"/g, '""') + '"',
                            payment.amount ? payment.amount.toFixed(2) : '0.00',
                            payment.paidAmount ? payment.paidAmount.toFixed(2) : '0.00',
                            payment.createDate ? new Date(payment.createDate).toLocaleDateString() : '',
                            payment.paymentDate || '',
                            '"' + (getStatusText(payment.status) || '').replace(/"/g, '""') + '"',
                            '"' + (payment.remark || '').replace(/"/g, '""') + '"'
                        ];
                        csvContent += row.join(',') + '\n';
                    });
                    
                    // 创建Blob并下载
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(blob);
                    
                    // 设置文件名
                    const currentDate = new Date();
                    const fileName = `电镀付款记录_${currentDate.getFullYear()}${(currentDate.getMonth() + 1).toString().padStart(2, '0')}${currentDate.getDate().toString().padStart(2, '0')}.csv`;
                    
                    link.setAttribute('href', url);
                    link.setAttribute('download', fileName);
                    link.style.visibility = 'hidden';
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // 清理URL对象
                    setTimeout(() => URL.revokeObjectURL(url), 100);
                }
                
                // 为导出按钮添加事件监听器（使用事件委托更可靠）
                document.addEventListener('click', function(e) {
                    if (e.target.closest('#export-payments-btn')) {
                        exportPaymentsToExcel();
                    }
                });
                
                // 也直接为按钮元素添加事件监听器，确保两种方式都能工作
                function setupExportButtonListener() {
                    const exportBtn = document.getElementById('export-payments-btn');
                    if (exportBtn) {
                        // 移除可能存在的旧监听器，避免重复绑定
                        exportBtn.removeEventListener('click', exportPaymentsToExcel);
                        exportBtn.addEventListener('click', exportPaymentsToExcel);
                    }
                }
                
                // 在子模块切换时重新设置监听器
                document.querySelectorAll('.submodule-nav button').forEach(button => {
                    button.addEventListener('click', function() {
                        // 短暂延迟确保子模块已加载
                        setTimeout(setupExportButtonListener, 100);
                    });
                });
                
                // 初始设置监听器
                setupExportButtonListener();
                
                // 导入电镀付款记录功能
                function importPaymentsFromExcel() {
                    // 触发隐藏的文件选择框
                    const fileInput = document.getElementById('payments-file-input');
                    fileInput.value = ''; // 重置文件输入，以便能选择相同文件
                    fileInput.click();
                }
                
                // 解析CSV文件内容
                function parseCSV(csvText) {
                    const lines = csvText.split('\n');
                    const results = [];
                    
                    // 跳过BOM字符
                    let headerLine = lines[0];
                    if (headerLine && headerLine.charCodeAt(0) === 0xFEFF) {
                        headerLine = headerLine.substring(1);
                    }
                    
                    // 假设第一行是表头，从第二行开始读取数据
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;
                        
                        // 简单的CSV解析，处理带引号的字段
                        const values = [];
                        let inQuotes = false;
                        let currentValue = '';
                        
                        for (let j = 0; j < line.length; j++) {
                            const char = line[j];
                            
                            if (char === '"') {
                                if (inQuotes && j + 1 < line.length && line[j + 1] === '"') {
                                    // 处理双引号转义
                                    currentValue += '"';
                                    j++; // 跳过第二个引号
                                } else {
                                    inQuotes = !inQuotes;
                                }
                            } else if (char === ',' && !inQuotes) {
                                values.push(currentValue.trim());
                                currentValue = '';
                            } else {
                                currentValue += char;
                            }
                        }
                        
                        values.push(currentValue.trim());
                        
                        if (values.length >= 8) { // 至少需要8个字段
                            results.push({
                                factory: values[0] || '',
                                invoiceNumber: values[1] || '',
                                amount: parseFloat(values[2]) || 0,
                                paidAmount: parseFloat(values[3]) || 0,
                                createDate: values[4] ? new Date(values[4]).toISOString() : new Date().toISOString(),
                                paymentDate: values[5] || '',
                                status: getStatusKey(values[6]) || 'pending',
                                remark: values[7] || '',
                                paymentId: generateUniqueId() // 生成新的唯一ID
                            });
                        }
                    }
                    
                    return results;
                }
                
                // 根据状态文本获取状态键
                function getStatusKey(statusText) {
                    const statusMap = {
                        '已完成': 'completed',
                        '失败': 'failed',
                        '待处理': 'pending'
                    };
                    return statusMap[statusText] || 'pending';
                }
                
                // 生成唯一ID
                function generateUniqueId() {
                    return Date.now().toString(36) + Math.random().toString(36).substr(2);
                }
                
                // 为导入按钮添加事件监听器
                document.addEventListener('click', function(e) {
                    if (e.target.closest('#import-payments-btn')) {
                        importPaymentsFromExcel();
                    }
                });
                
                // 为文件输入框添加change事件处理
                document.addEventListener('change', function(e) {
                    if (e.target.id === 'payments-file-input' && e.target.files.length > 0) {
                        const file = e.target.files[0];
                        const reader = new FileReader();
                        
                        reader.onload = function(event) {
                            try {
                                // 处理CSV文件
                                if (file.name.endsWith('.csv')) {
                                    const csvContent = event.target.result;
                                    const importedPayments = parseCSV(csvContent);
                                    
                                    if (importedPayments.length === 0) {
                                        alert('未找到有效的电镀付款数据！');
                                        return;
                                    }
                                    
                                    // 获取现有数据
                                    const data = dataManager.getAllData();
                                    const existingPayments = data.payments || [];

                                    // 合并并去重（根据发票号去重）
                                    const invoiceNumbers = new Set(existingPayments.map(p => p.invoiceNumber));
                                    const newPayments = importedPayments.filter(p => !invoiceNumbers.has(p.invoiceNumber));

                                    const mergedPayments = [...existingPayments, ...newPayments];

                                    // 保存到localStorage
                                    data.payments = mergedPayments;
                                    localStorage.setItem(window.storagePrefix + 'payments', JSON.stringify(mergedPayments));
                                    
                                    // 更新表格
                                    updatePaymentList();
                                    
                                    alert(`成功导入 ${newPayments.length} 条新记录，总计 ${mergedPayments.length} 条记录！`);
                                } else {
                                    alert('目前仅支持CSV格式文件导入！');
                                }
                            } catch (error) {
                                console.error('导入失败:', error);
                                alert('导入失败，请检查文件格式和内容！');
                            }
                        };
                        
                        reader.onerror = function() {
                            alert('读取文件失败！');
                        };
                        
                        // 以文本方式读取文件
                        reader.readAsText(file, 'UTF-8');
                    }
                });
                
                // 初始化时更新付款列表
                updatePaymentList();
                
                // 付款操作按钮事件监听（使用事件委托）
                const paymentTableBody = document.querySelector('#payments-submodule tbody');
                if (paymentTableBody) {
                    paymentTableBody.addEventListener('click', function(e) {
                        const paymentId = e.target.closest('[data-id]')?.getAttribute('data-id');
                        if (!paymentId) return;
                        
                        // 获取付款数据
                        const payments = JSON.parse(localStorage.getItem(window.storagePrefix + "payments")) || [];
                        const payment = payments.find(p => p.paymentId === paymentId);
                        
                        if (!payment) {
                            alert('未找到该付款记录！');
                            return;
                        }
                        
                        // 查看按钮处理
                        if (e.target.closest('.view-payment')) {
                            // 创建查看模态框
                            const modalHtml = `
                                <div class="modal-overlay">
                                    <div class="modal-content max-w-2xl">
                                        <div class="modal-header">
                                            <h3 class="modal-title">查看电镀付款</h3>
                                            <button class="modal-close">×</button>
                                        </div>
                                        <div class="modal-body">
                                            <div class="grid grid-cols-2 gap-4">
                                                <div class="form-group">
                                                    <label class="form-label">电镀厂</label>
                                                    <input type="text" value="${payment.factory || '-'}" class="form-input" readonly>
                                                </div>
                                                <div class="form-group">
                                                    <label class="form-label">发票号</label>
                                                    <input type="text" value="${payment.invoiceNumber || '-'}" class="form-input" readonly>
                                                </div>
                                                <div class="form-group">
                                                    <label class="form-label">应付金额</label>
                                                    <input type="text" value="¥${payment.amount ? payment.amount.toFixed(2) : '0.00'}" class="form-input" readonly>
                                                </div>
                                                <div class="form-group">
                                                    <label class="form-label">付款金额</label>
                                                    <input type="text" value="¥${payment.paidAmount ? payment.paidAmount.toFixed(2) : '0.00'}" class="form-input" readonly>
                                                </div>
                                                <div class="form-group">
                                                    <label class="form-label">创建日期</label>
                                                    <input type="text" value="${payment.createDate ? new Date(payment.createDate).toLocaleDateString() : '-'}" class="form-input" readonly>
                                                </div>
                                                <div class="form-group">
                                                    <label class="form-label">实际付款日期</label>
                                                    <input type="text" value="${payment.paymentDate || '-'}" class="form-input" readonly>
                                                </div>
                                                <div class="form-group">
                                                    <label class="form-label">状态</label>
                                                    <input type="text" value="${getStatusText(payment.status)}" class="form-input" readonly>
                                                </div>
                                            </div>
                                            <div class="mt-4 form-group">
                                                <label class="form-label">备注</label>
                                                <textarea class="form-input" readonly rows="3">${payment.remark || '-'}</textarea>
                                            </div>
                                            ${payment.relatedInvoices && payment.relatedInvoices.length > 0 ? `
                                                <div class="mt-4">
                                                    <h4 class="text-lg font-semibold mb-2">相关发票</h4>
                                                    <ul class="list-disc pl-6">
                                                        ${payment.relatedInvoices.map(inv => `<li>发票号：${inv.invoiceNumber || '-'}, 金额：¥${inv.amount ? inv.amount.toFixed(2) : '0.00'}</li>`).join('')}
                                                    </ul>
                                                </div>
                                            ` : ''}
                                        </div>
                                        <div class="modal-footer">
                                            <button class="btn btn-primary modal-close">关闭</button>
                                        </div>
                                    </div>
                                </div>
                            `;
                            
                            // 添加模态框到页面
                            const modalContainer = document.createElement('div');
                            modalContainer.innerHTML = modalHtml;
                            document.body.appendChild(modalContainer);
                            
                            // 关闭模态框
                            modalContainer.querySelectorAll('.modal-close').forEach(btn => {
                                btn.addEventListener('click', () => {
                                    document.body.removeChild(modalContainer);
                                });
                            });
                        }
                        
                        // 编辑按钮处理
                        else if (e.target.closest('.edit-payment')) {
                            // 打开编辑模态框
                            const createPaymentModal = document.getElementById('create-payment-modal');
                            const modalTitle = document.getElementById('create-payment-modal-title');
                            const paymentIdInput = document.getElementById('payment-id-input');
                            const factorySelect = document.getElementById('payment-factory');
                            const invoiceNumberInput = document.getElementById('payment-invoice-number');
                            const amountInput = document.getElementById('payment-amount');
                            const paidAmountInput = document.getElementById('payment-paid-amount');
                            const createDateInput = document.getElementById('payment-create-date');
                            const paymentDateInput = document.getElementById('payment-date');
                            const paymentMethodSelect = document.getElementById('payment-method');
                            const transactionIdInput = document.getElementById('payment-transaction-id');
                            const statusSelect = document.getElementById('payment-status');
                            const remarkTextarea = document.getElementById('payment-remark');
                            
                            if (createPaymentModal && modalTitle) {
                                modalTitle.textContent = '编辑电镀付款';
                                createPaymentModal.classList.remove('hidden');
                                
                                // 填充表单数据
                                if (paymentIdInput) paymentIdInput.value = payment.paymentId;
                                if (factorySelect) factorySelect.value = payment.factory || '';
                                if (invoiceNumberInput) invoiceNumberInput.value = payment.invoiceNumber || '';
                                if (amountInput) amountInput.value = payment.amount || '';
                                if (paidAmountInput) paidAmountInput.value = payment.paidAmount || '';
                                if (createDateInput) {
                                    createDateInput.value = payment.createDate ? new Date(payment.createDate).toLocaleDateString() : '';
                                }
                                if (paymentDateInput) paymentDateInput.value = payment.paymentDate || '';
                                if (paymentMethodSelect) paymentMethodSelect.value = payment.paymentMethod || '';
                                if (transactionIdInput) transactionIdInput.value = payment.transactionId || '';
                                if (statusSelect) statusSelect.value = payment.status || 'completed';
                                if (remarkTextarea) remarkTextarea.value = payment.remark || '';
                            }
                        }
                        
                        // 删除按钮处理
                        else if (e.target.closest('.delete-payment')) {
                            if (confirm('确定要删除这条付款记录吗？')) {
                                // 从localStorage中删除
                                const updatedPayments = payments.filter(p => p.paymentId !== paymentId);
                                localStorage.setItem(window.storagePrefix + "payments", JSON.stringify(updatedPayments));
                        updateFinanceStatistics();
                                
                                // 更新列表
                                updatePaymentList();
                                alert('删除成功！');
                            }
                        }
                    });
                }
            }
            
            // 子模块切换函数
            function switchSubmodule(submoduleName) {
                // 隐藏所有子模块内容
                const billModule = document.getElementById('bills-submodule');
                const paymentModule = document.getElementById('payments-submodule');
                const reconciliationModule = document.getElementById('reconciliation-submodule');
                
                if (billModule) billModule.classList.add('hidden');
                if (paymentModule) paymentModule.classList.add('hidden');
                if (reconciliationModule) reconciliationModule.classList.add('hidden');
                
                // 移除所有子导航的激活状态
                const subNavItems = document.querySelectorAll('.nav-subitem');
                subNavItems.forEach(function(el) {
                    el.classList.remove('active', 'text-primary', 'border-b-2', 'border-primary');
                    el.classList.add('text-gray-medium');
                });
                
                // 显示选中的子模块
                const targetSubmodule = document.getElementById(submoduleName + '-submodule');
                if (targetSubmodule) {
                    targetSubmodule.classList.remove('hidden');
                    // 如果是付款子模块，更新列表以显示保存的数据
                    if (submoduleName === 'payments' && typeof updatePaymentList === 'function') {
                        updatePaymentList();
                    } else if (submoduleName === 'bills' && typeof loadBillsTable === 'function') {
                        loadBillsTable();
                    }
                }
                
                // 激活当前子导航项
                const activeNavItem = document.querySelector('.nav-subitem[data-submodule="' + submoduleName + '"]');
                if (activeNavItem) {
                    activeNavItem.classList.add('active', 'text-primary', 'border-b-2', 'border-primary');
                    activeNavItem.classList.remove('text-gray-medium');
                }
                

            }
            


            // 导出订单数据为Excel功能
            function exportOrdersToExcel() {
                const orders = JSON.parse(localStorage.getItem(window.storagePrefix + "orders")) || [];
                
                if (orders.length === 0) {
                    alert('没有订单数据可导出！');
                    return;
                }
                
                // 创建CSV内容
                let csvContent = '订单编号,客户名称,产品,数量,加工单价,交货期,电镀厂,备注\n';
                
                orders.forEach(order => {
                    // 处理可能包含逗号或换行符的数据
                    const sanitize = (value) => {
                        if (typeof value === 'string' && (value.includes(',') || value.includes('"') || value.includes('\n'))) {
                            return '"' + value.replace(/"/g, '""') + '"';
                        }
                        return value || '';
                    };
                    
                    const row = [
                        sanitize(order.orderId),
                        sanitize(order.customer),
                        sanitize(order.product),
                        sanitize(order.quantity),
                        sanitize(order.unitPrice || ''),
                        sanitize(order.deliveryDate),
                        sanitize(order.electroplatingFactory),
                        sanitize(order.remark)
                    ].join(',');
                    
                    csvContent += row + '\n';
                });
                
                // 创建Blob对象
                const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                
                // 创建下载链接
                const link = document.createElement('a');
                link.href = url;
                link.download = `订单数据_${new Date().toISOString().split('T')[0]}.csv`;
                
                // 触发下载
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // 释放URL对象
                URL.revokeObjectURL(url);
            }
            
            // 导入订单数据功能
            function importOrdersFromExcel() {
                const fileInput = document.getElementById('order-import-input');
                fileInput.click();
            }

            // 处理文件上传
            const orderImportInput = document.getElementById('order-import-input');
            if (orderImportInput) {
                orderImportInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (!file) return;

                    // 验证文件类型
                    if (!file.name.endsWith('.csv')) {
                        alert('请上传CSV格式的文件！');
                        this.value = '';
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = function(event) {
                        try {
                            // 解析CSV内容
                            const csvContent = event.target.result;
                            const lines = csvContent.split('\n').filter(line => line.trim());
                            
                            if (lines.length < 2) {
                                alert('CSV文件内容为空或格式不正确！');
                                return;
                            }

                            // 跳过标题行，获取数据行
                            const dataLines = lines.slice(1);
                            const newOrders = [];
                            let errorCount = 0;
                            
                            // 获取现有订单数据
                            const existingOrders = JSON.parse(localStorage.getItem(window.storagePrefix + "orders")) || [];
                            const existingOrderIds = new Set(existingOrders.map(order => order.orderId));
                            
                            dataLines.forEach((line, index) => {
                                try {
                                    // 使用更健壮的CSV解析方法，处理包含逗号的字段
                                    const values = parseCSVLine(line);
                                    
                                    if (values.length < 5) {
                                        errorCount++;
                                        return;
                                    }

                                    // 提取字段，注意可能有空格需要去除
                                    const orderId = values[0]?.trim();
                                    const customer = values[1]?.trim();
                                    const product = values[2]?.trim() || '';
                                    const quantity = values[3]?.trim();
                                    const unitPrice = values[4]?.trim() || '';
                                    const deliveryDate = values[5]?.trim();
                                    const electroplatingFactory = values[6]?.trim() || '';
                                    const remark = values[7]?.trim() || '';

                                    // 验证必填字段
                                    if (!orderId || !customer || !quantity || !deliveryDate) {
                                        errorCount++;
                                        return;
                                    }

                                    // 检查订单编号是否已存在
                                    if (existingOrderIds.has(orderId)) {
                                        // 可以选择覆盖或跳过已存在的订单
                                        // 这里选择跳过
                                        return;
                                    }

                                    // 创建新订单对象
                                    const newOrder = {
                                        orderId,
                                        customer,
                                        product,
                                        quantity,
                                        unitPrice,
                                        deliveryDate,
                                        electroplatingFactory,
                                        remark,
                                        createTime: new Date().toLocaleString('zh-CN')
                                    };

                                    newOrders.push(newOrder);
                                    existingOrderIds.add(orderId);
                                } catch (err) {
                                    errorCount++;
                                }
                            });

                            if (newOrders.length > 0) {
                                // 合并并保存订单数据
                                const allOrders = [...existingOrders, ...newOrders];
                                localStorage.setItem(window.storagePrefix + "orders", JSON.stringify(allOrders));
                                localStorage.removeItem(window.storagePrefix + "ordersCleared");
                                
                                // 重新加载订单列表
                                loadOrders();
                                
                                alert(`成功导入 ${newOrders.length} 条订单数据！${errorCount > 0 ? `有 ${errorCount} 条记录导入失败。` : ''}`);
                            } else {
                                alert(`没有成功导入的订单数据${errorCount > 0 ? `，有 ${errorCount} 条记录导入失败。` : ''}。`);
                            }
                        } catch (error) {
                            console.error('导入订单失败:', error);
                            alert('导入订单失败，请检查文件格式是否正确！');
                        } finally {
                            // 清空文件选择，允许重新选择同一文件
                            orderImportInput.value = '';
                        }
                    };

                    reader.readAsText(file, 'UTF-8');
                });
            }

            // 辅助函数：解析CSV行，处理包含逗号的引号字段
            function parseCSVLine(line) {
                const result = [];
                let current = '';
                let inQuotes = false;
                let quoteEscaped = false;

                for (let i = 0; i < line.length; i++) {
                    const char = line[i];

                    if (char === '"' && !quoteEscaped) {
                        inQuotes = !inQuotes;
                        quoteEscaped = false;
                    } else if (char === '"' && quoteEscaped) {
                        current += '"';
                        quoteEscaped = false;
                    } else if (char === '"' && inQuotes) {
                        quoteEscaped = true;
                    } else if (char === ',' && !inQuotes) {
                        result.push(current);
                        current = '';
                    } else {
                        current += char;
                    }
                }

                result.push(current);
                return result;
            }

            // 为导入按钮添加事件监听器
            const importOrdersBtn = document.getElementById('import-orders-btn');
            if (importOrdersBtn) {
                importOrdersBtn.addEventListener('click', importOrdersFromExcel);
            }

            // 为导出按钮添加事件监听器
            const exportOrdersBtn = document.getElementById('export-orders-btn');
            if (exportOrdersBtn) {
                exportOrdersBtn.addEventListener('click', exportOrdersToExcel);
            }
            
            // 导出发货数据为Excel功能
            function exportDeliveriesToExcel() {
                const deliveries = JSON.parse(localStorage.getItem(window.storagePrefix + "deliveries")) || [];
                
                if (deliveries.length === 0) {
                    alert('没有发货数据可导出！');
                    return;
                }
                
                // 创建CSV内容，完全匹配表格中的字段
                let csvContent = '订单编号,客户,产品,毛坯数量,返镀数量,报废数量,合计,发货件数,电镀厂,发货日期,要求送回日期,备注\n';
                
                deliveries.forEach(delivery => {
                    // 处理可能包含逗号或换行符的数据
                    const sanitize = (value) => {
                        if (typeof value === 'string' && (value.includes(',') || value.includes('"') || value.includes('\n'))) {
                            return '"' + value.replace(/"/g, '""') + '"';
                        }
                        return value || '';
                    };
                    
                    // 计算合计：毛坯数量 + 返镀数量 - 报废数量
                    const rawQty = parseInt(delivery.rawQuantity || 0);
                    const reworkQty = parseInt(delivery.reworkQuantity || 0);
                    const scrapQty = parseInt(delivery.scrapQuantity || 0);
                    const totalQty = rawQty + reworkQty - scrapQty;
                    
                    const row = [
                        sanitize(delivery.orderNumber),
                        sanitize(delivery.customer),
                        sanitize(delivery.product),
                        sanitize(delivery.rawQuantity || ''),
                        sanitize(delivery.reworkQuantity || ''),
                        sanitize(delivery.scrapQuantity || ''),
                        sanitize(totalQty),
                        sanitize(delivery.deliveryQuantity),
                        sanitize(delivery.factory || ''),
                        sanitize(delivery.deliveryDate),
                        sanitize(delivery.requiredReturnDate || ''),
                        sanitize(delivery.remark)
                    ].join(',');
                    
                    csvContent += row + '\n';
                });
                
                // 创建Blob对象
                const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                
                // 创建下载链接
                const link = document.createElement('a');
                link.href = url;
                link.download = `发货数据_${new Date().toISOString().split('T')[0]}.csv`;
                
                // 触发下载
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // 释放URL对象
                URL.revokeObjectURL(url);
            }
            
            // 导出收货数据为Excel功能
            function exportReceiptsToExcel() {
                const receipts = JSON.parse(localStorage.getItem(window.storagePrefix + "receipts")) || [];
                
                if (receipts.length === 0) {
                    alert('没有收货数据可导出！');
                    return;
                }
                
                // 创建CSV内容，完全匹配表格中的字段
                let csvContent = '订单编号,客户,产品,成品数量,返修数量,报废数量,合计,件数,电镀厂,收货日期,备注\n';
                
                receipts.forEach(receipt => {
                    // 处理可能包含逗号或换行符的数据
                    const sanitize = (value) => {
                        if (typeof value === 'string' && (value.includes(',') || value.includes('"') || value.includes('\n'))) {
                            return '"' + value.replace(/"/g, '""') + '"';
                        }
                        return value || '';
                    };
                    
                    // 计算合计：成品数量 + 返修数量 - 报废数量
                    const finishedQty = parseInt(receipt.finishedQuantity || 0);
                    const reworkQty = parseInt(receipt.reworkQuantity || 0);
                    const scrapQty = parseInt(receipt.scrapQuantity || 0);
                    const totalQty = finishedQty + reworkQty - scrapQty;
                    
                    const row = [
                        sanitize(receipt.orderNumber),
                        sanitize(receipt.customer),
                        sanitize(receipt.product),
                        sanitize(receipt.finishedQuantity || ''),
                        sanitize(receipt.reworkQuantity || ''), // 使用正确的字段名
                        sanitize(receipt.scrapQuantity || ''),
                        sanitize(totalQty),
                        sanitize(receipt.pieces || ''), // 使用正确的字段名
                        sanitize(receipt.factory || ''), // 使用正确的字段名
                        sanitize(receipt.receiptDate),
                        sanitize(receipt.remark)
                    ].join(',');
                    
                    csvContent += row + '\n';
                });
                
                // 创建Blob对象
                const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                
                // 创建下载链接
                const link = document.createElement('a');
                link.href = url;
                link.download = `收货数据_${new Date().toISOString().split('T')[0]}.csv`;
                
                // 触发下载
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // 释放URL对象
                URL.revokeObjectURL(url);
            }
            
            // 导入发货数据功能
            function importDeliveriesFromExcel() {
                const fileInput = document.getElementById('delivery-import-input');
                fileInput.click();
            }

            // 处理发货数据文件上传
            const deliveryImportInput = document.getElementById('delivery-import-input');
            if (deliveryImportInput) {
                deliveryImportInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (!file) return;

                    // 验证文件类型
                    if (!file.name.endsWith('.csv')) {
                        alert('请上传CSV格式的文件！');
                        this.value = '';
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = function(event) {
                        try {
                            // 解析CSV内容
                            const csvContent = event.target.result;
                            const lines = csvContent.split('\n').filter(line => line.trim());
                            
                            if (lines.length < 2) {
                                alert('CSV文件内容为空或格式不正确！');
                                return;
                            }

                            // 跳过标题行，获取数据行
                            const dataLines = lines.slice(1);
                            const newDeliveries = [];
                            let errorCount = 0;
                            
                            // 获取现有发货数据
                            const existingDeliveries = JSON.parse(localStorage.getItem(window.storagePrefix + "deliveries")) || [];
                            
                            dataLines.forEach((line, index) => {
                                try {
                                    // 使用更健壮的CSV解析方法，处理包含逗号的字段
                                    const values = parseCSVLine(line);
                                    
                                    if (values.length < 8) { // 至少需要8个字段
                                        errorCount++;
                                        return;
                                    }

                                    // 提取字段，注意可能有空格需要去除
                                    const orderNumber = values[0]?.trim();
                                    const customer = values[1]?.trim();
                                    const product = values[2]?.trim() || '';
                                    const rawQuantity = values[3]?.trim() || '0';
                                    // 使用reworkQuantity而不是replatingQuantity，保持与其他功能一致
                                    const reworkQuantity = values[4]?.trim() || '0';
                                    const scrapQuantity = values[5]?.trim() || '0';
                                    // 跳过合计字段，因为它是计算字段
                                    const deliveryQuantity = values[7]?.trim() || values[6]?.trim(); // 兼容旧格式和新格式
                                    // 使用factory而不是electroplatingFactory，保持与其他功能一致
                                    const factory = values[8]?.trim() || values[7]?.trim() || '';
                                    const deliveryDate = values[9]?.trim() || values[8]?.trim();
                                    const requiredReturnDate = values[10]?.trim() || values[9]?.trim() || '';
                                    const remark = values[11]?.trim() || values[10]?.trim() || '';

                                    // 验证必填字段
                                    if (!orderNumber || !customer || !deliveryQuantity || !deliveryDate) {
                                        errorCount++;
                                        return;
                                    }

                                    // 生成唯一的发货ID
                                    const deliveryId = 'DEL-' + Date.now() + '-' + Math.floor(Math.random() * 1000);

                                    // 创建新发货记录对象
                                    const newDelivery = {
                                        deliveryId,
                                        orderNumber,
                                        customer,
                                        product,
                                        rawQuantity,
                                        reworkQuantity, // 使用正确的字段名
                                        scrapQuantity,
                                        deliveryQuantity,
                                        factory, // 使用正确的字段名
                                        deliveryDate,
                                        requiredReturnDate,
                                        remark,
                                        createTime: new Date().toLocaleString('zh-CN')
                                    };

                                    newDeliveries.push(newDelivery);
                                } catch (err) {
                                    errorCount++;
                                }
                            });

                            if (newDeliveries.length > 0) {
                                // 合并并保存发货数据
                                const allDeliveries = [...existingDeliveries, ...newDeliveries];
                                localStorage.setItem(window.storagePrefix + "deliveries", JSON.stringify(allDeliveries));
                                
                                // 重新加载发货列表
                                if (typeof updateDeliveryList === 'function') {
                                    updateDeliveryList();
                                }
                                
                                alert(`成功导入 ${newDeliveries.length} 条发货数据！${errorCount > 0 ? `有 ${errorCount} 条记录导入失败。` : ''}`);
                            } else {
                                alert(`没有成功导入的发货数据${errorCount > 0 ? `，有 ${errorCount} 条记录导入失败。` : ''}。`);
                            }
                        } catch (error) {
                            console.error('导入发货数据失败:', error);
                            alert('导入发货数据失败，请检查文件格式是否正确！');
                        } finally {
                            // 清空文件选择，允许重新选择同一文件
                            deliveryImportInput.value = '';
                        }
                    };

                    reader.readAsText(file, 'UTF-8');
                });
            }

            // 为发货导入按钮添加事件监听器
            const importDeliveriesBtn = document.getElementById('import-deliveries-btn');
            if (importDeliveriesBtn) {
                importDeliveriesBtn.addEventListener('click', importDeliveriesFromExcel);
            }
            
            // 为发货导出按钮添加事件监听器
            const exportDeliveriesBtn = document.getElementById('export-deliveries-btn');
            if (exportDeliveriesBtn) {
                exportDeliveriesBtn.addEventListener('click', exportDeliveriesToExcel);
            }
            
            // 为收货导出按钮添加事件监听器
            const exportReceiptsBtn = document.getElementById('export-receipts-btn');
            if (exportReceiptsBtn) {
                exportReceiptsBtn.addEventListener('click', exportReceiptsToExcel);
            }
            
            // 导入收货数据功能
            function importReceiptsFromExcel() {
                const fileInput = document.getElementById('receipt-import-input');
                fileInput.click();
            }

            // 处理收货数据文件上传
            const receiptImportInput = document.getElementById('receipt-import-input');
            if (receiptImportInput) {
                receiptImportInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (!file) return;

                    // 验证文件类型
                    if (!file.name.endsWith('.csv')) {
                        alert('请上传CSV格式的文件！');
                        this.value = '';
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = function(event) {
                        try {
                            // 解析CSV内容
                            const csvContent = event.target.result;
                            const lines = csvContent.split('\n').filter(line => line.trim());
                            
                            if (lines.length < 2) {
                                alert('CSV文件内容为空或格式不正确！');
                                return;
                            }

                            // 跳过标题行，获取数据行
                            const dataLines = lines.slice(1);
                            const newReceipts = [];
                            let errorCount = 0;
                            
                            // 获取现有收货数据
                            const existingReceipts = JSON.parse(localStorage.getItem(window.storagePrefix + "receipts")) || [];
                            
                            dataLines.forEach((line, index) => {
                                try {
                                    // 使用更健壮的CSV解析方法，处理包含逗号的字段
                                    const values = parseCSVLine(line);
                                    
                                    if (values.length < 7) { // 至少需要7个字段
                                        errorCount++;
                                        return;
                                    }

                                    // 提取字段，注意可能有空格需要去除
                                    const orderNumber = values[0]?.trim();
                                    const customer = values[1]?.trim();
                                    const product = values[2]?.trim() || '';
                                    const finishedQuantity = values[3]?.trim() || '0';
                                    // 使用reworkQuantity而不是repairQuantity，保持与其他功能一致
                                    const reworkQuantity = values[4]?.trim() || '0';
                                    const scrapQuantity = values[5]?.trim() || '0';
                                    // 跳过合计字段，因为它是计算字段
                                    const quantity = values[7]?.trim() || values[6]?.trim(); // 兼容旧格式和新格式
                                    // 使用factory而不是electroplatingFactory，保持与其他功能一致
                                    const factory = values[8]?.trim() || values[7]?.trim() || '';
                                    const receiptDate = values[9]?.trim() || values[8]?.trim();
                                    const remark = values[10]?.trim() || values[9]?.trim() || '';

                                    // 验证必填字段
                                    if (!orderNumber || !customer || !quantity || !receiptDate) {
                                        errorCount++;
                                        return;
                                    }

                                    // 生成唯一的收货ID
                                    const receiptId = 'REC-' + Date.now() + '-' + Math.floor(Math.random() * 1000);

                                    // 创建新收货记录对象
                                    const newReceipt = {
                                        receiptId,
                                        orderNumber,
                                        customer,
                                        product,
                                        finishedQuantity,
                                        reworkQuantity, // 使用正确的字段名
                                        scrapQuantity,
                                        pieces: quantity, // 字段名保持一致
                                        factory, // 使用正确的字段名
                                        receiptDate,
                                        remark,
                                        createTime: new Date().toLocaleString('zh-CN')
                                    };

                                    newReceipts.push(newReceipt);
                                } catch (err) {
                                    errorCount++;
                                }
                            });

                            if (newReceipts.length > 0) {
                                // 合并并保存收货数据
                                const allReceipts = [...existingReceipts, ...newReceipts];
                                localStorage.setItem(window.storagePrefix + "receipts", JSON.stringify(allReceipts));
                                
                                // 重新加载收货列表
                                if (typeof updateReceiptList === 'function') {
                                    updateReceiptList();
                                }
                                
                                alert(`成功导入 ${newReceipts.length} 条收货数据！${errorCount > 0 ? `有 ${errorCount} 条记录导入失败。` : ''}`);
                            } else {
                                alert(`没有成功导入的收货数据${errorCount > 0 ? `，有 ${errorCount} 条记录导入失败。` : ''}。`);
                            }
                        } catch (error) {
                            console.error('导入收货数据失败:', error);
                            alert('导入收货数据失败，请检查文件格式是否正确！');
                        } finally {
                            // 清空文件选择，允许重新选择同一文件
                            receiptImportInput.value = '';
                        }
                    };

                    reader.readAsText(file, 'UTF-8');
                });
            }

            // 为收货导入按钮添加事件监听器
            const importReceiptsBtn = document.getElementById('import-receipts-btn');
            if (importReceiptsBtn) {
                importReceiptsBtn.addEventListener('click', importReceiptsFromExcel);
            }
            
            // 模块内导航链接
            const navLinks = document.querySelectorAll('[data-navigate]');
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const targetModule = this.getAttribute('data-navigate');
                    
                    // 更新导航状态
                    navItems.forEach(nav => nav.classList.remove('active'));
                    document.querySelector(`.nav-item[data-module="${targetModule}"]`).classList.add('active');
                    
                    // 更新页面标题
                    pageTitle.textContent = document.querySelector(`.nav-item[data-module="${targetModule}"] span`).textContent;
                    
                    // 显示对应模块
                    moduleContents.forEach(content => content.classList.add('hidden'));
                    document.getElementById(`${targetModule}-module`).classList.remove('hidden');
                });
            });
            
            // 填充订单编号下拉框
            function populateOrderNumberDropdown() {
                const orderNumberSelect = document.getElementById('delivery-order-number-select');
                if (!orderNumberSelect) return;
                
                // 清空下拉框（保留默认选项）
                orderNumberSelect.innerHTML = '<option value="" disabled selected>请选择订单编号</option>';
                
                // 从localStorage获取订单数据
                const orders = JSON.parse(localStorage.getItem(window.storagePrefix + "orders")) || [];
                
                if (orders.length > 0) {
                    // 添加所有订单编号
                    orders.forEach(order => {
                        if (order.orderId) {
                            const option = document.createElement('option');
                            option.value = order.orderId;
                            option.textContent = order.orderId;
                            orderNumberSelect.appendChild(option);
                        }
                    });
                }
            }
            
            // 模态框控制
            const createOrderBtn = document.getElementById('create-order-btn');
            const createDeliveryBtn = document.getElementById('create-delivery-btn');
            const createReceiptBtn = document.getElementById('create-receipt-btn');
            const createInvoiceBtn = document.getElementById('create-invoice-btn');
            const closeModalBtns = document.querySelectorAll('.close-modal');
            
            if (createOrderBtn) {
                createOrderBtn.addEventListener('click', function() {
                    document.getElementById('create-order-modal').classList.remove('hidden');
                });
            }
            
            if (createDeliveryBtn) {
                createDeliveryBtn.addEventListener('click', function() {
                    // 设置今天的日期作为默认值
                    const today = new Date();
                    const year = today.getFullYear();
                    const month = String(today.getMonth() + 1).padStart(2, '0');
                    const day = String(today.getDate()).padStart(2, '0');
                    const formattedDate = `${year}-${month}-${day}`;
                    
                    const deliveryDateInput = document.getElementById('delivery-date');
                    if (deliveryDateInput) {
                        deliveryDateInput.value = formattedDate;
                    }
                    
                    // 填充订单编号下拉框
                    populateOrderNumberDropdown();
                    
                    // 为订单编号下拉框添加change事件监听器
                    const orderNumberSelect = document.getElementById('delivery-order-number-select');
                    if (orderNumberSelect) {
                        // 先移除可能存在的旧事件监听器
                        orderNumberSelect.removeEventListener('change', handleOrderSelectChange);
                        // 添加新的事件监听器
                        orderNumberSelect.addEventListener('change', handleOrderSelectChange);
                    }
                    
                    document.getElementById('create-delivery-modal').classList.remove('hidden');
                });
            }
            
            // 处理订单选择变更，自动填充相关信息
            function handleOrderSelectChange(event) {
                const selectedOrderId = event.target.value;
                if (!selectedOrderId) return;
                
                // 从localStorage获取订单数据
                const orders = JSON.parse(localStorage.getItem(window.storagePrefix + "orders")) || [];
                
                // 使用多种方式查找订单，确保能找到匹配的订单
                let selectedOrder = null;
                
                // 方法1：通过orderId或orderNumber精确匹配
                selectedOrder = orders.find(order => 
                    order.orderId === selectedOrderId || 
                    order.orderNumber === selectedOrderId
                );
                
                // 如果方法1失败，尝试其他匹配方式
                if (!selectedOrder) {
                    // 方法2：尝试字符串包含匹配
                    selectedOrder = orders.find(order => 
                        (order.orderId && order.orderId.includes(selectedOrderId)) || 
                        (order.orderNumber && order.orderNumber.includes(selectedOrderId))
                    );
                }
                
                // 如果找到订单，执行填充操作
                if (selectedOrder) {
                    // 更可靠的方式获取输入框 - 通过查找标签后紧跟的输入框
                    // 获取客户输入框
                    const customerLabel = document.evaluate(
                        "//div[@id='create-delivery-modal']//label[contains(text(), '客户')]/following-sibling::input",
                        document,
                        null,
                        XPathResult.FIRST_ORDERED_NODE_TYPE,
                        null
                    ).singleNodeValue;
                    
                    // 获取产品输入框
                    const productLabel = document.evaluate(
                        "//div[@id='create-delivery-modal']//label[contains(text(), '产品')]/following-sibling::input",
                        document,
                        null,
                        XPathResult.FIRST_ORDERED_NODE_TYPE,
                        null
                    ).singleNodeValue;
                    
                    // 获取电镀厂输入框
                    const factoryLabel = document.evaluate(
                        "//div[@id='create-delivery-modal']//label[contains(text(), '电镀厂')]/following-sibling::input",
                        document,
                        null,
                        XPathResult.FIRST_ORDERED_NODE_TYPE,
                        null
                    ).singleNodeValue;
                    
                    // 尝试多种可能的字段名，确保兼容不同的数据结构
                    const customerValue = selectedOrder.customer || selectedOrder.customerName || selectedOrder['客户'] || '';
                    const productValue = selectedOrder.product || selectedOrder.productName || selectedOrder['产品'] || '';
                    const factoryValue = selectedOrder.electroplatingFactory || selectedOrder.factory || selectedOrder.platingFactory || selectedOrder['电镀厂'] || '';
                    
                    // 确保元素存在后，设置值并触发change事件
                    if (customerLabel) {
                        setTimeout(() => {
                            customerLabel.value = customerValue;
                            customerLabel.dispatchEvent(new Event('change', { bubbles: true }));
                            customerLabel.dispatchEvent(new Event('input', { bubbles: true }));
                        }, 10);
                    }
                    
                    if (productLabel) {
                        setTimeout(() => {
                            productLabel.value = productValue;
                            productLabel.dispatchEvent(new Event('change', { bubbles: true }));
                            productLabel.dispatchEvent(new Event('input', { bubbles: true }));
                        }, 10);
                    }
                    
                    if (factoryLabel) {
                        setTimeout(() => {
                            factoryLabel.value = factoryValue;
                            factoryLabel.dispatchEvent(new Event('change', { bubbles: true }));
                            factoryLabel.dispatchEvent(new Event('input', { bubbles: true }));
                        }, 10);
                    }
                    
                    // 添加日志以便调试
                    console.log('发货单自动填充信息:', {
                        orderNumber: selectedOrderId,
                        customer: customerValue,
                        product: productValue,
                        factory: factoryValue,
                        elementsFound: {
                            customer: !!customerLabel,
                            product: !!productLabel,
                            factory: !!factoryLabel
                        }
                    });
                }
            }
            
            if (createReceiptBtn) {
                createReceiptBtn.addEventListener('click', function() {
                    // 设置今天的日期作为收货日期默认值
                    const today = new Date();
                    const year = today.getFullYear();
                    const month = String(today.getMonth() + 1).padStart(2, '0');
                    const day = String(today.getDate()).padStart(2, '0');
                    const formattedDate = `${year}-${month}-${day}`;
                    
                    // 获取收货日期输入框（通过选择器）
                    const receiptDateInput = document.querySelector('#create-receipt-modal input[type="date"]');
                    if (receiptDateInput) {
                        receiptDateInput.value = formattedDate;
                    }
                    
                    // 从localStorage获取所有发货记录
                    const deliveries = JSON.parse(localStorage.getItem(window.storagePrefix + "deliveries")) || [];
                    
                    // 提取唯一的订单编号
                    const uniqueOrderNumbers = [...new Set(deliveries.map(delivery => delivery.orderNumber).filter(orderNumber => orderNumber))];
                    
                    // 获取新建收货单模态框中的订单编号下拉框
                    const orderNumberSelect = document.querySelector('#create-receipt-modal select');
                    
                    if (orderNumberSelect) {
                        // 清空现有选项，保留默认提示项
                        orderNumberSelect.innerHTML = '<option value="">请选择订单</option>';
                        
                        // 添加唯一的订单编号作为选项
                        uniqueOrderNumbers.forEach(orderNumber => {
                            const option = document.createElement('option');
                            option.value = orderNumber;
                            option.textContent = orderNumber;
                            orderNumberSelect.appendChild(option);
                        });
                        
                        // 添加change事件监听器，用于自动填充相关信息
                        // 先移除可能存在的旧事件监听器
                        orderNumberSelect.removeEventListener('change', handleReceiptOrderSelectChange);
                        // 添加新的事件监听器
                        orderNumberSelect.addEventListener('change', function() {
                            handleReceiptOrderSelectChange(deliveries, this.value);
                        });
                    }
                    
                    document.getElementById('create-receipt-modal').classList.remove('hidden');
                });
            }
            
            // 处理收货单订单选择变更，自动填充相关信息
            function handleReceiptOrderSelectChange(deliveries, selectedOrderNumber) {
                if (!selectedOrderNumber) return;
                
                // 从发货记录中查找对应的订单信息
                // 找到第一个匹配的发货记录
                const matchingDelivery = deliveries.find(delivery => delivery.orderNumber === selectedOrderNumber);
                
                if (matchingDelivery) {
                    // 更可靠的方式获取输入框 - 通过查找标签后紧跟的输入框
                    // 获取客户输入框
                    const customerLabel = document.evaluate(
                        "//div[@id='create-receipt-modal']//label[contains(text(), '客户')]/following-sibling::input",
                        document,
                        null,
                        XPathResult.FIRST_ORDERED_NODE_TYPE,
                        null
                    ).singleNodeValue;
                    
                    // 获取产品输入框
                    const productLabel = document.evaluate(
                        "//div[@id='create-receipt-modal']//label[contains(text(), '产品')]/following-sibling::input",
                        document,
                        null,
                        XPathResult.FIRST_ORDERED_NODE_TYPE,
                        null
                    ).singleNodeValue;
                    
                    // 获取电镀厂输入框
                    const factoryLabel = document.evaluate(
                        "//div[@id='create-receipt-modal']//label[contains(text(), '电镀厂')]/following-sibling::input",
                        document,
                        null,
                        XPathResult.FIRST_ORDERED_NODE_TYPE,
                        null
                    ).singleNodeValue;
                    
                    // 尝试多种可能的字段名，确保兼容不同的数据结构
                    const customerValue = matchingDelivery.customer || matchingDelivery.customerName || matchingDelivery['客户'] || '';
                    const productValue = matchingDelivery.product || matchingDelivery.productName || matchingDelivery['产品'] || '';
                    const factoryValue = matchingDelivery.factory || matchingDelivery.platingFactory || matchingDelivery['电镀厂'] || '';
                    
                    // 填充对应的信息
                    if (customerLabel) {
                        customerLabel.value = customerValue;
                    }
                    if (productLabel) {
                        productLabel.value = productValue;
                    }
                    if (factoryLabel) {
                        factoryLabel.value = factoryValue;
                    }
                    
                    // 添加日志以便调试
                    console.log('自动填充信息:', {
                        orderNumber: selectedOrderNumber,
                        customer: customerValue,
                        product: productValue,
                        factory: factoryValue,
                        elementsFound: {
                            customer: !!customerLabel,
                            product: !!productLabel,
                            factory: !!factoryLabel
                        }
                    });
                }
            }
            
            if (createInvoiceBtn) {
                createInvoiceBtn.addEventListener('click', function() {
                    document.getElementById('create-invoice-modal').classList.remove('hidden');
                    // 设置创建日期为今天
                    const today = new Date().toISOString().split('T')[0];
                    const createDateInput = document.getElementById('invoice-create-date');
                    if (createDateInput) {
                        createDateInput.value = today;
                    }
                });
            }
            
            closeModalBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    this.closest('.fixed').classList.add('hidden');
                });
            });
            
            // 订单详情按钮
            const viewOrderBtns = document.querySelectorAll('.text-primary.hover\\:text-accent');
            viewOrderBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    document.getElementById('order-detail-modal').classList.remove('hidden');
                });
            });
            
            // 分页相关变量
            // 从localStorage加载订单数据
            function loadOrders() {
                const orders = JSON.parse(localStorage.getItem(window.storagePrefix + "orders")) || [];
                const orderTableBody = document.querySelector('#orders-module tbody');
                
                // 检查是否被清空
                if (localStorage.getItem(window.storagePrefix + "ordersCleared") === 'true' || orders.length === 0) {
                    if (orderTableBody) {
                        orderTableBody.innerHTML = '<tr class="text-center text-gray-500"><td colspan="10">暂无订单数据</td></tr>';
                    }
                    return;
                }
                
                // 按交货期倒序排序
                const sortedOrders = [...orders].sort((a, b) => {
                    return new Date(b.deliveryDate) - new Date(a.deliveryDate);
                });
                
                // 清空表格并添加所有数据（不分页）
                if (orderTableBody) {
                    orderTableBody.innerHTML = '';
                    
                    if (sortedOrders.length === 0) {
                        orderTableBody.innerHTML = '<tr class="text-center text-gray-500"><td colspan="10">暂无订单数据</td></tr>';
                    } else {
                        sortedOrders.forEach(order => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td class="table-cell">
                                    <input type="checkbox" class="order-checkbox rounded text-primary focus:ring-primary" data-id="${order.orderId}">
                                </td>
                                <td class="table-cell">${order.orderId}</td>
                                <td class="table-cell">${order.customer}</td>
                                <td class="table-cell">${order.product || ''}</td>
                                <td class="table-cell">${order.quantity}</td>
                                <td class="table-cell">${order.unitPrice || ''}</td>
                                <td class="table-cell">${order.deliveryDate}</td>
                                <td class="table-cell">${getStyledFactoryHTML(order.electroplatingFactory)}</td>
                                <td class="table-cell">${order.remark || ''}</td>
                                <td class="table-cell">
                                    <div class="flex gap-2">
                                        <button class="text-primary hover:text-accent view-order" data-id="${order.orderId}">
                                            <i class="fa fa-eye"></i>
                                        </button>
                                        <button class="text-gray-medium hover:text-primary edit-order" data-id="${order.orderId}">
                                            <i class="fa fa-edit"></i>
                                        </button>
                                        <button class="text-gray-medium hover:text-danger delete-order" data-id="${order.orderId}">
                                            <i class="fa fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            `;
                            orderTableBody.appendChild(row);
                        });
                    }
                    
                    // 添加查看事件
                    document.querySelectorAll('.view-order').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const orderId = this.getAttribute('data-id');
                            viewOrder(orderId);
                        });
                    });
                    
                    // 添加编辑事件
                    document.querySelectorAll('.edit-order').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const orderId = this.getAttribute('data-id');
                            editOrder(orderId);
                        });
                    });
                    
                    // 添加删除事件
                    document.querySelectorAll('.delete-order').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const orderId = this.getAttribute('data-id');
                            deleteOrder(orderId);
                        });
                    });
                }
            }
            
            // 添加分页事件监听器 - 分页功能已移除
            function initPagination() {
                // 分页功能已移除，此函数保留以避免调用错误
            }
            
            // 页面加载时初始化分页
            document.addEventListener('DOMContentLoaded', function() {
                initPagination();
            });
            
            // 确保在切换到订单计划模块时重新初始化分页
            function showOrdersModule() {
                const ordersModule = document.getElementById('orders-module');
                if (ordersModule) {
                    ordersModule.classList.remove('hidden');
                }
                hideAllModulesExcept('orders-module');
                
                // 重新初始化分页功能
                initPagination();
                // 重新加载订单数据
                loadOrders();
                
                // 记录操作日志
                console.log('显示订单计划模块');
            }
            
            // 保存订单到localStorage
            function saveOrder(orderData) {
                const orders = JSON.parse(localStorage.getItem(window.storagePrefix + "orders")) || [];
                orders.push(orderData);
                localStorage.setItem(window.storagePrefix + "orders", JSON.stringify(orders));
                localStorage.removeItem(window.storagePrefix + "ordersCleared"); // 取消清空标记
            }
            
            // 查看订单
            function viewOrder(orderId) {
                const orders = JSON.parse(localStorage.getItem(window.storagePrefix + "orders")) || [];
                const order = orders.find(order => order.orderId === orderId);
                
                if (order) {
                    // 构建查看详情的字符串
                    let details = `订单详情：\n\n`;
                    details += `订单编号：${order.orderId}\n`;
                    details += `客户名称：${order.customer}\n`;
                    details += `产品：${order.product || '无'}\n`;
                    details += `数量：${order.quantity}\n`;
                    details += `交货期：${order.deliveryDate}\n`;
                    details += `电镀厂：${order.electroplatingFactory || '无'}\n`;
                    details += `备注：${order.remark || '无'}\n`;
                    details += `创建时间：${order.createTime || '无'}`;
                    
                    alert(details);
                } else {
                    alert('未找到该订单');
                }
            }
            
            // 编辑订单
            function editOrder(orderId) {
                const orders = JSON.parse(localStorage.getItem(window.storagePrefix + "orders")) || [];
                const order = orders.find(order => order.orderId === orderId);
                
                if (order) {
                    // 编辑订单编号
                    const newOrderNumber = prompt('编辑订单编号：', order.orderNumber || order.orderId);
                    if (newOrderNumber !== null) order.orderNumber = newOrderNumber;
                    
                    // 编辑客户名称
                    const newCustomer = prompt('编辑客户名称：', order.customer);
                    if (newCustomer !== null) order.customer = newCustomer;
                    
                    // 编辑产品
                    const newProduct = prompt('编辑产品：', order.product);
                    if (newProduct !== null) order.product = newProduct;
                    
                    // 编辑数量
                    const newQuantity = prompt('编辑数量：', order.quantity);
                    if (newQuantity !== null) order.quantity = newQuantity;
                    
                    // 编辑加工单价
                    const newUnitPrice = prompt('编辑加工单价：', order.unitPrice || '0');
                    if (newUnitPrice !== null) order.unitPrice = newUnitPrice;
                    
                    // 编辑交货期
                    const newDeliveryDate = prompt('编辑交货期：', order.deliveryDate);
                    if (newDeliveryDate !== null) order.deliveryDate = newDeliveryDate;
                    
                    // 编辑电镀厂（确保与新建订单模态框中的选项一致）
                    const factoryOptions = ['宣城沃新', '丹阳裕丰'];
                    let factoryPrompt = '请选择电镀厂\n';
                    factoryOptions.forEach((factory, index) => {
                        factoryPrompt += `${index + 1}. ${factory}\n`;
                    });
                    const factoryChoice = prompt(factoryPrompt, '1');
                    if (factoryChoice !== null && factoryChoice >= 1 && factoryChoice <= factoryOptions.length) {
                        order.electroplatingFactory = factoryOptions[factoryChoice - 1];
                    }
                    
                    // 编辑备注
                    const newRemark = prompt('编辑备注：', order.remark || '');
                    if (newRemark !== null) order.remark = newRemark;
                    
                    // 保存更新后的订单列表
                    localStorage.setItem(window.storagePrefix + "orders", JSON.stringify(orders));
                    loadOrders(); // 重新加载订单
                    alert('订单编辑成功！');
                } else {
                    alert('未找到该订单');
                }
            }
            
            // 删除订单
            function deleteOrder(orderId) {
                if (confirm('确定要删除该订单吗？')) {
                    let orders = JSON.parse(localStorage.getItem(window.storagePrefix + "orders")) || [];
                    orders = orders.filter(order => order.orderId !== orderId);
                    localStorage.setItem(window.storagePrefix + "orders", JSON.stringify(orders));
                    loadOrders(); // 重新加载订单
                    alert('订单删除成功！');
                }
            }
            
            // 生成订单编号
            function generateOrderId() {
                const orders = JSON.parse(localStorage.getItem(window.storagePrefix + "orders")) || [];
                const date = new Date();
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                
                // 查找当天最大的订单编号
                let maxNum = 0;
                orders.forEach(order => {
                    if (order.orderId.startsWith(`ORD-${year}-${month}${day}`)) {
                        const num = parseInt(order.orderId.split('-').pop());
                        maxNum = Math.max(maxNum, num);
                    }
                });
                
                const newNum = String(maxNum + 1).padStart(3, '0');
                return `ORD-${year}-${month}${day}-${newNum}`;
            }
            
            // 查看发货单
            function viewDelivery(deliveryId) {
                const deliveries = JSON.parse(localStorage.getItem(window.storagePrefix + "deliveries")) || [];
                const delivery = deliveries.find(d => d.deliveryId === deliveryId);
                
                if (delivery) {
                    // 构建查看详情的字符串
                    let details = `发货单详情：\n\n`;
                    details += `发货单号：${delivery.deliveryId}\n`;
                    details += `订单编号：${delivery.orderNumber}\n`;
                    details += `客户：${delivery.customer}\n`;
                    details += `产品：${delivery.product}\n`;
                    details += `毛坯数量：${delivery.rawQuantity}\n`;
                    details += `返镀数量：${delivery.reworkQuantity}\n`;
                    details += `报废数量：${delivery.scrapQuantity}\n`;
                    details += `发货件数：${delivery.deliveryQuantity}\n`;
                    details += `电镀厂：${delivery.factory}\n`;
                    details += `发货日期：${delivery.deliveryDate}\n`;
                    details += `要求送回日期：${delivery.requiredReturnDate}\n`;
                    details += `备注：${delivery.remark || '无'}\n`;
                    
                    alert(details);
                } else {
                    alert('未找到该发货单');
                }
            }
            
            // 编辑发货单
            function editDelivery(deliveryId) {
                const deliveries = JSON.parse(localStorage.getItem(window.storagePrefix + "deliveries")) || [];
                const delivery = deliveries.find(d => d.deliveryId === deliveryId);
                
                if (delivery) {
                    // 编辑各个字段
                    const newRawQuantity = prompt('编辑毛坯数量：', delivery.rawQuantity);
                    if (newRawQuantity !== null) delivery.rawQuantity = newRawQuantity;
                    
                    const newReworkQuantity = prompt('编辑返镀数量：', delivery.reworkQuantity);
                    if (newReworkQuantity !== null) delivery.reworkQuantity = newReworkQuantity;
                    
                    const newScrapQuantity = prompt('编辑报废数量：', delivery.scrapQuantity);
                    if (newScrapQuantity !== null) delivery.scrapQuantity = newScrapQuantity;
                    
                    const newDeliveryQuantity = prompt('编辑发货件数：', delivery.deliveryQuantity);
                    if (newDeliveryQuantity !== null) delivery.deliveryQuantity = newDeliveryQuantity;
                    
                    const newDeliveryDate = prompt('编辑发货日期：', delivery.deliveryDate);
                    if (newDeliveryDate !== null) delivery.deliveryDate = newDeliveryDate;
                    
                    const newRequiredReturnDate = prompt('编辑要求送回日期：', delivery.requiredReturnDate);
                    if (newRequiredReturnDate !== null) delivery.requiredReturnDate = newRequiredReturnDate;
                    
                    const newRemark = prompt('编辑备注：', delivery.remark || '');
                    if (newRemark !== null) delivery.remark = newRemark;
                    
                    // 保存更新后的发货单列表
                    localStorage.setItem(window.storagePrefix + "deliveries", JSON.stringify(deliveries));
                    updateDeliveryList(); // 重新加载发货单
                    alert('发货单编辑成功！');
                } else {
                    alert('未找到该发货单');
                }
            }
            
            // 删除发货单
            function deleteDelivery(deliveryId) {
                if (confirm('确定要删除该发货单吗？')) {
                    let deliveries = JSON.parse(localStorage.getItem(window.storagePrefix + "deliveries")) || [];
                    deliveries = deliveries.filter(d => d.deliveryId !== deliveryId);
                    localStorage.setItem(window.storagePrefix + "deliveries", JSON.stringify(deliveries));
                    updateDeliveryList(); // 重新加载发货单
                    alert('发货单删除成功！');
                }
            }
            
            // 绑定发货单按钮事件
            function bindDeliveryButtons() {
                // 添加查看事件
                document.querySelectorAll('.view-delivery').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const deliveryId = this.getAttribute('data-id');
                        viewDelivery(deliveryId);
                    });
                });
                
                // 添加编辑事件
                document.querySelectorAll('.edit-delivery').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const deliveryId = this.getAttribute('data-id');
                        editDelivery(deliveryId);
                    });
                });
                
                // 添加删除事件
                document.querySelectorAll('.delete-delivery').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const deliveryId = this.getAttribute('data-id');
                        deleteDelivery(deliveryId);
                    });
                });
            }
            
            // 更新分页显示 - 修改为兼容我们的分页实现
            function updatePagination() {
                const orders = JSON.parse(localStorage.getItem(window.storagePrefix + "orders")) || [];
                const paginationControls = document.querySelector('#orders-module .flex.gap-1');
                
                // 控制分页控件显示
                if (paginationControls) {
                    if (orders.length === 0 && localStorage.getItem(window.storagePrefix + "ordersCleared") === 'true') {
                        paginationControls.classList.add('hidden');
                    } else {
                        paginationControls.classList.remove('hidden');
                    }
                }
                
                // 重新加载订单数据以更新分页显示
                loadOrders();
            }
            
            // 通用表单提交处理 (排除特定表单)
            const forms = document.querySelectorAll('form:not(#create-order-form):not(#create-delivery-form):not(#create-receipt-form)');
            forms.forEach(form => {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    // 模拟表单提交
                    alert('操作成功！');
                    this.closest('.fixed').classList.add('hidden');
                });
            });
            
            // 新建收货单表单提交处理
            const createReceiptForm = document.getElementById('create-receipt-form');
            if (createReceiptForm) {
                createReceiptForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    // 获取表单数据
                    const formElements = this.elements;
                    const orderNumber = formElements[0].value; // 订单编号
                    const customer = formElements[1].value; // 客户
                    const product = formElements[2].value; // 产品
                    const finishedQuantity = formElements[3].value; // 成品数量
                    const reworkQuantity = formElements[4].value || '0'; // 返修数量
                    const scrapQuantity = formElements[5].value || '0'; // 报废数量
                    const pieces = formElements[6].value; // 件数
                    const factory = formElements[7].value; // 电镀厂
                    const receiptDate = formElements[8].value; // 收货日期
                    const remark = formElements[9].value; // 备注
                    
                    // 生成唯一的收货单号 (格式: SH + 年月日 + 4位随机数)
                    const today = new Date();
                    const year = today.getFullYear();
                    const month = String(today.getMonth() + 1).padStart(2, '0');
                    const day = String(today.getDate()).padStart(2, '0');
                    const randomNum = String(Math.floor(Math.random() * 10000)).padStart(4, '0');
                    const receiptId = `SH${year}${month}${day}${randomNum}`;
                    
                    // 创建收货单对象
                    const receiptData = {
                        receiptId,
                        orderNumber,
                        customer,
                        product,
                        finishedQuantity,
                        reworkQuantity,
                        scrapQuantity,
                        pieces,
                        factory,
                        receiptDate,
                        remark
                    };
                    
                    // 从localStorage获取现有收货单数据或创建新数组
                    const receipts = JSON.parse(localStorage.getItem(window.storagePrefix + "receipts")) || [];
                    receipts.push(receiptData);
                    
                    // 保存到localStorage
                    localStorage.setItem(window.storagePrefix + "receipts", JSON.stringify(receipts));
                    
                    // 更新收货单列表
                    updateReceiptList();
                    
                    // 提示成功并关闭模态框
                    alert('收货单创建成功！');
                    this.closest('.fixed').classList.add('hidden');
                    // 重置表单
                    this.reset();
                });
            }
            
            // 更新收货单列表函数
            function updateReceiptList() {
                const receiptTableBody = document.querySelector('#receipt-module tbody');
                const receipts = JSON.parse(localStorage.getItem(window.storagePrefix + "receipts")) || [];
                
                // 更新统计信息
                const startRecordElement = document.getElementById('receipt-start-record');
                const endRecordElement = document.getElementById('receipt-end-record');
                const totalRecordsElement = document.getElementById('receipt-total-records');
                
                if (startRecordElement && endRecordElement && totalRecordsElement) {
                    if (receipts.length === 0) {
                        startRecordElement.textContent = '0';
                        endRecordElement.textContent = '0';
                        totalRecordsElement.textContent = '0';
                    } else {
                        startRecordElement.textContent = '1';
                        endRecordElement.textContent = receipts.length.toString();
                        totalRecordsElement.textContent = receipts.length.toString();
                    }
                }
                
                if (receiptTableBody) {
                    if (receipts.length === 0) {
                        receiptTableBody.innerHTML = '<tr><td colspan="12" class="table-cell text-center py-8 text-gray-medium">暂无收货单数据</td></tr>';
                    } else {
                        // 按收货日期倒序排序
                        const sortedReceipts = [...receipts].sort((a, b) => {
                            return new Date(b.receiptDate) - new Date(a.receiptDate);
                        });
                        
                        // 清空表格
                        receiptTableBody.innerHTML = '';
                        
                        // 添加收货单数据
                        sortedReceipts.forEach(receipt => {
                                // 计算合计：成品数量 + 返修数量 - 报废数量
                                const finishedQty = parseInt(receipt.finishedQuantity || 0);
                                const reworkQty = parseInt(receipt.reworkQuantity || 0);
                                const scrapQty = parseInt(receipt.scrapQuantity || 0);
                                const totalQty = finishedQty + reworkQty - scrapQty;
                                
                                const row = document.createElement('tr');
                                row.innerHTML = `
                                    <td class="table-cell sticky-left bg-white z-10">${receipt.orderNumber}</td>
                                    <td class="table-cell">${receipt.customer}</td>
                                    <td class="table-cell">${receipt.product}</td>
                                    <td class="table-cell">${receipt.finishedQuantity}</td>
                                    <td class="table-cell">${receipt.reworkQuantity}</td>
                                    <td class="table-cell">${receipt.scrapQuantity}</td>
                                    <td class="table-cell">${totalQty}</td>
                                    <td class="table-cell">${receipt.pieces}</td>
                                    <td class="table-cell">${getStyledFactoryHTML(receipt.factory)}</td>
                                    <td class="table-cell">${receipt.receiptDate}</td>
                                    <td class="table-cell">${receipt.remark || '-'}</td>
                                    <td class="table-cell">
                                        <div class="flex gap-2">
                                            <button class="btn btn-sm btn-primary view-receipt" data-id="${receipt.receiptId}">
                                                查看
                                            </button>
                                            <button class="btn btn-sm btn-secondary edit-receipt" data-id="${receipt.receiptId}">
                                                编辑
                                            </button>
                                            <button class="btn btn-sm btn-danger delete-receipt" data-id="${receipt.receiptId}">
                                                删除
                                            </button>
                                        </div>
                                    </td>
                                `;
                            receiptTableBody.appendChild(row);
                        });
                    }
                    // 绑定收货单按钮事件
                    bindReceiptButtons();
                }
            }
            
            // 查看收货单
            function viewReceipt(receiptId) {
                const receipts = JSON.parse(localStorage.getItem(window.storagePrefix + "receipts")) || [];
                const receipt = receipts.find(r => r.receiptId === receiptId);
                
                if (receipt) {
                    // 构建查看详情的字符串
                    let details = `收货单详情：\n\n`;
                    details += `收货单号：${receipt.receiptId}\n`;
                    details += `订单编号：${receipt.orderNumber}\n`;
                    details += `客户：${receipt.customer}\n`;
                    details += `产品：${receipt.product}\n`;
                    details += `成品数量：${receipt.finishedQuantity}\n`;
                    details += `返镀数量：${receipt.reworkQuantity}\n`;
                    details += `报废数量：${receipt.scrapQuantity}\n`;
                    details += `件数：${receipt.pieces}\n`;
                    details += `电镀厂：${receipt.factory}\n`;
                    details += `收货日期：${receipt.receiptDate}\n`;
                    details += `备注：${receipt.remark || '无'}\n`;
                    
                    alert(details);
                } else {
                    alert('未找到该收货单');
                }
            }

            // 编辑收货单
            function editReceipt(receiptId) {
                const receipts = JSON.parse(localStorage.getItem(window.storagePrefix + "receipts")) || [];
                const receipt = receipts.find(r => r.receiptId === receiptId);
                
                if (receipt) {
                    // 编辑各个字段
                    const newFinishedQuantity = prompt('编辑成品数量：', receipt.finishedQuantity);
                    if (newFinishedQuantity !== null) receipt.finishedQuantity = newFinishedQuantity;
                    
                    const newReworkQuantity = prompt('编辑返镀数量：', receipt.reworkQuantity);
                    if (newReworkQuantity !== null) receipt.reworkQuantity = newReworkQuantity;
                    
                    const newScrapQuantity = prompt('编辑报废数量：', receipt.scrapQuantity);
                    if (newScrapQuantity !== null) receipt.scrapQuantity = newScrapQuantity;
                    
                    const newPieces = prompt('编辑件数：', receipt.pieces);
                    if (newPieces !== null) receipt.pieces = newPieces;
                    
                    const newFactory = prompt('编辑电镀厂：', receipt.factory);
                    if (newFactory !== null) receipt.factory = newFactory;
                    
                    const newReceiptDate = prompt('编辑收货日期：', receipt.receiptDate);
                    if (newReceiptDate !== null) receipt.receiptDate = newReceiptDate;
                    
                    const newRemark = prompt('编辑备注：', receipt.remark || '');
                    if (newRemark !== null) receipt.remark = newRemark;
                    
                    // 保存更新后的收货单列表
                    localStorage.setItem(window.storagePrefix + "receipts", JSON.stringify(receipts));
                    updateReceiptList(); // 重新加载收货单
                    alert('收货单编辑成功！');
                } else {
                    alert('未找到该收货单');
                }
            }
            
            // 绑定收货单按钮事件
            function bindReceiptButtons() {
                // 添加查看事件
                document.querySelectorAll('.view-receipt').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const receiptId = this.getAttribute('data-id');
                        viewReceipt(receiptId);
                    });
                });
                
                // 添加编辑事件
                document.querySelectorAll('.edit-receipt').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const receiptId = this.getAttribute('data-id');
                        editReceipt(receiptId);
                    });
                });
                
                // 添加删除事件
                document.querySelectorAll('.delete-receipt').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const receiptId = this.getAttribute('data-id');
                        if (confirm('确定要删除该收货单吗？')) {
                            const receipts = JSON.parse(localStorage.getItem(window.storagePrefix + "receipts")) || [];
                            const updatedReceipts = receipts.filter(receipt => receipt.receiptId !== receiptId);
                            localStorage.setItem(window.storagePrefix + "receipts", JSON.stringify(updatedReceipts));
                            updateReceiptList();
                            alert('收货单删除成功！');
                        }
                    });
                });
            }
            
            // 新建发货单表单提交处理
            const createDeliveryForm = document.getElementById('create-delivery-form');
            if (createDeliveryForm) {
                createDeliveryForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    // 获取表单数据
                    const orderNumberSelect = document.getElementById('delivery-order-number-select');
                    const orderNumber = orderNumberSelect ? orderNumberSelect.value : '';
                    const customer = document.getElementById('delivery-customer-input').value;
                    const product = document.getElementById('delivery-product-input').value;
                    const rawQuantity = this.querySelector('input[type="number"][placeholder="请输入毛坯数量"]').value;
                    const reworkQuantity = this.querySelector('input[type="number"][placeholder="请输入返镀数量"]').value;
                    const scrapQuantity = this.querySelector('input[type="number"][placeholder="请输入报废数量"]').value;
                    const deliveryQuantity = this.querySelector('input[type="number"][placeholder="请输入发货件数"]').value;
                    const factory = document.getElementById('delivery-factory-input').value;
                    const deliveryDate = document.getElementById('delivery-date').value;
                    const requiredReturnDate = this.querySelectorAll('input[type="date"]')[1].value;
                    const remark = this.querySelector('textarea[placeholder="请输入备注信息"]').value;
                    
                    // 生成唯一的发货单号 (格式: DH + 年月日 + 4位随机数)
                    const today = new Date();
                    const year = today.getFullYear();
                    const month = String(today.getMonth() + 1).padStart(2, '0');
                    const day = String(today.getDate()).padStart(2, '0');
                    const randomNum = String(Math.floor(Math.random() * 10000)).padStart(4, '0');
                    const deliveryId = `DH${year}${month}${day}${randomNum}`;
                    
                    // 创建发货单对象
                    const deliveryData = {
                        deliveryId,
                        orderNumber,
                        customer,
                        product,
                        rawQuantity,
                        reworkQuantity,
                        scrapQuantity,
                        deliveryQuantity,
                        factory,
                        deliveryDate,
                        requiredReturnDate,
                        remark,
                        status: 'pending' // 初始状态为待发货
                    };
                    
                    // 从localStorage获取现有发货单数据或创建新数组
                    const deliveries = JSON.parse(localStorage.getItem(window.storagePrefix + "deliveries")) || [];
                    deliveries.push(deliveryData);
                    
                    // 保存到localStorage
                    localStorage.setItem(window.storagePrefix + "deliveries", JSON.stringify(deliveries));
                    
                    // 更新发货单列表
                    updateDeliveryList();
                    
                    // 提示成功并关闭模态框
                    alert('发货单创建成功！');
                    this.closest('.fixed').classList.add('hidden');
                    // 重置表单
                    this.reset();
                });
            }
            
            // 更新发货单列表函数
            function updateDeliveryList() {
                const deliveryTableBody = document.querySelector('#delivery-module tbody');
                const deliveries = JSON.parse(localStorage.getItem(window.storagePrefix + "deliveries")) || [];
                
                // 更新统计信息
                const startRecordElement = document.getElementById('delivery-start-record');
                const endRecordElement = document.getElementById('delivery-end-record');
                const totalRecordsElement = document.getElementById('delivery-total-records');
                
                if (startRecordElement && endRecordElement && totalRecordsElement) {
                    if (deliveries.length === 0) {
                        startRecordElement.textContent = '0';
                        endRecordElement.textContent = '0';
                        totalRecordsElement.textContent = '0';
                    } else {
                        startRecordElement.textContent = '1';
                        endRecordElement.textContent = deliveries.length.toString();
                        totalRecordsElement.textContent = deliveries.length.toString();
                    }
                }
                
                if (deliveryTableBody) {
                    if (deliveries.length === 0) {
                        deliveryTableBody.innerHTML = '<tr><td colspan="14" class="table-cell text-center py-8 text-gray-medium">暂无发货单数据</td></tr>';
                    } else {
                        // 按发货日期倒序排序
                        const sortedDeliveries = [...deliveries].sort((a, b) => {
                            return new Date(b.deliveryDate) - new Date(a.deliveryDate);
                        });
                        
                        // 清空表格
                        deliveryTableBody.innerHTML = '';
                        
                        // 添加发货单数据
                        sortedDeliveries.forEach(delivery => {
                            // 计算合计：毛坯数量 + 返镀数量 - 报废数量
                            const rawQty = parseInt(delivery.rawQuantity || 0);
                            const reworkQty = parseInt(delivery.reworkQuantity || 0);
                            const scrapQty = parseInt(delivery.scrapQuantity || 0);
                            const totalQty = rawQty + reworkQty - scrapQty;
                            
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td class="table-cell"><input type="checkbox" class="delivery-checkbox form-checkbox rounded" data-id="${delivery.deliveryId}"></td>
                                <td class="table-cell">${delivery.orderNumber}</td>
                                <td class="table-cell">${delivery.customer}</td>
                                <td class="table-cell">${delivery.product}</td>
                                <td class="table-cell">${delivery.rawQuantity}</td>
                                <td class="table-cell">${delivery.reworkQuantity}</td>
                                <td class="table-cell">${delivery.scrapQuantity}</td>
                                <td class="table-cell">${totalQty}</td>
                                <td class="table-cell">${delivery.deliveryQuantity}</td>
                                <td class="table-cell">${getStyledFactoryHTML(delivery.factory)}</td>
                                <td class="table-cell">${delivery.deliveryDate}</td>
                                <td class="table-cell">${delivery.requiredReturnDate}</td>
                                <td class="table-cell">${delivery.remark || '-'}</td>
                                <td class="table-cell">
                                <div class="flex gap-2">
                                    <button class="btn btn-sm btn-primary view-delivery" data-id="${delivery.deliveryId}">
                                        查看
                                    </button>
                                    <button class="btn btn-sm btn-secondary edit-delivery" data-id="${delivery.deliveryId}">
                                        编辑
                                    </button>
                                    <button class="btn btn-sm btn-danger delete-delivery" data-id="${delivery.deliveryId}">
                                        删除
                                    </button>
                                </div>
                            </td>
                            `;
                            deliveryTableBody.appendChild(row);
                        });
                    }
                    // 绑定按钮事件
                    bindDeliveryButtons();
                }
            }
            
            // 新建订单表单提交处理
            const createOrderForm = document.getElementById('create-order-form');
            if (createOrderForm) {
                createOrderForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    // 获取表单数据 - 使用ID获取元素更可靠
                    const customer = document.getElementById('order-customer-input').value;
                    const orderNumber = document.getElementById('order-number-input').value;
                    const productSelect = document.getElementById('product-select');
                    const product = productSelect && productSelect.selectedIndex > 0 ? productSelect.options[productSelect.selectedIndex].textContent : '';
                    const quantity = this.querySelector('input[type="number"]').value;
                    const unitPrice = this.querySelectorAll('input[type="number"]')[1]?.value || '';
                    const deliveryDate = this.querySelector('input[type="date"]').value;
                    const electroplatingFactorySelect = document.getElementById('electroplating-factory-select');
                    const electroplatingFactory = electroplatingFactorySelect && electroplatingFactorySelect.selectedIndex > 0 ? electroplatingFactorySelect.options[electroplatingFactorySelect.selectedIndex].textContent : '';
                    const remark = this.querySelector('textarea').value;
                    
                    // 添加日志调试信息
                    console.log('表单数据：', { customer, orderNumber, product, quantity, deliveryDate, electroplatingFactory });
                    
                    // 验证必填字段
                    if (!customer || !orderNumber || !product || !quantity || !deliveryDate || !electroplatingFactory) {
                        alert('请填写所有必填字段！');
                        return;
                    }
                    
                    // 创建订单数据
                    const now = new Date();
                    const orderData = {
                        orderId: orderNumber, // 直接使用用户输入的订单编号作为orderId
                        customer: customer,
                        orderNumber: orderNumber,
                        product: product,
                        quantity: quantity,
                        unitPrice: unitPrice,
                        deliveryDate: deliveryDate,
                        electroplatingFactory: electroplatingFactory,
                        remark: remark,
                        createTime: now.toISOString().split('T')[0]
                    };
                    
                    // 保存订单
                    saveOrder(orderData);
                    
                    // 重新加载订单列表和更新分页
                    loadOrders();
                    updatePagination();
                    
                    // 关闭模态框
                    alert('订单创建成功！');
                    this.reset();
                    this.closest('.fixed').classList.add('hidden');
                });
            }
            
            // 对账差异功能实现
            const reconcileBtn = document.getElementById('reconcile-btn');
            const exportReconcileBtn = document.getElementById('export-reconcile-btn');
            const reconcilePeriod = document.getElementById('reconcile-period');
            const customDateRange = document.getElementById('custom-date-range');
            const selectAllDiff = document.getElementById('select-all-diff');
            const reconcileTableBody = document.getElementById('reconcile-table-body');
            const batchActions = document.getElementById('batch-actions');
            const selectedCount = document.getElementById('selected-count');
            const batchHandleBtn = document.getElementById('batch-handle-btn');
            const batchExportBtn = document.getElementById('batch-export-btn');
            const filterReconcileBtn = document.getElementById('filter-reconcile-btn');
            const resetFilterBtn = document.getElementById('reset-filter-btn');
            const diffStatusFilter = document.getElementById('diff-status-filter');
            const diffTypeFilter = document.getElementById('diff-type-filter');
            const diffPartyFilter = document.getElementById('diff-party-filter');
            const reconcileType = document.getElementById('reconcile-type');
            
            // 对账结果统计元素
            const totalReconciledEl = document.getElementById('total-reconciled');
            const diffRecordsEl = document.getElementById('diff-records');
            const totalDiffAmountEl = document.getElementById('total-diff-amount');
            const diffHandleRateEl = document.getElementById('diff-handle-rate');
            
            // 选中的差异记录ID数组
            let selectedDiffIds = [];
            // 所有对账差异数据
            let allReconciliationData = [];
            
            // 初始化日期控件
            function initDateControls() {
                const today = new Date();
                const formattedDate = today.toISOString().split('T')[0];
                document.getElementById('end-date').value = formattedDate;
                
                // 设置开始日期为本月第一天
                const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                document.getElementById('start-date').value = firstDayOfMonth.toISOString().split('T')[0];
            }
            
            // 自定义日期范围显示控制
            if (reconcilePeriod) {
                reconcilePeriod.addEventListener('change', function() {
                    customDateRange.style.display = this.value === 'custom' ? 'flex' : 'none';
                });
            }
            
            // 获取日期范围
            function getDateRange() {
                const period = reconcilePeriod ? reconcilePeriod.value : 'month';
                const today = new Date();
                let startDate, endDate;
                
                if (period === 'custom') {
                    startDate = document.getElementById('start-date').value;
                    endDate = document.getElementById('end-date').value;
                    if (!startDate || !endDate) {
                        alert('请选择完整的日期范围');
                        return null;
                    }
                } else {
                    endDate = today.toISOString().split('T')[0];
                    
                    switch (period) {
                        case 'month':
                            startDate = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
                            break;
                        case 'quarter':
                            const quarter = Math.floor(today.getMonth() / 3);
                            startDate = new Date(today.getFullYear(), quarter * 3, 1).toISOString().split('T')[0];
                            break;
                        case 'year':
                            startDate = new Date(today.getFullYear(), 0, 1).toISOString().split('T')[0];
                            break;
                        default:
                            startDate = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
                    }
                }
                
                return { startDate, endDate };
            }
            
            // 基于实际数据计算对账差异
            function calculateReconciliationData(dateRange) {
                // 从localStorage获取实际数据
                const bills = JSON.parse(localStorage.getItem(window.storagePrefix + "bills")) || [];
                const payments = JSON.parse(localStorage.getItem(window.storagePrefix + "payments")) || [];
                const orders = JSON.parse(localStorage.getItem(window.storagePrefix + "orders")) || [];
                
                const reconciliationData = [];
                let idCounter = 1;
                
                // 处理客户对账（账单与付款对比）
                bills.forEach(bill => {
                    // 检查账单日期是否在指定范围内
                    if (bill.createdDate) {
                        const billDate = new Date(bill.createdDate);
                        const startDate = new Date(dateRange.startDate);
                        const endDate = new Date(dateRange.endDate);
                        
                        if (billDate >= startDate && billDate <= endDate) {
                            // 查找与该账单相关的付款记录
                            const relatedPayments = payments.filter(payment => 
                                payment.type === 'customer' && 
                                payment.relatedInvoices && 
                                payment.relatedInvoices.some(invoice => invoice.billId === bill.billId)
                            );
                            
                            // 计算实际支付金额
                            const actualAmount = relatedPayments.reduce((sum, payment) => sum + parseFloat(payment.amount || 0), 0);
                            const systemAmount = parseFloat(bill.amount || 0);
                            const diffAmount = parseFloat((systemAmount - actualAmount).toFixed(2));
                            
                            // 确定差异类型
                            let diffType, reason, status;
                            if (diffAmount === 0) {
                                diffType = 'matched';
                                reason = '金额一致';
                                status = 'handled';
                            } else if (actualAmount === 0) {
                                diffType = 'no-payment';
                                reason = '客户未付款';
                                status = 'unhandled';
                            } else if (diffAmount < 0) {
                                diffType = 'overpayment';
                                reason = '客户多付，可能是预付款';
                                status = 'unhandled';
                            } else {
                                diffType = 'underpayment';
                                reason = '客户少付，需催收';
                                status = 'unhandled';
                            }
                            
                            // 查找相关订单信息
                            const relatedOrder = orders.find(order => order.orderNumber === bill.orderNumber);
                            
                            reconciliationData.push({
                                id: `RECON-CUST-${Date.now()}-${idCounter++}`,
                                type: 'customer',
                                orderNumber: bill.orderNumber || relatedOrder?.orderNumber || '',
                                party: bill.customer || '未知客户',
                                documentNumber: bill.invoiceNumber || '无发票号',
                                systemAmount: systemAmount,
                                actualAmount: actualAmount,
                                diffAmount: diffAmount,
                                diffType: diffType,
                                createdDate: bill.createdDate.split('T')[0],
                                lastTransactionDate: relatedPayments.length > 0 ? 
                                    new Date(Math.max(...relatedPayments.map(p => new Date(p.paymentDate)))).toISOString().split('T')[0] : 
                                    bill.createdDate.split('T')[0],
                                reason: reason,
                                status: status,
                                billId: bill.billId,
                                orderId: relatedOrder?.orderId || ''
                            });
                        }
                    }
                });
                
                // 处理电镀厂对账（付款记录分析）
                // 按电镀厂和相关订单分组
                const factoryPaymentsByGroup = {};
                
                payments.filter(p => p.type === 'factory').forEach(payment => {
                    const factoryKey = `${payment.electroplatingFactory || '未知电镀厂'}-${payment.relatedOrders?.join(',') || 'no-orders'}`;
                    if (!factoryPaymentsByGroup[factoryKey]) {
                        factoryPaymentsByGroup[factoryKey] = {
                            factory: payment.electroplatingFactory || '未知电镀厂',
                            relatedOrders: payment.relatedOrders || [],
                            payments: [],
                            totalPaid: 0,
                            paymentDate: payment.paymentDate
                        };
                    }
                    factoryPaymentsByGroup[factoryKey].payments.push(payment);
                    factoryPaymentsByGroup[factoryKey].totalPaid += parseFloat(payment.amount || 0);
                });
                
                // 分析每个电镀厂的付款情况
                Object.values(factoryPaymentsByGroup).forEach(group => {
                    // 获取该电镀厂相关订单的应付金额
                    let systemAmount = 0;
                    
                    // 1. 首先尝试从付款记录中获取应付金额（如果存在）
                    group.payments.forEach(payment => {
                        if (payment.payableAmount) {
                            systemAmount += parseFloat(payment.payableAmount);
                        }
                    });
                    
                    // 2. 如果没有明确的应付金额，则基于订单计算
                    if (systemAmount === 0) {
                        group.relatedOrders.forEach(orderId => {
                            const order = orders.find(o => o.orderId === orderId || o.orderNumber === orderId);
                            if (order) {
                                // 使用订单数量 * 电镀单价（优先使用订单中的电镀费用字段）
                                if (order.electroplatingCost) {
                                    systemAmount += parseFloat(order.electroplatingCost);
                                } else {
                                    // 回退方案：使用订单数量 * 单价 * 0.7（假设电镀费用占订单的70%）
                                    systemAmount += parseFloat(order.quantity || 0) * parseFloat(order.unitPrice || 10) * 0.7;
                                }
                            }
                        });
                    }
                    
                    // 3. 如果仍无法计算，使用已付款金额作为系统应付金额（最后回退）
                    if (systemAmount === 0) {
                        systemAmount = group.totalPaid;
                    }
                    
                    // 计算差异金额：应付金额 - 已付金额
                    const diffAmount = parseFloat((systemAmount - group.totalPaid).toFixed(2));
                    
                    // 确定差异类型
                    let diffType, reason, status;
                    if (diffAmount === 0) {
                        diffType = 'matched';
                        reason = '应付金额与实际付款金额一致';
                        status = 'handled';
                    } else if (group.totalPaid === 0) {
                        diffType = 'no-payment';
                        reason = '未向电镀厂付款';
                        status = 'unhandled';
                    } else if (diffAmount > 0) {
                        diffType = 'overpayment';
                        reason = `少付电镀厂 ¥${diffAmount.toFixed(2)}，需补付`;
                        status = 'unhandled';
                    } else {
                        diffType = 'underpayment';
                        reason = `多付电镀厂 ¥${Math.abs(diffAmount).toFixed(2)}，需退款`;
                        status = 'unhandled';
                    }
                    
                    // 获取最近的付款日期
                    const latestPaymentDate = group.payments.length > 0 ?
                        new Date(Math.max(...group.payments.map(p => new Date(p.paymentDate)))).toISOString().split('T')[0] :
                        new Date().toISOString().split('T')[0];
                    
                    reconciliationData.push({
                        id: `RECON-FACT-${Date.now()}-${idCounter++}`,
                        type: 'factory',
                        orderNumber: group.relatedOrders.length > 0 ? group.relatedOrders.join(', ') : '无关联订单',
                        party: group.factory,
                        documentNumber: group.payments.map(p => p.invoiceNumber).filter(Boolean).join(', ') || '无发票号',
                        systemAmount: systemAmount,
                        actualAmount: group.totalPaid,
                        diffAmount: diffAmount,
                        diffType: diffType,
                        createdDate: latestPaymentDate,
                        lastTransactionDate: latestPaymentDate,
                        reason: reason,
                        status: status
                    });
                });
                
                return reconciliationData;
            }
            
            // 开始对账
            if (reconcileBtn) {
                reconcileBtn.addEventListener('click', function() {
                    const dateRange = getDateRange();
                    if (!dateRange) return;
                    
                    // 模拟加载状态
                    reconcileBtn.disabled = true;
                    reconcileBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> 对账中...';
                    
                    // 异步对账过程
                    setTimeout(() => {
                        // 基于实际数据计算对账差异
                        allReconciliationData = calculateReconciliationData(dateRange);
                        
                        // 更新表格
                        updateReconciliationTable(allReconciliationData);
                        
                        // 更新统计信息
                        updateReconciliationStats(allReconciliationData);
                        
                        // 更新关联方筛选器选项
                        updatePartyFilterOptions(allReconciliationData);
                        
                        // 恢复按钮状态
                        reconcileBtn.disabled = false;
                        reconcileBtn.innerHTML = '<i class="fa fa-refresh"></i> 开始对账';
                        
                        // 显示成功消息
                        alert(`对账完成！共对账 ${allReconciliationData.length} 条记录，发现 ${allReconciliationData.filter(item => item.diffAmount !== 0).length} 条差异。`);
                    }, 1000);
                });
            }
            
            // 更新对账表格
            function updateReconciliationTable(data) {
                if (!reconcileTableBody) return;
                
                reconcileTableBody.innerHTML = '';
                
                if (data.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td colspan="14" class="table-cell text-center py-8 text-gray-medium">
                            未找到对账数据
                        </td>
                    `;
                    reconcileTableBody.appendChild(row);
                    batchActions.style.display = 'none';
                    return;
                }
                
                // 显示批量操作栏
                batchActions.style.display = 'flex';
                
                // 重置选中状态
                selectedDiffIds = [];
                updateSelectedCount();
                if (selectAllDiff) selectAllDiff.checked = false;
                
                // 添加数据行
                    data.forEach(item => {
                    const row = document.createElement('tr');
                    
                    // 根据差异类型和金额设置样式
                    let diffAmountClass = 'text-dark';
                    if (item.diffAmount > 0) {
                        diffAmountClass = 'text-danger';
                    } else if (item.diffAmount < 0) {
                        diffAmountClass = 'text-success';
                    }
                    
                    // 设置状态样式
                    let statusText, statusClass;
                    switch (item.status) {
                        case 'handled':
                            statusText = '已处理';
                            statusClass = 'bg-success/10 text-success';
                            break;
                        case 'partially-handled':
                            statusText = '部分处理';
                            statusClass = 'bg-warning/10 text-warning';
                            break;
                        default:
                            statusText = '未处理';
                            statusClass = 'bg-danger/10 text-danger';
                    }
                    
                    // 设置差异类型文本
                    let diffTypeText;
                    if (item.diffType === 'matched') {
                        diffTypeText = '金额一致';
                    } else if (item.type === 'customer') {
                        switch (item.diffType) {
                            case 'overpayment': diffTypeText = '客户多付'; break;
                            case 'underpayment': diffTypeText = '客户少付'; break;
                            case 'no-payment': diffTypeText = '未付款'; break;
                            default: diffTypeText = '其他差异';
                        }
                    } else {
                        // 电镀付款差异类型文本优化
                        switch (item.diffType) {
                            case 'overpayment': diffTypeText = '少付电镀厂'; break;
                            case 'underpayment': diffTypeText = '多付电镀厂'; break;
                            case 'no-payment': diffTypeText = '未付电镀厂'; break;
                            default: diffTypeText = '其他差异';
                        }
                    }
                    
                    row.innerHTML = `
                        <td class="table-cell">
                            <input type="checkbox" class="diff-checkbox" data-id="${item.id}">
                        </td>
                        <td class="table-cell">${item.type === 'customer' ? '客户收款' : '电镀厂付款'}</td>
                        <td class="table-cell">${item.orderNumber}</td>
                        <td class="table-cell">${item.party}</td>
                        <td class="table-cell">${item.documentNumber}</td>
                        <td class="table-cell">¥${item.systemAmount.toFixed(2)}</td>
                        <td class="table-cell">¥${item.actualAmount.toFixed(2)}</td>
                        <td class="table-cell ${diffAmountClass}">¥${item.diffAmount.toFixed(2)}</td>
                        <td class="table-cell">${diffTypeText}</td>
                        <td class="table-cell">${item.createdDate}</td>
                        <td class="table-cell">${item.lastTransactionDate}</td>
                        <td class="table-cell">${item.reason}</td>
                        <td class="table-cell">
                            <span class="px-2 py-1 rounded-full text-xs ${statusClass}">${statusText}</span>
                        </td>
                        <td class="table-cell">
                            <div class="flex gap-1">
                                <button class="btn btn-primary text-xs py-1 px-2" onclick="viewReconciliationDetail('${item.id}')">
                                    详情
                                </button>
                                <button class="btn btn-secondary text-xs py-1 px-2" onclick="handleReconciliation('${item.id}')">
                                    ${item.status === 'handled' ? '重新处理' : '处理'}
                                </button>
                            </div>
                        </td>
                    `;
                    
                    reconcileTableBody.appendChild(row);
                });
                
                // 添加复选框事件监听
                document.querySelectorAll('.diff-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        const id = this.getAttribute('data-id');
                        if (this.checked) {
                            selectedDiffIds.push(id);
                        } else {
                            selectedDiffIds = selectedDiffIds.filter(itemId => itemId !== id);
                        }
                        updateSelectedCount();
                    });
                });
                
                // 存储数据到全局变量
                window.allReconciliationData = data;
            }
            
            // 更新选中数量
            function updateSelectedCount() {
                if (selectedCount) {
                    selectedCount.textContent = selectedDiffIds.length;
                }
            }
            
            // 更新对账统计信息
            function updateReconciliationStats(data) {
                const totalRecords = data.length;
                const diffRecords = data.filter(item => item.diffAmount !== 0).length;
                const totalDiffAmount = data.reduce((sum, item) => sum + Math.abs(item.diffAmount), 0);
                const handledDiffRecords = data.filter(item => item.diffAmount !== 0 && item.status === 'handled').length;
                const handleRate = diffRecords > 0 ? Math.round((handledDiffRecords / diffRecords) * 100) : 100;
                
                if (totalReconciledEl) totalReconciledEl.textContent = totalRecords;
                if (diffRecordsEl) diffRecordsEl.textContent = diffRecords;
                if (totalDiffAmountEl) totalDiffAmountEl.textContent = `¥${totalDiffAmount.toFixed(2)}`;
                if (diffHandleRateEl) diffHandleRateEl.textContent = `${handleRate}%`;
            }
            
            // 更新关联方筛选器选项
            function updatePartyFilterOptions(data) {
                if (!diffPartyFilter) return;
                
                // 获取所有唯一的关联方
                const parties = [...new Set(data.map(item => item.party))];
                
                // 清空现有选项，保留"全部关联方"
                const allOption = diffPartyFilter.querySelector('option[value="all"]');
                diffPartyFilter.innerHTML = '';
                diffPartyFilter.appendChild(allOption);
                
                // 添加新选项
                parties.forEach(party => {
                    const option = document.createElement('option');
                    option.value = party;
                    option.textContent = party;
                    diffPartyFilter.appendChild(option);
                });
            }
            
            // 全选/取消全选
            if (selectAllDiff) {
                selectAllDiff.addEventListener('change', function() {
                    const checkboxes = document.querySelectorAll('.diff-checkbox');
                    
                    if (this.checked) {
                        // 全选
                        selectedDiffIds = [];
                        checkboxes.forEach(checkbox => {
                            checkbox.checked = true;
                            const id = checkbox.getAttribute('data-id');
                            selectedDiffIds.push(id);
                        });
                    } else {
                        // 取消全选
                        checkboxes.forEach(checkbox => {
                            checkbox.checked = false;
                        });
                        selectedDiffIds = [];
                    }
                    
                    updateSelectedCount();
                });
            }
            
            // 筛选对账数据
            if (filterReconcileBtn) {
                filterReconcileBtn.addEventListener('click', function() {
                    if (allReconciliationData.length === 0) {
                        alert('请先进行对账');
                        return;
                    }
                    
                    const status = diffStatusFilter ? diffStatusFilter.value : 'all';
                    const type = diffTypeFilter ? diffTypeFilter.value : 'all';
                    const party = diffPartyFilter ? diffPartyFilter.value : 'all';
                    const reconcileTypeVal = reconcileType ? reconcileType.value : 'all';
                    
                    // 应用筛选
                    const filteredData = allReconciliationData.filter(item => {
                        let match = true;
                        
                        if (status !== 'all' && item.status !== status) match = false;
                        if (type !== 'all' && item.diffType !== type) match = false;
                        if (party !== 'all' && item.party !== party) match = false;
                        if (reconcileTypeVal !== 'all' && item.type !== reconcileTypeVal) match = false;
                        
                        return match;
                    });
                    
                    // 更新表格
                    updateReconciliationTable(filteredData);
                });
            }
            
            // 重置筛选
            if (resetFilterBtn) {
                resetFilterBtn.addEventListener('click', function() {
                    if (diffStatusFilter) diffStatusFilter.value = 'all';
                    if (diffTypeFilter) diffTypeFilter.value = 'all';
                    if (diffPartyFilter) diffPartyFilter.value = 'all';
                    if (reconcileType) reconcileType.value = 'all';
                    
                    // 显示全部数据
                    updateReconciliationTable(allReconciliationData);
                });
            }
            
            // 批量标记已处理
            if (batchHandleBtn) {
                batchHandleBtn.addEventListener('click', function() {
                    if (selectedDiffIds.length === 0) {
                        alert('请选择要处理的记录');
                        return;
                    }
                    
                    if (confirm(`确定要将选中的 ${selectedDiffIds.length} 条记录标记为已处理吗？`)) {
                        // 更新数据状态
                        allReconciliationData = allReconciliationData.map(item => {
                            if (selectedDiffIds.includes(item.id)) {
                                return { ...item, status: 'handled' };
                            }
                            return item;
                        });
                        
                        // 重新应用当前筛选并更新表格
                        const status = diffStatusFilter ? diffStatusFilter.value : 'all';
                        const type = diffTypeFilter ? diffTypeFilter.value : 'all';
                        const party = diffPartyFilter ? diffPartyFilter.value : 'all';
                        const reconcileTypeVal = reconcileType ? reconcileType.value : 'all';
                        
                        const filteredData = allReconciliationData.filter(item => {
                            let match = true;
                            if (status !== 'all' && item.status !== status) match = false;
                            if (type !== 'all' && item.diffType !== type) match = false;
                            if (party !== 'all' && item.party !== party) match = false;
                            if (reconcileTypeVal !== 'all' && item.type !== reconcileTypeVal) match = false;
                            return match;
                        });
                        
                        updateReconciliationTable(filteredData);
                        updateReconciliationStats(allReconciliationData);
                        
                        alert('批量处理完成！');
                    }
                });
            }
            
            // 导出全部差异
            if (exportReconcileBtn) {
                exportReconcileBtn.addEventListener('click', function() {
                    if (allReconciliationData.length === 0) {
                        alert('请先进行对账');
                        return;
                    }
                    
                    alert('导出功能已触发，实际项目中这里会生成Excel或CSV文件');
                    // 实际项目中这里会实现真正的导出逻辑
                });
            }
            
            // 导出选中的差异
            if (batchExportBtn) {
                batchExportBtn.addEventListener('click', function() {
                    if (selectedDiffIds.length === 0) {
                        alert('请选择要导出的记录');
                        return;
                    }
                    
                    alert(`导出选中的 ${selectedDiffIds.length} 条记录，实际项目中这里会生成Excel或CSV文件`);
                    // 实际项目中这里会实现真正的导出逻辑
                });
            }
            
            // 初始化日期控件
            initDateControls();
            
            // 全局函数 - 查看对账详情
            window.viewReconciliationDetail = function(id) {
                const item = allReconciliationData.find(item => item.id === id);
                if (item) {
                    let message = `对账详情\n\n`;
                    message += `类型: ${item.type === 'customer' ? '客户收款' : '电镀厂付款'}\n`;
                    message += `订单编号: ${item.orderNumber}\n`;
                    message += `关联方: ${item.party}\n`;
                    message += `账单编号/发票号: ${item.documentNumber}\n`;
                    message += `系统金额: ¥${item.systemAmount.toFixed(2)}\n`;
                    message += `实际金额: ¥${item.actualAmount.toFixed(2)}\n`;
                    message += `差异金额: ¥${item.diffAmount.toFixed(2)}\n`;
                    message += `创建日期: ${item.createdDate}\n`;
                    message += `最后交易日期: ${item.lastTransactionDate}\n`;
                    message += `原因分析: ${item.reason}\n`;
                    message += `处理状态: ${item.status === 'handled' ? '已处理' : item.status === 'partially-handled' ? '部分处理' : '未处理'}`;
                    
                    alert(message);
                }
            };
            
            // 全局函数 - 处理对账差异
            window.handleReconciliation = function(id) {
                const item = allReconciliationData.find(item => item.id === id);
                if (item) {
                    const newStatus = item.status === 'handled' ? 'unhandled' : 'handled';
                    const actionText = newStatus === 'handled' ? '标记为已处理' : '标记为未处理';
                    
                    if (confirm(`确定要将此记录${actionText}吗？`)) {
                        // 更新数据
                        allReconciliationData = allReconciliationData.map(item => {
                            if (item.id === id) {
                                return { ...item, status: newStatus };
                            }
                            return item;
                        });
                        
                        // 重新应用当前筛选并更新表格
                        const status = diffStatusFilter ? diffStatusFilter.value : 'all';
                        const type = diffTypeFilter ? diffTypeFilter.value : 'all';
                        const party = diffPartyFilter ? diffPartyFilter.value : 'all';
                        const reconcileTypeVal = reconcileType ? reconcileType.value : 'all';
                        
                        const filteredData = allReconciliationData.filter(item => {
                            let match = true;
                            if (status !== 'all' && item.status !== status) match = false;
                            if (type !== 'all' && item.diffType !== type) match = false;
                            if (party !== 'all' && item.party !== party) match = false;
                            if (reconcileTypeVal !== 'all' && item.type !== reconcileTypeVal) match = false;
                            return match;
                        });
                        
                        updateReconciliationTable(filteredData);
                        updateReconciliationStats(allReconciliationData);
                        
                        alert('处理完成！');
                    }
                }
            };
            

            
            // 按订单编号汇总发货与收货记录的专用函数
            function getOrdersWithDeliveriesAndReceipts() {
                // 从localStorage获取数据
                const orders = JSON.parse(localStorage.getItem(window.storagePrefix + "orders")) || [];
                const deliveries = JSON.parse(localStorage.getItem(window.storagePrefix + "deliveries")) || [];
                const receipts = JSON.parse(localStorage.getItem(window.storagePrefix + "receipts")) || [];
                
                // 按订单编号汇总发货记录
                const orderDeliveriesMap = {};
                deliveries.forEach(delivery => {
                    const orderNumber = delivery.orderNumber || '';
                    if (!orderNumber) return;
                    
                    if (!orderDeliveriesMap[orderNumber]) {
                        orderDeliveriesMap[orderNumber] = [];
                    }
                    orderDeliveriesMap[orderNumber].push({
                        id: delivery.deliveryId,
                        date: delivery.deliveryDate,
                        rawQuantity: parseInt(delivery.rawQuantity || 0),
                        reworkQuantity: parseInt(delivery.reworkQuantity || 0),
                        scrapQuantity: parseInt(delivery.scrapQuantity || 0),
                        customer: delivery.customer,
                        product: delivery.product,
                        factory: delivery.factory
                    });
                });
                
                // 按订单编号汇总收货记录
                const orderReceiptsMap = {};
                receipts.forEach(receipt => {
                    const orderNumber = receipt.orderNumber || '';
                    if (!orderNumber) return;
                    
                    if (!orderReceiptsMap[orderNumber]) {
                        orderReceiptsMap[orderNumber] = [];
                    }
                    orderReceiptsMap[orderNumber].push({
                        id: receipt.receiptId,
                        date: receipt.receiptDate,
                        finishedQuantity: parseInt(receipt.finishedQuantity || 0),
                        reworkQuantity: parseInt(receipt.reworkQuantity || 0),
                        scrapQuantity: parseInt(receipt.scrapQuantity || 0),
                        customer: receipt.customer,
                        product: receipt.product,
                        factory: receipt.factory
                    });
                });
                
                // 构建汇总数据
                const result = [];
                orders.forEach(order => {
                    const orderNumber = order.orderNumber || order.orderId || '';
                    
                    // 汇总数量信息（与populateOrderSummary相同的汇总逻辑）
                    const totalRawQuantity = (orderDeliveriesMap[orderNumber] || []).reduce((sum, d) => sum + d.rawQuantity, 0);
                    const totalDeliveryScrap = (orderDeliveriesMap[orderNumber] || []).reduce((sum, d) => sum + d.scrapQuantity, 0);
                    const totalFinishedQuantity = (orderReceiptsMap[orderNumber] || []).reduce((sum, r) => sum + r.finishedQuantity, 0);
                    const totalReworkQuantity = (orderReceiptsMap[orderNumber] || []).reduce((sum, r) => sum + r.reworkQuantity, 0);
                    const totalDeliveryRework = (orderDeliveriesMap[orderNumber] || []).reduce((sum, d) => sum + d.reworkQuantity, 0);
                    const totalReceiptScrap = (orderReceiptsMap[orderNumber] || []).reduce((sum, r) => sum + r.scrapQuantity, 0);
                    
                    const goodProductQuantity = totalFinishedQuantity + totalReworkQuantity - totalDeliveryRework;
                    const totalScrapQuantity = totalDeliveryScrap + totalReceiptScrap;
                    const orderQuantity = parseInt(order.quantity || 0);
                    
                    // 构建汇总对象
                    result.push({
                        orderNumber,
                        orderInfo: {
                            id: order.orderId,
                            customer: order.customer,
                            product: order.product,
                            quantity: orderQuantity,
                            deliveryDate: order.deliveryDate,
                            factory: order.electroplatingFactory
                        },
                        summary: {
                            totalRawQuantity,
                            goodProductQuantity,
                            totalScrapQuantity,
                            retentionQuantity: totalRawQuantity - goodProductQuantity - totalScrapQuantity,
                            inventoryQuantity: goodProductQuantity - orderQuantity,
                            settlementQuantity: goodProductQuantity > orderQuantity ? orderQuantity : goodProductQuantity,
                            status: totalRawQuantity === 0 ? 'pending' : (goodProductQuantity < orderQuantity ? 'processing' : 'completed')
                        },
                        deliveries: orderDeliveriesMap[orderNumber] || [],
                        receipts: orderReceiptsMap[orderNumber] || []
                    });
                });
                
                return result;
            }
            
            // 显示订单发货收货汇总信息
            function showOrderSummaryDetail(orderNumber) {
                const summaryData = getOrdersWithDeliveriesAndReceipts();
                const orderSummary = summaryData.find(item => item.orderNumber === orderNumber);
                
                if (!orderSummary) {
                    alert('未找到订单编号: ' + orderNumber);
                    return;
                }
                
                // 构建详细信息字符串
                let details = `订单汇总详情\n\n`;
                details += `订单编号: ${orderSummary.orderNumber}\n`;
                details += `客户: ${orderSummary.orderInfo.customer || '-'}\n`;
                details += `产品: ${orderSummary.orderInfo.product || '-'}\n`;
                details += `订单数量: ${orderSummary.orderInfo.quantity || 0}\n`;
                details += `交货期: ${orderSummary.orderInfo.deliveryDate || '-'}\n\n`;
                
                // 汇总统计
                details += `汇总统计:\n`;
                details += `  总发货毛坯数量: ${orderSummary.summary.totalRawQuantity}\n`;
                details += `  良品数量: ${orderSummary.summary.goodProductQuantity}\n`;
                details += `  报废数量: ${orderSummary.summary.totalScrapQuantity}\n`;
                details += `  滞留数量: ${orderSummary.summary.retentionQuantity}\n`;
                details += `  库存数量: ${orderSummary.summary.inventoryQuantity}\n`;
                details += `  结算数量: ${orderSummary.summary.settlementQuantity}\n`;
                details += `  状态: ${orderSummary.summary.status === 'pending' ? '待电镀' : (orderSummary.summary.status === 'processing' ? '电镀中' : '已完成')}\n\n`;
                
                // 发货记录
                details += `发货记录 (${orderSummary.deliveries.length}条):\n`;
                if (orderSummary.deliveries.length > 0) {
                    orderSummary.deliveries.forEach((delivery, index) => {
                        details += `  ${index + 1}. 日期: ${delivery.date || '-'}, 毛坯: ${delivery.rawQuantity}, 返镀: ${delivery.reworkQuantity}, 报废: ${delivery.scrapQuantity}\n`;
                    });
                } else {
                    details += `  无发货记录\n`;
                }
                details += `\n`;
                
                // 收货记录
                details += `收货记录 (${orderSummary.receipts.length}条):\n`;
                if (orderSummary.receipts.length > 0) {
                    orderSummary.receipts.forEach((receipt, index) => {
                        details += `  ${index + 1}. 日期: ${receipt.date || '-'}, 成品: ${receipt.finishedQuantity}, 返修: ${receipt.reworkQuantity}, 报废: ${receipt.scrapQuantity}\n`;
                    });
                } else {
                    details += `  无收货记录\n`;
                }
                
                // 显示详情（可以根据需要改为更美观的模态框）
                alert(details);
            }
            
            // 分页相关的全局变量
            let summaryCurrentPage = 1;
            let summaryPageSize = 10;
            let summaryTotalPages = 1;
            let summaryFilteredOrders = [];
            
            // 从订单计划提取数据到订单汇总表格
            function populateOrderSummary() {
                // 获取订单汇总表格的tbody元素
                const summaryTableBody = document.querySelector('#summary-module tbody');
                if (!summaryTableBody) return;
                
                // 从localStorage获取订单数据、发货记录数据和收货记录数据
                const orders = JSON.parse(localStorage.getItem(window.storagePrefix + "orders")) || [];
                const deliveries = JSON.parse(localStorage.getItem(window.storagePrefix + "deliveries")) || [];
                const receipts = JSON.parse(localStorage.getItem(window.storagePrefix + "receipts")) || [];
                
                // 对发货记录中的毛坯数量按订单编号进行汇总
                const rawQuantitySummary = {};
                deliveries.forEach(delivery => {
                    const orderNumber = delivery.orderNumber || '';
                    const rawQty = parseInt(delivery.rawQuantity || 0);
                    if (orderNumber && !isNaN(rawQty)) {
                        if (!rawQuantitySummary[orderNumber]) {
                            rawQuantitySummary[orderNumber] = 0;
                        }
                        rawQuantitySummary[orderNumber] += rawQty;
                    }
                });
                
                // 对发货记录中的报废数量按订单编号进行汇总
                const deliveryScrapSummary = {};
                deliveries.forEach(delivery => {
                    const orderNumber = delivery.orderNumber || '';
                    const scrapQty = parseInt(delivery.scrapQuantity || 0);
                    if (orderNumber && !isNaN(scrapQty)) {
                        if (!deliveryScrapSummary[orderNumber]) {
                            deliveryScrapSummary[orderNumber] = 0;
                        }
                        deliveryScrapSummary[orderNumber] += scrapQty;
                    }
                });
                
                // 对收货记录中的报废数量按订单编号进行汇总
                const receiptScrapSummary = {};
                receipts.forEach(receipt => {
                    const orderNumber = receipt.orderNumber || '';
                    const scrapQty = parseInt(receipt.scrapQuantity || 0);
                    if (orderNumber && !isNaN(scrapQty)) {
                        if (!receiptScrapSummary[orderNumber]) {
                            receiptScrapSummary[orderNumber] = 0;
                        }
                        receiptScrapSummary[orderNumber] += scrapQty;
                    }
                });
                
                // 对收货记录中的成品数量按订单编号进行汇总
                const finishedQuantitySummary = {};
                receipts.forEach(receipt => {
                    const orderNumber = receipt.orderNumber || '';
                    const finishedQty = parseInt(receipt.finishedQuantity || 0);
                    if (orderNumber && !isNaN(finishedQty)) {
                        if (!finishedQuantitySummary[orderNumber]) {
                            finishedQuantitySummary[orderNumber] = 0;
                        }
                        finishedQuantitySummary[orderNumber] += finishedQty;
                    }
                });
                
                // 对收货记录中的返修数量按订单编号进行汇总
                const reworkQuantitySummary = {};
                receipts.forEach(receipt => {
                    const orderNumber = receipt.orderNumber || '';
                    const reworkQty = parseInt(receipt.reworkQuantity || 0);
                    if (orderNumber && !isNaN(reworkQty)) {
                        if (!reworkQuantitySummary[orderNumber]) {
                            reworkQuantitySummary[orderNumber] = 0;
                        }
                        reworkQuantitySummary[orderNumber] += reworkQty;
                    }
                });
                
                // 对发货记录中的返镀数量按订单编号进行汇总
                const returnPlatingSummary = {};
                deliveries.forEach(delivery => {
                    const orderNumber = delivery.orderNumber || '';
                    // 根据系统设计，返镀数量可能存储在reworkQuantity字段
                    const returnPlatingQty = parseInt(delivery.reworkQuantity || 0);
                    if (orderNumber && !isNaN(returnPlatingQty)) {
                        if (!returnPlatingSummary[orderNumber]) {
                            returnPlatingSummary[orderNumber] = 0;
                        }
                        returnPlatingSummary[orderNumber] += returnPlatingQty;
                    }
                });
                
                // 计算订单状态统计数据
                let pendingPlatingCount = 0;
                let pendingPlatingAmount = 0;
                let platingCount = 0;
                let platingAmount = 0;
                let completedCount = 0;
                let completedAmount = 0;
                
                // 总体统计数据
                let totalOrderCount = orders.length;
                let totalGoodProductCount = 0;
                let totalInventoryCount = 0;
                let totalStayCount = 0;
                let totalScrapCount = 0;
                
                // 遍历订单计算各状态数量
                orders.forEach(order => {
                    const orderNumber = order.orderNumber || order.orderId || '';
                    const orderQuantity = parseInt(order.quantity || 0);
                    const totalRawQuantity = rawQuantitySummary[orderNumber] || 0;
                    const goodProductQuantity = (finishedQuantitySummary[orderNumber] || 0) + 
                                              (reworkQuantitySummary[orderNumber] || 0) - 
                                              (returnPlatingSummary[orderNumber] || 0);
                
                    if (totalRawQuantity === 0) {
                        // 待电镀
                        pendingPlatingCount++;
                        pendingPlatingAmount += orderQuantity;
                    } else if (goodProductQuantity < orderQuantity) {
                        // 电镀中
                        platingCount++;
                        platingAmount += orderQuantity;
                    } else {
                        // 已完成
                        completedCount++;
                        completedAmount += orderQuantity;
                    }
                });
                
                // 更新统计卡片数据
                document.getElementById('pending-plating-count').textContent = pendingPlatingCount;
                document.getElementById('pending-plating-amount').textContent = pendingPlatingAmount;
                document.getElementById('plating-count').textContent = platingCount;
                document.getElementById('plating-amount').textContent = platingAmount;
                document.getElementById('completed-count').textContent = completedCount;
                document.getElementById('completed-amount').textContent = completedAmount;
                
                // 按交货期倒序排序订单数据
                const sortedOrders = [...orders].sort((a, b) => {
                    const dateA = a.deliveryDate ? new Date(a.deliveryDate) : new Date(0);
                    const dateB = b.deliveryDate ? new Date(b.deliveryDate) : new Date(0);
                    return dateB - dateA;
                });
                
                // 保存排序后的订单
                summaryFilteredOrders = sortedOrders;
                
                // 清空表格内容
                summaryTableBody.innerHTML = '';
                
                if (sortedOrders.length === 0) {
                    // 如果没有订单数据，显示提示信息
                    summaryTableBody.innerHTML = '<tr><td colspan="16" class="table-cell text-center py-8 text-gray-medium">暂无订单汇总数据</td></tr>';
                } else {
                    // 使用所有订单数据，不分页
                    const currentPageOrders = sortedOrders;
                    
                    // 遍历当前页的订单数据，填充到汇总表格并计算总体统计
                    currentPageOrders.forEach(order => {
                        // 创建表格行
                        const row = document.createElement('tr');
                        
                        // 获取当前订单的汇总数据
                        const orderNumber = order.orderNumber || order.orderId || '';
                        const totalRawQuantity = rawQuantitySummary[orderNumber] || 0;
                        // 计算总报废数量：发货报废数量 + 收货报废数量
                        const totalScrapQuantity = (deliveryScrapSummary[orderNumber] || 0) + (receiptScrapSummary[orderNumber] || 0);
                        
                        // 获取成品数量、返修数量和返镀数量
                        const totalFinishedQuantity = finishedQuantitySummary[orderNumber] || 0;
                        const totalReworkQuantity = reworkQuantitySummary[orderNumber] || 0;
                        const totalReturnPlatingQuantity = returnPlatingSummary[orderNumber] || 0;
                        
                        // 计算良品数量：成品数量 + 返修数量 - 返镀数量
                        const goodProductQuantity = totalFinishedQuantity + totalReworkQuantity - totalReturnPlatingQuantity;
                        
                        // 计算滞留数量：毛坯数量 - 良品数量 - 报废数量
                        const retentionQuantity = totalRawQuantity - goodProductQuantity - totalScrapQuantity;
                        
                        // 计算库存数量：良品数量 - 订单数量
                        const inventoryQuantity = goodProductQuantity - parseInt(order.quantity || 0);
                        
                        // 计算结算数量：当良品数量大于订单数量时，结算数量等于订单数量；否则等于良品数量
                        const orderQuantity = parseInt(order.quantity || 0);
                        const settlementQuantity = goodProductQuantity > orderQuantity ? orderQuantity : goodProductQuantity;
                        
                        // 累加总体统计数据
                        totalGoodProductCount += goodProductQuantity;
                        totalInventoryCount += inventoryQuantity;
                        totalStayCount += retentionQuantity;
                        totalScrapCount += totalScrapQuantity;
                        
                        // 填充数据，注意映射正确的字段名
                        row.innerHTML = `
                            <td class="table-cell"><input type="checkbox" class="rounded text-primary focus:ring-primary summary-checkbox" data-id="${order.orderId}"></td>
                            <td class="table-cell">${getStyledFactoryHTML(order.electroplatingFactory)}</td>
                            <td class="table-cell">
                                <span class="order-number-link cursor-pointer text-primary hover:underline" data-order-number="${orderNumber}">${orderNumber}</span>
                            </td>
                            <td class="table-cell">${order.customer || ''}</td>
                            <td class="table-cell">${order.product || ''}</td>
                            <td class="table-cell">${order.quantity || ''}</td>
                            <td class="table-cell">${order.deliveryDate || ''}</td> <!-- 交货期 -->
                            <td class="table-cell" title="还缺毛坯数量为：${Math.max(0, orderQuantity - totalRawQuantity)}">${totalRawQuantity}</td> <!-- 汇总后的毛坯数量 -->
                            <td class="table-cell">${goodProductQuantity}</td> <!-- 良品数量 -->
                            <td class="table-cell">${inventoryQuantity}</td> <!-- 库存数量 -->
                            <td class="table-cell">${totalScrapQuantity}</td> <!-- 汇总后的报废数量 -->
                            <td class="table-cell">${retentionQuantity}</td> <!-- 滞留数量 -->
                            <td class="table-cell">${settlementQuantity}</td> <!-- 结算数量 -->
                            <td class="table-cell">
                                ${totalRawQuantity === 0 ? '<span style="background-color: #e74c3c; color: white; padding: 2px 8px; border-radius: 4px; font-weight: 500;">待电镀</span>' : (goodProductQuantity < parseInt(order.quantity || 0) ? '<span style="background-color: #f39c12; color: white; padding: 2px 8px; border-radius: 4px; font-weight: 500;">电镀中</span>' : '<span style="background-color: #27ae60; color: white; padding: 2px 8px; border-radius: 4px; font-weight: 500;">已完成</span>')}
                            </td> <!-- 状态 -->
                            <td class="table-cell" style="min-width: 200px;">
                                <textarea class="edit-remark w-full min-w-[180px] p-2 border rounded focus:outline-none focus:ring-2 focus:ring-primary" 
                                          data-id="${order.orderId}" 
                                          rows="1" 
                                          placeholder="点击编辑备注">${order.remark || ''}</textarea>
                            </td>
                            <td class="table-cell">
                                <button class="btn btn-sm btn-info view-order-details" data-order-number="${orderNumber}">
                                    查看明细
                                </button>
                            </td>
                        `;
                        
                        // 添加行到表格
                        summaryTableBody.appendChild(row);
                    });
                    
                    // 为订单编号链接添加点击事件监听器
                    document.querySelectorAll('.order-number-link').forEach(link => {
                        link.addEventListener('click', function() {
                            const orderNumber = this.getAttribute('data-order-number');
                            showOrderSummaryDetail(orderNumber);
                        });
                    });
                    
                    // 为查看明细按钮添加点击事件监听器
                    document.querySelectorAll('.view-order-details').forEach(button => {
                        button.addEventListener('click', function() {
                            const orderNumber = this.getAttribute('data-order-number');
                            showOrderSummaryDetail(orderNumber);
                        });
                    });
                    
                    // 查看按钮已移除，相关事件监听器也已移除
                    
                    // 为备注文本框添加保存功能
                    document.querySelectorAll('.edit-remark').forEach(textarea => {
                        // 自动调整文本框高度
                        textarea.addEventListener('input', function() {
                            this.style.height = 'auto';
                            this.style.height = (this.scrollHeight) + 'px';
                        });
                        
                        // 失去焦点时保存备注
                        textarea.addEventListener('blur', function() {
                            const orderId = this.getAttribute('data-id');
                            const newRemark = this.value;
                            
                            // 保存到localStorage
                            const orders = JSON.parse(localStorage.getItem(window.storagePrefix + "orders")) || [];
                            const orderIndex = orders.findIndex(o => o.orderId === orderId);
                            
                            if (orderIndex !== -1) {
                                orders[orderIndex].remark = newRemark;
                                localStorage.setItem(window.storagePrefix + "orders", JSON.stringify(orders));
                            }
                        });
                    });
                    
                    // 更新全选功能
                    updateSelectAllCheckbox();
                }
                
                // 更新数据概览模块中的统计卡片数据
                document.getElementById('total-order-count').textContent = totalOrderCount;
                document.getElementById('total-good-product-count').textContent = totalGoodProductCount;
                document.getElementById('total-inventory-count').textContent = totalInventoryCount;
                document.getElementById('total-stay-count').textContent = totalStayCount;
                document.getElementById('total-scrap-count').textContent = totalScrapCount;
            }
            

            
            // 设置全选复选框功能
            function setupSelectAllCheckbox() {
                const selectAllCheckbox = document.getElementById('select-all-summary');
                if (selectAllCheckbox) {
                    selectAllCheckbox.addEventListener('change', function() {
                        const isChecked = this.checked;
                        // 选择或取消选择所有行内复选框
                        document.querySelectorAll('.summary-checkbox').forEach(checkbox => {
                            checkbox.checked = isChecked;
                        });
                    });
                }
            }
            
            // 更新全选复选框状态
            function updateSelectAllCheckbox() {
                const selectAllCheckbox = document.getElementById('select-all-summary');
                const checkboxes = document.querySelectorAll('.summary-checkbox');
                
                if (selectAllCheckbox && checkboxes.length > 0) {
                    const allChecked = Array.from(checkboxes).every(checkbox => checkbox.checked);
                    const anyChecked = Array.from(checkboxes).some(checkbox => checkbox.checked);
                    
                    selectAllCheckbox.checked = allChecked;
                    selectAllCheckbox.indeterminate = anyChecked && !allChecked;
                }
            }
            
            // 为行内复选框添加事件监听
            function setupRowCheckboxes() {
                // 使用事件委托监听行内复选框变化
                const summaryTableBody = document.querySelector('#summary-module tbody');
                if (summaryTableBody) {
                    summaryTableBody.addEventListener('change', function(event) {
                        if (event.target.classList.contains('summary-checkbox')) {
                            updateSelectAllCheckbox();
                        }
                    });
                }
            }
            
            // 初始化订单汇总功能
            function initSummaryModule() {
                setupSelectAllCheckbox();
                setupRowCheckboxes();
            }
            
            // 同步已完成订单到账单管理
            function syncCompletedOrdersToBills() {
                // 从localStorage获取订单数据、发货记录数据和收货记录数据
                const orders = JSON.parse(localStorage.getItem(window.storagePrefix + "orders")) || [];
                const deliveries = JSON.parse(localStorage.getItem(window.storagePrefix + "deliveries")) || [];
                const receipts = JSON.parse(localStorage.getItem(window.storagePrefix + "receipts")) || [];
                let bills = JSON.parse(localStorage.getItem(window.storagePrefix + "bills")) || [];
                
                // 对发货记录中的毛坯数量按订单编号进行汇总
                const rawQuantitySummary = {};
                deliveries.forEach(delivery => {
                    const orderNumber = delivery.orderNumber || '';
                    const rawQty = parseInt(delivery.rawQuantity || 0);
                    if (orderNumber && !isNaN(rawQty)) {
                        if (!rawQuantitySummary[orderNumber]) {
                            rawQuantitySummary[orderNumber] = 0;
                        }
                        rawQuantitySummary[orderNumber] += rawQty;
                    }
                });
                
                // 对收货记录中的成品数量按订单编号进行汇总
                const finishedQuantitySummary = {};
                receipts.forEach(receipt => {
                    const orderNumber = receipt.orderNumber || '';
                    const finishedQty = parseInt(receipt.finishedQuantity || 0);
                    if (orderNumber && !isNaN(finishedQty)) {
                        if (!finishedQuantitySummary[orderNumber]) {
                            finishedQuantitySummary[orderNumber] = 0;
                        }
                        finishedQuantitySummary[orderNumber] += finishedQty;
                    }
                });
                
                // 对收货记录中的返修数量按订单编号进行汇总
                const reworkQuantitySummary = {};
                receipts.forEach(receipt => {
                    const orderNumber = receipt.orderNumber || '';
                    const reworkQty = parseInt(receipt.reworkQuantity || 0);
                    if (orderNumber && !isNaN(reworkQty)) {
                        if (!reworkQuantitySummary[orderNumber]) {
                            reworkQuantitySummary[orderNumber] = 0;
                        }
                        reworkQuantitySummary[orderNumber] += reworkQty;
                    }
                });
                
                // 对发货记录中的返镀数量按订单编号进行汇总
                const returnPlatingSummary = {};
                deliveries.forEach(delivery => {
                    const orderNumber = delivery.orderNumber || '';
                    const returnPlatingQty = parseInt(delivery.reworkQuantity || 0);
                    if (orderNumber && !isNaN(returnPlatingQty)) {
                        if (!returnPlatingSummary[orderNumber]) {
                            returnPlatingSummary[orderNumber] = 0;
                        }
                        returnPlatingSummary[orderNumber] += returnPlatingQty;
                    }
                });
                
                // 筛选已完成的订单并添加到账单
                let syncedCount = 0;
                orders.forEach(order => {
                    const orderNumber = order.orderNumber || order.orderId || '';
                    const totalRawQuantity = rawQuantitySummary[orderNumber] || 0;
                    const goodProductQuantity = (finishedQuantitySummary[orderNumber] || 0) + 
                                              (reworkQuantitySummary[orderNumber] || 0) - 
                                              (returnPlatingSummary[orderNumber] || 0);
                    const orderQuantity = parseInt(order.quantity || 0);
                    
                    // 使用与订单汇总表格相同的逻辑计算订单状态
                    let status = '';
                    if (totalRawQuantity === 0) {
                        status = '待电镀';
                    } else if (goodProductQuantity < orderQuantity) {
                        status = '电镀中';
                    } else {
                        status = '已完成';
                    }
                    
                    // 只处理已完成的订单，并且检查是否已经同步过
                    if (status === '已完成') {
                        const existingBill = bills.find(bill => bill.orderNumber === orderNumber);
                        if (!existingBill) {
                            // 对发货记录中的报废数量按订单编号进行汇总
                            const deliveryScrapSummary = {};
                            deliveries.forEach(delivery => {
                                const deliveryOrderNumber = delivery.orderNumber || '';
                                const scrapQty = parseInt(delivery.scrapQuantity || 0);
                                if (deliveryOrderNumber && !isNaN(scrapQty)) {
                                    if (!deliveryScrapSummary[deliveryOrderNumber]) {
                                        deliveryScrapSummary[deliveryOrderNumber] = 0;
                                    }
                                    deliveryScrapSummary[deliveryOrderNumber] += scrapQty;
                                }
                            });
                            
                            // 对收货记录中的报废数量按订单编号进行汇总
                            const receiptScrapSummary = {};
                            receipts.forEach(receipt => {
                                const receiptOrderNumber = receipt.orderNumber || '';
                                const scrapQty = parseInt(receipt.scrapQuantity || 0);
                                if (receiptOrderNumber && !isNaN(scrapQty)) {
                                    if (!receiptScrapSummary[receiptOrderNumber]) {
                                        receiptScrapSummary[receiptOrderNumber] = 0;
                                    }
                                    receiptScrapSummary[receiptOrderNumber] += scrapQty;
                                }
                            });
                            
                            // 计算总报废数量：发货报废数量 + 收货报废数量
                            const totalScrapQuantity = (deliveryScrapSummary[orderNumber] || 0) + (receiptScrapSummary[orderNumber] || 0);
                            
                            // 计算滞留数量：毛坯数量 - 良品数量 - 报废数量
                            const retentionQuantity = (rawQuantitySummary[orderNumber] || 0) - goodProductQuantity - totalScrapQuantity;
                            
                            // 结算数量：直接使用与订单汇总表格相同的逻辑
                            // 即"滞留数量"后面一列的"结算数值"
                            const orderQuantity = parseInt(order.quantity || 0);
                            const settlementQuantity = goodProductQuantity > orderQuantity ? orderQuantity : goodProductQuantity;
                            
                            // 计算扣款金额：扣款 = (报废数量 - 订单数量 * 千分之三) * 60
                            const deduction = Math.max(0, (totalScrapQuantity - orderQuantity * 0.003) * 60);
                            
                            // 创建新的账单记录
                            const newBill = {
                                id: 'BILL-' + Date.now() + '-' + Math.floor(Math.random() * 1000),
                                electroplatingFactory: order.electroplatingFactory || '',
                                orderNumber: orderNumber,
                                customer: order.customer || '',
                                product: order.product || '',
                                settlementQuantity: settlementQuantity,
                                unitPrice: order.unitPrice || 0,
                                deduction: deduction,
                                amount: settlementQuantity * (order.unitPrice || 0) - deduction,
                                orderStatus: status,
                                billStatus: 'unpaid',
                                invoiceDate: '',
                                invoiceNumber: '',
                                remark: order.remark || '',
                                createDate: new Date().toISOString().split('T')[0]
                            };
                            
                            bills.push(newBill);
                            syncedCount++;
                        }
                    }
                });
                
                // 数据迁移：将旧的settleQuantity字段转换为settlementQuantity
                bills = bills.map(bill => {
                    if (bill.settleQuantity !== undefined && bill.settlementQuantity === undefined) {
                        return {
                            ...bill,
                            settlementQuantity: bill.settleQuantity
                        };
                    }
                    return bill;
                });
                
                // 保存账单数据到localStorage
                localStorage.setItem(window.storagePrefix + "bills", JSON.stringify(bills));
                
                // 刷新账单表格
                loadBillsTable();
                // 确保统计卡片更新
                if (typeof updateFinanceStatistics === 'function') {
                    updateFinanceStatistics();
                }
                
                return syncedCount;
            }
            
            // 加载账单表格数据
            function loadBillsTable() {
                let bills = JSON.parse(localStorage.getItem(window.storagePrefix + "bills")) || [];
                
                // 数据迁移：将旧的settleQuantity字段转换为settlementQuantity
                bills = bills.map(bill => {
                    if (bill.settleQuantity !== undefined && bill.settlementQuantity === undefined) {
                        return {
                            ...bill,
                            settlementQuantity: bill.settleQuantity
                        };
                    }
                    return bill;
                });
                
                // 保存迁移后的数据
                localStorage.setItem(window.storagePrefix + "bills", JSON.stringify(bills));
                
                // 更新结算对账统计卡片
                if (typeof updateFinanceStatistics === 'function') {
                    updateFinanceStatistics();
                }
                

                
                const billsTableBody = document.querySelector('#bills-submodule tbody');
                
                if (!billsTableBody) return;
                
                if (bills.length === 0) {
                    billsTableBody.innerHTML = `
                        <tr>
                            <td colspan="14" class="table-cell text-center py-8 text-gray-medium">
                                暂无账单数据
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                // 清空表格
                billsTableBody.innerHTML = '';
                
                // 添加账单数据到表格
                bills.forEach((bill, index) => {
                            const row = document.createElement('tr');
                            // 判断是否禁用复选框（已支付的账单禁用）
                            const isDisabled = bill.billStatus === 'paid';
                            row.innerHTML = `
                                <td class="table-cell">
                                    <input 
                                        type="checkbox" 
                                        class="bill-checkbox ${isDisabled ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer'}" 
                                        data-index="${index}" 
                                        data-invoice="${bill.invoiceNumber || ''}"
                                        ${isDisabled ? 'disabled' : ''}
                                    >
                                </td>
                                <td class="table-cell">${getStyledFactoryHTML(bill.electroplatingFactory)}</td>
                        <td class="table-cell">${bill.orderNumber}</td>
                        <td class="table-cell">${bill.customer}</td>
                        <td class="table-cell">${bill.product}</td>
                        <td class="table-cell">${bill.settlementQuantity}</td>
                        <td class="table-cell">${bill.unitPrice}</td>
                        <td class="table-cell">${bill.deduction}</td>
                        <td class="table-cell">${bill.amount}</td>
                        <td class="table-cell">
                            <span class="badge badge-success">${bill.orderStatus}</span>
                        </td>
                        <td class="table-cell">
                            <span class="badge ${bill.billStatus === 'paid' ? 'badge-success' : bill.billStatus === 'unpaid' ? 'badge-warning' : 'badge-danger'}">
                                ${bill.billStatus === 'paid' ? '已支付' : bill.billStatus === 'unpaid' ? '待支付' : '逾期'}
                            </span>
                        </td>
                        <td class="table-cell">${bill.invoiceDate || '-'}</td>
                        <td class="table-cell">${bill.invoiceNumber || '-'}</td>
                        <td class="table-cell">${bill.remark || '-'}</td>
                        <td class="table-cell">
                            <div class="flex gap-2">
                                <button class="text-primary hover:text-accent edit-bill-btn" title="编辑" data-index="${index}">
                                    <i class="fa fa-edit"></i>
                                </button>
                                <button class="text-danger hover:text-dark delete-bill-btn" title="删除" data-index="${index}">
                                    <i class="fa fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    billsTableBody.appendChild(row);
                });
                
                // 为编辑按钮添加事件监听器
                document.querySelectorAll('.edit-bill-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const index = parseInt(this.getAttribute('data-index'));
                        editBill(index);
                    });
                });
                
                // 为删除按钮添加事件监听器
                document.querySelectorAll('.delete-bill-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const index = parseInt(this.getAttribute('data-index'));
                        deleteBill(index);
                    });
                });
                
                // 全选/取消全选功能
                const selectAllCheckbox = document.getElementById('select-all-bills');
                if (selectAllCheckbox) {
                    selectAllCheckbox.addEventListener('change', function() {
                        const isChecked = this.checked;
                        document.querySelectorAll('.bill-checkbox:not(:disabled)').forEach(checkbox => {
                            checkbox.checked = isChecked;
                        });
                    });
                }
                
                // 单个复选框改变时，检查是否需要更新全选框状态
                document.querySelectorAll('.bill-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        updateSelectAllStatus();
                    });
                });
                
                // 更新全选框状态
                function updateSelectAllStatus() {
                    const totalCheckboxes = document.querySelectorAll('.bill-checkbox:not(:disabled)').length;
                    const checkedCheckboxes = document.querySelectorAll('.bill-checkbox:not(:disabled):checked').length;
                    const selectAllCheckbox = document.getElementById('select-all-bills');
                    if (selectAllCheckbox) {
                        selectAllCheckbox.checked = totalCheckboxes > 0 && totalCheckboxes === checkedCheckboxes;
                        selectAllCheckbox.indeterminate = checkedCheckboxes > 0 && checkedCheckboxes < totalCheckboxes;
                    }
                }
            }
            
            // 在订单汇总模块添加同步按钮
            // 编辑账单函数
            function editBill(index) {
                const bills = JSON.parse(localStorage.getItem(window.storagePrefix + "bills")) || [];
                const bill = bills[index];
                
                if (!bill) return;
                
                // 创建编辑表单模态框
                const modalHTML = `
                <div id="edit-bill-modal" class="modal-overlay">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">编辑账单</h3>
                            <button id="close-modal-btn" class="modal-close">×</button>
                        </div>
                        <div class="modal-body">
                            <form id="edit-bill-form">
                                <div class="form-group">
                                    <label>电镀厂</label>
                                    <input type="text" name="electroplatingFactory" value="${bill.electroplatingFactory}" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label>订单号</label>
                                    <input type="text" name="orderNumber" value="${bill.orderNumber}" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label>客户</label>
                                    <input type="text" name="customer" value="${bill.customer}" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label>产品</label>
                                    <input type="text" name="product" value="${bill.product}" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label>结算数量</label>
                                    <input type="number" name="settlementQuantity" value="${bill.settlementQuantity}" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label>单价</label>
                                    <input type="number" step="0.01" name="unitPrice" value="${bill.unitPrice}" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label>扣款</label>
                                    <input type="number" step="0.01" name="deduction" value="${bill.deduction || 0}" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label>账单状态</label>
                                    <select name="billStatus" class="form-control">
                                        <option value="unpaid" ${bill.billStatus === 'unpaid' ? 'selected' : ''}>待支付</option>
                                        <option value="paid" ${bill.billStatus === 'paid' ? 'selected' : ''}>已支付</option>
                                        <option value="overdue" ${bill.billStatus === 'overdue' ? 'selected' : ''}>逾期</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>发票日期</label>
                                    <input type="date" name="invoiceDate" value="${bill.invoiceDate || ''}" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label>发票号</label>
                                    <input type="text" name="invoiceNumber" value="${bill.invoiceNumber || ''}" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label>备注</label>
                                    <textarea name="remark" class="form-control">${bill.remark || ''}</textarea>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button id="save-bill-btn" class="btn btn-primary">保存</button>
                            <button id="cancel-edit-btn" class="btn btn-secondary">取消</button>
                        </div>
                    </div>
                </div>
                `;
                
                // 添加模态框到页面
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                
                // 关闭模态框函数
                function closeModal() {
                    const modal = document.getElementById('edit-bill-modal');
                    if (modal) {
                        modal.remove();
                    }
                }
                
                // 绑定关闭事件
                document.getElementById('close-modal-btn').addEventListener('click', closeModal);
                document.getElementById('cancel-edit-btn').addEventListener('click', closeModal);
                
                // 保存编辑后的账单
                document.getElementById('save-bill-btn').addEventListener('click', function() {
                    const form = document.getElementById('edit-bill-form');
                    const settlementQuantity = parseFloat(form.settlementQuantity.value) || 0;
                    const unitPrice = parseFloat(form.unitPrice.value) || 0;
                    const deduction = parseFloat(form.deduction.value) || 0;
                    const amount = settlementQuantity * unitPrice - deduction;
                    
                    // 更新账单数据
                    bills[index] = {
                        ...bill,
                        electroplatingFactory: form.electroplatingFactory.value,
                        orderNumber: form.orderNumber.value,
                        customer: form.customer.value,
                        product: form.product.value,
                        settlementQuantity: settlementQuantity,
                        unitPrice: unitPrice,
                        deduction: deduction,
                        amount: amount,
                        billStatus: form.billStatus.value,
                        invoiceDate: form.invoiceDate.value || '',
                        invoiceNumber: form.invoiceNumber.value || '',
                        remark: form.remark.value || ''
                    };
                    
                    // 保存到localStorage
                    localStorage.setItem(window.storagePrefix + "bills", JSON.stringify(bills));
                    
                    // 刷新表格
                    loadBillsTable();
                    
                    // 关闭模态框
                    closeModal();
                    
                    // 显示成功提示
                    alert('账单编辑成功！');
                });
            }
            
            // 添加模态框样式
            function addModalStyles() {
                // 检查样式是否已存在
                if (document.getElementById('modal-styles')) return;
                
                const style = document.createElement('style');
                style.id = 'modal-styles';
                style.innerHTML = `
                .modal-overlay {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0, 0, 0, 0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 1000;
                }
                
                .modal-content {
                    background-color: white;
                    border-radius: 8px;
                    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
                    width: 90%;
                    max-width: 600px;
                    max-height: 90vh;
                    overflow-y: auto;
                }
                
                .modal-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 16px 20px;
                    border-bottom: 1px solid #eaeaea;
                }
                
                .modal-title {
                    margin: 0;
                    font-size: 18px;
                    font-weight: 600;
                }
                
                .modal-close {
                    background: none;
                    border: none;
                    font-size: 24px;
                    cursor: pointer;
                    color: #999;
                }
                
                .modal-close:hover {
                    color: #333;
                }
                
                .modal-body {
                    padding: 20px;
                }
                
                .modal-footer {
                    display: flex;
                    justify-content: flex-end;
                    gap: 12px;
                    padding: 16px 20px;
                    border-top: 1px solid #eaeaea;
                }
                
                .form-group {
                    margin-bottom: 16px;
                }
                
                .form-group label {
                    display: block;
                    margin-bottom: 6px;
                    font-weight: 500;
                    color: #333;
                }
                
                .form-control {
                    width: 100%;
                    padding: 8px 12px;
                    border: 1px solid #ddd;
                    border-radius: 4px;
                    font-size: 14px;
                }
                
                .form-control:focus {
                    outline: none;
                    border-color: #1890ff;
                    box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
                }
                
                textarea.form-control {
                    min-height: 80px;
                    resize: vertical;
                }
                `;
                
                document.head.appendChild(style);
            }
            
            // 调用添加样式函数
            addModalStyles();
            
            // 删除账单函数
            function deleteBill(index) {
                if (confirm('确定要删除这条账单记录吗？此操作不可撤销。')) {
                    const bills = JSON.parse(localStorage.getItem(window.storagePrefix + "bills")) || [];
                    bills.splice(index, 1);
                    localStorage.setItem(window.storagePrefix + "bills", JSON.stringify(bills));
                    loadBillsTable();
                    alert('账单已成功删除！');
                }
            }
            
            function addSyncButtonToSummary() {
                const summaryHeader = document.querySelector('#summary-module .card .flex.justify-between');
                if (summaryHeader) {
                    // 检查是否已经添加了同步按钮
                    if (!summaryHeader.querySelector('#sync-to-bills-btn')) {
                        const syncButton = document.createElement('button');
                        syncButton.id = 'sync-to-bills-btn';
                        syncButton.className = 'btn btn-primary';
                        syncButton.innerHTML = '<i class="fa fa-sync"></i> 同步已完成订单到账单';
                        syncButton.addEventListener('click', function() {
                            const syncedCount = syncCompletedOrdersToBills();
                            alert(`已成功同步 ${syncedCount} 个已完成订单到账单管理！`);
                        });
                        summaryHeader.appendChild(syncButton);
                    }
                }
            }
            
            // 导出订单汇总报表功能
            function exportSummaryReport() {
                // 获取订单汇总数据（与填充表格相同的逻辑）
                const orders = JSON.parse(localStorage.getItem(window.storagePrefix + "orders")) || [];
                const deliveries = JSON.parse(localStorage.getItem(window.storagePrefix + "deliveries")) || [];
                const receipts = JSON.parse(localStorage.getItem(window.storagePrefix + "receipts")) || [];
                
                // 对发货记录中的毛坯数量按订单编号进行汇总
                const rawQuantitySummary = {};
                deliveries.forEach(delivery => {
                    const orderNumber = delivery.orderNumber || '';
                    const rawQty = parseInt(delivery.rawQuantity || 0);
                    if (orderNumber && !isNaN(rawQty)) {
                        if (!rawQuantitySummary[orderNumber]) {
                            rawQuantitySummary[orderNumber] = 0;
                        }
                        rawQuantitySummary[orderNumber] += rawQty;
                    }
                });
                
                // 对发货记录中的报废数量按订单编号进行汇总
                const deliveryScrapSummary = {};
                deliveries.forEach(delivery => {
                    const orderNumber = delivery.orderNumber || '';
                    const scrapQty = parseInt(delivery.scrapQuantity || 0);
                    if (orderNumber && !isNaN(scrapQty)) {
                        if (!deliveryScrapSummary[orderNumber]) {
                            deliveryScrapSummary[orderNumber] = 0;
                        }
                        deliveryScrapSummary[orderNumber] += scrapQty;
                    }
                });
                
                // 对收货记录中的报废数量按订单编号进行汇总
                const receiptScrapSummary = {};
                receipts.forEach(receipt => {
                    const orderNumber = receipt.orderNumber || '';
                    const scrapQty = parseInt(receipt.scrapQuantity || 0);
                    if (orderNumber && !isNaN(scrapQty)) {
                        if (!receiptScrapSummary[orderNumber]) {
                            receiptScrapSummary[orderNumber] = 0;
                        }
                        receiptScrapSummary[orderNumber] += scrapQty;
                    }
                });
                
                // 对收货记录中的成品数量按订单编号进行汇总
                const finishedQuantitySummary = {};
                receipts.forEach(receipt => {
                    const orderNumber = receipt.orderNumber || '';
                    const finishedQty = parseInt(receipt.finishedQuantity || 0);
                    if (orderNumber && !isNaN(finishedQty)) {
                        if (!finishedQuantitySummary[orderNumber]) {
                            finishedQuantitySummary[orderNumber] = 0;
                        }
                        finishedQuantitySummary[orderNumber] += finishedQty;
                    }
                });
                
                // 对收货记录中的返修数量按订单编号进行汇总
                const reworkQuantitySummary = {};
                receipts.forEach(receipt => {
                    const orderNumber = receipt.orderNumber || '';
                    const reworkQty = parseInt(receipt.reworkQuantity || 0);
                    if (orderNumber && !isNaN(reworkQty)) {
                        if (!reworkQuantitySummary[orderNumber]) {
                            reworkQuantitySummary[orderNumber] = 0;
                        }
                        reworkQuantitySummary[orderNumber] += reworkQty;
                    }
                });
                
                // 对发货记录中的返镀数量按订单编号进行汇总
                const returnPlatingSummary = {};
                deliveries.forEach(delivery => {
                    const orderNumber = delivery.orderNumber || '';
                    const returnPlatingQty = parseInt(delivery.reworkQuantity || 0);
                    if (orderNumber && !isNaN(returnPlatingQty)) {
                        if (!returnPlatingSummary[orderNumber]) {
                            returnPlatingSummary[orderNumber] = 0;
                        }
                        returnPlatingSummary[orderNumber] += returnPlatingQty;
                    }
                });
                
                // 按交货期倒序排序订单数据
                const sortedOrders = [...orders].sort((a, b) => {
                    const dateA = a.deliveryDate ? new Date(a.deliveryDate) : new Date(0);
                    const dateB = b.deliveryDate ? new Date(b.deliveryDate) : new Date(0);
                    return dateB - dateA;
                });
                
                // 准备CSV数据
                let csvContent = "\uFEFF" + // 添加BOM以支持Excel正确识别中文
                    "电镀厂,订单号,客户,产品,订单数量,交货期,毛坯数量,良品数量,库存数量,报废数量,滞留数量,结算数量,状态,备注\n";
                
                // 遍历订单数据生成CSV内容
                sortedOrders.forEach(order => {
                    const orderNumber = order.orderNumber || order.orderId || '';
                    const totalRawQuantity = rawQuantitySummary[orderNumber] || 0;
                    const totalScrapQuantity = (deliveryScrapSummary[orderNumber] || 0) + (receiptScrapSummary[orderNumber] || 0);
                    const totalFinishedQuantity = finishedQuantitySummary[orderNumber] || 0;
                    const totalReworkQuantity = reworkQuantitySummary[orderNumber] || 0;
                    const totalReturnPlatingQuantity = returnPlatingSummary[orderNumber] || 0;
                    
                    const goodProductQuantity = totalFinishedQuantity + totalReworkQuantity - totalReturnPlatingQuantity;
                    const retentionQuantity = totalRawQuantity - goodProductQuantity - totalScrapQuantity;
                    const orderQuantity = parseInt(order.quantity || 0);
                    const inventoryQuantity = goodProductQuantity - orderQuantity;
                    const settlementQuantity = goodProductQuantity > orderQuantity ? orderQuantity : goodProductQuantity;
                    
                    // 确定状态
                    let status = '';
                    if (totalRawQuantity === 0) {
                        status = '待电镀';
                    } else if (goodProductQuantity < orderQuantity) {
                        status = '电镀中';
                    } else {
                        status = '已完成';
                    }
                    
                    // 处理备注中的逗号和换行符，用双引号包裹包含特殊字符的字段
                    const remark = order.remark || '';
                    const escapedRemark = remark.includes(',') || remark.includes('"') || remark.includes('\n') ? 
                        '"' + remark.replace(/"/g, '""') + '"' : remark;
                    
                    // 构建CSV行
                    const row = [
                        order.electroplatingFactory || '',
                        orderNumber,
                        order.customer || '',
                        order.product || '',
                        order.quantity || '',
                        order.deliveryDate || '',
                        totalRawQuantity,
                        goodProductQuantity,
                        inventoryQuantity,
                        totalScrapQuantity,
                        retentionQuantity,
                        settlementQuantity,
                        status,
                        escapedRemark
                    ].join(',');
                    
                    csvContent += row + '\n';
                });
                
                // 创建下载链接
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                
                // 设置下载文件名，包含当前日期
                const date = new Date();
                const formattedDate = `${date.getFullYear()}${(date.getMonth() + 1).toString().padStart(2, '0')}${date.getDate().toString().padStart(2, '0')}`;
                const fileName = `订单汇总报表_${formattedDate}.csv`;
                
                // 设置链接属性并触发下载
                link.setAttribute("href", url);
                link.setAttribute("download", fileName);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // 显示导出成功提示
                showNotification('报表导出成功！', 'success');
            }
            
            // 设置顶部按钮提示功能
// 获取真实订单状态变更信息
function getOrderStatusNotifications() {
    // 从localStorage获取订单数据
    const orders = JSON.parse(localStorage.getItem(window.storagePrefix + "orders")) || [];
    const deliveries = JSON.parse(localStorage.getItem(window.storagePrefix + "deliveries")) || [];
    const receipts = JSON.parse(localStorage.getItem(window.storagePrefix + "receipts")) || [];
    
    // 对发货记录中的毛坯数量、成品数量等按订单编号进行汇总
    const rawQuantitySummary = {};
    const finishedQuantitySummary = {};
    
    deliveries.forEach(delivery => {
        const orderNumber = delivery.orderNumber || delivery.orderId || '';
        
        // 汇总毛坯数量
        const rawQty = parseInt(delivery.rawQuantity || 0);
        if (orderNumber && !isNaN(rawQty)) {
            if (!rawQuantitySummary[orderNumber]) {
                rawQuantitySummary[orderNumber] = 0;
            }
            rawQuantitySummary[orderNumber] += rawQty;
        }
        
        // 汇总成品数量
        const finishedQty = parseInt(delivery.finishedQuantity || 0);
        if (orderNumber && !isNaN(finishedQty)) {
            if (!finishedQuantitySummary[orderNumber]) {
                finishedQuantitySummary[orderNumber] = 0;
            }
            finishedQuantitySummary[orderNumber] += finishedQty;
        }
    });
    
    // 计算订单状态变更通知
    const notifications = [];
    const today = new Date();
    const oneDay = 24 * 60 * 60 * 1000;
    
    // 检查接近交货期的订单
    orders.forEach(order => {
        const orderNumber = order.orderNumber || order.orderId || '';
        const orderQuantity = parseInt(order.quantity || 0);
        const totalRawQuantity = rawQuantitySummary[orderNumber] || 0;
        const totalFinishedQuantity = finishedQuantitySummary[orderNumber] || 0;
        
        // 检查交货期
        if (order.deliveryDate) {
            const deliveryDate = new Date(order.deliveryDate);
            const daysUntilDelivery = Math.ceil((deliveryDate - today) / oneDay);
            
            // 待电镀订单
            if (totalRawQuantity === 0) {
                if (daysUntilDelivery <= 3) {
                    notifications.push(`警告：订单#${orderNumber} 即将到期(${daysUntilDelivery}天后)，尚未开始电镀`);
                }
            } 
            // 电镀中订单
            else if (totalFinishedQuantity < orderQuantity) {
                if (daysUntilDelivery <= 2) {
                    notifications.push(`警告：订单#${orderNumber} 即将到期(${daysUntilDelivery}天后)，仍在电镀中`);
                }
            }
            // 已完成订单
            else if (totalFinishedQuantity >= orderQuantity) {
                notifications.push(`提示：订单#${orderNumber} 电镀已完成，可安排发货`);
            }
        }
    });
    
    // 检查异常订单（未收到收货确认的已发货订单）
    const deliveredOrders = new Set();
    const receivedOrders = new Set();
    
    deliveries.forEach(delivery => {
        if (delivery.finishedQuantity > 0) {
            deliveredOrders.add(delivery.orderNumber || delivery.orderId);
        }
    });
    
    receipts.forEach(receipt => {
        receivedOrders.add(receipt.orderNumber || receipt.orderId);
    });
    
    deliveredOrders.forEach(orderNumber => {
        if (!receivedOrders.has(orderNumber)) {
            notifications.push(`提示：订单#${orderNumber} 已发货，但尚未收到收货确认`);
        }
    });
    
    return notifications;
}

// setupTooltips 函数已移除，因为通知和帮助图标已删除

// 导入订单汇总报表功能
function importSummaryReport(file) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const content = e.target.result;
                        // 处理BOM头
                        const csvContent = content.startsWith('\uFEFF') ? content.slice(1) : content;
                        
                        // 解析CSV内容
                        const lines = csvContent.split('\n').filter(line => line.trim());
                        if (lines.length < 2) {
                            showNotification('导入失败：CSV文件内容为空或格式不正确', 'error');
                            return;
                        }
                        
                        // 检查表头
                        const headers = lines[0].split(',').map(h => h.trim());
                        const expectedHeaders = ['电镀厂', '订单号', '客户', '产品', '订单数量', '交货期', '毛坯数量', '良品数量', '库存数量', '报废数量', '滞留数量', '结算数量', '状态', '备注'];
                        
                        // 简化检查，只要包含关键字段即可
                        const hasRequiredHeaders = expectedHeaders.slice(0, 4).every(h => 
                            headers.some(header => header.includes(h))
                        );
                        
                        if (!hasRequiredHeaders) {
                            showNotification('导入失败：CSV文件表头格式不正确，请使用系统导出的报表格式', 'error');
                            return;
                        }
                        
                        // 解析数据行
                        const importedOrders = [];
                        const importedDeliveries = [];
                        const importedReceipts = [];
                        
                        for (let i = 1; i < lines.length; i++) {
                            // 处理包含逗号的字段（CSV格式）
                            const row = parseCSVLine(lines[i]);
                            if (row.length >= 14) {
                                // 创建订单记录
                                const orderId = generateUniqueId();
                                const orderNumber = row[1].trim();
                                
                                importedOrders.push({
                                    orderId: orderId,
                                    orderNumber: orderNumber,
                                    customer: row[2].trim(),
                                    product: row[3].trim(),
                                    quantity: parseInt(row[4]) || 0,
                                    deliveryDate: row[5].trim(),
                                    electroplatingFactory: row[0].trim(),
                                    remark: row[13].trim(),
                                    status: row[12].trim(),
                                    createTime: new Date().toISOString()
                                });
                                
                                // 根据导入的数据创建相应的发货和收货记录
                                const rawQuantity = parseInt(row[6]) || 0;
                                if (rawQuantity > 0) {
                                    importedDeliveries.push({
                                        deliveryId: generateUniqueId(),
                                        orderNumber: orderNumber,
                                        rawQuantity: rawQuantity,
                                        deliveryDate: new Date().toISOString().split('T')[0],
                                        scrapQuantity: parseInt(row[9]) || 0,
                                        createTime: new Date().toISOString()
                                    });
                                }
                                
                                const goodProductQuantity = parseInt(row[7]) || 0;
                                if (goodProductQuantity > 0) {
                                    importedReceipts.push({
                                        receiptId: generateUniqueId(),
                                        orderNumber: orderNumber,
                                        finishedQuantity: goodProductQuantity,
                                        receiptDate: new Date().toISOString().split('T')[0],
                                        scrapQuantity: 0,
                                        createTime: new Date().toISOString()
                                    });
                                }
                            }
                        }
                        
                        if (importedOrders.length === 0) {
                            showNotification('导入失败：未找到有效的订单数据', 'error');
                            return;
                        }
                        
                        // 获取现有数据
                        const existingOrders = JSON.parse(localStorage.getItem(window.storagePrefix + "orders")) || [];
                        const existingDeliveries = JSON.parse(localStorage.getItem(window.storagePrefix + "deliveries")) || [];
                        const existingReceipts = JSON.parse(localStorage.getItem(window.storagePrefix + "receipts")) || [];
                        
                        // 合并数据（简单处理：添加新数据）
                        const updatedOrders = [...existingOrders, ...importedOrders];
                        const updatedDeliveries = [...existingDeliveries, ...importedDeliveries];
                        const updatedReceipts = [...existingReceipts, ...importedReceipts];
                        
                        // 保存到localStorage
                        localStorage.setItem(window.storagePrefix + "orders", JSON.stringify(updatedOrders));
                        localStorage.setItem(window.storagePrefix + "deliveries", JSON.stringify(updatedDeliveries));
                        localStorage.setItem(window.storagePrefix + "receipts", JSON.stringify(updatedReceipts));
                        
                        // 重新加载订单汇总数据
                        populateOrderSummary();
                        
                        showNotification(`成功导入 ${importedOrders.length} 条订单记录`, 'success');
                    } catch (error) {
                        console.error('导入失败:', error);
                        showNotification('导入失败：文件解析错误，请检查文件格式', 'error');
                    }
                };
                
                reader.onerror = function() {
                    showNotification('导入失败：文件读取错误', 'error');
                };
                
                // 读取文件内容
                reader.readAsText(file, 'UTF-8');
            }
            
            // 解析CSV行，处理包含逗号和引号的字段
            function parseCSVLine(line) {
                const result = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    
                    if (char === '"') {
                        if (inQuotes && i + 1 < line.length && line[i + 1] === '"') {
                            // 处理转义的引号
                            current += '"';
                            i++; // 跳过下一个引号
                        } else {
                            inQuotes = !inQuotes;
                        }
                    } else if (char === ',' && !inQuotes) {
                        // 字段分隔符
                        result.push(current);
                        current = '';
                    } else {
                        current += char;
                    }
                }
                
                // 添加最后一个字段
                result.push(current);
                
                return result;
            }
            
            // 生成唯一ID
            function generateUniqueId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            }
            
            // 设置导出报表按钮事件监听
            function setupExportButton() {
                const exportButton = document.getElementById('export-summary-btn');
                if (exportButton) {
                    exportButton.addEventListener('click', function() {
                        // 显示加载状态
                        this.innerHTML = '<i class="fa fa-spinner fa-spin"></i> 导出中...';
                        this.disabled = true;
                        
                        // 使用setTimeout模拟异步操作，让用户看到加载状态
                        setTimeout(() => {
                            exportSummaryReport();
                            // 恢复按钮状态
                            this.innerHTML = '<i class="fa fa-download"></i> 导出报表';
                            this.disabled = false;
                        }, 500);
                    });
                }
            }
            
            // 设置导入报表文件输入事件监听
            function setupImportButton() {
                const importFileInput = document.getElementById('import-summary-file');
                if (importFileInput) {
                    importFileInput.addEventListener('change', function() {
                        if (this.files && this.files.length > 0) {
                            const file = this.files[0];
                            
                            // 检查文件类型
                            if (file.name.toLowerCase().endsWith('.csv')) {
                                // 重置文件输入，以便可以重复导入同一文件
                                const importButton = this.closest('label');
                                importButton.innerHTML = '<i class="fa fa-spinner fa-spin"></i> 导入中...';
                                importButton.disabled = true;
                                
                                // 延迟执行以显示加载状态
                                setTimeout(() => {
                                    importSummaryReport(file);
                                    // 重置文件输入
                                    this.value = '';
                                    // 恢复按钮状态
                                    importButton.innerHTML = '<i class="fa fa-upload"></i> 导入报表<input type="file" id="import-summary-file" accept=".csv" class="hidden">';
                                    importButton.disabled = false;
                                    
                                    // 重新绑定事件到新创建的input元素
                                    const newInput = document.getElementById('import-summary-file');
                                    if (newInput) {
                                        newInput.addEventListener('change', this.onchange);
                                    }
                                }, 300);
                            } else {
                                showNotification('请选择CSV格式的文件', 'error');
                                this.value = '';
                            }
                        }
                    });
                }
            }
            setupSelectAllCheckbox();
            setupRowCheckboxes();
            setupExportButton(); // 初始化导出报表功能
    setupImportButton(); // 初始化导入报表功能
    // setupTooltips 函数已移除，因为通知和帮助图标已删除
            
            // 当切换到订单汇总模块时，自动填充数据
            // 获取订单汇总模块的导航项
            const summaryNavItem = document.querySelector('.nav-item[data-module="summary"]');
            if (summaryNavItem) {
                summaryNavItem.addEventListener('click', function() {
                    // 延迟填充，确保模块已显示
                    setTimeout(populateOrderSummary, 100);
                    // 添加同步已完成订单到账单的按钮
                    setTimeout(addSyncButtonToSummary, 100);
                });
            }
            
            // 导出报表按钮
            const exportSummaryBtn = document.getElementById('export-summary-btn');
            if (exportSummaryBtn) {
                exportSummaryBtn.addEventListener('click', function() {
                    // 首先确保汇总表格数据是最新的
                    populateOrderSummary();
                    
                    // 模拟报表导出
                    alert('报表导出中，请稍候...');
                    setTimeout(() => {
                        alert('报表已成功导出为Excel文件！');
                    }, 1500);
                });
            }
            
            // 移动端菜单按钮
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const sidebar = document.querySelector('aside');
            
            if (mobileMenuButton) {
                mobileMenuButton.addEventListener('click', function() {
                    sidebar.classList.toggle('-translate-x-full');
                });
            }
            
            // 搜索订单功能
            const orderSearchInput = document.getElementById('order-search-input');
            if (orderSearchInput) {
                orderSearchInput.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    const orders = JSON.parse(localStorage.getItem(window.storagePrefix + "orders")) || [];
                    const orderTableBody = document.querySelector('#orders-module tbody');
                    
                    if (localStorage.getItem(window.storagePrefix + "ordersCleared") === 'true') {
                        if (orderTableBody) {
                            orderTableBody.innerHTML = '<tr class="text-center text-gray-500"><td colspan="10">暂无订单数据</td></tr>';
                        }
                        return;
                    }
                    
                    // 过滤订单数据
                    const filteredOrders = orders.filter(order => {
                        // 检查订单的所有字段是否包含搜索词
                        return Object.values(order).some(value => {
                            if (value && typeof value === 'string') {
                                return value.toLowerCase().includes(searchTerm);
                            }
                            return false;
                        });
                    });
                    
                    // 按交货期倒序排序过滤后的订单
                    const sortedFilteredOrders = [...filteredOrders].sort((a, b) => {
                        return new Date(b.deliveryDate) - new Date(a.deliveryDate);
                    });
                    
                    // 更新表格显示
                    if (orderTableBody) {
                        if (filteredOrders.length === 0) {
                            orderTableBody.innerHTML = '<tr class="text-center text-gray-500"><td colspan="10">未找到匹配的订单</td></tr>';
                        } else {
                            orderTableBody.innerHTML = '';
                            sortedFilteredOrders.forEach(order => {
                                const row = document.createElement('tr');
                                row.innerHTML = `
                                    <td class="table-cell">
                                        <input type="checkbox" class="order-checkbox rounded text-primary focus:ring-primary" data-id="${order.orderId}">
                                    </td>
                                    <td class="table-cell">${order.orderId}</td>
                                    <td class="table-cell">${order.customer}</td>
                                    <td class="table-cell">${order.product || ''}</td>
                                    <td class="table-cell">${order.quantity}</td>
                                    <td class="table-cell">${order.deliveryDate}</td>
                                    <td class="table-cell">${getStyledFactoryHTML(order.electroplatingFactory)}</td>
                                    <td class="table-cell">${order.remark || ''}</td>
                                    <td class="table-cell">
                                        <div class="flex gap-2">
                                            <button class="text-primary hover:text-accent view-order" data-id="${order.orderId}">
                                                <i class="fa fa-eye"></i>
                                            </button>
                                            <button class="text-gray-medium hover:text-primary edit-order" data-id="${order.orderId}">
                                                <i class="fa fa-edit"></i>
                                            </button>
                                            <button class="text-gray-medium hover:text-danger delete-order" data-id="${order.orderId}">
                                                <i class="fa fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                `;
                                orderTableBody.appendChild(row);
                            });
                            
                            // 重新添加事件监听器
                            document.querySelectorAll('.view-order').forEach(btn => {
                                btn.addEventListener('click', function() {
                                    const orderId = this.getAttribute('data-id');
                                    viewOrder(orderId);
                                });
                            });
                            
                            document.querySelectorAll('.edit-order').forEach(btn => {
                                btn.addEventListener('click', function() {
                                    const orderId = this.getAttribute('data-id');
                                    editOrder(orderId);
                                });
                            });
                            
                            document.querySelectorAll('.delete-order').forEach(btn => {
                                btn.addEventListener('click', function() {
                                    const orderId = this.getAttribute('data-id');
                                    deleteOrder(orderId);
                                });
                            });
                        }
                    }
                });
            }
            
            // 实现新建订单模态框中客户输入框的下拉选择和人工输入功能
            const customerInput = document.getElementById('order-customer-input');
            const customerDropdown = document.getElementById('customer-dropdown');
            
            if (customerInput && customerDropdown) {
                // 显示下拉列表
                customerInput.addEventListener('focus', function() {
                    customerDropdown.classList.remove('hidden');
                });
                
                // 隐藏下拉列表（点击外部）
                document.addEventListener('click', function(event) {
                    if (!customerInput.contains(event.target) && !customerDropdown.contains(event.target)) {
                        customerDropdown.classList.add('hidden');
                    }
                });
                
                // 点击下拉选项
                const dropdownItems = customerDropdown.querySelectorAll('.cursor-pointer');
                dropdownItems.forEach(item => {
                    item.addEventListener('click', function() {
                        customerInput.value = this.textContent;
                        customerDropdown.classList.add('hidden');
                    });
                });
                
                // 从订单列表中获取所有客户名称
                function getAllCustomers() {
                    const orders = JSON.parse(localStorage.getItem(window.storagePrefix + "orders")) || [];
                    const customerSet = new Set();
                    
                    // 添加已有的订单客户
                    orders.forEach(order => {
                        if (order.customer) {
                            customerSet.add(order.customer);
                        }
                    });
                    
                    // 添加一些预设的客户名称作为备选
                    const defaultCustomers = [
                        '上海电子科技有限公司',
                        '北京精密制造有限公司',
                        '广州五金制品有限公司',
                        '深圳科技有限公司',
                        '杭州电子元件有限公司',
                        '天津机械厂',
                        '苏州电子有限公司',
                        '南京精密仪器厂',
                        '武汉金属制品厂',
                        '成都电子设备厂'
                    ];
                    
                    defaultCustomers.forEach(customer => customerSet.add(customer));
                    
                    return Array.from(customerSet).sort();
                }
                
                // 根据输入过滤客户列表
                customerInput.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    const customers = getAllCustomers();
                    const filteredCustomers = searchTerm ? 
                        customers.filter(customer => customer.toLowerCase().includes(searchTerm)) : 
                        [];
                    
                    // 更新下拉列表
                    customerDropdown.innerHTML = '';
                    
                    if (filteredCustomers.length > 0) {
                        filteredCustomers.forEach(customer => {
                            const option = document.createElement('div');
                            option.className = 'px-4 py-2 hover:bg-gray-100 cursor-pointer text-sm';
                            option.textContent = customer;
                            option.addEventListener('click', function() {
                                customerInput.value = customer;
                                customerDropdown.classList.add('hidden');
                            });
                            customerDropdown.appendChild(option);
                        });
                        customerDropdown.classList.remove('hidden');
                    } else {
                        customerDropdown.classList.add('hidden');
                    }
                });
                
                // 点击输入框时显示所有客户（如果有输入内容）
                customerInput.addEventListener('focus', function() {
                    if (this.value.trim()) {
                        // 触发input事件来显示过滤后的客户
                        const inputEvent = new Event('input');
                        this.dispatchEvent(inputEvent);
                    }
                });
                
                // 已经在前面添加了相同的点击事件监听器，这里不需要重复添加
            }
            
            // 页面加载时加载订单并更新分页
            loadOrders();
            updatePagination();
            
            // 页面加载时更新发货单列表
            updateDeliveryList();
            
            // 实现发货单中订单编号的模糊查找和自动填充功能
            const orderNumberInput = document.getElementById('delivery-order-number-input');
            const orderNumberDropdown = document.getElementById('order-number-dropdown');
            const deliveryCustomerInput = document.getElementById('delivery-customer-input');
            const deliveryProductInput = document.getElementById('delivery-product-input');
            const deliveryFactoryInput = document.getElementById('delivery-factory-input');
            
            if (orderNumberInput && orderNumberDropdown && deliveryCustomerInput && deliveryProductInput && deliveryFactoryInput) {
                // 从订单列表中获取所有订单
                function getAllOrders() {
                    return JSON.parse(localStorage.getItem(window.storagePrefix + "orders")) || [];
                }
                
                // 根据输入过滤订单编号
                orderNumberInput.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    const orders = getAllOrders();
                    const filteredOrders = searchTerm ? 
                        orders.filter(order => {
                            // 同时检查orderId和orderNumber字段
                            const hasOrderId = order.orderId && order.orderId.toLowerCase().includes(searchTerm);
                            const hasOrderNumber = order.orderNumber && order.orderNumber.toLowerCase().includes(searchTerm);
                            return hasOrderId || hasOrderNumber;
                        }) : 
                        [];
                    
                    // 更新下拉列表
                    orderNumberDropdown.innerHTML = '';
                    
                    if (filteredOrders.length > 0) {
                        filteredOrders.forEach(order => {
                            const option = document.createElement('div');
                            option.className = 'px-4 py-2 hover:bg-gray-100 cursor-pointer text-sm';
                            option.textContent = order.orderId;
                            option.addEventListener('click', function() {
                                // 设置订单编号 - 使用存在的字段
                                orderNumberInput.value = order.orderId || order.orderNumber || '';
                                
                                // 自动填充客户信息 - 支持多种可能的字段名
                                const customerValue = order.customer || order.customerName || '';
                                if (customerValue) {
                                    deliveryCustomerInput.value = customerValue;
                                    // 触发事件确保输入框状态更新
                                    deliveryCustomerInput.dispatchEvent(new Event('change', { bubbles: true }));
                                    deliveryCustomerInput.dispatchEvent(new Event('input', { bubbles: true }));
                                }
                                
                                // 自动填充产品信息
                                if (order.product) deliveryProductInput.value = order.product;
                                
                                // 自动填充电镀厂信息
                                if (order.electroplatingFactory) deliveryFactoryInput.value = order.electroplatingFactory;
                                
                                // 设置一个小延迟确保DOM更新
                                setTimeout(() => {
                                    // 关闭下拉列表
                                    orderNumberDropdown.classList.add('hidden');
                                }, 100);
                            });
                            orderNumberDropdown.appendChild(option);
                        });
                        orderNumberDropdown.classList.remove('hidden');
                    } else {
                        orderNumberDropdown.classList.add('hidden');
                    }
                });
                
                // 点击输入框时显示所有订单（如果有输入内容）
                orderNumberInput.addEventListener('focus', function() {
                    if (this.value.trim()) {
                        // 触发input事件来显示过滤后的订单
                        const inputEvent = new Event('input');
                        this.dispatchEvent(inputEvent);
                    }
                });
                
                // 点击页面其他地方关闭下拉列表
                document.addEventListener('click', function(event) {
                    if (!orderNumberInput.contains(event.target) && !orderNumberDropdown.contains(event.target)) {
                        orderNumberDropdown.classList.add('hidden');
                    }
                });
            }
            
            // 清空订单按钮事件
            const clearOrdersBtn = document.getElementById('clear-orders-btn');
            if (clearOrdersBtn) {
                clearOrdersBtn.addEventListener('click', function() {
                    if (confirm('确定要永久性清空所有订单数据吗？此操作不可恢复！')) {
                        const orderTableBody = document.querySelector('#orders-module tbody');
                        
                        if (orderTableBody) {
                            // 清空表格内容，并设置提示信息
                            orderTableBody.innerHTML = '<tr class="text-center text-gray-500"><td colspan="11">暂无订单数据</td></tr>';
                        }
                        
                        // 清空localStorage中的订单数据
                        localStorage.setItem(window.storagePrefix + "orders", JSON.stringify([]));
                        localStorage.setItem(window.storagePrefix + "ordersCleared", 'true');
                        
                        // 更新分页
                        updatePagination();
                        
                        alert('订单数据已永久性清空！');
                    }
                });
            }
        });
        
        // 全局图表实例变量，用于更新图表
        let orderTrendChart = null;
        let orderStatusChart = null;
        let orderTypeChart = null;
        let customerOrderChart = null;
        
        // 获取订单统计数据
        function getOrderStatistics(timeRange = currentTimeRange) {
            const orders = JSON.parse(localStorage.getItem(window.storagePrefix + "orders")) || [];
            const deliveries = JSON.parse(localStorage.getItem(window.storagePrefix + "deliveries")) || [];
            const receipts = JSON.parse(localStorage.getItem(window.storagePrefix + "receipts")) || [];
            const now = new Date();
            const currentYear = now.getFullYear();
            
            // 根据时间范围筛选订单
            let filteredOrders = orders;
            if (timeRange) {
                const now = new Date();
                let startTime;
                
                switch(timeRange) {
                    case 'month':
                        startTime = new Date(now.getFullYear(), now.getMonth(), 1);
                        break;
                    case 'quarter':
                        const currentQuarter = Math.floor(now.getMonth() / 3);
                        startTime = new Date(now.getFullYear(), currentQuarter * 3, 1);
                        break;
                    case 'year':
                        startTime = new Date(now.getFullYear(), 0, 1);
                        break;
                    default:
                        startTime = null;
                }
                
                if (startTime) {
                    filteredOrders = orders.filter(order => {
                        if (!order.deliveryDate) return false;
                        const orderDate = new Date(order.deliveryDate);
                        return orderDate >= startTime;
                    });
                }
            }
            
            // 初始化按月统计的数据
            const monthlyOrderCount = Array(12).fill(0);
            // 修改为统计"待电镀"、"电镀中"、"已完成"这三个状态
            const statusCount = {
                '待电镀': 0,
                '电镀中': 0,
                '已完成': 0
            };
            
            // 初始化按年度统计产品数量的数据
            const yearlyProductQuantity = {};
            // 获取所有年份并去重
            const years = [...new Set(orders.map(order => {
                if (order.deliveryDate) {
                    return new Date(order.deliveryDate).getFullYear();
                }
                return null;
            }).filter(year => year !== null))].sort();
            
            // 初始化电镀类型统计
            const platingTypeCount = {
                '镀金': 0,
                '镀镍': 0,
                '镀铬': 0,
                '镀锌': 0
            };
            
            // 初始化客户订单统计
            const customerOrderCount = {};
            
            // 如果订单已清空，返回空统计数据
            if (localStorage.getItem(window.storagePrefix + "ordersCleared") === 'true' || filteredOrders.length === 0) {
                return {
                    monthlyOrderCount,
                    statusCount,
                    platingTypeCount,
                    customerOrderCount
                };
            }
            
            // 对发货记录中的毛坯数量按订单编号进行汇总
            const rawQuantitySummary = {};
            deliveries.forEach(delivery => {
                const orderNumber = delivery.orderNumber || '';
                const rawQty = parseInt(delivery.rawQuantity || 0);
                if (orderNumber && !isNaN(rawQty)) {
                    if (!rawQuantitySummary[orderNumber]) {
                        rawQuantitySummary[orderNumber] = 0;
                    }
                    rawQuantitySummary[orderNumber] += rawQty;
                }
            });
            
            // 对收货记录中的良品数量按订单编号进行汇总
            const finishedQuantitySummary = {};
            receipts.forEach(receipt => {
                const orderNumber = receipt.orderNumber || '';
                const finishQty = parseInt(receipt.qualifiedQuantity || 0);
                if (orderNumber && !isNaN(finishQty)) {
                    if (!finishedQuantitySummary[orderNumber]) {
                        finishedQuantitySummary[orderNumber] = 0;
                    }
                    finishedQuantitySummary[orderNumber] += finishQty;
                }
            });
            
            // 对发货记录中的返工数量按订单编号进行汇总
            const reworkQuantitySummary = {};
            deliveries.forEach(delivery => {
                const orderNumber = delivery.orderNumber || '';
                const reworkQty = parseInt(delivery.qualifiedQuantity || 0);
                if (orderNumber && !isNaN(reworkQty)) {
                    if (!reworkQuantitySummary[orderNumber]) {
                        reworkQuantitySummary[orderNumber] = 0;
                    }
                    reworkQuantitySummary[orderNumber] += reworkQty;
                }
            });
            
            // 对发货记录中的返镀数量按订单编号进行汇总
            const returnPlatingSummary = {};
            deliveries.forEach(delivery => {
                const orderNumber = delivery.orderNumber || '';
                const returnPlatingQty = parseInt(delivery.reworkQuantity || 0);
                if (orderNumber && !isNaN(returnPlatingQty)) {
                    if (!returnPlatingSummary[orderNumber]) {
                        returnPlatingSummary[orderNumber] = 0;
                    }
                    returnPlatingSummary[orderNumber] += returnPlatingQty;
                }
            });
            
            // 统计订单数据
            // 初始化每个年份的产品数量统计
            years.forEach(year => {
                yearlyProductQuantity[year] = {};
            });
            
            filteredOrders.forEach(order => {
                // 按月统计订单数量
                if (order.deliveryDate) {
                    const orderDate = new Date(order.deliveryDate);
                    if (orderDate.getFullYear() === currentYear) {
                        const month = orderDate.getMonth(); // 0-11
                        monthlyOrderCount[month]++;
                    }
                    
                    // 按年度统计产品数量
                    const orderYear = orderDate.getFullYear();
                    const product = order.product || '未知产品';
                    const quantity = parseInt(order.quantity || 0);
                    
                    if (yearlyProductQuantity[orderYear]) {
                        yearlyProductQuantity[orderYear][product] = 
                            (yearlyProductQuantity[orderYear][product] || 0) + quantity;
                    }
                }
                
                // 统计订单状态 - 使用与订单汇总相同的逻辑计算状态
                const orderNumber = order.orderNumber || order.orderId || '';
                const orderQuantity = parseInt(order.quantity || 0);
                const totalRawQuantity = rawQuantitySummary[orderNumber] || 0;
                const goodProductQuantity = (finishedQuantitySummary[orderNumber] || 0) + 
                                          (reworkQuantitySummary[orderNumber] || 0) - 
                                          (returnPlatingSummary[orderNumber] || 0);
                
                // 确定订单状态
                let orderStatus;
                if (totalRawQuantity === 0) {
                    // 待电镀：没有发毛坯
                    orderStatus = '待电镀';
                } else if (goodProductQuantity < orderQuantity) {
                    // 电镀中：有发毛坯但良品数量不足
                    orderStatus = '电镀中';
                } else {
                    // 已完成：良品数量达到或超过订单数量
                    orderStatus = '已完成';
                }
                
                statusCount[orderStatus]++;
                
                // 统计电镀类型（假设从产品名称中提取）
                const product = order.product || '';
                if (product.includes('金')) platingTypeCount['镀金']++;
                else if (product.includes('镍')) platingTypeCount['镀镍']++;
                else if (product.includes('铬')) platingTypeCount['镀铬']++;
                else if (product.includes('锌')) platingTypeCount['镀锌']++;
                
                // 统计客户订单数量
                const customer = order.customer || '未知客户';
                customerOrderCount[customer] = (customerOrderCount[customer] || 0) + 1;
            });
            
            return {
                monthlyOrderCount,
                statusCount,
                platingTypeCount,
                customerOrderCount,
                yearlyProductQuantity,
                years
            };
        }
        
        // 更新仪表板统计数据
        function updateDashboardStatistics() {
            const orders = JSON.parse(localStorage.getItem(window.storagePrefix + "orders")) || [];
            
            // 更新订单总数
            const totalOrderCount = document.getElementById('total-order-count');
            if (totalOrderCount) {
                if (localStorage.getItem(window.storagePrefix + "ordersCleared") === 'true') {
                    totalOrderCount.textContent = '0';
                } else {
                    totalOrderCount.textContent = orders.length.toString();
                }
            }
            
            // 更新订单数量总和
            const totalOrderQuantity = document.getElementById('total-order-quantity');
            if (totalOrderQuantity) {
                if (localStorage.getItem(window.storagePrefix + "ordersCleared") === 'true') {
                    totalOrderQuantity.textContent = '0';
                } else {
                    // 计算所有订单的数量总和
                    const totalQuantity = orders.reduce((sum, order) => {
                        return sum + parseInt(order.quantity || 0);
                    }, 0);
                    totalOrderQuantity.textContent = totalQuantity.toString();
                }
            }
            
            // 可以根据需要更新其他统计数据
        }
        
        // 全局变量存储当前的统计类型
        let currentStatType = 'product'; // 'product' 或 'quantity'
        let currentTimeRange = 'quarter'; // 'month', 'quarter', 'year'
        
        // 初始化图表
        function initCharts() {
            const { monthlyOrderCount, statusCount, platingTypeCount, customerOrderCount, yearlyProductQuantity, years } = getOrderStatistics(currentTimeRange);
            
            // 订单趋势图表 - 按年度产品数量柱形统计
            const orderTrendCtx = document.getElementById('orderTrendChart');
            if (orderTrendCtx) {
                if (orderTrendChart) orderTrendChart.destroy();
                
                // 准备图表数据
                let labels = [];
                let datasets = [];
                
                // 如果有数据，按年度准备统计
                if (years.length > 0 && Object.keys(yearlyProductQuantity).length > 0) {
                    // 设置标签为年份
                    labels = years.slice(-3); // 只显示最近3年的数据
                    
                    if (currentStatType === 'product') {
                        // 产品统计 - 显示各产品在各年份的数量
                        // 获取所有唯一产品名称
                        const allProducts = [...new Set(
                            Object.values(yearlyProductQuantity).flatMap(yearData => 
                                Object.keys(yearData)
                            )
                        )].slice(0, 5); // 限制最多显示5个产品以避免图表过于复杂
                        
                        // 为每个产品创建数据集
                        const colors = [
                            'rgba(30, 136, 229, 0.7)',  // 蓝色
                            'rgba(76, 175, 80, 0.7)',   // 绿色
                            'rgba(255, 152, 0, 0.7)',   // 橙色
                            'rgba(244, 67, 54, 0.7)',   // 红色
                            'rgba(156, 39, 176, 0.7)'   // 紫色
                        ];
                        
                        allProducts.forEach((product, index) => {
                            const data = labels.map(year => 
                                yearlyProductQuantity[year] && yearlyProductQuantity[year][product] 
                                    ? yearlyProductQuantity[year][product] 
                                    : 0
                            );
                            
                            datasets.push({
                                label: product,
                                data: data,
                                backgroundColor: colors[index % colors.length],
                                borderColor: colors[index % colors.length].replace('0.7', '1'),
                                borderWidth: 1
                            });
                        });
                    } else {
                        // 数量统计 - 显示各年份的总数量
                        const totalQuantityData = labels.map(year => {
                            const yearData = yearlyProductQuantity[year];
                            if (!yearData) return 0;
                            return Object.values(yearData).reduce((sum, quantity) => sum + quantity, 0);
                        });
                        
                        datasets.push({
                            label: '年度总数量',
                            data: totalQuantityData,
                            backgroundColor: 'rgba(30, 136, 229, 0.7)',
                            borderColor: 'rgba(30, 136, 229, 1)',
                            borderWidth: 1
                        });
                    }
                } else {
                    // 如果没有数据，显示默认内容
                    labels = ['暂无数据'];
                    datasets = [{
                        label: currentStatType === 'product' ? '产品数量' : '年度总数量',
                        data: [0],
                        backgroundColor: 'rgba(30, 136, 229, 0.7)',
                        borderColor: 'rgba(30, 136, 229, 1)',
                        borderWidth: 1
                    }];
                }
                
                // 创建柱形图
                orderTrendChart = new Chart(orderTrendCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: currentStatType === 'product', // 产品统计时显示图例
                                position: 'top',
                                labels: {
                                    boxWidth: 12,
                                    padding: 15
                                }
                            },
                            title: {
                                display: true,
                                text: currentStatType === 'product' ? '年度产品数量统计' : '年度总数量统计',
                                font: {
                                    size: 16
                                }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: '产品数量'
                                },
                                grid: {
                                    drawBorder: false
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: '年份'
                                },
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            }
            
            // 订单状态分布图表
            const orderStatusCtx = document.getElementById('orderStatusChart');
            if (orderStatusCtx) {
                if (orderStatusChart) orderStatusChart.destroy();
                orderStatusChart = new Chart(orderStatusCtx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(statusCount),  // 自动使用更新后的三个状态：待电镀、电镀中、已完成
                        datasets: [{
                            data: Object.values(statusCount),
                            backgroundColor: [
                                '#FF9800',  // 待电镀 - 橙色
                                '#2196F3',  // 电镀中 - 蓝色
                                '#4CAF50'   // 已完成 - 绿色
                            ],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    boxWidth: 12
                                }
                            }
                        },
                        cutout: '70%'
                    }
                });
            }
            
            // 订单类型分布图表
            const orderTypeCtx = document.getElementById('orderTypeChart');
            if (orderTypeCtx) {
                if (orderTypeChart) orderTypeChart.destroy();
                
                // 过滤掉值为0的电镀类型，只显示有数据的类型
                const filteredPlatingTypes = {};
                Object.entries(platingTypeCount).forEach(([type, count]) => {
                    if (count > 0) {
                        filteredPlatingTypes[type] = count;
                    }
                });
                
                // 设置默认颜色
                const colors = ['#FFD700', '#C0C0C0', '#CD7F32', '#8DB6CD', '#FF6384', '#36A2EB', '#FFCE56'];
                
                orderTypeChart = new Chart(orderTypeCtx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(filteredPlatingTypes).length > 0 ? Object.keys(filteredPlatingTypes) : ['暂无数据'],
                        datasets: [{
                            data: Object.keys(filteredPlatingTypes).length > 0 ? Object.values(filteredPlatingTypes) : [1],
                            backgroundColor: Object.keys(filteredPlatingTypes).map((_, index) => colors[index % colors.length]),
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    boxWidth: 12
                                }
                            }
                        }
                    }
                });
            }
            
            // 客户订单排行图表
            const customerOrderCtx = document.getElementById('customerOrderChart');
            if (customerOrderCtx) {
                // 排序客户并取前5名
                const sortedCustomers = Object.entries(customerOrderCount)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);
                
                // 修复错误：应该销毁customerOrderChart而不是orderTypeChart
                if (customerOrderChart) customerOrderChart.destroy();
                customerOrderChart = new Chart(customerOrderCtx, {
                    type: 'bar',
                    data: {
                        labels: sortedCustomers.length > 0 ? sortedCustomers.map(item => item[0]) : ['暂无数据'],
                        datasets: [{
                            label: '订单数量',
                            data: sortedCustomers.length > 0 ? sortedCustomers.map(item => item[1]) : [0],
                            backgroundColor: '#1E88E5',
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    drawBorder: false
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            }
        }
        
        // 更新图表
        function updateCharts() {
            initCharts();
        }
        
        // 根据时间范围更新图表
        function updateChartsByTimeRange(range) {
            // 更新按钮状态
            const buttons = document.querySelectorAll('#summary-module .card .flex.gap-2 button');
            buttons.forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-secondary');
            });
            
            // 为当前选中的按钮添加激活状态
            const activeButton = Array.from(buttons).find(btn => 
                btn.textContent.trim() === (range === 'month' ? '本月' : range === 'quarter' ? '季度' : '年度')
            );
            if (activeButton) {
                activeButton.classList.remove('btn-secondary');
                activeButton.classList.add('btn-primary');
            }
            
            // 更新当前时间范围并刷新图表
            currentTimeRange = range;
            updateCharts();
        }
        
        // 订单汇总搜索功能 - 模糊查找订单汇总详情中产品的所有信息
        document.addEventListener('DOMContentLoaded', function() {
            const summarySearch = document.getElementById('summary-search');
            if (summarySearch) {
                summarySearch.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.toLowerCase();
                    const rows = document.querySelectorAll('#summary-module tbody tr');
                    
                    if (rows.length === 1 && rows[0].querySelector('td').colSpan > 1) {
                        // 如果只有"暂无数据"的行，不进行筛选
                        return;
                    }
                    
                    rows.forEach(row => {
                        // 获取行中所有单元格的文本内容
                        const cells = row.querySelectorAll('td');
                        let found = false;
                        
                        // 遍历所有单元格，检查是否包含搜索词
                        cells.forEach(cell => {
                            const cellText = cell.textContent.toLowerCase();
                            if (cellText.includes(searchTerm)) {
                                found = true;
                            }
                        });
                        
                        // 根据搜索结果显示或隐藏行
                        row.style.display = found ? '' : 'none';
                    });
                });
            }
        });
        
        // 全局作用域的对账差异详情查看函数
        function viewReconciliationDetail(id) {
            // 查找对应的对账差异记录
            const reconciliationItem = window.allReconciliationData && window.allReconciliationData.find(item => item.id === id);
            if (!reconciliationItem) {
                alert('未找到对账差异记录！');
                return;
            }
            
            // 构建详情信息
            let message = '对账差异详情\n\n';
            message += `类型: ${reconciliationItem.type === 'customer' ? '客户收款' : '电镀厂付款'}\n`;
            message += `订单编号: ${reconciliationItem.orderNumber || '无'}\n`;
            message += `关联方: ${reconciliationItem.party || '未知'}\n`;
            message += `账单编号/发票号: ${reconciliationItem.documentNumber || '无'}\n`;
            message += `系统金额: ¥${reconciliationItem.systemAmount.toFixed(2)}\n`;
            message += `实际金额: ¥${reconciliationItem.actualAmount.toFixed(2)}\n`;
            message += `差异金额: ¥${reconciliationItem.diffAmount.toFixed(2)}\n`;
            message += `差异类型: ${reconciliationItem.diffType === 'matched' ? '应付金额与实际付款金额一致' : 
                        reconciliationItem.type === 'customer' ? 
                            (reconciliationItem.diffType === 'overpayment' ? '客户多付' : 
                             reconciliationItem.diffType === 'underpayment' ? '客户少付' : '未付款') :
                            (reconciliationItem.diffType === 'overpayment' ? '少付电镀厂' : 
                             reconciliationItem.diffType === 'underpayment' ? '多付电镀厂' : '未付电镀厂')}\n`;
            message += `创建日期: ${reconciliationItem.createdDate}\n`;
            message += `最后交易日期: ${reconciliationItem.lastTransactionDate}\n`;
            message += `差异原因: ${reconciliationItem.reason || '无'}\n`;
            message += `处理状态: ${reconciliationItem.status === 'handled' ? '已处理' : 
                        reconciliationItem.status === 'partially-handled' ? '部分处理' : '未处理'}`;
            
            // 显示详情
            alert(message);
        }
        
        // 全局作用域的对账差异处理函数
        function handleReconciliation(id) {
            // 查找对应的对账差异记录
            const reconciliationItem = window.allReconciliationData && window.allReconciliationData.find(item => item.id === id);
            if (!reconciliationItem) {
                alert('未找到对账差异记录！');
                return;
            }
            
            // 提示用户确认处理
            if (confirm(`确定要${reconciliationItem.status === 'handled' ? '重新处理' : '处理'}该对账差异吗？`)) {
                // 更新记录状态
                reconciliationItem.status = reconciliationItem.status === 'handled' ? 'unhandled' : 'handled';
                
                // 更新界面显示
                const reconcileBtn = document.getElementById('reconcile-btn');
                if (reconcileBtn) {
                    // 触发重新对账以更新显示
                    reconcileBtn.click();
                }
                
                alert('对账差异处理成功！');
            }
        }
        
        // 确保allReconciliationData在全局作用域可访问
        window.allReconciliationData = [];
        
        // 初始化页面功能
        document.addEventListener('DOMContentLoaded', function() {
            console.log('开始初始化页面功能...');
            
            // 更新当前日期显示
            const currentDateElement = document.getElementById('current-date');
            if (currentDateElement) {
                const now = new Date();
                const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
                currentDateElement.textContent = now.toLocaleDateString('zh-CN', options);
                console.log('当前日期已更新');
            }
            
            // 初始化导航系统
            const navItems = document.querySelectorAll('.nav-item');
            const moduleContents = document.querySelectorAll('.module-content');
            const pageTitle = document.getElementById('page-title');
            
            console.log('找到导航项数量:', navItems.length);
            console.log('找到模块内容数量:', moduleContents.length);
            console.log('页面标题元素存在:', !!pageTitle);
            
            // 确保所有模块都初始化为隐藏，除了dashboard模块
            moduleContents.forEach(content => {
                if (content.id !== 'dashboard-module') {
                    content.classList.add('hidden');
                    content.style.display = 'none'; // 双重保险
                } else {
                    content.classList.remove('hidden');
                    content.style.display = 'block';
                    console.log('初始化显示dashboard模块');
                }
            });
            
            // 简化的导航功能实现
            function showModule(moduleName) {
                console.log('显示模块:', moduleName);
                
                // 更新导航状态
                navItems.forEach(nav => nav.classList.remove('active'));
                const activeNav = document.querySelector(`[data-module="${moduleName}"]`);
                if (activeNav) {
                    activeNav.classList.add('active');
                }
                
                // 更新页面标题
                if (pageTitle && activeNav) {
                    const titleText = activeNav.querySelector('span')?.textContent || '未知页面';
                    pageTitle.textContent = titleText;
                    console.log('更新页面标题为:', titleText);
                }
                
                // 隐藏所有模块
                moduleContents.forEach(content => {
                    content.classList.add('hidden');
                    content.style.display = 'none';
                });
                
                // 显示目标模块
                const targetElement = document.getElementById(moduleName + '-module');
                if (targetElement) {
                    console.log('找到模块元素:', moduleName + '-module');
                    targetElement.classList.remove('hidden');
                    targetElement.style.display = 'block';
                    
                    // 模块特定初始化逻辑
                    try {
                        switch(moduleName) {
                            case 'dashboard':
                                if (typeof updateDashboardStats === 'function') {
                                    updateDashboardStats();
                                    console.log('执行dashboard初始化');
                                }
                                break;
                            case 'summary':
                                // 重置分页状态
                                if (typeof resetSummaryPagination === 'function') {
                                    resetSummaryPagination();
                                    console.log('重置汇总模块分页');
                                }
                                // 初始化分页和复选框功能
                                if (typeof initSummaryModule === 'function') {
                                    initSummaryModule();
                                    console.log('初始化汇总模块');
                                }
                                // 重新填充数据以应用分页
                                if (typeof populateOrderSummary === 'function') {
                                    setTimeout(populateOrderSummary, 100);
                                    console.log('重新填充汇总数据');
                                }
                                break;
                            case 'finance':
                                if (typeof initReconciliationSubmodules === 'function') {
                                    initReconciliationSubmodules();
                                    console.log('执行finance初始化');
                                }
                                break;
                        }
                    } catch (error) {
                        console.error('模块初始化错误:', error);
                    }
                } else {
                    console.error('未找到模块元素:', moduleName + '-module');
                }
            }
            
            // 为每个导航项添加点击事件
            navItems.forEach(function(item) {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const moduleName = this.getAttribute('data-module');
                    if (moduleName) {
                        console.log('导航项被点击:', moduleName);
                        showModule(moduleName);
                    }
                });
            });
            
            // 处理URL哈希变化
            window.addEventListener('hashchange', function() {
                const hash = window.location.hash.substring(1);
                if (hash) {
                    console.log('哈希变化:', hash);
                    showModule(hash);
                }
            });
            
            console.log('页面功能初始化完成');
        });
    </script>
    <div class="fixed bottom-4 left-4 font-cursive text-gray-medium" style="font-family: 'Ma Shan Zheng', cursive;">Designed by AlonZhang</div>
</body>
</html>
