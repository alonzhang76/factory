<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>炉架生产管理系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <style>
        /* 隐藏数字输入框的微调按钮 */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        
        /* 人员排班表样式 */
        .scheduling-cell {
            background-color: #A855F7;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: pre-line;
            text-align: center;
        }
        
        /* 员工姓名样式 */
        .employee-name {
            cursor: help;
            display: inline-block;
            padding: 2px 4px;
            border-radius: 2px;
            transition: background-color 0.2s;
        }
        
        .employee-name:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
    </style>
    <script>
        console.log('页面加载时检查localStorage中的订单数据:', localStorage.getItem('orderData'));
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        success: '#00B42A',
                        warning: '#FF7D00',
                        danger: '#F53F3F',
                        gray: {
                            100: '#F2F3F5',
                            200: '#E5E6EB',
                            300: '#C9CDD4',
                            400: '#86909C',
                            500: '#4E5969',
                            600: '#272E3B',
                            700: '#1D2129',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
        
        // 设备管理相关常量和变量
        const EQUIPMENT_STORAGE_KEY = 'production_equipment_data';
        let equipmentData = [];
        let currentEditIndex = -1;

        // 工序管理相关常量和变量
        const PROCESS_STORAGE_KEY = 'production_process_data';
        let processData = [];
        let currentProcessEditIndex = -1;
        
        // 订单管理相关常量和变量
        const ORDER_STORAGE_KEY = 'production_order_data';
        let orderData = [];
        let currentOrderEditIndex = -1;
        // 分页相关变量
        let currentOrderPage = 1;
        let ordersPerPage = 10;
        let totalOrderPages = 1;
        
        // 工单管理分页相关变量
        let currentWorkOrderPage = 1;
        let workOrdersPerPage = 10;
        let totalWorkOrderPages = 1;
        
        // 初始化设备数据
        function initEquipmentData() {
            // 检查localStorage中是否有设备数据
            const storedData = localStorage.getItem(EQUIPMENT_STORAGE_KEY);
            if (storedData) {
                equipmentData = JSON.parse(storedData);
            } else {
                // 初始设备数据
                equipmentData = [
                    { id: 'EQ001', name: '抛光机', purchaseDate: '2023-01-15', status: 'running' },
                    { id: 'EQ002', name: '剪板机', purchaseDate: '2023-02-20', status: 'running' },
                    { id: 'EQ003', name: '折弯机', purchaseDate: '2023-03-10', status: 'running' },
                    { id: 'EQ004', name: '电焊机', purchaseDate: '2023-04-05', status: 'maintenance' }
                ];
                localStorage.setItem(EQUIPMENT_STORAGE_KEY, JSON.stringify(equipmentData));
            }
            
            // 渲染设备列表
            renderEquipmentList();
        }

        // 初始化订单数据
        function initOrderData() {
            // 尝试从主要存储键加载数据
            let storedData = localStorage.getItem(ORDER_STORAGE_KEY);
            
            // 如果没有找到，尝试从旧的存储键加载数据
            if (!storedData) {
                console.log('未找到production_order_data数据，尝试从orderData加载');
                storedData = localStorage.getItem('orderData');
            }
            
            if (storedData) {
                // 加载存储的数据
                const loadedData = JSON.parse(storedData);
                console.log('从localStorage加载的订单数据:', loadedData);
                
                // 检查并转换每个订单，确保它们包含系统需要的字段结构
                orderData = loadedData.map(order => {
                    console.log('处理订单数据:', order.orderNumber || order.orderNo);
                    console.log('处理前:', JSON.stringify(order, null, 2));
                    
                    // 字段映射和默认值设置
                    const mappedOrder = {
                        // 映射基本字段
                        id: order.id || order.orderNumber || order.orderNo || `ORD${Date.now()}${Math.floor(Math.random() * 1000)}`,
                        date: order.date || order.deliveryDate || new Date().toISOString().split('T')[0],
                        customer: order.customer || '未知客户',
                        orderNumber: order.orderNumber || order.orderNo || '',
                        product: order.product || '未知产品',
                        specification: order.specification || '未知规格',
                        drawingNumber: order.drawingNumber || '',
                        quantity: order.quantity || 0,
                        status: order.status || '待处理',
                        remarks: order.remarks || '',
                        
                        // 映射工序相关字段
                        processes: Array.isArray(order.processes) ? order.processes : (order.processes ? order.processes.split('、').map(p => ({ name: p, quantity: 0, completed: 0, pending: 0, remarks: '' })) : []),
                        processCount: order.processCount || (Array.isArray(order.processes) ? order.processes.length : 0),
                        completedCount: order.completedCount || 0,
                        pendingCount: order.pendingCount || 0,
                        
                        // UI状态字段
                        isExpanded: order.isExpanded === undefined ? true : order.isExpanded,
                        isEditing: order.isEditing === undefined ? false : order.isEditing
                    };
                    
                    console.log('处理后:', JSON.stringify(mappedOrder, null, 2));
                    return mappedOrder;
                });
                
                // 保存修复后的数据到主要存储键
                localStorage.setItem(ORDER_STORAGE_KEY, JSON.stringify(orderData));
                console.log('修复后保存到localStorage的订单数据:', orderData);
            } else {
                // 如果没有存储数据，使用包含product和specification字段的初始订单数据
                orderData = [
                    { id: 'ORD20251221001', date: '2025-12-21', customer: '客户A', orderNumber: 'ORD20251221001', product: '炉架', specification: '1200x800x2000', drawingNumber: 'DRW-001', quantity: 100, processes: '切割、焊接、打磨', processCount: 3, completedCount: 60, pendingCount: 40, status: '进行中', remarks: '加急订单' },
                    { id: 'ORD20251220001', date: '2025-12-20', customer: '客户B', orderNumber: 'ORD20251220001', product: '支架', specification: '600x400x800', drawingNumber: 'DRW-002', quantity: 50, processes: '切割、折弯、焊接', processCount: 3, completedCount: 50, pendingCount: 0, status: '已完成', remarks: '常规订单' },
                    { id: 'ORD20251219001', date: '2025-12-19', customer: '客户C', orderNumber: 'ORD20251219001', product: '工作台', specification: '1500x1000x750', drawingNumber: 'DRW-003', quantity: 200, processes: '切割、焊接、打磨、喷漆', processCount: 4, completedCount: 120, pendingCount: 80, status: '进行中', remarks: '需要特殊包装' }
                ];
                // 保存到localStorage
                localStorage.setItem(ORDER_STORAGE_KEY, JSON.stringify(orderData));
                console.log('使用初始订单数据并保存到localStorage:', orderData);
            }
        }
        
        // 保存订单数据到localStorage
        function saveOrderData() {
            localStorage.setItem(ORDER_STORAGE_KEY, JSON.stringify(orderData));
        }
        
        // 更新分页控件
        function updatePaginationControls(filteredCount = orderData.length) {
            // 更新记录统计
            const recordCountEl = document.getElementById('orderRecordCount');
            const startIndex = (currentOrderPage - 1) * ordersPerPage;
            const endIndex = Math.min(startIndex + ordersPerPage, filteredCount);
            if (recordCountEl) {
                recordCountEl.textContent = `显示 ${startIndex + 1} 到 ${endIndex} 条，共 ${filteredCount} 条记录`;
            }
            
            // 更新当前页码和总页数
            const currentPageEl = document.getElementById('orderCurrentPage');
            const totalPagesEl = document.getElementById('orderTotalPages');
            if (currentPageEl) currentPageEl.textContent = currentOrderPage;
            if (totalPagesEl) totalPagesEl.textContent = totalOrderPages;
            
            // 更新页码跳转输入框
            const pageJumpEl = document.getElementById('orderPageJump');
            if (pageJumpEl) {
                pageJumpEl.value = currentOrderPage;
                pageJumpEl.max = totalOrderPages;
            }
            
            // 更新按钮状态
            const firstPageBtn = document.getElementById('orderFirstPage');
            const prevPageBtn = document.getElementById('orderPrevPage');
            const nextPageBtn = document.getElementById('orderNextPage');
            const lastPageBtn = document.getElementById('orderLastPage');
            
            if (firstPageBtn) firstPageBtn.disabled = currentOrderPage === 1;
            if (prevPageBtn) prevPageBtn.disabled = currentOrderPage === 1;
            if (nextPageBtn) nextPageBtn.disabled = currentOrderPage === totalOrderPages;
            if (lastPageBtn) lastPageBtn.disabled = currentOrderPage === totalOrderPages;
        }
        
        // 渲染订单表格
        function renderOrderTable(searchKeyword = '', startDate = '', endDate = '') {
            const orderTableBody = document.querySelector('#orderManagement-page table tbody');
            if (!orderTableBody) return;
            
            // 筛选数据
            let filteredData = orderData;
            
            // 关键词筛选
            if (searchKeyword) {
                const keyword = searchKeyword.toLowerCase();
                filteredData = filteredData.filter(order => 
                    order.customer.toLowerCase().includes(keyword) ||
                    order.orderNumber.toLowerCase().includes(keyword) ||
                    order.drawingNumber.toLowerCase().includes(keyword) ||
                    (order.product && order.product.toLowerCase().includes(keyword)) ||
                    (order.specification && order.specification.toLowerCase().includes(keyword))
                );
            }
            
            // 日期范围筛选
            if (startDate || endDate) {
                filteredData = filteredData.filter(order => {
                    // 确保订单有日期字段
                    if (!order.date) return true;
                    
                    const orderDate = new Date(order.date);
                    const start = startDate ? new Date(startDate) : new Date(0);
                    const end = endDate ? new Date(endDate) : new Date();
                    
                    // 设置结束日期为当天的最后一刻
                    end.setHours(23, 59, 59, 999);
                    
                    return orderDate >= start && orderDate <= end;
                });
            }
            
            // 计算总页数
            totalOrderPages = Math.ceil(filteredData.length / ordersPerPage);
            if (totalOrderPages === 0) totalOrderPages = 1;
            if (currentOrderPage > totalOrderPages) currentOrderPage = totalOrderPages;
            
            // 清空表格内容
            orderTableBody.innerHTML = '';
            
            // 计算当前页的数据范围
            const startIndex = (currentOrderPage - 1) * ordersPerPage;
            const endIndex = startIndex + ordersPerPage;
            const currentPageData = filteredData.slice(startIndex, endIndex);
            
            // 更新搜索结果统计
            const searchStatsEl = document.getElementById('orderSearchStats');
            const searchCountEl = document.getElementById('orderSearchCount');
            const searchTotalQuantityEl = document.getElementById('orderSearchTotalQuantity');
            
            if (searchKeyword) {
                // 计算搜索结果的总数量
                const totalQuantity = filteredData.reduce((sum, order) => sum + (parseInt(order.quantity) || 0), 0);
                
                if (searchStatsEl) searchStatsEl.classList.remove('hidden');
                if (searchCountEl) searchCountEl.textContent = filteredData.length;
                if (searchTotalQuantityEl) searchTotalQuantityEl.textContent = totalQuantity;
            } else {
                if (searchStatsEl) searchStatsEl.classList.add('hidden');
            }
            
            // 渲染当前页的每个订单
            currentPageData.forEach((order, index) => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-100 hover:bg-gray-50';
                
                // 日期
                const dateTd = document.createElement('td');
                dateTd.className = 'py-3 px-4 whitespace-nowrap';
                dateTd.textContent = order.date;
                row.appendChild(dateTd);
                
                // 客户
                const customerTd = document.createElement('td');
                customerTd.className = 'py-3 px-4 whitespace-nowrap';
                customerTd.textContent = order.customer;
                row.appendChild(customerTd);
                
                // 订单号
                const orderNumberTd = document.createElement('td');
                orderNumberTd.className = 'py-3 px-4 whitespace-nowrap';
                orderNumberTd.textContent = order.orderNumber;
                row.appendChild(orderNumberTd);
                
                // 产品
                const productTd = document.createElement('td');
                productTd.className = 'py-3 px-4 whitespace-nowrap';
                productTd.textContent = order.product || '';
                row.appendChild(productTd);
                
                // 规格
                const specificationTd = document.createElement('td');
                specificationTd.className = 'py-3 px-4 whitespace-nowrap';
                specificationTd.textContent = order.specification || '';
                row.appendChild(specificationTd);
                
                // 图纸号
                const drawingNumberTd = document.createElement('td');
                drawingNumberTd.className = 'py-3 px-4 whitespace-nowrap';
                drawingNumberTd.textContent = order.drawingNumber;
                row.appendChild(drawingNumberTd);
                
                // 数量
                const quantityTd = document.createElement('td');
                quantityTd.className = 'py-3 px-4 whitespace-nowrap';
                quantityTd.textContent = order.quantity;
                row.appendChild(quantityTd);
                
                // 新增：空白列（用于折叠和加号图标）
                const controlTd = document.createElement('td');
                controlTd.className = 'py-3 px-4 whitespace-nowrap text-center';
                
                // 确保订单有processes数组和isExpanded属性
                if (!Array.isArray(order.processes)) {
                    // 将旧格式的字符串转换为数组
                    order.processes = order.processes ? order.processes.split('、').map(p => ({ name: p, quantity: 0, completed: 0, pending: 0, remarks: '' })) : [];
                }
                if (order.isExpanded === undefined) {
                    order.isExpanded = true;
                }
                
                // 折叠/展开按钮
                const toggleBtn = document.createElement('button');
                toggleBtn.className = 'text-secondary mr-2';
                toggleBtn.innerHTML = order.isExpanded ? '<i class="fa fa-chevron-down"></i>' : '<i class="fa fa-chevron-right"></i>';
                toggleBtn.addEventListener('click', () => {
                    order.isExpanded = !order.isExpanded;
                    saveOrderData();
                    renderOrderTable();
                });
                controlTd.appendChild(toggleBtn);
                
                // 加号按钮（添加工序）
                const addProcessBtn = document.createElement('button');
                addProcessBtn.className = 'text-primary';
                addProcessBtn.innerHTML = '<i class="fa fa-plus"></i>';
                addProcessBtn.addEventListener('click', () => {
                    // 添加新工序，包含所有必要字段
                    order.processes.push({ name: '', quantity: 0, completed: 0, pending: 0, remarks: '' });
                    order.processCount = order.processes.length;
                    saveOrderData();
                    renderOrderTable();
                });
                controlTd.appendChild(addProcessBtn);
                
                row.appendChild(controlTd);
                
                // 工序
                const processesTd = document.createElement('td');
                processesTd.className = 'py-3 px-4 whitespace-nowrap';
                
                if (order.isExpanded && order.processes.length > 0) {
                    const processesList = document.createElement('div');
                    
                    // 添加表头行
                    const headerDiv = document.createElement('div');
                    headerDiv.className = 'mb-1 flex items-center font-bold text-sm';
                    headerDiv.innerHTML = '<div class="w-32 mr-2"></div><div class="w-20 mr-2">工序数量</div><div class="w-20 mr-2">已完成数量</div><div class="w-20 mr-2">待完成数量</div><div class="w-40 mr-2">备注</div>';
                    processesList.appendChild(headerDiv);
                    
                    order.processes.forEach((process, processIndex) => {
                        // 确保每个工序对象有必要的字段
                        if (!process.hasOwnProperty('quantity')) process.quantity = 0;
                        if (!process.hasOwnProperty('completed')) process.completed = 0;
                        if (!process.hasOwnProperty('pending')) process.pending = 0;
                        if (!process.hasOwnProperty('remarks')) process.remarks = '';
                        
                        const processDiv = document.createElement('div');
                        processDiv.className = 'mb-2 flex items-center';
                        
                        // 工序输入框（带下拉列表）
                        const processInputContainer = document.createElement('div');
                        processInputContainer.className = 'relative mr-2';
                        
                        const processInput = document.createElement('input');
                        processInput.type = 'text';
                        processInput.value = process.name;
                        processInput.className = 'border rounded px-2 py-1 text-sm w-32';
                        processInputContainer.appendChild(processInput);
                        
                        // 工序下拉列表
                        const processDropdown = document.createElement('div');
                        processDropdown.className = 'hidden fixed z-50 mt-1 w-32 bg-white border border-gray-200 rounded-lg shadow-lg max-h-40 overflow-y-auto';
                        // 将下拉列表添加到body而不是输入框容器，避免被overflow-x-auto裁剪
                        document.body.appendChild(processDropdown);
                        
                        // 实时筛选工序列表
                        const filterProcesses = () => {
                            const searchTerm = processInput.value.toLowerCase();
                            const filteredProcesses = processData.filter(p => p.name.toLowerCase().includes(searchTerm));
                            
                            processDropdown.innerHTML = '';
                            if (filteredProcesses.length > 0) {
                                // 获取输入框的位置和尺寸
                                const inputRect = processInput.getBoundingClientRect();
                                
                                // 设置下拉列表的位置
                                processDropdown.style.top = `${inputRect.top + window.scrollY + inputRect.height}px`;
                                processDropdown.style.left = `${inputRect.left + window.scrollX}px`;
                                processDropdown.style.width = `${inputRect.width}px`;
                                
                                processDropdown.classList.remove('hidden');
                                filteredProcesses.forEach(p => {
                                    const option = document.createElement('div');
                                    option.className = 'px-2 py-1 hover:bg-gray-100 cursor-pointer text-sm';
                                    option.textContent = p.name;
                                    option.addEventListener('click', () => {
                                        processInput.value = p.name;
                                        process.name = p.name;
                                        processDropdown.classList.add('hidden');
                                        
                                        // 更新已完成数量
                                        updateCompletedQuantity();
                                        saveOrderData();
                                    });
                                    processDropdown.appendChild(option);
                                });
                            } else {
                                processDropdown.classList.add('hidden');
                            }
                        };
                        
                        // 更新待完成数量的函数
                        const updatePendingQuantity = () => {
                            const quantity = parseInt(quantityInput.value) || 0;
                            const completed = parseInt(completedInput.value) || 0;
                            const pending = quantity - completed;
                             
                            process.pending = pending;
                            pendingInput.value = pending;
                        };
                        
                        // 更新已完成数量的函数
                        const updateCompletedQuantity = () => {
                            const customer = order.customer;
                            const orderNumber = order.orderNumber;
                            const currentProcess = process.name;
                             
                            // 汇总该客户订单号下该工序的已完成数量
                            let totalCompleted = 0;
                            workOrderData.forEach(workOrder => {
                                if (workOrder.customer === customer && 
                                    workOrder.orderNumber === orderNumber && 
                                    workOrder.process === currentProcess) {
                                    totalCompleted += workOrder.processQuantity;
                                }
                            });
                             
                            process.completed = totalCompleted;
                            completedInput.value = totalCompleted;
                             
                            // 更新待完成数量
                            updatePendingQuantity();
                        };
                        
                        // 工序输入框事件
                        processInput.addEventListener('input', () => {
                            process.name = processInput.value;
                            filterProcesses();
                            updateCompletedQuantity();
                            saveOrderData();
                        });
                        
                        // 点击外部关闭下拉列表
                        document.addEventListener('click', (e) => {
                            if (!processInputContainer.contains(e.target)) {
                                processDropdown.classList.add('hidden');
                            }
                        });
                        
                        processDiv.appendChild(processInputContainer);
                        
                        // 可编辑的工序数量输入框
                        const quantityInput = document.createElement('input');
                        quantityInput.type = 'number';
                        quantityInput.value = process.quantity;
                        quantityInput.min = '0';
                        quantityInput.className = 'border rounded px-2 py-1 mr-2 text-sm w-20';
                        // 添加CSS样式隐藏微调按钮
                        quantityInput.style.webkitAppearance = 'none';
                        quantityInput.style.mozAppearance = 'textfield';
                        quantityInput.addEventListener('input', () => {
                            process.quantity = parseInt(quantityInput.value) || 0;
                            updatePendingQuantity();
                            saveOrderData();
                        });
                        processDiv.appendChild(quantityInput);
                        
                        // 已完成数量输入框（只读）
                        const completedInput = document.createElement('input');
                        completedInput.type = 'number';
                        completedInput.value = process.completed;
                        completedInput.min = '0';
                        completedInput.className = 'border rounded px-2 py-1 mr-2 text-sm w-20 bg-gray-50';
                        // 添加CSS样式隐藏微调按钮
                        completedInput.style.webkitAppearance = 'none';
                        completedInput.style.mozAppearance = 'textfield';
                        completedInput.readOnly = true;
                        
                        processDiv.appendChild(completedInput);
                         
                        // 待完成数量输入框（只读）
                        const pendingInput = document.createElement('input');
                        pendingInput.type = 'number';
                        pendingInput.value = process.pending;
                        pendingInput.min = '0';
                        pendingInput.className = 'border rounded px-2 py-1 mr-2 text-sm w-20 bg-gray-50';
                        // 添加CSS样式隐藏微调按钮
                        pendingInput.style.webkitAppearance = 'none';
                        pendingInput.style.mozAppearance = 'textfield';
                        pendingInput.readOnly = true;
                        
                        // 初始化时更新已完成数量和待完成数量（在所有输入框都声明后调用）
                        updateCompletedQuantity();
                        updatePendingQuantity();
                        
                        processDiv.appendChild(pendingInput);
                        
                        // 可编辑的备注输入框
                        const remarksInput = document.createElement('input');
                        remarksInput.type = 'text';
                        remarksInput.value = process.remarks;
                        remarksInput.className = 'border rounded px-2 py-1 mr-2 text-sm w-40';
                        remarksInput.addEventListener('input', () => {
                            process.remarks = remarksInput.value;
                            saveOrderData();
                        });
                        processDiv.appendChild(remarksInput);
                        
                        // 删除工序按钮
                        const deleteProcessBtn = document.createElement('button');
                        deleteProcessBtn.className = 'text-danger text-sm';
                        deleteProcessBtn.innerHTML = '<i class="fa fa-times"></i>';
                        deleteProcessBtn.addEventListener('click', () => {
                            if (order.processes.length > 1) {
                                order.processes.splice(processIndex, 1);
                                order.processCount = order.processes.length;
                                saveOrderData();
                                renderOrderTable();
                            }
                        });
                        processDiv.appendChild(deleteProcessBtn);
                        
                        processesList.appendChild(processDiv);
                    });
                    processesTd.appendChild(processesList);
                } else if (!order.isExpanded) {
                    processesTd.textContent = `${order.processes.length} 道工序`;
                } else {
                    processesTd.textContent = '暂无工序';
                }
                
                row.appendChild(processesTd);
                
                // 状态
                const statusTd = document.createElement('td');
                statusTd.className = 'py-3 px-4 whitespace-nowrap';
                const statusSpan = document.createElement('span');
                statusSpan.className = 'px-2 py-1 rounded text-xs';
                
                // 确定订单状态
                function getOrderStatus(order) {
                    // 1. 检查工单管理表格中是否有该订单号的工序
                    const orderWorkOrders = workOrderData.filter(workOrder => workOrder.orderNumber === order.orderNumber);
                    
                    if (orderWorkOrders.length === 0) {
                        // 未出现该订单号的工序，显示"待开始"
                        return '待开始';
                    } else {
                        // 2. 出现该订单号的工序，找到最新日期的一道工序
                        // 按日期降序排序
                        orderWorkOrders.sort((a, b) => new Date(b.date) - new Date(a.date));
                        const latestWorkOrder = orderWorkOrders[0];
                        
                        // 3. 检查最新工序是否含"箱"字符且待完成数量为0
                        if (latestWorkOrder.process.includes('箱') && order.pendingCount === 0) {
                            return '已完成';
                        } else {
                            // 显示最新日期的工序名称
                            return latestWorkOrder.process;
                        }
                    }
                }
                
                const orderStatus = getOrderStatus(order);
                
                if (orderStatus === '已完成') {
                    statusSpan.className += ' bg-success/10 text-success';
                } else if (orderStatus === '待开始') {
                    statusSpan.className += ' bg-info/10 text-info';
                } else {
                    statusSpan.className += ' bg-warning/10 text-warning';
                }
                statusSpan.textContent = orderStatus;
                statusTd.appendChild(statusSpan);
                row.appendChild(statusTd);
                
                // 备注
                const remarksTd = document.createElement('td');
                remarksTd.className = 'py-3 px-4 whitespace-nowrap';
                remarksTd.textContent = order.remarks;
                row.appendChild(remarksTd);
                
                // 操作
                const actionTd = document.createElement('td');
                actionTd.className = 'py-3 px-4 whitespace-nowrap';
                
                const actionDiv = document.createElement('div');
                actionDiv.className = 'flex gap-2';
                
                // 编辑按钮
                const editBtn = document.createElement('button');
                // 确保订单对象有isEditing属性
                if (order.isEditing === undefined) {
                    order.isEditing = false;
                }
                
                // 设置初始状态
                if (order.isEditing) {
                    editBtn.className = 'text-success text-xs p-1';
                    editBtn.innerHTML = '<i class="fa fa-check"></i>';
                    editBtn.title = '完成编辑';
                } else {
                    editBtn.className = 'text-primary text-xs p-1';
                    editBtn.innerHTML = '<i class="fa fa-edit"></i>';
                    editBtn.title = '编辑';
                }
                
                editBtn.addEventListener('click', () => {
                    // 获取当前行的索引
                    const originalIndex = startIndex + index;
                    const currentOrder = orderData[originalIndex];
                    
                    if (currentOrder.isEditing) {
                        // 完成编辑，保存数据并退出编辑状态
                        currentOrder.isEditing = false;
                        saveOrderData();
                        renderOrderTable(); // 重新渲染表格以显示更新后的数据
                    } else {
                        // 进入编辑状态
                        currentOrder.isEditing = true;
                        saveOrderData();
                        
                        // 只有备注字段变为可编辑输入框
                        // 备注
                        remarksTd.innerHTML = '';
                        const remarksInput = document.createElement('input');
                        remarksInput.type = 'text';
                        remarksInput.value = currentOrder.remarks || '';
                        remarksInput.className = 'border rounded px-2 py-1 text-sm';
                        remarksInput.addEventListener('input', () => {
                            currentOrder.remarks = remarksInput.value;
                            saveOrderData();
                        });
                        remarksTd.appendChild(remarksInput);
                        
                        // 更新按钮图标和标题
                        editBtn.className = 'text-success text-xs p-1';
                        editBtn.innerHTML = '<i class="fa fa-check"></i>';
                        editBtn.title = '完成编辑';
                    }
                });
                
                actionDiv.appendChild(editBtn);
                actionTd.appendChild(actionDiv);
                row.appendChild(actionTd);
                
                orderTableBody.appendChild(row);
            });
            // 添加合计行
            if (currentPageData.length > 0) {
                // 计算当前页的总数量
                const currentPageTotalQuantity = currentPageData.reduce((sum, order) => sum + (parseInt(order.quantity) || 0), 0);
                
                // 创建合计行
                const totalRow = document.createElement('tr');
                totalRow.className = 'bg-gray-50 font-semibold';
                
                // 空白单元格（对应前面的列）
                for (let i = 0; i < 6; i++) {
                    const emptyTd = document.createElement('td');
                    emptyTd.className = 'py-3 px-4';
                    totalRow.appendChild(emptyTd);
                }
                
                // 合计数量单元格
                const totalQuantityTd = document.createElement('td');
                totalQuantityTd.className = 'py-3 px-4 whitespace-nowrap text-left';
                totalQuantityTd.textContent = `合计: ${currentPageTotalQuantity}`;
                totalRow.appendChild(totalQuantityTd);
                
                // 剩余空白单元格（对应后面的列）
                for (let i = 0; i < 5; i++) {
                    const emptyTd = document.createElement('td');
                    emptyTd.className = 'py-3 px-4';
                    totalRow.appendChild(emptyTd);
                }
                
                orderTableBody.appendChild(totalRow);
            }
            
            // 更新分页控件
            updatePaginationControls(filteredData.length);
        }
        
        // 工单数据相关
        const WORK_ORDER_STORAGE_KEY = 'workOrderData';
        let workOrderData = [
            {
                id: 'WJ20251221001',
                date: '2025-12-21',
                customer: '客户A',
                orderNumber: 'DD20251221001',
                process: '焊接',
                processQuantity: 50,
                equipment: '焊接机',
                employeeName: '张三',
                remarks: '注意焊接质量',
                status: 'processing'
            },
            {
                id: 'WJ20251221002',
                date: '2025-12-21',
                customer: '客户B',
                orderNumber: 'DD20251221002',
                process: '打磨',
                processQuantity: 100,
                equipment: '打磨机',
                employeeName: '李四',
                remarks: '',
                status: 'processing'
            },
            {
                id: 'WJ20251220001',
                date: '2025-12-20',
                customer: '客户A',
                orderNumber: 'DD20251220001',
                process: '喷漆',
                processQuantity: 50,
                equipment: '喷漆设备',
                employeeName: '王五',
                remarks: '使用环保漆',
                status: 'completed'
            }
        ];
        
        // 初始化工单数据
        function initWorkOrderData() {
            // 检查localStorage中是否有工单数据
            const savedWorkOrderData = localStorage.getItem(WORK_ORDER_STORAGE_KEY);
            if (savedWorkOrderData) {
                workOrderData = JSON.parse(savedWorkOrderData);
            } else {
                // 保存初始数据到localStorage
                localStorage.setItem(WORK_ORDER_STORAGE_KEY, JSON.stringify(workOrderData));
            }
        }
        
        // 保存工单数据到localStorage
        function saveWorkOrderData() {
            localStorage.setItem(WORK_ORDER_STORAGE_KEY, JSON.stringify(workOrderData));
        }

        // 打开编辑工单模态框并填充数据
        function openEditWorkOrderModal(index) {
            console.log('openEditWorkOrderModal函数被调用，索引值:', index);
            try {
                console.log('workOrderData:', workOrderData);
                console.log('workOrderData长度:', workOrderData.length);
                
                // 获取要编辑的工单数据
                const workOrder = workOrderData[index];
                console.log('要编辑的工单数据:', workOrder);
                
                // 在打开编辑模态框前，先为编辑模态框的下拉选择框生成选项
                populateEquipmentOptions();
                populateEmployeeOptions();
                
                // 检查表单元素是否存在
                const dateInput = document.getElementById('editModalWorkOrderDate');
                const numberInput = document.getElementById('editModalWorkOrderId'); // 修复ID不匹配问题
                console.log('日期输入框元素:', dateInput);
                console.log('工单号输入框元素:', numberInput);
                
                // 填充表单数据，添加空值检查
                if (dateInput) dateInput.value = workOrder.date;
                if (numberInput) numberInput.value = workOrder.id;
                
                // 为其他字段添加空值检查
                const customerInput = document.getElementById('editModalWorkOrderCustomer');
                const orderNumberInput = document.getElementById('editModalWorkOrderOrderNumber');
                const productInput = document.getElementById('editModalWorkOrderProduct');
                const specificationInput = document.getElementById('editModalWorkOrderSpecification');
                const processInput = document.getElementById('editModalWorkOrderProcess');
                const processQuantityInput = document.getElementById('editModalWorkOrderProcessQuantity');
                const repairQuantityInput = document.getElementById('editModalWorkOrderRepairQuantity');
                const scrapQuantityInput = document.getElementById('editModalWorkOrderScrapQuantity');
                const equipmentInput = document.getElementById('editModalWorkOrderEquipment');
                const employeeNameInput = document.getElementById('editModalWorkOrderEmployeeName');
                const remarksInput = document.getElementById('editModalWorkOrderRemarks');
                
                if (customerInput) customerInput.value = workOrder.customer;
                if (orderNumberInput) orderNumberInput.value = workOrder.orderNumber;
                if (productInput) productInput.value = workOrder.product;
                if (specificationInput) specificationInput.value = workOrder.specification;
                if (processInput) processInput.value = workOrder.process;
                if (processQuantityInput) processQuantityInput.value = workOrder.processQuantity;
                if (repairQuantityInput) repairQuantityInput.value = workOrder.repairQuantity || '';
                if (scrapQuantityInput) scrapQuantityInput.value = workOrder.scrapQuantity || '';
                if (equipmentInput) equipmentInput.value = workOrder.equipment;
                if (employeeNameInput) employeeNameInput.value = workOrder.employeeName;
                if (remarksInput) remarksInput.value = workOrder.remarks || '';
                
                // 设置隐藏的工单索引，修复ID不匹配问题
                const indexInput = document.getElementById('editWorkOrderIndex');
                if (indexInput) indexInput.value = index;
                
                // 显示模态框
                const editModal = document.getElementById('editWorkOrderModal');
                console.log('模态框元素:', editModal);
                if (editModal) {
                    console.log('模态框当前类名:', editModal.className);
                    editModal.classList.remove('hidden');
                    editModal.classList.add('flex');
                    console.log('模态框修改后的类名:', editModal.className);
                    console.log('模态框已显示');
                } else {
                    console.error('未找到编辑模态框元素');
                }
            } catch (error) {
                console.error('打开编辑模态框时出错:', error);
                console.error('错误堆栈:', error.stack);
            }
        }
        
        // 更新工单分页控件
        function updateWorkOrderPaginationControls(filteredCount = workOrderData.length) {
            // 更新记录统计
            const recordCountEl = document.getElementById('workOrderRecordCount');
            const startIndex = (currentWorkOrderPage - 1) * workOrdersPerPage;
            const endIndex = Math.min(startIndex + workOrdersPerPage, filteredCount);
            if (recordCountEl) {
                recordCountEl.textContent = `显示 ${startIndex + 1} 到 ${endIndex} 条，共 ${filteredCount} 条记录`;
            }
            
            // 更新当前页码和总页数
            const currentPageEl = document.getElementById('workOrderCurrentPage');
            const totalPagesEl = document.getElementById('workOrderTotalPages');
            if (currentPageEl) currentPageEl.textContent = currentWorkOrderPage;
            if (totalPagesEl) totalPagesEl.textContent = totalWorkOrderPages;
            
            // 更新页码跳转输入框
            const pageJumpEl = document.getElementById('workOrderPageJump');
            if (pageJumpEl) {
                pageJumpEl.value = currentWorkOrderPage;
                pageJumpEl.max = totalWorkOrderPages;
            }
            
            // 更新按钮状态
            const firstPageBtn = document.getElementById('workOrderFirstPage');
            const prevPageBtn = document.getElementById('workOrderPrevPage');
            const nextPageBtn = document.getElementById('workOrderNextPage');
            const lastPageBtn = document.getElementById('workOrderLastPage');
            
            if (firstPageBtn) firstPageBtn.disabled = currentWorkOrderPage === 1;
            if (prevPageBtn) prevPageBtn.disabled = currentWorkOrderPage === 1;
            if (nextPageBtn) nextPageBtn.disabled = currentWorkOrderPage === totalWorkOrderPages;
            if (lastPageBtn) lastPageBtn.disabled = currentWorkOrderPage === totalWorkOrderPages;
        }
        
        // 渲染工单表格
        function renderWorkOrderTable(searchKeyword = '', startDate = '', endDate = '') {
            const workOrderTableBody = document.querySelector('#orders-page table tbody');
            if (!workOrderTableBody) return;
            
            // 搜索筛选
            let filteredData = workOrderData;
            
            // 关键词筛选
            if (searchKeyword.trim()) {
                const keyword = searchKeyword.toLowerCase().trim();
                filteredData = filteredData.filter(workOrder => 
                    (workOrder.id && workOrder.id.toLowerCase().includes(keyword)) ||
                    (workOrder.customer && workOrder.customer.toLowerCase().includes(keyword)) ||
                    (workOrder.orderNumber && workOrder.orderNumber.toLowerCase().includes(keyword)) ||
                    (workOrder.process && workOrder.process.toLowerCase().includes(keyword)) ||
                    (workOrder.product && workOrder.product.toLowerCase().includes(keyword)) ||
                    (workOrder.specification && workOrder.specification.toLowerCase().includes(keyword)) ||
                    (workOrder.employeeName && workOrder.employeeName.toLowerCase().includes(keyword))
                );
            }
            
            // 日期范围筛选
            if (startDate || endDate) {
                filteredData = filteredData.filter(workOrder => {
                    // 确保工单有日期字段
                    if (!workOrder.date) return true;
                    
                    const workOrderDate = new Date(workOrder.date);
                    const start = startDate ? new Date(startDate) : new Date(0);
                    const end = endDate ? new Date(endDate) : new Date();
                    
                    // 设置结束日期为当天的最后一刻
                    end.setHours(23, 59, 59, 999);
                    
                    return workOrderDate >= start && workOrderDate <= end;
                });
            }
            
            // 计算总页数
            totalWorkOrderPages = Math.ceil(filteredData.length / workOrdersPerPage);
            if (totalWorkOrderPages === 0) totalWorkOrderPages = 1;
            if (currentWorkOrderPage > totalWorkOrderPages) currentWorkOrderPage = totalWorkOrderPages;
            
            // 清空表格内容
            workOrderTableBody.innerHTML = '';
            
            // 计算当前页的数据范围
            const startIndex = (currentWorkOrderPage - 1) * workOrdersPerPage;
            const endIndex = startIndex + workOrdersPerPage;
            const currentPageData = filteredData.slice(startIndex, endIndex);
            
            // 更新搜索结果统计
            const searchStats = document.getElementById('workOrderSearchStats');
            const searchCount = document.getElementById('workOrderSearchCount');
            const processTotal = document.getElementById('workOrderProcessTotal');
            
            if (searchKeyword.trim()) {
                // 计算工序数量合计
                const totalProcessQuantity = filteredData.reduce((total, workOrder) => {
                    return total + (parseFloat(workOrder.processQuantity) || 0);
                }, 0);
                
                if (searchStats) searchStats.classList.remove('hidden');
                if (searchCount) searchCount.textContent = filteredData.length;
                if (processTotal) processTotal.textContent = totalProcessQuantity;
            } else {
                if (searchStats) searchStats.classList.add('hidden');
            }
            
            // 渲染当前页的每个工单
            currentPageData.forEach((workOrder, index) => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-100 hover:bg-gray-50';
                
                // 复选框
                const checkboxTd = document.createElement('td');
                checkboxTd.className = 'py-3 px-4 whitespace-nowrap';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'rounded border-gray-300 text-primary focus:ring-primary';
                checkbox.dataset.workOrderId = workOrder.id;
                checkboxTd.appendChild(checkbox);
                row.appendChild(checkboxTd);
                
                // 日期
                const dateTd = document.createElement('td');
                dateTd.className = 'py-3 px-4 whitespace-nowrap';
                dateTd.textContent = workOrder.date;
                row.appendChild(dateTd);
                
                // 工单编号
                const idTd = document.createElement('td');
                idTd.className = 'py-3 px-4 whitespace-nowrap';
                idTd.textContent = workOrder.id;
                row.appendChild(idTd);
                
                // 客户
                const customerTd = document.createElement('td');
                customerTd.className = 'py-3 px-4 whitespace-nowrap';
                customerTd.textContent = workOrder.customer;
                row.appendChild(customerTd);
                
                // 订单号
                const orderNumberTd = document.createElement('td');
                orderNumberTd.className = 'py-3 px-4 whitespace-nowrap';
                orderNumberTd.textContent = workOrder.orderNumber;
                row.appendChild(orderNumberTd);
                
                // 产品
                const productTd = document.createElement('td');
                productTd.className = 'py-3 px-4 whitespace-nowrap';
                productTd.textContent = workOrder.product || '';
                row.appendChild(productTd);
                
                // 规格
                const specificationTd = document.createElement('td');
                specificationTd.className = 'py-3 px-4 whitespace-nowrap';
                specificationTd.textContent = workOrder.specification || '';
                row.appendChild(specificationTd);
                
                // 工序
                const processTd = document.createElement('td');
                processTd.className = 'py-3 px-4 whitespace-nowrap';
                processTd.textContent = workOrder.process;
                row.appendChild(processTd);
                
                // 工序数量
                const processQuantityTd = document.createElement('td');
                processQuantityTd.className = 'py-3 px-4 whitespace-nowrap';
                processQuantityTd.textContent = workOrder.processQuantity;
                row.appendChild(processQuantityTd);
                
                // 返修数量
                const repairQuantityTd = document.createElement('td');
                repairQuantityTd.className = 'py-3 px-4 whitespace-nowrap';
                repairQuantityTd.textContent = workOrder.repairQuantity || '';
                row.appendChild(repairQuantityTd);
                
                // 报废数量
                const scrapQuantityTd = document.createElement('td');
                scrapQuantityTd.className = 'py-3 px-4 whitespace-nowrap';
                scrapQuantityTd.textContent = workOrder.scrapQuantity || '';
                row.appendChild(scrapQuantityTd);
                
                // 所需设备
                const equipmentTd = document.createElement('td');
                equipmentTd.className = 'py-3 px-4 whitespace-nowrap';
                equipmentTd.textContent = workOrder.equipment;
                row.appendChild(equipmentTd);
                
                // 员工姓名
                const employeeNameTd = document.createElement('td');
                employeeNameTd.className = 'py-3 px-4 whitespace-nowrap';
                employeeNameTd.textContent = workOrder.employeeName;
                row.appendChild(employeeNameTd);
                
                // 备注
                const remarksTd = document.createElement('td');
                remarksTd.className = 'py-3 px-4 whitespace-nowrap';
                remarksTd.textContent = workOrder.remarks;
                row.appendChild(remarksTd);
                
                // 操作
                const actionTd = document.createElement('td');
                actionTd.className = 'py-3 px-4 whitespace-nowrap';
                
                const actionDiv = document.createElement('div');
                actionDiv.className = 'flex gap-2';
                
                // 编辑按钮
                const editBtn = document.createElement('button');
                editBtn.className = 'text-primary hover:text-primary/80 p-1';
                editBtn.innerHTML = '<i class="fa fa-edit"></i>';
                editBtn.title = '编辑';
                editBtn.addEventListener('click', () => {
                    console.log('编辑按钮被点击');
                    console.log('当前页码索引:', index);
                    console.log('当前页起始索引:', startIndex);
                    // 计算原始数据中的索引
                    const originalIndex = startIndex + index;
                    console.log('计算得到的原始数据索引:', originalIndex);
                    // 打开编辑模态框并填充数据
                    openEditWorkOrderModal(originalIndex);
                });
                
                // 删除按钮
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'text-danger hover:text-danger/80 p-1';
                deleteBtn.innerHTML = '<i class="fa fa-trash"></i>';
                deleteBtn.title = '删除';
                deleteBtn.addEventListener('click', () => {
                    if (confirm('确定要删除该工单吗？')) {
                        // 计算原始数据中的索引
                        const originalIndex = startIndex + index;
                        // 删除工单
                        workOrderData.splice(originalIndex, 1);
                        saveWorkOrderData();
                        renderWorkOrderTable();
                    }
                });
                
                actionDiv.appendChild(editBtn);
                actionDiv.appendChild(deleteBtn);
                actionTd.appendChild(actionDiv);
                row.appendChild(actionTd);
                
                workOrderTableBody.appendChild(row);
            });
            
            // 更新分页控件
            updateWorkOrderPaginationControls(filteredData.length);
        }
        
        // 初始化工序数据
        function initProcessData() {
            // 检查localStorage中是否有工序数据
            const storedData = localStorage.getItem(PROCESS_STORAGE_KEY);
            if (storedData) {
                processData = JSON.parse(storedData);
            } else {
                // 初始工序数据
                processData = [
                    { id: 'PR001', name: '裁剪', description: '使用剪板机裁剪原材料' },
                    { id: 'PR002', name: '折弯', description: '使用折弯机进行金属弯曲' },
                    { id: 'PR003', name: '焊接', description: '使用电焊机进行部件焊接' },
                    { id: 'PR004', name: '抛光', description: '使用抛光机进行表面处理' }
                ];
                localStorage.setItem(PROCESS_STORAGE_KEY, JSON.stringify(processData));
            }
            
            // 渲染工序列表
            renderProcessList();
        }
        
        // 设备维护记录数据
        let maintenanceRecords = [];
        const MAINTENANCE_STORAGE_KEY = 'factory_management_system_maintenance_records';
        let currentSelectedEquipment = null; // 跟踪当前选中的设备
        
        // 初始化维护记录数据
        function initMaintenanceRecords() {
            const storedData = localStorage.getItem(MAINTENANCE_STORAGE_KEY);
            console.log('从localStorage加载维护记录:', storedData);
            if (storedData) {
                maintenanceRecords = JSON.parse(storedData);
                console.log('解析后的维护记录:', maintenanceRecords);
            } else {
                // 初始化空数组
                maintenanceRecords = [];
                localStorage.setItem(MAINTENANCE_STORAGE_KEY, JSON.stringify(maintenanceRecords));
                console.log('初始化空的维护记录数组');
            }
            
            // 渲染维护记录表格
            renderMaintenanceRecords();
        }
        
        // 保存维护记录数据到localStorage
        function saveMaintenanceRecords() {
            localStorage.setItem(MAINTENANCE_STORAGE_KEY, JSON.stringify(maintenanceRecords));
            console.log('维护记录已保存到localStorage:', maintenanceRecords);
            console.log('localStorage当前状态:', localStorage.getItem(MAINTENANCE_STORAGE_KEY));
        }
        
        // 生成维护记录ID
        function generateMaintenanceId() {
            // 格式：MR-年月日-4位随机数
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const dateStr = `${year}${month}${day}`;
            
            // 生成4位随机数
            const randomNum = String(Math.floor(1000 + Math.random() * 9000));
            
            return `MR-${dateStr}-${randomNum}`;
        }
        
        // 渲染维护记录表格，只显示当前选中设备的记录
        function renderMaintenanceRecords() {
            const tbody = document.getElementById('maintenance-records-body');
            if (!tbody) return;
            
            // 添加调试信息
            const debugInfo = document.getElementById('debug-info');
            if (debugInfo) {
                debugInfo.innerHTML = `维护记录总数: ${maintenanceRecords.length} | 当前选中设备: ${currentSelectedEquipment ? currentSelectedEquipment.name : '无'}`;
            }
            
            tbody.innerHTML = '';
            
            // 筛选出当前选中设备的记录
            const filteredRecords = currentSelectedEquipment 
                ? maintenanceRecords.filter(record => record.equipmentId === currentSelectedEquipment.id)
                : [];
            
            filteredRecords.forEach((record, index) => {
                const tr = document.createElement('tr');
                tr.className = 'border-b border-gray-100 hover:bg-gray-50';
                
                // 序号
                const serialTd = document.createElement('td');
                serialTd.className = 'py-3 px-4';
                serialTd.textContent = index + 1;
                
                // 维修记录
                const recordTd = document.createElement('td');
                recordTd.className = 'py-3 px-4';
                recordTd.innerHTML = `<div class="font-medium">${record.id}</div><div class="text-sm text-gray-600">${record.description}</div>`;
                
                // 日期
                const dateTd = document.createElement('td');
                dateTd.className = 'py-3 px-4';
                dateTd.textContent = record.date;
                
                // 添加到行
                tr.appendChild(serialTd);
                tr.appendChild(recordTd);
                tr.appendChild(dateTd);
                
                // 添加到表格
                tbody.appendChild(tr);
            });
        }
        
        // 打开维修记录模态框
        function openMaintenanceModal(equipment) {
            currentSelectedEquipment = equipment;
            document.getElementById('maintenance-equipment').value = equipment.name;
            // 设置默认日期为当前日期
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('maintenance-date').value = today;
            document.getElementById('maintenance-modal').classList.remove('hidden');
        }
        
        // 关闭维修记录模态框
        function closeMaintenanceModal() {
            document.getElementById('maintenance-modal').classList.add('hidden');
            document.getElementById('maintenance-form').reset();
        }
        
        // 处理维修记录表单提交
        function handleMaintenanceSubmit(event) {
            event.preventDefault();
            
            if (!currentSelectedEquipment) return;
            
            const formData = new FormData(event.target);
            const recordId = generateMaintenanceId();
            const newRecord = {
                id: recordId,
                equipmentId: currentSelectedEquipment.id,
                equipmentName: currentSelectedEquipment.name,
                description: formData.get('maintenanceRecord'),
                date: formData.get('maintenanceDate')
            };
            
            maintenanceRecords.push(newRecord);
            saveMaintenanceRecords();
            renderMaintenanceRecords();
            closeMaintenanceModal();
        }
        
        // 保存设备数据到localStorage
        function saveEquipmentData() {
            localStorage.setItem(EQUIPMENT_STORAGE_KEY, JSON.stringify(equipmentData));
        }

        // 保存工序数据到localStorage
        function saveProcessData() {
            localStorage.setItem(PROCESS_STORAGE_KEY, JSON.stringify(processData));
        }
        
        // 生成设备ID
        function generateEquipmentId() {
            const maxId = equipmentData.reduce((max, equipment) => {
                const idNum = parseInt(equipment.id.replace('EQ', ''), 10);
                return idNum > max ? idNum : max;
            }, 0);
            const newIdNum = maxId + 1;
            return `EQ${newIdNum.toString().padStart(3, '0')}`;
        }


        
        // 打开设备模态框
        function openAddEquipmentModal() {
            const equipmentModal = document.getElementById('equipment-modal');
            const equipmentModalTitle = document.getElementById('equipment-modal-title');
            const equipmentIdInput = document.getElementById('equipment-id');
            const equipmentForm = document.getElementById('equipment-form');
            const today = new Date().toISOString().split('T')[0];
            
            equipmentModalTitle.textContent = '新增设备';
            equipmentIdInput.value = generateEquipmentId();
            document.getElementById('equipment-name').value = '';
            document.getElementById('equipment-date').value = today;
            equipmentModal.classList.remove('hidden');
            
            // 重置表单
            equipmentForm.reset();
            equipmentIdInput.value = generateEquipmentId();
            document.getElementById('equipment-date').value = today;
        }
        
        // 关闭设备模态框
        function closeEquipmentModal() {
            const equipmentModal = document.getElementById('equipment-modal');
            equipmentModal.classList.add('hidden');
        }
        
        // 保存设备数据
        function saveEquipment(e) {
            e.preventDefault();
            
            const equipmentForm = document.getElementById('equipment-form');
            const formData = new FormData(equipmentForm);
            
            const equipment = {
                id: formData.get('equipmentId'),
                name: formData.get('equipmentName'),
                purchaseDate: formData.get('equipmentDate'),
                status: 'running' // 默认状态为运行中
            };
            
            // 添加新设备
            equipmentData.push(equipment);
            
            // 保存到localStorage
            saveEquipmentData();
            
            // 更新表格
            renderEquipmentList();
            
            // 关闭模态框
            closeEquipmentModal();
        }
        

        

        
        // 渲染设备列表
        function renderEquipmentList() {
            const tbody = document.querySelector('#equipment-page table tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            equipmentData.forEach((equipment, index) => {
                const tr = document.createElement('tr');
                tr.className = 'border-b border-gray-100 hover:bg-gray-50';
                
                // 序号（自动编号）
                const serialTd = document.createElement('td');
                serialTd.className = 'py-3 px-4';
                serialTd.textContent = index + 1;
                
                // 设备名称
                const nameTd = document.createElement('td');
                nameTd.className = 'py-3 px-4';
                nameTd.textContent = equipment.name;
                nameTd.dataset.field = 'name';
                
                // 添置日期
                const dateTd = document.createElement('td');
                dateTd.className = 'py-3 px-4';
                dateTd.textContent = equipment.purchaseDate;
                dateTd.dataset.field = 'purchaseDate';
                
                // 状态
                const statusTd = document.createElement('td');
                statusTd.className = 'py-3 px-4';
                
                const statusSpan = document.createElement('span');
                statusSpan.className = 'text-xs px-2 py-1 rounded cursor-pointer';
                
                // 根据状态设置不同的样式
                switch(equipment.status) {
                    case 'running':
                        statusSpan.className += ' bg-success/10 text-success';
                        statusSpan.textContent = '运行中';
                        break;
                    case 'maintenance':
                        statusSpan.className += ' bg-warning/10 text-warning';
                        statusSpan.textContent = '维护中';
                        break;
                    case 'scrapped':
                        statusSpan.className += ' bg-danger/10 text-danger';
                        statusSpan.textContent = '报废';
                        break;
                }
                
                statusTd.appendChild(statusSpan);
                
                // 添加状态点击事件
                statusSpan.addEventListener('click', () => toggleStatus(index));
                
                // 操作按钮
                const actionTd = document.createElement('td');
                actionTd.className = 'py-3 px-4';
                
                const actionDiv = document.createElement('div');
                actionDiv.className = 'flex gap-2';
                
                // 编辑按钮
                const editBtn = document.createElement('button');
                editBtn.className = 'text-primary hover:text-primary/80 edit-btn';
                editBtn.innerHTML = '<i class="fa fa-edit"></i>';
                editBtn.dataset.index = index;
                
                // 删除按钮
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'text-danger hover:text-danger/80 delete-btn';
                deleteBtn.innerHTML = '<i class="fa fa-trash"></i>';
                deleteBtn.dataset.index = index;
                
                // 添加维修记录按钮
                const maintenanceBtn = document.createElement('button');
                maintenanceBtn.className = 'text-warning hover:text-warning/80 maintenance-btn';
                maintenanceBtn.innerHTML = '<i class="fa fa-wrench"></i>';
                maintenanceBtn.dataset.index = index;
                
                actionDiv.appendChild(editBtn);
                actionDiv.appendChild(deleteBtn);
                actionDiv.appendChild(maintenanceBtn);
                actionTd.appendChild(actionDiv);
                
                // 将所有单元格添加到行中
                tr.appendChild(serialTd);
                tr.appendChild(nameTd);
                tr.appendChild(dateTd);
                tr.appendChild(statusTd);
                tr.appendChild(actionTd);
                
                // 添加设备行点击事件
                tr.addEventListener('click', () => {
                    // 移除其他行的选中样式
                    document.querySelectorAll('#equipment-page table tbody tr').forEach(row => {
                        row.classList.remove('bg-primary/10');
                    });
                    // 添加当前行的选中样式
                    tr.classList.add('bg-primary/10');
                    // 设置当前选中的设备
                    currentSelectedEquipment = equipment;
                    // 重新渲染维护记录表格
                    renderMaintenanceRecords();
                });
                
                // 添加到表格主体
                tbody.appendChild(tr);
            });
            
            // 添加新增设备行
            const addRow = document.createElement('tr');
            addRow.className = 'bg-gray-50 border-t border-gray-200';
            
            const addTd = document.createElement('td');
            addTd.className = 'py-3 px-4 text-center';
            addTd.colSpan = 5;
            
            const addBtn = document.createElement('button');
            addBtn.className = 'bg-primary text-white px-4 py-2 rounded-lg text-sm flex items-center gap-2 hover:bg-primary/90 transition-colors mx-auto';
            addBtn.innerHTML = '<i class="fa fa-plus"></i> 新增设备';
            addBtn.addEventListener('click', openAddEquipmentModal);
            
            addTd.appendChild(addBtn);
            addRow.appendChild(addTd);
            tbody.appendChild(addRow);
            
            // 绑定编辑按钮事件
            bindEditEvents();
        }

        // 渲染工序列表
        function renderProcessList() {
            const tbody = document.querySelector('#processManagement-page table tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            processData.forEach((process, index) => {
                const tr = document.createElement('tr');
                tr.className = 'border-b border-gray-100 hover:bg-gray-50';
                
                // 序号（自动编号）
                const serialTd = document.createElement('td');
                serialTd.className = 'py-3 px-4';
                serialTd.textContent = index + 1;
                
                // 工序名称
                const nameTd = document.createElement('td');
                nameTd.className = 'py-3 px-4';
                nameTd.textContent = process.name;
                
                // 备注
                const descriptionTd = document.createElement('td');
                descriptionTd.className = 'py-3 px-4';
                descriptionTd.textContent = process.description;
                
                // 操作按钮
                const actionTd = document.createElement('td');
                actionTd.className = 'py-3 px-4';
                
                const actionDiv = document.createElement('div');
                actionDiv.className = 'flex gap-2';
                
                // 编辑按钮
                const editBtn = document.createElement('button');
                editBtn.className = 'text-primary hover:text-primary/80 process-edit-btn';
                editBtn.innerHTML = '<i class="fa fa-edit"></i>';
                editBtn.dataset.index = index;
                
                actionDiv.appendChild(editBtn);
                actionTd.appendChild(actionDiv);
                
                // 将所有单元格添加到行中
                tr.appendChild(serialTd);
                tr.appendChild(nameTd);
                tr.appendChild(descriptionTd);
                tr.appendChild(actionTd);
                
                // 添加到表格主体
                tbody.appendChild(tr);
            });
            
            // 绑定工序编辑和删除按钮事件
            bindProcessEditEvents();
        }
        
        // 切换设备状态
        function toggleStatus(index) {
            if (index < 0 || index >= equipmentData.length) return;
            
            // 状态切换顺序：运行中 -> 维护中 -> 报废 -> 运行中
            const statusOrder = ['running', 'maintenance', 'scrapped'];
            const currentStatusIndex = statusOrder.indexOf(equipmentData[index].status);
            
            // 获取下一个状态
            const nextStatusIndex = (currentStatusIndex + 1) % statusOrder.length;
            equipmentData[index].status = statusOrder[nextStatusIndex];
            
            // 保存到localStorage
            saveEquipmentData();
            
            // 重新渲染列表
            renderEquipmentList();
        }
        
        // 绑定编辑按钮事件
        function bindEditEvents() {
            const editButtons = document.querySelectorAll('.edit-btn');
            editButtons.forEach(button => {
                button.addEventListener('click', handleEditClick);
            });
            
            // 绑定删除按钮点击事件
            const deleteButtons = document.querySelectorAll('.delete-btn');
            deleteButtons.forEach(button => {
                button.addEventListener('click', handleDeleteClick);
            });
            
            // 绑定添加维修记录按钮点击事件
            const maintenanceButtons = document.querySelectorAll('.maintenance-btn');
            maintenanceButtons.forEach(button => {
                button.addEventListener('click', handleMaintenanceClick);
            });
        }
        
        // 绑定工序编辑和删除按钮事件
        function bindProcessEditEvents() {
            // 绑定工序编辑按钮点击事件
            const processEditButtons = document.querySelectorAll('.process-edit-btn');
            processEditButtons.forEach(button => {
                button.addEventListener('click', handleProcessEditClick);
            });
            
            // 绑定工序删除按钮点击事件
            const processDeleteButtons = document.querySelectorAll('.process-delete-btn');
            processDeleteButtons.forEach(button => {
                button.addEventListener('click', handleProcessDeleteClick);
            });
        }
        
        // 处理工序编辑按钮点击
        function handleProcessEditClick(event) {
            const index = parseInt(event.target.closest('.process-edit-btn').dataset.index);
            if (isNaN(index)) return;
            
            // 如果已经在编辑状态，先取消
            if (currentProcessEditIndex !== -1) {
                cancelProcessEdit();
            }
            
            currentProcessEditIndex = index;
            
            // 获取工序行
            const row = event.target.closest('tr');
            if (!row) return;
            
            // 只将备注变为可编辑状态
            const descriptionTd = row.cells[2];
            
            // 保存原始值
            const originalName = row.cells[1].textContent;
            const originalDescription = descriptionTd.textContent;
            
            // 创建备注输入框
            const descriptionInput = document.createElement('textarea');
            descriptionInput.className = 'border border-gray-200 rounded-lg px-3 py-1 focus:outline-none focus:border-primary w-full resize-none';
            descriptionInput.value = originalDescription;
            descriptionInput.rows = 2;
            
            // 替换备注文本为输入框
            descriptionTd.innerHTML = '';
            descriptionTd.appendChild(descriptionInput);
            
            // 创建保存和取消按钮
            const actionTd = row.cells[3];
            const originalActionContent = actionTd.innerHTML;
            
            const actionDiv = document.createElement('div');
            actionDiv.className = 'flex gap-2';
            
            const saveBtn = document.createElement('button');
            saveBtn.className = 'text-success hover:text-success/80';
            saveBtn.innerHTML = '<i class="fa fa-check"></i>';
            saveBtn.addEventListener('click', () => {
                // 只保存备注编辑
                processData[index].description = descriptionInput.value;
                
                // 保存到localStorage
                saveProcessData();
                
                // 重新渲染工序列表
                renderProcessList();
                
                // 重置编辑索引
                currentProcessEditIndex = -1;
            });
            
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'text-danger hover:text-danger/80';
            cancelBtn.innerHTML = '<i class="fa fa-times"></i>';
            cancelBtn.addEventListener('click', cancelProcessEdit);
            
            actionDiv.appendChild(saveBtn);
            actionDiv.appendChild(cancelBtn);
            actionTd.innerHTML = '';
            actionTd.appendChild(actionDiv);
            
            // 自动聚焦到名称输入框
            nameInput.focus();
            
            // 保存原始内容以便取消编辑时恢复
            row.dataset.originalName = originalName;
            row.dataset.originalDescription = originalDescription;
            row.dataset.originalAction = originalActionContent;
        }
        
        // 取消工序编辑
        function cancelProcessEdit() {
            const rows = document.querySelectorAll('#processManagement-page table tbody tr');
            rows.forEach(row => {
                // 检查是否是当前编辑的行
                if (row.cells.length >= 4 && row.cells[3].querySelector('.text-success')) {
                    // 恢复原始内容
                    const descriptionTd = row.cells[2];
                    const actionTd = row.cells[3];
                    
                    descriptionTd.textContent = row.dataset.originalDescription;
                    actionTd.innerHTML = row.dataset.originalAction;
                    
                    // 重置编辑索引
                    currentProcessEditIndex = -1;
                }
            });
        }
        
        // 处理工序删除按钮点击
        function handleProcessDeleteClick(event) {
            const index = parseInt(event.target.closest('.process-delete-btn').dataset.index);
            if (isNaN(index)) return;
            
            // 阻止事件冒泡
            event.stopPropagation();
            
            // 确认删除
            if (confirm('确定要删除该工序吗？')) {
                // 删除工序数据
                processData.splice(index, 1);
                
                // 保存到localStorage
                saveProcessData();
                
                // 重新渲染工序列表
                renderProcessList();
            }
        }
        
        // 处理编辑按钮点击
        function handleEditClick(event) {
            const index = parseInt(event.target.closest('.edit-btn').dataset.index);
            if (isNaN(index)) return;
            
            // 如果已经在编辑状态，先取消
            if (currentEditIndex !== -1) {
                cancelEdit();
            }
            
            currentEditIndex = index;
            
            // 获取设备行
            const row = event.target.closest('tr');
            if (!row) return;
            
            // 将设备名称和添置日期变为可编辑状态
            const nameTd = row.cells[1];
            const dateTd = row.cells[2];
            
            // 保存原始值
            const originalName = nameTd.textContent;
            const originalDate = dateTd.textContent;
            
            // 创建输入框
            const nameInput = document.createElement('input');
            nameInput.type = 'text';
            nameInput.className = 'border border-gray-200 rounded-lg px-3 py-1 focus:outline-none focus:border-primary w-full';
            nameInput.value = originalName;
            
            const dateInput = document.createElement('input');
            dateInput.type = 'date';
            dateInput.className = 'border border-gray-200 rounded-lg px-3 py-1 focus:outline-none focus:border-primary w-full';
            dateInput.value = originalDate;
            
            // 替换文本为输入框
            nameTd.innerHTML = '';
            nameTd.appendChild(nameInput);
            
            dateTd.innerHTML = '';
            dateTd.appendChild(dateInput);
            
            // 自动保存功能
            nameInput.addEventListener('change', () => saveEdit(index, 'name', nameInput.value));
            dateInput.addEventListener('change', () => saveEdit(index, 'purchaseDate', dateInput.value));
            
            // 按下Enter键也保存
            nameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    nameInput.dispatchEvent(new Event('change'));
                }
            });
            
            dateInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    dateInput.dispatchEvent(new Event('change'));
                }
            });
            
            // 聚焦到第一个输入框
            nameInput.focus();
        }
        
        // 保存编辑
        function saveEdit(index, field, value) {
            if (index >= 0 && index < equipmentData.length) {
                // 更新数据
                equipmentData[index][field] = value;
                
                // 保存到localStorage
                saveEquipmentData();
                
                // 重新渲染列表
                renderEquipmentList();
                
                // 重置编辑状态
                currentEditIndex = -1;
            }
        }
        
        // 取消编辑
        function cancelEdit() {
            // 重新渲染列表以恢复原始状态
            renderEquipmentList();
            currentEditIndex = -1;
        }
        
        // 处理删除按钮点击
        function handleDeleteClick(event) {
            const index = parseInt(event.target.closest('.delete-btn').dataset.index);
            if (isNaN(index)) return;
            
            if (confirm('确定要删除该设备吗？')) {
                // 从数组中删除设备
                equipmentData.splice(index, 1);
                
                // 保存到localStorage
                saveEquipmentData();
                
                // 重新渲染列表
                renderEquipmentList();
            }
        }
        
        // 处理添加维修记录按钮点击
        function handleMaintenanceClick(event) {
            const index = parseInt(event.target.closest('.maintenance-btn').dataset.index);
            if (isNaN(index)) return;
            
            // 获取设备信息
            const equipment = equipmentData[index];
            
            // 打开维修记录模态框
            openMaintenanceModal(equipment);
        }
        
        // 页面切换功能
        document.addEventListener('DOMContentLoaded', function() {
            // 获取所有导航链接
            const navLinks = document.querySelectorAll('nav a[data-page]');
            // 获取所有页面内容
            const pageContents = document.querySelectorAll('.page-content');
            
            // 为每个导航链接添加点击事件监听
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault(); // 阻止默认链接行为
                    
                    const targetPage = this.getAttribute('data-page');
                    
                    // 移除所有导航链接的激活状态
                    navLinks.forEach(l => {
                        l.classList.remove('text-primary', 'bg-primary/5', 'border-b-2', 'border-primary');
                        l.classList.add('text-gray-600');
                    });
                    
                    // 为当前点击的链接添加激活状态
                    this.classList.add('text-primary', 'bg-primary/5', 'border-b-2', 'border-primary');
                    this.classList.remove('text-gray-600');
                    
                    // 隐藏所有页面内容
                    pageContents.forEach(page => {
                        page.classList.add('hidden');
                    });
                    
                    // 显示目标页面内容
                    const targetPageElement = document.getElementById(`${targetPage}-page`);
                    if (targetPageElement) {
                        targetPageElement.classList.remove('hidden');
                        

                        // 如果是设备管理页面，初始化设备数据
                        if (targetPage === 'equipment') {
                            initEquipmentData();
                        }
                        // 如果是订单管理页面，渲染订单表格
                        if (targetPage === 'orderManagement') {
                            renderOrderTable();
                        }
                        // 如果是工单管理页面，渲染工单表格
                        if (targetPage === 'orders') {
                            renderWorkOrderTable();
                        }
                    }
                });
            });
            
            // 初始化设备数据
            initEquipmentData();
            // 初始化维护记录数据
            initMaintenanceRecords();
            // 初始化工序数据
            initProcessData();
            // 初始化订单数据
            initOrderData();
            // 初始化工单数据
            initWorkOrderData();
            // 绑定订单管理事件
            bindOrderEvents();
            // 默认调用一次renderOrderTable，确保订单数据被正确加载和保存
            renderOrderTable();
            
            // 默认显示工单管理页面
            const workOrderNavLink = document.querySelector('a[data-page="orders"]');
            const workOrderPage = 'orders';
            
            // 移除所有导航链接的激活状态
            navLinks.forEach(link => {
                link.classList.remove('text-primary', 'bg-primary/5', 'border-b-2', 'border-primary');
                link.classList.add('text-gray-600');
            });
            
            // 激活工单管理导航链接
            if (workOrderNavLink) {
                workOrderNavLink.classList.add('text-primary', 'bg-primary/5', 'border-b-2', 'border-primary');
                workOrderNavLink.classList.remove('text-gray-600');
            }
            
            // 显示工单管理页面内容
            const workOrderPageElement = document.getElementById(`${workOrderPage}-page`);
            if (workOrderPageElement) {
                workOrderPageElement.classList.remove('hidden');
                // 页面首次加载时渲染工单管理表格，确保显示localStorage中的数据
                renderWorkOrderTable();
            }
            
            // 调试：页面加载完成后打印orderData内容
            console.log('页面加载完成后orderData:', orderData);
            
            // 获取当前选择的日期范围
            function getCurrentSchedulingDate() {
                const startDateInput = document.getElementById('schedulingStartDate');
                const endDateInput = document.getElementById('schedulingEndDate');
                
                // 解析开始日期，确保使用本地时间而非UTC时间，并设置为当天0点
                const startParts = startDateInput.value.split('-');
                const startDate = new Date(parseInt(startParts[0]), parseInt(startParts[1]) - 1, parseInt(startParts[2]));
                startDate.setHours(0, 0, 0, 0);
                
                // 解析结束日期，确保使用本地时间而非UTC时间，并设置为当天23:59:59
                const endParts = endDateInput.value.split('-');
                const endDate = new Date(parseInt(endParts[0]), parseInt(endParts[1]) - 1, parseInt(endParts[2]));
                endDate.setHours(23, 59, 59, 999);
                
                // 调试：输出解析后的开始和结束日期
                console.log('解析后的开始日期:', startDate.toISOString());
                console.log('解析后的结束日期:', endDate.toISOString());
                
                return {
                    startDate: startDate,
                    endDate: endDate
                };
            }
            
            // 生成日期列的表头
            function generateDateHeaders(startDate, endDate) {
                const table = document.querySelector('#scheduling-page table');
                if (!table) return;
                
                const thead = table.querySelector('thead');
                if (!thead) return;
                
                const headerRow = thead.querySelector('tr');
                if (!headerRow) return;
                
                // 移除现有的日期列（从第5列开始）
                while (headerRow.cells.length > 4) {
                    headerRow.removeChild(headerRow.cells[4]);
                }
                
                // 生成日期列 - 确保从startDate开始，包括startDate当天
                const currentDate = new Date(startDate);
                // 设置为当天的0点，确保日期比较准确
                currentDate.setHours(0, 0, 0, 0);
                
                // 调试：输出开始和结束日期
                console.log('生成日期列，开始日期:', currentDate.toISOString(), '结束日期:', endDate.toISOString());
                
                let counter = 0;
                while (currentDate <= endDate) {
                    const month = currentDate.getMonth() + 1;
                    const day = currentDate.getDate();
                    const dayOfWeek = currentDate.toLocaleDateString('zh-CN', { weekday: 'short' });
                    const th = document.createElement('th');
                    th.className = 'text-center py-3 px-4 font-medium text-gray-500 whitespace-nowrap';
                    th.innerHTML = `${month}/${day}<br>${dayOfWeek}`;
                    headerRow.appendChild(th);
                    
                    // 调试：输出生成的日期
                    console.log(`生成日期列 ${counter + 1}: ${month}/${day}`);
                    
                    // 增加一天
                    currentDate.setDate(currentDate.getDate() + 1);
                    counter++;
                }
                
                // 调试：输出生成的日期列总数
                console.log('总共生成的日期列数:', counter);
            }
            
            // 渲染人员排班表
            function renderSchedulingTable() {
                // 检查关键元素是否存在
                const startDateInput = document.getElementById('schedulingStartDate');
                const endDateInput = document.getElementById('schedulingEndDate');
                const tableBody = document.querySelector('#scheduling-page table tbody');
                
                if (!startDateInput || !endDateInput || !tableBody) return;
                
                const { startDate, endDate } = getCurrentSchedulingDate();
                
                // 获取搜索输入框的值
                const searchInput = document.getElementById('schedulingSearchInput');
                const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';
                
                // 更新日期表头
                generateDateHeaders(startDate, endDate);
                
                // 清空表格内容
                tableBody.innerHTML = '';
                
                // 创建一个Map来存储每个订单号的所有工单
                const orderWorkOrdersMap = new Map();
                
                // 按照订单号和工序对工单进行分组
                workOrderData.forEach(workOrder => {
                    const key = `${workOrder.orderNumber}_${workOrder.process}`;
                    if (!orderWorkOrdersMap.has(key)) {
                        // 从订单数据中查找对应的订单
                        const correspondingOrder = orderData.find(order => order.orderNumber === workOrder.orderNumber);
                        
                        // 尝试从订单的工序列表中找到当前工序的目标数量
                        let processTargetQuantity = 0;
                        if (correspondingOrder && Array.isArray(correspondingOrder.processes)) {
                            const matchingProcess = correspondingOrder.processes.find(p => p.name === workOrder.process);
                            if (matchingProcess && matchingProcess.quantity) {
                                processTargetQuantity = matchingProcess.quantity;
                            }
                        }
                        
                        // 如果找不到工序的目标数量，则使用工单的工序数量作为后备
                        const quantity = processTargetQuantity > 0 ? processTargetQuantity : workOrder.processQuantity;
                        
                        orderWorkOrdersMap.set(key, {
                            customer: workOrder.customer,
                            orderNumber: workOrder.orderNumber,
                            process: workOrder.process,
                            quantity: quantity,
                            workOrders: []
                        });
                    }
                    orderWorkOrdersMap.get(key).workOrders.push(workOrder);
                });
                
                // 计算日期范围内的天数 - 确保包含开始和结束日期
                const start = new Date(startDate);
                start.setHours(0, 0, 0, 0);
                const end = new Date(endDate);
                end.setHours(0, 0, 0, 0);
                const daysInRange = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
                
                // 调试：输出日期范围和天数
                console.log('日期范围:', start.toISOString(), '到', end.toISOString());
                console.log('计算的日期范围内天数:', daysInRange);
                
                // 将Map转换为数组并按订单号排序
                const sortedOrderInfoArray = Array.from(orderWorkOrdersMap.values())
                    .sort((a, b) => a.orderNumber.localeCompare(b.orderNumber));
                
                // 渲染排序后的订单信息
                sortedOrderInfoArray.forEach(orderInfo => {
                    // 应用搜索筛选
                    const shouldShowRow = !searchTerm || 
                        (orderInfo.customer && orderInfo.customer.toLowerCase().includes(searchTerm)) ||
                        orderInfo.orderNumber.toLowerCase().includes(searchTerm) ||
                        orderInfo.quantity.toString().includes(searchTerm) ||
                        orderInfo.process.toLowerCase().includes(searchTerm);

                    if (!shouldShowRow) return;
                    
                    // 计算该工序所有员工的合计完成数量
                    let totalCompletedQuantity = 0;
                    orderInfo.workOrders.forEach(workOrder => {
                        totalCompletedQuantity += workOrder.processQuantity;
                    });
                    
                    // 计算合计完成比例
                    const totalPercentage = orderInfo.quantity > 0 ? 
                        (totalCompletedQuantity / orderInfo.quantity) * 100 : 0;
                    
                    // 调试输出
                    console.log(`工序: ${orderInfo.process}, 订单号: ${orderInfo.orderNumber}, 合计完成数量: ${totalCompletedQuantity}, 订单数量: ${orderInfo.quantity}, 完成比例: ${totalPercentage.toFixed(1)}%`);
                    
                    // 根据合计完成比例设置工序名称单元格的背景色
                    let processCellClass = "sticky left-[270px] bg-white";
                    if (totalPercentage < 100) {
                        processCellClass = "sticky left-[270px] bg-yellow-200";
                    } else if (totalPercentage >= 100 && totalPercentage <= 105) {
                        processCellClass = "sticky left-[270px] bg-green-600 text-white";
                    } else if (totalPercentage > 105) {
                        processCellClass = "sticky left-[270px] bg-red-600 text-white";
                    }

                    // 创建基础单元格，为前3列和工序名称列添加sticky定位
                    let cellsHTML = `
                        <td class="sticky left-0 bg-white">${orderInfo.customer}</td>
                        <td class="sticky left-[90px] bg-white">${orderInfo.orderNumber}</td>
                        <td class="sticky left-[180px] bg-white">${orderInfo.quantity}</td>
                        <td class="${processCellClass}">${orderInfo.process}</td>
                    `;
                    
                    // 添加日期列单元格 - 确保生成的列数与表头一致
                    console.log(`为订单 ${orderInfo.orderNumber} 生成 ${daysInRange} 个日期列`);
                    for (let day = 0; day < daysInRange; day++) {
                        cellsHTML += `<td></td>`;
                    }
                    
                    const row = document.createElement('tr');
                    row.innerHTML = cellsHTML;
                    
                    // 为每个工单添加员工姓名到对应的日期列
                    orderInfo.workOrders.forEach(workOrder => {
                        // 直接从日期字符串中提取年、月、日，避免时区问题
                        const dateParts = workOrder.date.split('-');
                        const workOrderYear = parseInt(dateParts[0]);
                        const workOrderMonth = parseInt(dateParts[1]);
                        const workOrderDay = parseInt(dateParts[2]);
                        const workOrderDate = new Date(workOrderYear, workOrderMonth - 1, workOrderDay);
                        
                        // 只处理日期范围内的工单
                        if (workOrderDate >= startDate && workOrderDate <= endDate) {
                            // 计算该日期在日期范围内的索引
                            const diffTime = workOrderDate - startDate;
                            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                            const columnIndex = diffDays + 4; // 客户(0), 订单号(1), 数量(2), 工序名称(3), 日期列从索引4开始（day=0对应索引4）
                            if (columnIndex < row.cells.length) {
                                const cell = row.cells[columnIndex];
                                
                                // 计算该订单该工序的总数量（分母）
                                let processTotalQuantity = 0;
                                // 从订单数据中查找对应的订单
                                const correspondingOrder = orderData.find(order => order.orderNumber === workOrder.orderNumber);
                                if (correspondingOrder && Array.isArray(correspondingOrder.processes)) {
                                    // 从订单的processes数组中找到对应的工序
                                    const matchingProcess = correspondingOrder.processes.find(p => p.name === workOrder.process);
                                    if (matchingProcess && matchingProcess.quantity) {
                                        processTotalQuantity = matchingProcess.quantity;
                                    }
                                }
                                
                                // 如果找不到订单工序的总数量，则使用订单的总数量作为后备
                                if (processTotalQuantity === 0 && correspondingOrder && correspondingOrder.quantity) {
                                    processTotalQuantity = correspondingOrder.quantity;
                                }
                                
                                // 计算百分比
                                const percentage = processTotalQuantity > 0 ? 
                                    ((workOrder.processQuantity / processTotalQuantity) * 100).toFixed(1) : 
                                    0;
                                
                                // 创建包含员工姓名和百分比的HTML
                                const employeeHTML = `<span class="employee-name" title="完成数量: ${workOrder.processQuantity}/${processTotalQuantity} (${percentage}%)">${workOrder.employeeName}</span>`;
                                
                                if (cell.innerHTML) {
                                    cell.innerHTML += `\n${employeeHTML}`;
                                } else {
                                    cell.innerHTML = employeeHTML;
                                }
                                cell.className = 'scheduling-cell';
                            }
                        }
                    });
                    
                    tableBody.appendChild(row);
                });
            }
            
            // 设置默认日期范围函数
            function setDefaultSchedulingDate() {
                const startDateInput = document.getElementById('schedulingStartDate');
                const endDateInput = document.getElementById('schedulingEndDate');
                
                if (!startDateInput || !endDateInput) return;
                
                // 获取当前日期
                const today = new Date();
                
                // 设置开始日期为今天
                const startDate = new Date(today);
                
                // 设置结束日期为今天往后一个月
                const endDate = new Date(today);
                endDate.setMonth(endDate.getMonth() + 1);
                
                // 格式化日期为YYYY-MM-DD格式
                const formatDate = (date) => {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                };
                
                // 设置输入框的值
                startDateInput.value = formatDate(startDate);
                endDateInput.value = formatDate(endDate);
                
                // 调试：输出默认日期
                console.log('设置默认开始日期:', startDateInput.value);
                console.log('设置默认结束日期:', endDateInput.value);
            }
            
            // 只在切换到人员排班页面时才初始化
            // 添加页面切换事件监听
            navLinks.forEach(link => {
                link.addEventListener('click', function() {
                    const targetPage = this.getAttribute('data-page');
                    
                    // 如果是人员排班页面，初始化并渲染表格
                    if (targetPage === 'scheduling') {
                        // 设置默认日期范围
                        setDefaultSchedulingDate();
                        
                        // 添加人员排班页面的事件监听器
                        const startDateInput = document.getElementById('schedulingStartDate');
                        const endDateInput = document.getElementById('schedulingEndDate');
                        
                        // 开始日期变化事件
                        if (startDateInput) {
                            startDateInput.addEventListener('change', renderSchedulingTable);
                        }
                        
                        // 结束日期变化事件
                        if (endDateInput) {
                            endDateInput.addEventListener('change', renderSchedulingTable);
                        }
                        
                        // 刷新按钮点击事件
                        const clearScheduleBtn = document.getElementById('clearScheduleBtn');
                        if (clearScheduleBtn) {
                            clearScheduleBtn.addEventListener('click', renderSchedulingTable);
                        }
                        
                        // 为搜索输入框添加事件监听器
                        const schedulingSearchInput = document.getElementById('schedulingSearchInput');
                        if (schedulingSearchInput) {
                            schedulingSearchInput.addEventListener('input', function() {
                                renderSchedulingTable();
                            });
                        }
                        
                        // 初始化人员排班表
                        renderSchedulingTable();
                    }
                });
            });
            
            // 检查当前是否是人员排班页面（如果是直接打开的链接）
            const currentPageElement = document.querySelector('.page-content:not(.hidden)');
            if (currentPageElement && currentPageElement.id === 'scheduling-page') {
                // 设置默认日期范围
                setDefaultSchedulingDate();
                
                // 初始化人员排班表
                renderSchedulingTable();
                
                // 添加人员排班页面的事件监听器
                const startDateInput = document.getElementById('schedulingStartDate');
                const endDateInput = document.getElementById('schedulingEndDate');
                
                // 开始日期变化事件
                if (startDateInput) {
                    startDateInput.addEventListener('change', renderSchedulingTable);
                }
                
                // 结束日期变化事件
                if (endDateInput) {
                    endDateInput.addEventListener('change', renderSchedulingTable);
                }
                
                // 刷新按钮点击事件
                const clearScheduleBtn = document.getElementById('clearScheduleBtn');
                if (clearScheduleBtn) {
                    clearScheduleBtn.addEventListener('click', renderSchedulingTable);
                }
                
                // 为搜索输入框添加事件监听器
                const schedulingSearchInput = document.getElementById('schedulingSearchInput');
                if (schedulingSearchInput) {
                    schedulingSearchInput.addEventListener('input', function() {
                        renderSchedulingTable();
                    });
                }
            }
            
            // 获取当前订单筛选条件
            function getCurrentOrderFilters() {
                const searchInput = document.getElementById('orderSearchInput');
                const startDateInput = document.getElementById('orderStartDate');
                const endDateInput = document.getElementById('orderEndDate');
                
                return {
                    keyword: searchInput ? searchInput.value.trim() : '',
                    startDate: startDateInput ? startDateInput.value : '',
                    endDate: endDateInput ? endDateInput.value : ''
                };
            }
            
            // 分页控件事件监听
            // 每页记录数变化
            const ordersPerPageSelect = document.getElementById('ordersPerPage');
            if (ordersPerPageSelect) {
                ordersPerPageSelect.addEventListener('change', function() {
                    ordersPerPage = parseInt(this.value);
                    currentOrderPage = 1; // 重置到第一页
                    const { keyword, startDate, endDate } = getCurrentOrderFilters();
                    renderOrderTable(keyword, startDate, endDate);
                });
            }
            
            // 页码跳转
            const orderPageJumpBtn = document.getElementById('orderPageJumpBtn');
            const orderPageJumpInput = document.getElementById('orderPageJump');
            if (orderPageJumpBtn && orderPageJumpInput) {
                orderPageJumpBtn.addEventListener('click', function() {
                    let page = parseInt(orderPageJumpInput.value);
                    if (isNaN(page) || page < 1) page = 1;
                    if (page > totalOrderPages) page = totalOrderPages;
                    currentOrderPage = page;
                    const { keyword, startDate, endDate } = getCurrentOrderFilters();
                    renderOrderTable(keyword, startDate, endDate);
                });
                
                // 回车键跳转
                orderPageJumpInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        orderPageJumpBtn.click();
                    }
                });
            }
            
            // 首页按钮
            const orderFirstPageBtn = document.getElementById('orderFirstPage');
            if (orderFirstPageBtn) {
                orderFirstPageBtn.addEventListener('click', function() {
                    currentOrderPage = 1;
                    const { keyword, startDate, endDate } = getCurrentOrderFilters();
                    renderOrderTable(keyword, startDate, endDate);
                });
            }
            
            // 上一页按钮
            const orderPrevPageBtn = document.getElementById('orderPrevPage');
            if (orderPrevPageBtn) {
                orderPrevPageBtn.addEventListener('click', function() {
                    if (currentOrderPage > 1) {
                        currentOrderPage--;
                        const { keyword, startDate, endDate } = getCurrentOrderFilters();
                        renderOrderTable(keyword, startDate, endDate);
                    }
                });
            }
            
            // 下一页按钮
            const orderNextPageBtn = document.getElementById('orderNextPage');
            if (orderNextPageBtn) {
                orderNextPageBtn.addEventListener('click', function() {
                    if (currentOrderPage < totalOrderPages) {
                        currentOrderPage++;
                        const { keyword, startDate, endDate } = getCurrentOrderFilters();
                        renderOrderTable(keyword, startDate, endDate);
                    }
                });
            }
            
            // 末页按钮
            const orderLastPageBtn = document.getElementById('orderLastPage');
            if (orderLastPageBtn) {
                orderLastPageBtn.addEventListener('click', function() {
                    currentOrderPage = totalOrderPages;
                    const { keyword, startDate, endDate } = getCurrentOrderFilters();
                    renderOrderTable(keyword, startDate, endDate);
                });
            }
            
            // 获取当前工单筛选条件
            function getCurrentWorkOrderFilters() {
                const searchInput = document.getElementById('workOrderSearchInput');
                const startDateInput = document.getElementById('workOrderStartDate');
                const endDateInput = document.getElementById('workOrderEndDate');
                
                return {
                    keyword: searchInput ? searchInput.value.trim() : '',
                    startDate: startDateInput ? startDateInput.value : '',
                    endDate: endDateInput ? endDateInput.value : ''
                };
            }
            
            // 执行工单筛选
            function performWorkOrderFilter() {
                const { keyword, startDate, endDate } = getCurrentWorkOrderFilters();
                currentWorkOrderPage = 1; // 重置到第一页
                renderWorkOrderTable(keyword, startDate, endDate);
            }
            
            // 重置工单筛选
            function resetWorkOrderFilters() {
                const searchInput = document.getElementById('workOrderSearchInput');
                const startDateInput = document.getElementById('workOrderStartDate');
                const endDateInput = document.getElementById('workOrderEndDate');
                
                if (searchInput) searchInput.value = '';
                if (startDateInput) startDateInput.value = '';
                if (endDateInput) endDateInput.value = '';
                
                currentWorkOrderPage = 1; // 重置到第一页
                renderWorkOrderTable('', '', '');
            }
            
            // 工单管理分页事件监听器
            // 搜索输入框事件
            const workOrderSearchInput = document.getElementById('workOrderSearchInput');
            const startDateInput = document.getElementById('workOrderStartDate');
            const endDateInput = document.getElementById('workOrderEndDate');
            const resetBtn = document.getElementById('workOrderResetFilterBtn');
            
            if (workOrderSearchInput) {
                workOrderSearchInput.addEventListener('input', performWorkOrderFilter);
            }
            
            // 日期输入框事件
            if (startDateInput) {
                startDateInput.addEventListener('change', performWorkOrderFilter);
            }
            if (endDateInput) {
                endDateInput.addEventListener('change', performWorkOrderFilter);
            }
            
            // 重置搜索按钮事件
            const workOrderSearchReset = document.getElementById('workOrderSearchReset');
            if (workOrderSearchReset) {
                workOrderSearchReset.addEventListener('click', resetWorkOrderFilters);
            }
            
            // 重置筛选按钮事件
            if (resetBtn) {
                resetBtn.addEventListener('click', resetWorkOrderFilters);
            }
            
            // 每页记录数选择
            const workOrdersPerPageSelect = document.getElementById('workOrdersPerPage');
            if (workOrdersPerPageSelect) {
                workOrdersPerPageSelect.addEventListener('change', function() {
                    workOrdersPerPage = parseInt(this.value);
                    currentWorkOrderPage = 1; // 重置到第一页
                    const { keyword, startDate, endDate } = getCurrentWorkOrderFilters();
                    renderWorkOrderTable(keyword, startDate, endDate);
                });
            }
            
            // 页码跳转
            const workOrderPageJumpBtn = document.getElementById('workOrderPageJumpBtn');
            const workOrderPageJumpInput = document.getElementById('workOrderPageJump');
            if (workOrderPageJumpBtn && workOrderPageJumpInput) {
                workOrderPageJumpBtn.addEventListener('click', function() {
                    let page = parseInt(workOrderPageJumpInput.value);
                    if (isNaN(page) || page < 1) page = 1;
                    if (page > totalWorkOrderPages) page = totalWorkOrderPages;
                    currentWorkOrderPage = page;
                    const { keyword, startDate, endDate } = getCurrentWorkOrderFilters();
                    renderWorkOrderTable(keyword, startDate, endDate);
                });
                
                // 回车键跳转
                workOrderPageJumpInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        workOrderPageJumpBtn.click();
                    }
                });
            }
            
            // 首页按钮
            const workOrderFirstPageBtn = document.getElementById('workOrderFirstPage');
            if (workOrderFirstPageBtn) {
                workOrderFirstPageBtn.addEventListener('click', function() {
                    currentWorkOrderPage = 1;
                    const { keyword, startDate, endDate } = getCurrentWorkOrderFilters();
                    renderWorkOrderTable(keyword, startDate, endDate);
                });
            }
            
            // 上一页按钮
            const workOrderPrevPageBtn = document.getElementById('workOrderPrevPage');
            if (workOrderPrevPageBtn) {
                workOrderPrevPageBtn.addEventListener('click', function() {
                    if (currentWorkOrderPage > 1) {
                        currentWorkOrderPage--;
                        const { keyword, startDate, endDate } = getCurrentWorkOrderFilters();
                        renderWorkOrderTable(keyword, startDate, endDate);
                    }
                });
            }
            
            // 下一页按钮
            const workOrderNextPageBtn = document.getElementById('workOrderNextPage');
            if (workOrderNextPageBtn) {
                workOrderNextPageBtn.addEventListener('click', function() {
                    if (currentWorkOrderPage < totalWorkOrderPages) {
                        currentWorkOrderPage++;
                        const { keyword, startDate, endDate } = getCurrentWorkOrderFilters();
                        renderWorkOrderTable(keyword, startDate, endDate);
                    }
                });
            }
            
            // 末页按钮
            const workOrderLastPageBtn = document.getElementById('workOrderLastPage');
            if (workOrderLastPageBtn) {
                workOrderLastPageBtn.addEventListener('click', function() {
                    currentWorkOrderPage = totalWorkOrderPages;
                    const { keyword, startDate, endDate } = getCurrentWorkOrderFilters();
                    renderWorkOrderTable(keyword, startDate, endDate);
                });
            }
            
            // 设备管理模态框事件监听器
            const equipmentModal = document.getElementById('equipment-modal');
            const equipmentCloseModalBtn = document.getElementById('equipment-close-modal');
            const equipmentCancelBtn = document.getElementById('equipment-cancel-btn');
            const equipmentForm = document.getElementById('equipment-form');
            
            // 关闭模态框按钮点击事件
            if (equipmentCloseModalBtn) {
                equipmentCloseModalBtn.addEventListener('click', closeEquipmentModal);
            }
            
            // 取消按钮点击事件
            if (equipmentCancelBtn) {
                equipmentCancelBtn.addEventListener('click', closeEquipmentModal);
            }
            
            // 表单提交事件
            if (equipmentForm) {
                equipmentForm.addEventListener('submit', saveEquipment);
            }
            
            // 点击模态框外部关闭模态框
            if (equipmentModal) {
                equipmentModal.addEventListener('click', (e) => {
                    if (e.target === equipmentModal) {
                        closeEquipmentModal();
                    }
                });
            }
            
            // 维修记录模态框事件监听器
            const maintenanceModal = document.getElementById('maintenance-modal');
            const maintenanceCloseModalBtn = document.getElementById('maintenance-close-modal');
            const maintenanceCancelBtn = document.getElementById('maintenance-cancel-btn');
            const maintenanceForm = document.getElementById('maintenance-form');
            
            // 关闭模态框按钮点击事件
            if (maintenanceCloseModalBtn) {
                maintenanceCloseModalBtn.addEventListener('click', closeMaintenanceModal);
            }
            
            // 取消按钮点击事件
            if (maintenanceCancelBtn) {
                maintenanceCancelBtn.addEventListener('click', closeMaintenanceModal);
            }
            
            // 表单提交事件
            if (maintenanceForm) {
                maintenanceForm.addEventListener('submit', handleMaintenanceSubmit);
            }
            
            // 点击模态框外部关闭模态框
            if (maintenanceModal) {
                maintenanceModal.addEventListener('click', (e) => {
                    if (e.target === maintenanceModal) {
                        closeMaintenanceModal();
                    }
                });
            }
            

            
            // 人员管理模态框功能
            const personnelModal = document.getElementById('personnel-modal');
            const modalTitle = document.getElementById('modal-title');
            const closeModalBtn = document.getElementById('close-modal');
            const cancelBtn = document.getElementById('cancel-btn');
            const personnelForm = document.getElementById('personnel-form');
            
            let currentEditIndex = -1;
            
            // 使用更加独特的键名避免冲突
            const STORAGE_KEY = 'factory_management_system_personnel_data_20240615';
            
            // 调试：页面加载时的localStorage状态
            console.log('=== 页面加载开始 ===');
            console.log('localStorage中的所有键:', Object.keys(localStorage));
            
            // 从localStorage加载人员数据
            let personnelData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            console.log('1. 初始加载personnelData:', personnelData);
            
            // 检查并清除示例数据，只在第一次加载时执行
            // 如果localStorage中没有数据，我们不添加任何示例数据，保持空数组
            console.log('2. 加载后的数据:', personnelData);
            
            // 如果localStorage为空，不添加任何示例数据
            // 这样用户新增的数据将不会被过滤掉
            if (personnelData.length === 0) {
                console.log('3. localStorage为空，准备接受用户新增数据');
            } else {
                console.log('3. 成功加载localStorage中的数据');
            }
            
            // 同步函数：从index.html的员工管理中获取在职员工数据
            function syncPersonnelFromIndex() {
                console.log('=== 开始同步员工数据 ===');
                
                // 从localStorage获取index.html中的员工数据
                const indexEmployees = JSON.parse(localStorage.getItem('employees')) || [];
                console.log('从index.html获取的员工数据:', indexEmployees);
                
                // 筛选出在职员工(status为'active')
                const activeEmployees = indexEmployees.filter(emp => emp.status === 'active');
                console.log('筛选后的在职员工:', activeEmployees);
                
                // 如果没有在职员工，直接返回
                if (activeEmployees.length === 0) {
                    console.log('没有在职员工数据需要同步');
                    return;
                }
                
                // 将index.html的员工数据转换为炉架系统需要的格式
                const syncedPersonnel = activeEmployees.map(emp => {
                    // 查找是否已存在该员工的记录
                    const existingRecord = personnelData.find(p => p.employeeId === emp.code);
                    
                    // 如果存在，保持原有出勤数据；如果不存在，创建新记录
                    if (existingRecord) {
                        return {
                            ...existingRecord,
                            employeeName: emp.name
                        };
                    } else {
                        // 获取当前年月
                        const now = new Date();
                        const currentYearMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                        
                        return {
                            employeeId: emp.code,
                            employeeName: emp.name,
                            status: '在职',
                            attendedDays: 0, // 默认出勤天数为0
                            [currentYearMonth]: 0 // 当前年月的出勤天数
                        };
                    }
                });
                
                console.log('转换后的人员数据:', syncedPersonnel);
                
                // 更新personnelData
                personnelData = syncedPersonnel;
                
                // 保存到localStorage
                localStorage.setItem(STORAGE_KEY, JSON.stringify(personnelData));
                console.log('成功保存到localStorage');
                
                // 更新表格显示
                updatePersonnelTable();
                console.log('=== 员工数据同步完成 ===');
            }
            
            // 页面加载时首先执行同步
            syncPersonnelFromIndex();
            
            // 页面加载时更新表格
            updatePersonnelTable();
            
            // 生成年月份下拉框选项
            generateYearMonthOptions();
            
            // 为年月下拉框添加事件监听器
            addYearMonthEventListener();
            
            // 添加storage事件监听器，当localStorage中的员工数据变化时自动同步
            window.addEventListener('storage', function(e) {
                if (e.key === 'employees') {
                    console.log('检测到员工数据变化，开始自动同步');
                    syncPersonnelFromIndex();
                }
            });
            
            // 状态切换顺序
            const statusOrder = ['在岗', '休假', '离职'];
            
            // 根据状态获取背景色类
            function getStatusClass(status) {
                switch (status) {
                    case '在岗': return 'bg-success/10 text-success';
                    case '休假': return 'bg-warning/10 text-warning';
                    case '离职': return 'bg-danger/10 text-danger';
                    default: return 'bg-gray-100 text-gray-500';
                }
            }
            
            // 人员管理模态框相关函数已删除
            
            // 关闭模态框
            function closeModal() {
                personnelModal.classList.add('hidden');
                currentEditIndex = -1;
            }
            
            // 保存人员数据函数已删除
            
            // 更新人员表格
            function updatePersonnelTable() {
                const tbody = document.querySelector('#personnel-page table tbody');
                tbody.innerHTML = '';
                
                personnelData.forEach((personnel, index) => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-100 hover:bg-gray-50';
                    
                    const statusClass = getStatusClass(personnel.employeeStatus);
                    
                    // 计算出勤天数
                    const selectedYearMonth = document.getElementById('attendanceYearMonth')?.value || '';
                    const attendanceDays = calculateAttendanceDays(personnel.employeeName, selectedYearMonth);
                    
                    row.innerHTML = `
                        <td class="py-3 px-4">${personnel.employeeId}</td>
                        <td class="py-3 px-4">${personnel.employeeName}</td>
                        <td class="py-3 px-4 cursor-pointer status-cell"><span class="${statusClass} px-2 py-1 rounded text-xs">${personnel.employeeStatus}</span></td>
                        <td class="py-3 px-4 text-center ${attendanceDays > 0 ? 'bg-green-100 text-green-800 font-medium' : ''}">${attendanceDays}</td>
                        <td class="py-3 px-4"></td>
                    `;
                    
                    // 直接为当前行的状态单元格绑定事件
                    const statusCell = row.querySelector('.status-cell');
                    statusCell.addEventListener('click', () => toggleStatus(index));
                    
                    tbody.appendChild(row);
                });
            }
            
            // 删除人员函数已删除
            
            // 计算出勤天数
            function calculateAttendanceDays(employeeName, yearMonth) {
                // 获取工单数据
                const workOrdersData = JSON.parse(localStorage.getItem('workOrderData') || '[]');
                const attendedDays = new Set();
                
                // 如果没有选择年月，返回0
                if (!yearMonth) return 0;
                
                // 解析年月
                const parts = yearMonth.split('-');
                const targetYear = parseInt(parts[0]);
                const targetMonth = parts.length > 1 ? parseInt(parts[1]) : null;
                
                // 遍历工单数据
                workOrdersData.forEach(order => {
                    // 检查工单日期是否在选定的年月
                    if (order.date) {
                        const orderDate = new Date(order.date);
                        // 检查年份是否匹配
                        if (orderDate.getFullYear() === targetYear) {
                            // 如果指定了月份，则检查月份是否匹配
                            if (targetMonth === null || orderDate.getMonth() === (targetMonth - 1)) {
                                // 检查是否有员工信息（工单数据中字段是employeeName）
                                if (order.employeeName && order.employeeName === employeeName) {
                                    // 将日期添加到集合中（去重）
                                    attendedDays.add(order.date);
                                }
                            }
                        }
                    }
                });
                
                // 返回出勤天数
                return attendedDays.size;
            }
            
            // 生成年月份下拉框选项（支持单独查整年或某年某月）
            function generateYearMonthOptions() {
                const select = document.getElementById('attendanceYearMonth');
                if (!select) return;
                
                // 清空现有选项
                select.innerHTML = '';
                
                // 添加默认选项
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = '选择年份或年月';
                select.appendChild(defaultOption);
                
                // 从2025年开始，往后5年
                const startYear = 2025;
                const endYear = startYear + 5;
                
                // 遍历年份
                for (let year = startYear; year <= endYear; year++) {
                    // 添加年份选项
                    const yearOption = document.createElement('option');
                    yearOption.value = `${year}`;
                    yearOption.textContent = `${year}年`;
                    yearOption.className = 'year-option';
                    select.appendChild(yearOption);
                    
                    // 添加月份子选项（使用缩进表示层级关系）
                    for (let month = 1; month <= 12; month++) {
                        const monthOption = document.createElement('option');
                        monthOption.value = `${year}-${String(month).padStart(2, '0')}`;
                        monthOption.textContent = `  ${year}年${month}月`;
                        monthOption.className = 'month-option';
                        select.appendChild(monthOption);
                    }
                }
            }
            
            // 为年月下拉框添加事件监听器
            function addYearMonthEventListener() {
                const select = document.getElementById('attendanceYearMonth');
                if (select) {
                    select.addEventListener('change', () => {
                        updatePersonnelTable();
                    });
                }
            }
            
            // 切换状态
            function toggleStatus(index) {
                const statusOrder = ['在岗', '休假', '离职'];
                const currentStatus = personnelData[index].employeeStatus;
                const currentIndex = statusOrder.indexOf(currentStatus);
                const nextIndex = (currentIndex + 1) % statusOrder.length;
                personnelData[index].employeeStatus = statusOrder[nextIndex];
                // 保存到localStorage
                localStorage.setItem(STORAGE_KEY, JSON.stringify(personnelData));
                updatePersonnelTable();
            }
            
            // 绑定人员管理事件
            function bindPersonnelEvents() {
                // 无事件监听器需要绑定
            }
            
            // 订单管理模态框事件监听器
            const orderModal = document.getElementById('order-modal');
            const orderCloseModalBtn = document.getElementById('order-close-modal');
            const orderCancelBtn = document.getElementById('order-cancel-btn');
            const orderForm = document.getElementById('order-form');
            const orderDateInput = document.getElementById('order-date');
            const addOrderBtn = document.querySelector('#orderManagement-page .bg-primary');
            
            // 设置日期默认值为今日
            function setDefaultOrderDate() {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                orderDateInput.value = `${year}-${month}-${day}`;
            }
            
            // 打开订单模态框
            function openOrderModal() {
                setDefaultOrderDate();
                orderModal.classList.remove('hidden');
            }
            
            // 关闭订单模态框
            function closeOrderModal() {
                orderModal.classList.add('hidden');
                orderForm.reset();
            }
            
            // 保存订单
            function saveOrder(e) {
                e.preventDefault();
                
                const formData = new FormData(orderForm);
                const orderDate = formData.get('orderDate');
                const orderCustomer = formData.get('orderCustomer');
                const orderNumber = formData.get('orderNumber');
                const orderDrawingNumber = formData.get('orderDrawingNumber');
                const orderQuantity = parseInt(formData.get('orderQuantity'));
                const orderRemarks = formData.get('orderRemarks'); // 获取备注字段
                
                // 生成订单ID
                const orderId = `ORD${orderDate.replace(/-/g, '')}${orderNumber.slice(-3)}`;
                
                // 获取产品和规格字段
                const orderProduct = document.getElementById('order-product').value;
                const orderSpecification = document.getElementById('order-specification').value;
                
                // 创建新订单对象
                const newOrder = {
                    id: orderId,
                    date: orderDate,
                    customer: orderCustomer,
                    orderNumber: orderNumber,
                    product: orderProduct,
                    specification: orderSpecification,
                    drawingNumber: orderDrawingNumber,
                    quantity: orderQuantity,
                    processes: '',
                    processCount: 0,
                    completedCount: 0,
                    pendingCount: orderQuantity,
                    status: '待开始',
                    remarks: orderRemarks // 使用获取到的备注值
                };
                
                // 添加到订单数据
                orderData.push(newOrder);
                
                // 保存到localStorage
                saveOrderData();
                
                // 重新渲染订单表格
                renderOrderTable();
                
                // 关闭模态框
                closeOrderModal();
            }
            
            // 客户和图纸号下拉列表功能
            const customerInput = document.getElementById('order-customer');
            const drawingInput = document.getElementById('order-drawing-number');
            const customerDropdown = document.getElementById('customer-dropdown');
            const drawingDropdown = document.getElementById('drawing-dropdown');
            
            // 获取所有唯一客户
            function getAllCustomers() {
                const customers = new Set();
                orderData.forEach(order => {
                    if (order.customer) {
                        customers.add(order.customer);
                    }
                });
                return Array.from(customers);
            }
            
            // 获取指定客户的所有唯一图纸号
            function getDrawingsByCustomer(customer) {
                const drawings = new Set();
                orderData.forEach(order => {
                    if (order.customer === customer && order.drawingNumber) {
                        drawings.add(order.drawingNumber);
                    }
                });
                return Array.from(drawings);
            }
            
            // 显示客户下拉列表
            function showCustomerDropdown() {
                const customers = getAllCustomers();
                const filter = customerInput.value.toLowerCase();
                const filteredCustomers = customers.filter(customer => 
                    customer.toLowerCase().includes(filter)
                );
                
                customerDropdown.innerHTML = '';
                
                if (filteredCustomers.length > 0) {
                    filteredCustomers.forEach(customer => {
                        const option = document.createElement('div');
                        option.className = 'px-4 py-2 hover:bg-gray-100 cursor-pointer';
                        option.textContent = customer;
                        option.addEventListener('click', () => {
                            customerInput.value = customer;
                            customerDropdown.classList.add('hidden');
                            // 客户选择后，清空并更新图纸号下拉列表
                            drawingInput.value = '';
                            updateDrawingDropdown();
                        });
                        customerDropdown.appendChild(option);
                    });
                    customerDropdown.classList.remove('hidden');
                } else {
                    customerDropdown.classList.add('hidden');
                }
            }
            
            // 更新图纸号下拉列表
            function updateDrawingDropdown() {
                const customer = customerInput.value;
                if (!customer) {
                    drawingDropdown.classList.add('hidden');
                    return;
                }
                
                const drawings = getDrawingsByCustomer(customer);
                const filter = drawingInput.value.toLowerCase();
                const filteredDrawings = drawings.filter(drawing => 
                    drawing.toLowerCase().includes(filter)
                );
                
                drawingDropdown.innerHTML = '';
                
                if (filteredDrawings.length > 0) {
                    filteredDrawings.forEach(drawing => {
                        const option = document.createElement('div');
                        option.className = 'px-4 py-2 hover:bg-gray-100 cursor-pointer';
                        option.textContent = drawing;
                        option.addEventListener('click', () => {
                            drawingInput.value = drawing;
                            drawingDropdown.classList.add('hidden');
                        });
                        drawingDropdown.appendChild(option);
                    });
                    drawingDropdown.classList.remove('hidden');
                } else {
                    drawingDropdown.classList.add('hidden');
                }
            }
            
            // 隐藏所有下拉列表
            function hideAllDropdowns() {
                customerDropdown.classList.add('hidden');
                drawingDropdown.classList.add('hidden');
            }
            
            // 绑定订单管理事件
            function bindOrderEvents() {
                // 只绑定新增订单按钮事件（固定元素）
                const addOrderBtn = document.querySelector('#orderManagement-page .bg-primary');
                if (addOrderBtn) {
                    addOrderBtn.addEventListener('click', openOrderModal);
                }
                
                // 绑定清空按钮事件
                const clearBtn = document.getElementById('orderClearBtn');
                if (clearBtn) {
                    clearBtn.addEventListener('click', function() {
                        // 确认对话框
                        if (confirm('确定要清空所有订单记录吗？此操作不可恢复！')) {
                            // 清空订单数据
                            orderData = [];
                            // 保存到localStorage
                            saveOrderData();
                            // 重置当前页为第一页
                            currentOrderPage = 1;
                            // 重新渲染表格
                            renderOrderTable('', '', '');
                            // 更新分页控件
                            updateOrderPagination();
                        }
                    });
                }
                
                // 绑定搜索输入框事件
                const searchInput = document.getElementById('orderSearchInput');
                const startDateInput = document.getElementById('orderStartDate');
                const endDateInput = document.getElementById('orderEndDate');
                const resetBtn = document.getElementById('orderResetFilterBtn');
                
                // 执行筛选的函数
                function performOrderFilter() {
                    const keyword = searchInput.value.trim();
                    const startDate = startDateInput.value;
                    const endDate = endDateInput.value;
                    // 重置当前页为第一页
                    currentOrderPage = 1;
                    // 重新渲染表格
                    renderOrderTable(keyword, startDate, endDate);
                    // 更新分页控件
                    updateOrderPagination();
                }
                
                // 搜索输入框事件
                if (searchInput) {
                    searchInput.addEventListener('input', performOrderFilter);
                }
                
                // 日期输入框事件
                if (startDateInput) {
                    startDateInput.addEventListener('change', performOrderFilter);
                }
                if (endDateInput) {
                    endDateInput.addEventListener('change', performOrderFilter);
                }
                
                // 重置按钮事件
                if (resetBtn) {
                    resetBtn.addEventListener('click', function() {
                        // 清空所有筛选条件
                        if (searchInput) searchInput.value = '';
                        if (startDateInput) startDateInput.value = '';
                        if (endDateInput) endDateInput.value = '';
                        // 重置当前页为第一页
                        currentOrderPage = 1;
                        // 重新渲染表格
                        renderOrderTable('', '', '');
                        // 更新分页控件
                        updateOrderPagination();
                    });
                }
            }
            
            // 关闭模态框按钮点击事件
            if (orderCloseModalBtn) {
                orderCloseModalBtn.addEventListener('click', closeOrderModal);
            }
            
            // 取消按钮点击事件
            if (orderCancelBtn) {
                orderCancelBtn.addEventListener('click', closeOrderModal);
            }
            
            // 表单提交事件
            if (orderForm) {
                orderForm.addEventListener('submit', saveOrder);
            }
            
            // 点击模态框外部关闭模态框
            if (orderModal) {
                orderModal.addEventListener('click', (e) => {
                    if (e.target === orderModal) {
                        closeOrderModal();
                    }
                });
            }
            
            // 客户输入框事件
            if (customerInput) {
                customerInput.addEventListener('input', showCustomerDropdown);
                customerInput.addEventListener('focus', showCustomerDropdown);
            }
            
            // 图纸号输入框事件
            if (drawingInput) {
                drawingInput.addEventListener('input', updateDrawingDropdown);
                drawingInput.addEventListener('focus', updateDrawingDropdown);
            }
            
            // 点击页面其他地方关闭下拉列表
            document.addEventListener('click', (e) => {
                if (customerDropdown && !customerDropdown.contains(e.target) && e.target !== customerInput) {
                    customerDropdown.classList.add('hidden');
                }
                if (drawingDropdown && !drawingDropdown.contains(e.target) && e.target !== drawingInput) {
                    drawingDropdown.classList.add('hidden');
                }
            });
            
            // 关闭模态框时隐藏所有下拉列表
            function closeOrderModal() {
                if (orderModal) {
                    orderModal.classList.add('hidden');
                }
                if (orderForm) {
                    orderForm.reset();
                }
                hideAllDropdowns();
            }
            
            
            if (closeModalBtn) {
                closeModalBtn.addEventListener('click', closeModal);
            }
            
            if (cancelBtn) {
                cancelBtn.addEventListener('click', closeModal);
            }
            
            // 人员管理相关的事件监听器已删除
            
            // 绑定初始事件
            bindPersonnelEvents();
        });

        // 图表初始化函数

    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .scrollbar-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            .card-shadow {
                box-shadow: 0 2px 14px 0 rgba(0, 0, 0, 0.06);
            }
        }
        
        /* 修复滚动条显示问题 */
        .overflow-x-auto {
            overflow-x: scroll !important;
            display: block;
            width: 100%;
        }
        
        /* 确保表格宽度正确计算 */
        #scheduling-page .overflow-x-auto {
            overflow-x: scroll !important;
        }
        
        /* 确保表格列不会被压缩 */
        #scheduling-page table th,
        #scheduling-page table td {
            white-space: nowrap;
            min-width: 80px;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-700 min-h-screen flex flex-col">
    <!-- 顶部导航栏 -->
    <header class="bg-white border-b border-gray-200 sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <i class="fa fa-industry text-primary text-2xl"></i>
                <h1 class="text-xl font-bold text-gray-700">炉架生产管理系统</h1>
            </div>
            <div class="flex items-center gap-6">
                <!-- 数据管理下拉菜单 -->
                <div class="relative">
                    <button id="dataManagementBtn" class="flex items-center gap-1 px-3 py-2 rounded-lg border border-gray-200 hover:bg-gray-50 text-sm">
                        <i class="fa fa-database"></i>
                        <span>数据管理</span>
                        <i class="fa fa-caret-down"></i>
                    </button>
                    <div id="dataManagementDropdown" class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 hidden">
                        <ul>
                            <li>
                                <button id="backupDataBtn" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-sm flex items-center gap-2">
                                    <i class="fa fa-download"></i>
                                    <span>备份数据</span>
                                </button>
                            </li>
                            <li>
                                <button id="restoreDataBtn" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-sm flex items-center gap-2">
                                    <i class="fa fa-upload"></i>
                                    <span>恢复数据</span>
                                </button>
                            </li>
                            <li>
                                <input type="file" id="restoreFileInput" accept=".json" class="hidden">
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <img src="https://picsum.photos/32/32" alt="用户头像" class="w-8 h-8 rounded-full">
                </div>
            </div>
        </div>
        
        <!-- 顶部导航菜单 -->
        <div class="bg-white border-b border-gray-200">
            <div class="container mx-auto px-4">
                <nav class="flex flex-wrap items-center">
                    <div class="flex-1 flex items-center gap-1">

                        <a href="#" data-page="orderManagement" class="flex items-center gap-2 px-4 py-3 text-gray-600 hover:bg-gray-100 transition-colors text-sm">
                            <i class="fa fa-shopping-cart"></i>
                            <span>订单管理</span>
                        </a>
                        <a href="#" data-page="orders" class="flex items-center gap-2 px-4 py-3 text-gray-600 hover:bg-gray-100 transition-colors text-sm">
                            <i class="fa fa-file-text-o"></i>
                            <span>工单管理</span>
                        </a>

                        <a href="#" data-page="scheduling" class="flex items-center gap-2 px-4 py-3 text-gray-600 hover:bg-gray-100 transition-colors text-sm">
                            <i class="fa fa-calendar"></i>
                            <span>人员排班</span>
                        </a>

                        <a href="#" data-page="personnel" class="flex items-center gap-2 px-4 py-3 text-gray-600 hover:bg-gray-100 transition-colors text-sm">
                            <i class="fa fa-users"></i>
                            <span>人员管理</span>
                        </a>
                        <a href="#" data-page="processManagement" class="flex items-center gap-2 px-4 py-3 text-gray-600 hover:bg-gray-100 transition-colors text-sm">
                            <i class="fa fa-tasks"></i>
                            <span>工序管理</span>
                        </a>
                        <a href="#" data-page="equipment" class="flex items-center gap-2 px-4 py-3 text-gray-600 hover:bg-gray-100 transition-colors text-sm">
                            <i class="fa fa-cogs"></i>
                            <span>设备管理</span>
                        </a>


                    </div>
                </nav>
            </div>
        </div>
    </header>

    <!-- 主体内容 -->
    <main class="flex-1 container mx-auto px-4 py-6">
        <!-- 侧边栏已移至顶部导航栏 -->
        
        <!-- 订单管理页面 -->
            <div id="orderManagement-page" class="page-content hidden">
                <div class="bg-white rounded-lg card-shadow p-6">
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex items-center gap-4 flex-wrap">
                            <h2 class="text-lg font-bold text-gray-700">订单管理</h2>
                            <!-- 搜索输入框 -->
                            <div class="relative">
                                <input type="text" id="orderSearchInput" placeholder="搜索客户/订单号/图纸号/产品/规格" class="pl-8 pr-4 py-2 rounded-lg border border-gray-200 focus:outline-none focus:border-primary w-64 text-sm">
                                <i class="fa fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            </div>
                            <!-- 日期范围筛选 -->
                            <div class="flex items-center gap-2">
                                <input type="date" id="orderStartDate" class="px-3 py-2 rounded-lg border border-gray-200 focus:outline-none focus:border-primary text-sm">
                                <span class="text-gray-400">至</span>
                                <input type="date" id="orderEndDate" class="px-3 py-2 rounded-lg border border-gray-200 focus:outline-none focus:border-primary text-sm">
                            </div>
                            <!-- 重置按钮 -->
                            <button id="orderResetFilterBtn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm hover:bg-gray-300 transition-colors">
                                <i class="fa fa-refresh"></i> 重置
                            </button>
                            <!-- 清空按钮 -->
                            <button id="orderClearBtn" class="bg-danger text-white px-4 py-2 rounded-lg text-sm hover:bg-red-600 transition-colors">
                                <i class="fa fa-trash"></i> 清空
                            </button>
                        </div>

                    </div>
                    <!-- 搜索结果统计 -->
                    <div id="orderSearchStats" class="mb-4 text-sm text-gray-600 hidden">
                        搜索结果：<span id="orderSearchCount">0</span> 条记录，合计数量：<span id="orderSearchTotalQuantity">0</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm" style="table-layout: auto;">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="text-left py-3 px-4 font-medium text-gray-500 whitespace-nowrap">日期</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-500 whitespace-nowrap">客户</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-500 whitespace-nowrap">订单号</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-500 whitespace-nowrap">产品</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-500 whitespace-nowrap">规格</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-500 whitespace-nowrap">图纸号</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-500 whitespace-nowrap">数量</th>
                                    <th class="text-center py-3 px-4 font-medium text-gray-500 whitespace-nowrap">操作</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-500 whitespace-nowrap">工序</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-500 whitespace-nowrap">状态</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-500 whitespace-nowrap">备注</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-500 whitespace-nowrap">操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- 模拟数据 -->
                                <tr class="border-b border-gray-100 hover:bg-gray-50">
                                    <td class="py-3 px-4 whitespace-nowrap">2025-12-21</td>
                                    <td class="py-3 px-4 whitespace-nowrap">客户A</td>
                                    <td class="py-3 px-4 whitespace-nowrap">ORD20251221001</td>
                                    <td class="py-3 px-4 whitespace-nowrap">DRW-001</td>
                                    <td class="py-3 px-4 whitespace-nowrap">100</td>
                                    <td class="py-3 px-4 whitespace-nowrap">切割、焊接、打磨</td>
                                    <td class="py-3 px-4 whitespace-nowrap">3</td>
                                    <td class="py-3 px-4 whitespace-nowrap">60</td>
                                    <td class="py-3 px-4 whitespace-nowrap">40</td>
                                    <td class="py-3 px-4 whitespace-nowrap"><span class="bg-warning/10 text-warning px-2 py-1 rounded text-xs">进行中</span></td>
                                    <td class="py-3 px-4 whitespace-nowrap">加急订单</td>
                                    <td class="py-3 px-4 whitespace-nowrap">
                                        <div class="flex gap-2">
                                            <button class="text-primary text-xs"><i class="fa fa-edit mr-1"></i> 编辑</button>
                                            <button class="text-danger text-xs"><i class="fa fa-trash mr-1"></i> 删除</button>
                                        </div>
                                    </td>
                                </tr>
                                <tr class="border-b border-gray-100 hover:bg-gray-50">
                                    <td class="py-3 px-4">2025-12-20</td>
                                    <td class="py-3 px-4">客户B</td>
                                    <td class="py-3 px-4">ORD20251220001</td>
                                    <td class="py-3 px-4">DRW-002</td>
                                    <td class="py-3 px-4">50</td>
                                    <td class="py-3 px-4">切割、折弯、焊接</td>
                                    <td class="py-3 px-4">3</td>
                                    <td class="py-3 px-4">50</td>
                                    <td class="py-3 px-4">0</td>
                                    <td class="py-3 px-4"><span class="bg-success/10 text-success px-2 py-1 rounded text-xs">已完成</span></td>
                                    <td class="py-3 px-4">常规订单</td>
                                    <td class="py-3 px-4">
                                        <div class="flex gap-2">
                                            <button class="text-primary text-xs"><i class="fa fa-edit mr-1"></i> 编辑</button>
                                            <button class="text-danger text-xs"><i class="fa fa-trash mr-1"></i> 删除</button>
                                        </div>
                                    </td>
                                </tr>
                                <tr class="border-b border-gray-100 hover:bg-gray-50">
                                    <td class="py-3 px-4">2025-12-19</td>
                                    <td class="py-3 px-4">客户C</td>
                                    <td class="py-3 px-4">ORD20251219001</td>
                                    <td class="py-3 px-4">DRW-003</td>
                                    <td class="py-3 px-4">200</td>
                                    <td class="py-3 px-4">切割、焊接、打磨、喷漆</td>
                                    <td class="py-3 px-4">4</td>
                                    <td class="py-3 px-4">120</td>
                                    <td class="py-3 px-4">80</td>
                                    <td class="py-3 px-4"><span class="bg-warning/10 text-warning px-2 py-1 rounded text-xs">进行中</span></td>
                                    <td class="py-3 px-4">需要特殊包装</td>
                                    <td class="py-3 px-4">
                                        <div class="flex gap-2">
                                            <button class="text-primary text-xs"><i class="fa fa-edit mr-1"></i> 编辑</button>
                                            <button class="text-danger text-xs"><i class="fa fa-trash mr-1"></i> 删除</button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- 分页控件 -->
                    <div class="mt-6 flex flex-col sm:flex-row justify-between items-center gap-4">
                        <!-- 记录统计 -->
                        <div id="orderRecordCount" class="text-sm text-gray-600">
                            显示 1 到 3 条，共 3 条记录
                        </div>
                        
                        <!-- 每页记录数选择 -->
                        <div class="flex items-center gap-2">
                            <label for="ordersPerPage" class="text-sm text-gray-600">每页记录数：</label>
                            <select id="ordersPerPage" class="border border-gray-300 rounded px-2 py-1 text-sm">
                                <option value="5">5</option>
                                <option value="10" selected>10</option>
                                <option value="20">20</option>
                                <option value="50">50</option>
                            </select>
                        </div>
                        
                        <!-- 分页按钮 -->
                        <div class="flex items-center gap-1">
                            <button id="orderFirstPage" class="px-3 py-1 border border-gray-300 rounded text-sm hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fa fa-angle-double-left"></i>
                            </button>
                            <button id="orderPrevPage" class="px-3 py-1 border border-gray-300 rounded text-sm hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fa fa-angle-left"></i>
                            </button>
                            
                            <span id="orderPageInfo" class="px-3 py-1 text-sm">
                                第 <span id="orderCurrentPage">1</span>/<span id="orderTotalPages">1</span> 页
                            </span>
                            
                            <button id="orderNextPage" class="px-3 py-1 border border-gray-300 rounded text-sm hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fa fa-angle-right"></i>
                            </button>
                            <button id="orderLastPage" class="px-3 py-1 border border-gray-300 rounded text-sm hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fa fa-angle-double-right"></i>
                            </button>
                            
                            <!-- 页码跳转 -->
                            <div class="flex items-center gap-1 ml-4">
                                <span class="text-sm text-gray-600">跳至：</span>
                                <input type="number" id="orderPageJump" class="w-12 border border-gray-300 rounded px-2 py-1 text-sm" min="1" max="1" value="1">
                                <button id="orderPageJumpBtn" class="px-3 py-1 bg-primary text-white rounded text-sm hover:bg-primary/90">
                                    确定
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 工单管理页面 -->
            <div id="orders-page" class="page-content hidden">
                <div class="bg-white rounded-lg card-shadow p-6">
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex items-center gap-4 flex-wrap">
                            <h2 class="text-lg font-bold text-gray-700">工单管理</h2>
                            <!-- 搜索输入框 -->
                            <div class="relative">
                                <input type="text" id="workOrderSearchInput" placeholder="搜索工单编号/客户/订单号/工序/产品/规格/员工姓名" class="pl-8 pr-4 py-2 rounded-lg border border-gray-200 focus:outline-none focus:border-primary w-64 text-sm">
                                <i class="fa fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            </div>
                            <!-- 日期范围筛选 -->
                            <div class="flex items-center gap-2">
                                <input type="date" id="workOrderStartDate" class="px-3 py-2 rounded-lg border border-gray-200 focus:outline-none focus:border-primary text-sm">
                                <span class="text-gray-400">至</span>
                                <input type="date" id="workOrderEndDate" class="px-3 py-2 rounded-lg border border-gray-200 focus:outline-none focus:border-primary text-sm">
                            </div>
                            <!-- 重置按钮 -->
                            <button id="workOrderResetFilterBtn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm hover:bg-gray-300 transition-colors">
                                <i class="fa fa-refresh"></i> 重置
                            </button>
                        </div>
                        <div class="flex gap-2">
                            <button id="createWorkOrderBtn" class="bg-primary text-white px-4 py-2 rounded-lg text-sm flex items-center gap-2 hover:bg-primary/90 transition-colors">
                                <i class="fa fa-plus"></i> 新建工单
                            </button>
                            <button id="createDispatchOrderBtn" class="bg-primary text-white px-4 py-2 rounded-lg text-sm flex items-center gap-2 hover:bg-primary/90 transition-colors">
                                <i class="fa fa-file-text-o"></i> 派工单
                            </button>
                        </div>
                    </div>
                    <!-- 搜索结果统计 -->
                    <div id="workOrderSearchStats" class="mb-4 text-sm text-gray-600 hidden">
                        搜索结果：<span id="workOrderSearchCount">0</span> 条记录，工序数量合计：<span id="workOrderProcessTotal">0</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="text-left py-3 px-4 font-medium text-gray-500 whitespace-nowrap">
                                        <input type="checkbox" id="selectAllWorkOrders" class="rounded border-gray-300 text-primary focus:ring-primary">
                                    </th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-500 whitespace-nowrap">日期</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-500 whitespace-nowrap">工单编号</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-500 whitespace-nowrap">客户</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-500 whitespace-nowrap">订单号</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-500 whitespace-nowrap">产品</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-500 whitespace-nowrap">规格</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-500 whitespace-nowrap">工序</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-500 whitespace-nowrap">工序数量</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-500 whitespace-nowrap">返修数量</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-500 whitespace-nowrap">报废数量</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-500 whitespace-nowrap">所需设备</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-500 whitespace-nowrap">员工姓名</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-500 whitespace-nowrap">备注</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-500 whitespace-nowrap">操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- 数据将通过JavaScript动态生成 -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- 分页控件 -->
                    <div class="mt-6 flex flex-col sm:flex-row justify-between items-center gap-4">
                        <!-- 记录统计 -->
                        <div id="workOrderRecordCount" class="text-sm text-gray-600">
                            显示 1 到 3 条，共 3 条记录
                        </div>
                        
                        <!-- 每页记录数选择 -->
                        <div class="flex items-center gap-2">
                            <label for="workOrdersPerPage" class="text-sm text-gray-600">每页记录数：</label>
                            <select id="workOrdersPerPage" class="border border-gray-300 rounded px-2 py-1 text-sm">
                                <option value="5">5</option>
                                <option value="10" selected>10</option>
                                <option value="20">20</option>
                                <option value="50">50</option>
                            </select>
                        </div>
                        
                        <!-- 分页按钮 -->
                        <div class="flex items-center gap-1">
                            <button id="workOrderFirstPage" class="px-3 py-1 border border-gray-300 rounded text-sm hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fa fa-angle-double-left"></i>
                            </button>
                            <button id="workOrderPrevPage" class="px-3 py-1 border border-gray-300 rounded text-sm hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fa fa-angle-left"></i>
                            </button>
                            
                            <span id="workOrderPageInfo" class="px-3 py-1 text-sm">
                                第 <span id="workOrderCurrentPage">1</span>/<span id="workOrderTotalPages">1</span> 页
                            </span>
                            
                            <button id="workOrderNextPage" class="px-3 py-1 border border-gray-300 rounded text-sm hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fa fa-angle-right"></i>
                            </button>
                            <button id="workOrderLastPage" class="px-3 py-1 border border-gray-300 rounded text-sm hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fa fa-angle-double-right"></i>
                            </button>
                            
                            <!-- 页码跳转 -->
                            <div class="flex items-center gap-1 ml-4">
                                <span class="text-sm text-gray-600">跳至：</span>
                                <input type="number" id="workOrderPageJump" class="w-12 border border-gray-300 rounded px-2 py-1 text-sm" min="1" max="1" value="1">
                                <button id="workOrderPageJumpBtn" class="px-3 py-1 bg-primary text-white rounded text-sm hover:bg-primary/90">
                                    确定
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>



            <!-- 人员排班页面 -->
            <div id="scheduling-page" class="page-content hidden">
                <div class="bg-white rounded-lg card-shadow p-6">
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex items-end gap-4 flex-wrap">
                            <h2 class="text-lg font-bold text-gray-700">人员排班</h2>
                            <!-- 搜索输入框 -->
                            <div class="relative">
                                <input type="text" id="schedulingSearchInput" placeholder="搜索客户/订单号/数量/工序" class="pl-8 pr-4 py-2 rounded-lg border border-gray-200 focus:outline-none focus:border-primary w-64 text-sm">
                                <i class="fa fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            </div>
                            <!-- 日期范围选择 -->
                            <div class="flex items-end gap-2">
                                <div>
                                    <label for="schedulingStartDate" class="text-sm text-gray-600 block mb-1">开始日期</label>
                                    <input type="date" id="schedulingStartDate" class="border border-gray-300 rounded px-3 py-2 text-sm">
                                </div>
                                <div>
                                    <label for="schedulingEndDate" class="text-sm text-gray-600 block mb-1">结束日期</label>
                                    <input type="date" id="schedulingEndDate" class="border border-gray-300 rounded px-3 py-2 text-sm">
                                </div>
                            </div>
                            <!-- 操作按钮 -->
                            <button id="clearScheduleBtn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm hover:bg-gray-300 transition-colors">
                                刷新
                            </button>
                        </div>
                    </div>
                    
                    <!-- 人员排班表格 -->
                    <div class="overflow-x-auto">
                        <!-- 颜色说明 -->
                        <div class="flex items-center gap-4 mb-4 text-sm">
                            <span class="flex items-center gap-2">
                                <span class="inline-block w-4 h-4 bg-yellow-200"></span>
                                黄色：完成比例 < 100%
                            </span>
                            <span class="flex items-center gap-2">
                                <span class="inline-block w-4 h-4 bg-green-600 text-white px-1 rounded text-xs">✓</span>
                                绿色：完成比例 100%~105%
                            </span>
                            <span class="flex items-center gap-2">
                                <span class="inline-block w-4 h-4 bg-red-600 text-white px-1 rounded text-xs">✗</span>
                                红色：完成比例 > 105%
                            </span>
                        </div>
                        <table class="min-w-full text-sm">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="text-left py-3 px-4 font-medium text-gray-500 whitespace-nowrap sticky left-0 bg-white z-20">客户</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-500 whitespace-nowrap sticky left-[90px] bg-white z-20">订单号</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-500 whitespace-nowrap sticky left-[180px] bg-white z-20">数量</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-500 whitespace-nowrap sticky left-[270px] bg-white z-10">工序名称</th>
                                    <!-- 日期列 -->
                                    <th class="text-center py-3 px-4 font-medium text-gray-500 whitespace-nowrap">12/1<br>周一</th>
                                    <th class="text-center py-3 px-4 font-medium text-gray-500 whitespace-nowrap">12/2<br>周二</th>
                                    <th class="text-center py-3 px-4 font-medium text-gray-500 whitespace-nowrap">12/3<br>周三</th>
                                    <th class="text-center py-3 px-4 font-medium text-gray-500 whitespace-nowrap">12/4<br>周四</th>
                                    <th class="text-center py-3 px-4 font-medium text-gray-500 whitespace-nowrap">12/5<br>周五</th>
                                    <th class="text-center py-3 px-4 font-medium text-gray-500 whitespace-nowrap">12/6<br>周六</th>
                                    <th class="text-center py-3 px-4 font-medium text-gray-500 whitespace-nowrap">12/7<br>周日</th>
                                    <th class="text-center py-3 px-4 font-medium text-gray-500 whitespace-nowrap">12/8<br>周一</th>
                                    <th class="text-center py-3 px-4 font-medium text-gray-500 whitespace-nowrap">12/9<br>周二</th>
                                    <th class="text-center py-3 px-4 font-medium text-gray-500 whitespace-nowrap">12/10<br>周三</th>
                                    <th class="text-center py-3 px-4 font-medium text-gray-500 whitespace-nowrap">12/11<br>周四</th>
                                    <th class="text-center py-3 px-4 font-medium text-gray-500 whitespace-nowrap">12/12<br>周五</th>
                                    <th class="text-center py-3 px-4 font-medium text-gray-500 whitespace-nowrap">12/13<br>周六</th>
                                    <th class="text-center py-3 px-4 font-medium text-gray-500 whitespace-nowrap">12/14<br>周日</th>
                                    <th class="text-center py-3 px-4 font-medium text-gray-500 whitespace-nowrap">12/15<br>周一</th>
                                </tr>
                            </thead>
                            <tbody id="schedulingTableBody">
                                <!-- 动态生成的排班数据 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 人员管理页面 -->
            <div id="personnel-page" class="page-content hidden">
                <div class="bg-white rounded-lg card-shadow p-6">
                    <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
                        <div class="flex items-center gap-4">
                            <h2 class="text-lg font-bold text-gray-700">人员管理</h2>
                            <!-- 年月份下拉框 -->
                            <div>
                                <label for="attendanceYearMonth" class="text-sm text-gray-600 block mb-1">统计月份</label>
                                <select id="attendanceYearMonth" class="border border-gray-300 rounded px-3 py-2 text-sm">
                                    <!-- 选项将通过JavaScript动态生成 -->
                                </select>
                            </div>
                        </div>

                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="text-left py-3 px-4 font-medium text-gray-500">工号</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-500">姓名</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-500">状态</th>
                                    <th class="text-center py-3 px-4 font-medium text-gray-500">出勤天数</th>

                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 工序管理页面 -->
            <div id="processManagement-page" class="page-content hidden">
                <div class="bg-white rounded-lg card-shadow p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-lg font-bold text-gray-700">工序管理</h2>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="text-left py-3 px-4 font-medium text-gray-500">序号</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-500">工序名称</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-500">备注</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-500">操作</th>
                                </tr>
                            </thead>
                            <tbody id="process-table-body">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 设备管理页面 -->
            <div id="equipment-page" class="page-content hidden">
                <div class="bg-white rounded-lg card-shadow p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-lg font-bold text-gray-700">设备管理</h2>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="border border-gray-200 rounded-lg p-4">
                            <h3 class="font-medium mb-3">设备列表</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead>
                                        <tr class="border-b border-gray-200">
                                            <th class="text-left py-3 px-4 font-medium text-gray-500">序号</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-500">设备名称</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-500">添置日期</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-500">状态</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-500">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr class="border-b border-gray-100 hover:bg-gray-50">
                                            <td class="py-3 px-4">1</td>
                                            <td class="py-3 px-4">抛光机</td>
                                            <td class="py-3 px-4">2023-01-15</td>
                                            <td class="py-3 px-4"><span class="text-xs bg-success/10 text-success px-2 py-1 rounded">运行中</span></td>
                                            <td class="py-3 px-4">
                                                <div class="flex gap-2">
                                                    <button class="text-primary hover:text-primary/80"><i class="fa fa-edit"></i></button>
                                                    <button class="text-danger hover:text-danger/80"><i class="fa fa-trash"></i></button>
                                                    <button class="text-warning hover:text-warning/80"><i class="fa fa-wrench"></i></button>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr class="border-b border-gray-100 hover:bg-gray-50">
                                            <td class="py-3 px-4">2</td>
                                            <td class="py-3 px-4">剪板机</td>
                                            <td class="py-3 px-4">2023-02-20</td>
                                            <td class="py-3 px-4"><span class="text-xs bg-success/10 text-success px-2 py-1 rounded">运行中</span></td>
                                            <td class="py-3 px-4">
                                                <div class="flex gap-2">
                                                    <button class="text-primary hover:text-primary/80"><i class="fa fa-edit"></i></button>
                                                    <button class="text-danger hover:text-danger/80"><i class="fa fa-trash"></i></button>
                                                    <button class="text-warning hover:text-warning/80"><i class="fa fa-wrench"></i></button>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr class="border-b border-gray-100 hover:bg-gray-50">
                                            <td class="py-3 px-4">3</td>
                                            <td class="py-3 px-4">折弯机</td>
                                            <td class="py-3 px-4">2023-03-10</td>
                                            <td class="py-3 px-4"><span class="text-xs bg-success/10 text-success px-2 py-1 rounded">运行中</span></td>
                                            <td class="py-3 px-4">
                                                <div class="flex gap-2">
                                                    <button class="text-primary hover:text-primary/80"><i class="fa fa-edit"></i></button>
                                                    <button class="text-danger hover:text-danger/80"><i class="fa fa-trash"></i></button>
                                                    <button class="text-warning hover:text-warning/80"><i class="fa fa-wrench"></i></button>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr class="border-b border-gray-100 hover:bg-gray-50">
                                            <td class="py-3 px-4">4</td>
                                            <td class="py-3 px-4">电焊机</td>
                                            <td class="py-3 px-4">2023-04-05</td>
                                            <td class="py-3 px-4"><span class="text-xs bg-warning/10 text-warning px-2 py-1 rounded">维护中</span></td>
                                            <td class="py-3 px-4">
                                                <div class="flex gap-2">
                                                    <button class="text-primary hover:text-primary/80"><i class="fa fa-edit"></i></button>
                                                    <button class="text-danger hover:text-danger/80"><i class="fa fa-trash"></i></button>
                                                    <button class="text-warning hover:text-warning/80"><i class="fa fa-wrench"></i></button>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="border border-gray-200 rounded-lg p-4">
                            <h3 class="font-medium mb-3">设备维护记录</h3>
                            <!-- 调试信息显示区域 -->
                            <div id="debug-info" class="mb-3 p-2 bg-yellow-50 border border-yellow-200 rounded text-xs"></div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead>
                                        <tr class="border-b border-gray-200">
                                            <th class="text-left py-3 px-4 font-medium text-gray-500">序号</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-500">维修记录</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-500">日期</th>
                                        </tr>
                                    </thead>
                                    <tbody id="maintenance-records-body">
                                        <!-- 维护记录将通过JavaScript自动生成 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>




        </div>
    </main>

    <!-- 新增/编辑人员模态框 -->
    <div id="personnel-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-700" id="modal-title">新增人员</h3>
                <button id="close-modal" class="text-gray-500 hover:text-gray-700">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <form id="personnel-form">
                <div class="space-y-4">
                    <div>
                        <label for="employee-id" class="block text-sm font-medium text-gray-700 mb-1">工号</label>
                        <input type="text" id="employee-id" name="employeeId" class="w-full border border-gray-200 rounded-lg px-3 py-2 focus:outline-none focus:border-primary" required readonly>
                    </div>
                    <div>
                        <label for="employee-name" class="block text-sm font-medium text-gray-700 mb-1">姓名</label>
                        <input type="text" id="employee-name" name="employeeName" class="w-full border border-gray-200 rounded-lg px-3 py-2 focus:outline-none focus:border-primary" required>
                    </div>

                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" id="cancel-btn" class="border border-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50 transition-colors">取消</button>
                    <button type="submit" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90 transition-colors">保存</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 设备维修记录模态框 -->
    <div id="maintenance-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-700" id="maintenance-modal-title">添加维修记录</h3>
                <button id="maintenance-close-modal" class="text-gray-500 hover:text-gray-700">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <form id="maintenance-form">
                <div class="space-y-4">
                    <div>
                        <label for="maintenance-equipment" class="block text-sm font-medium text-gray-700 mb-1">设备名称</label>
                        <input type="text" id="maintenance-equipment" name="maintenanceEquipment" class="w-full border border-gray-200 rounded-lg px-3 py-2 focus:outline-none focus:border-primary" readonly>
                    </div>
                    <div>
                        <label for="maintenance-record" class="block text-sm font-medium text-gray-700 mb-1">维修记录</label>
                        <textarea id="maintenance-record" name="maintenanceRecord" rows="4" class="w-full border border-gray-200 rounded-lg px-3 py-2 focus:outline-none focus:border-primary" required placeholder="请输入维修记录详情..."></textarea>
                    </div>
                    <div>
                        <label for="maintenance-date" class="block text-sm font-medium text-gray-700 mb-1">维修日期</label>
                        <input type="date" id="maintenance-date" name="maintenanceDate" class="w-full border border-gray-200 rounded-lg px-3 py-2 focus:outline-none focus:border-primary" required>
                    </div>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" id="maintenance-cancel-btn" class="border border-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50 transition-colors">取消</button>
                    <button type="submit" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90 transition-colors">保存</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 新增/编辑设备模态框 -->
    <div id="equipment-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-700" id="equipment-modal-title">新增设备</h3>
                <button id="equipment-close-modal" class="text-gray-500 hover:text-gray-700">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <form id="equipment-form">
                <div class="space-y-4">
                    <div>
                        <label for="equipment-id" class="block text-sm font-medium text-gray-700 mb-1">设备编号</label>
                        <input type="text" id="equipment-id" name="equipmentId" class="w-full border border-gray-200 rounded-lg px-3 py-2 focus:outline-none focus:border-primary" required readonly>
                    </div>
                    <div>
                        <label for="equipment-name" class="block text-sm font-medium text-gray-700 mb-1">设备名称</label>
                        <input type="text" id="equipment-name" name="equipmentName" class="w-full border border-gray-200 rounded-lg px-3 py-2 focus:outline-none focus:border-primary" required>
                    </div>
                    <div>
                        <label for="equipment-date" class="block text-sm font-medium text-gray-700 mb-1">添置日期</label>
                        <input type="date" id="equipment-date" name="equipmentDate" class="w-full border border-gray-200 rounded-lg px-3 py-2 focus:outline-none focus:border-primary" required>
                    </div>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" id="equipment-cancel-btn" class="border border-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50 transition-colors">取消</button>
                    <button type="submit" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90 transition-colors">保存</button>
                </div>
            </form>
        </div>
    </div>
    




    <!-- 页脚 -->
    <footer class="bg-gray-800 text-white text-center p-4 mt-6">
        Designed By AlonZhang(202512)
    </footer>

    <!-- 数据管理功能脚本 -->
    <script>
        // 数据管理下拉菜单控制
        const dataManagementBtn = document.getElementById('dataManagementBtn');
        const dataManagementDropdown = document.getElementById('dataManagementDropdown');
        const backupDataBtn = document.getElementById('backupDataBtn');
        const restoreDataBtn = document.getElementById('restoreDataBtn');
        const restoreFileInput = document.getElementById('restoreFileInput');

        // 所有数据存储键名
        const ALL_STORAGE_KEYS = [
            'production_equipment_data',
            'production_process_data',
            'factory_management_system_maintenance_records',
            'factory_management_system_personnel_data_20240615',
            'production_order_data',
            'workOrderData'
        ];

        // 显示/隐藏下拉菜单
        dataManagementBtn.addEventListener('click', function() {
            dataManagementDropdown.classList.toggle('hidden');
        });

        // 点击页面其他地方关闭下拉菜单
        document.addEventListener('click', function(e) {
            if (!dataManagementBtn.contains(e.target) && !dataManagementDropdown.contains(e.target)) {
                dataManagementDropdown.classList.add('hidden');
            }
        });

        // 备份数据功能
        backupDataBtn.addEventListener('click', function() {
            // 收集所有模块的数据
            const backupData = {};
            ALL_STORAGE_KEYS.forEach(key => {
                backupData[key] = localStorage.getItem(key);
            });

            // 添加备份时间戳
            backupData.timestamp = new Date().toISOString();
            backupData.version = '1.0';

            // 转换为JSON字符串
            const jsonData = JSON.stringify(backupData, null, 2);

            // 创建下载链接
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `炉架生产管理系统数据备份_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            // 显示备份成功提示
            alert('数据备份成功！');
        });

        // 恢复数据功能
        restoreDataBtn.addEventListener('click', function() {
            restoreFileInput.click();
        });

        // 处理文件选择
        restoreFileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    // 解析JSON数据
                    const restoreData = JSON.parse(e.target.result);

                    // 确认恢复
                    if (confirm('确定要恢复数据吗？这将覆盖当前所有数据！')) {
                        // 恢复所有数据到localStorage
                        ALL_STORAGE_KEYS.forEach(key => {
                            if (restoreData[key] !== undefined) {
                                localStorage.setItem(key, restoreData[key]);
                            }
                        });

                        // 刷新页面以加载新数据
                        alert('数据恢复成功！页面将刷新以显示恢复后的数据。');
                        window.location.reload();
                    }
                } catch (error) {
                    alert('数据文件格式错误，请选择正确的备份文件！');
                    console.error('恢复数据错误:', error);
                }
            };
            reader.readAsText(file);

            // 重置文件输入
            this.value = '';
        });
        

    </script>
    
    <!-- 新建工单模态框 -->
    <div id="createWorkOrderModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl mx-4">
            <!-- 模态框头部 -->
            <div class="flex justify-between items-center border-b border-gray-200 px-6 py-4">
                <h3 class="text-lg font-semibold text-gray-700">新建工单</h3>
                <button id="closeWorkOrderModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            
            <!-- 模态框内容 -->
            <div class="p-6">
                <form id="createWorkOrderForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- 日期 -->
                    <div>
                        <label for="modalWorkOrderDate" class="block text-sm font-medium text-gray-700 mb-1">日期 *</label>
                        <input type="date" id="modalWorkOrderDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary" required>
                    </div>
                    
                    <!-- 工单编号 -->
                    <div>
                        <label for="modalWorkOrderId" class="block text-sm font-medium text-gray-700 mb-1">工单编号 *</label>
                        <input type="text" id="modalWorkOrderId" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary bg-gray-50 cursor-not-allowed" placeholder="如：WJ2025122100001" required readonly>
                    </div>
                    
                    <!-- 客户 -->
                    <div class="relative">
                        <label for="modalWorkOrderCustomer" class="block text-sm font-medium text-gray-700 mb-1">客户 *</label>
                        <input type="text" id="modalWorkOrderCustomer" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary" placeholder="请输入客户名称" required>
                        <div id="customerSuggestions" class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto hidden"></div>
                    </div>
                    
                    <!-- 订单号 -->
                    <div class="relative">
                        <label for="modalWorkOrderOrderNumber" class="block text-sm font-medium text-gray-700 mb-1">订单号 *</label>
                        <input type="text" id="modalWorkOrderOrderNumber" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary" placeholder="如：DD20251221001" required>
                        <div id="orderNumberSuggestions" class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto hidden"></div>
                    </div>
                    
                    <!-- 产品 -->
                    <div>
                        <label for="modalWorkOrderProduct" class="block text-sm font-medium text-gray-700 mb-1">产品 *</label>
                        <input type="text" id="modalWorkOrderProduct" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary" placeholder="请输入产品名称" required>
                    </div>
                    
                    <!-- 规格 -->
                    <div>
                        <label for="modalWorkOrderSpecification" class="block text-sm font-medium text-gray-700 mb-1">规格 *</label>
                        <input type="text" id="modalWorkOrderSpecification" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary" placeholder="请输入产品规格" required>
                    </div>
                    
                    <!-- 工序 -->
                    <div>
                        <label for="modalWorkOrderProcess" class="block text-sm font-medium text-gray-700 mb-1">工序 *</label>
                        <select id="modalWorkOrderProcess" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary" required>
                            <option value="">请选择工序</option>
                            <!-- 工序选项将根据订单号动态生成 -->
                        </select>
                    </div>
                    
                    <!-- 工序数量 -->
                    <div>
                        <label for="modalWorkOrderProcessQuantity" class="block text-sm font-medium text-gray-700 mb-1">工序数量 *</label>
                        <input type="number" id="modalWorkOrderProcessQuantity" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary" placeholder="请输入数量" min="1" required>
                    </div>
                    
                    <!-- 所需设备 -->
                    <div>
                        <label for="modalWorkOrderEquipment" class="block text-sm font-medium text-gray-700 mb-1">所需设备</label>
                        <select id="modalWorkOrderEquipment" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                            <option value="">请选择设备</option>
                            <!-- 设备选项将通过JavaScript动态生成 -->
                        </select>
                    </div>
                    
                    <!-- 员工姓名 -->
                    <div>
                        <label for="modalWorkOrderEmployeeName" class="block text-sm font-medium text-gray-700 mb-1">员工姓名 *</label>
                        <select id="modalWorkOrderEmployeeName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary" required>
                            <option value="">请选择员工</option>
                            <!-- 员工选项将通过JavaScript动态生成 -->
                        </select>
                    </div>
                    
                    <!-- 备注 -->
                    <div class="md:col-span-2">
                        <label for="modalWorkOrderRemarks" class="block text-sm font-medium text-gray-700 mb-1">备注</label>
                        <textarea id="modalWorkOrderRemarks" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary" rows="3" placeholder="请输入备注信息"></textarea>
                    </div>
                </form>
            </div>
            
            <!-- 模态框底部 -->
            <div class="flex justify-end items-center border-t border-gray-200 px-6 py-4 gap-3">
                <button id="cancelWorkOrderModal" class="px-4 py-2 border border-gray-300 rounded-lg text-sm text-gray-700 hover:bg-gray-50">
                    取消
                </button>
                <button id="submitWorkOrderModal" class="px-4 py-2 bg-primary text-white rounded-lg text-sm hover:bg-primary/90">
                    保存
                </button>
            </div>
        </div>
    </div>

    <!-- 编辑工单模态框 -->
    <div id="editWorkOrderModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl mx-4">
            <!-- 模态框头部 -->
            <div class="flex justify-between items-center border-b border-gray-200 px-6 py-4">
                <h3 class="text-lg font-semibold text-gray-700">编辑工单</h3>
                <button id="closeEditWorkOrderModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            
            <!-- 模态框内容 -->
            <div class="p-6">
                <form id="editWorkOrderForm" class="space-y-6">
                    <!-- 隐藏的工单索引 -->
                    <input type="hidden" id="editWorkOrderIndex" name="editWorkOrderIndex">
                    
                    <!-- 员工姓名、日期、工单编号行 -->
                    <div class="flex flex-col md:flex-row gap-4">
                        <!-- 员工姓名 -->
                        <div class="flex-1">
                            <label for="editModalWorkOrderEmployeeName" class="block text-sm font-medium text-gray-700 mb-1">员工姓名 *</label>
                            <select id="editModalWorkOrderEmployeeName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary" required>
                                <option value="">请选择员工</option>
                                <!-- 员工选项将通过JavaScript动态生成 -->
                            </select>
                        </div>
                        
                        <!-- 日期 -->
                        <div class="flex-1">
                            <label for="editModalWorkOrderDate" class="block text-sm font-medium text-gray-700 mb-1">日期 *</label>
                            <input type="date" id="editModalWorkOrderDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary" required>
                        </div>
                        
                        <!-- 工单编号 -->
                        <div class="flex-1">
                            <label for="editModalWorkOrderId" class="block text-sm font-medium text-gray-700 mb-1">工单编号 *</label>
                            <input type="text" id="editModalWorkOrderId" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary bg-gray-50 cursor-not-allowed" placeholder="如：WJ2025122100001" required readonly>
                        </div>
                    </div>
                    
                    <!-- 客户和订单号行 -->
                    <div class="flex flex-col md:flex-row gap-4">
                        <!-- 客户 -->
                        <div class="flex-1">
                            <label for="editModalWorkOrderCustomer" class="block text-sm font-medium text-gray-700 mb-1">客户 *</label>
                            <div class="relative">
                                <input type="text" id="editModalWorkOrderCustomer" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary" placeholder="请输入客户名称" required>
                                <div id="editCustomerSuggestions" class="absolute left-0 right-0 z-10 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto hidden"></div>
                            </div>
                        </div>
                        
                        <!-- 订单号 -->
                        <div class="flex-1">
                            <label for="editModalWorkOrderOrderNumber" class="block text-sm font-medium text-gray-700 mb-1">订单号 *</label>
                            <div class="relative">
                                <input type="text" id="editModalWorkOrderOrderNumber" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary" placeholder="如：DD20251221001" required>
                                <div id="editOrderNumberSuggestions" class="absolute left-0 right-0 z-10 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto hidden"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 产品和规格 -->
                    <div class="flex flex-col md:flex-row gap-4">
                        <!-- 产品 -->
                        <div class="flex-1">
                            <label for="editModalWorkOrderProduct" class="block text-sm font-medium text-gray-700 mb-1">产品 *</label>
                            <input type="text" id="editModalWorkOrderProduct" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary" placeholder="请输入产品名称" required>
                        </div>
                        
                        <!-- 规格 -->
                        <div class="flex-1">
                            <label for="editModalWorkOrderSpecification" class="block text-sm font-medium text-gray-700 mb-1">规格 *</label>
                            <input type="text" id="editModalWorkOrderSpecification" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary" placeholder="请输入产品规格" required>
                        </div>
                    </div>
                    
                    <!-- 工序、工序数量、所需设备 -->
                    <div class="flex flex-col md:flex-row gap-4">
                        <!-- 工序 -->
                        <div class="flex-1">
                            <label for="editModalWorkOrderProcess" class="block text-sm font-medium text-gray-700 mb-1">工序 *</label>
                            <div class="relative">
                                <input type="text" id="editModalWorkOrderProcess" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary" placeholder="如：焊接、打磨、喷漆" required>
                                <div id="editProcessSuggestions" class="absolute left-0 right-0 z-10 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto hidden"></div>
                            </div>
                        </div>
                        
                        <!-- 工序数量 -->
                        <div class="flex-1">
                            <label for="editModalWorkOrderProcessQuantity" class="block text-sm font-medium text-gray-700 mb-1">工序数量 *</label>
                            <input type="number" id="editModalWorkOrderProcessQuantity" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary" placeholder="请输入数量" min="1" required>
                        </div>
                        
                        <!-- 返修数量 -->
                        <div class="flex-1">
                            <label for="editModalWorkOrderRepairQuantity" class="block text-sm font-medium text-gray-700 mb-1">返修数量</label>
                            <input type="number" id="editModalWorkOrderRepairQuantity" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary" placeholder="请输入返修数量" min="0">
                        </div>
                        
                        <!-- 报废数量 -->
                        <div class="flex-1">
                            <label for="editModalWorkOrderScrapQuantity" class="block text-sm font-medium text-gray-700 mb-1">报废数量</label>
                            <input type="number" id="editModalWorkOrderScrapQuantity" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary" placeholder="请输入报废数量" min="0">
                        </div>
                        
                        <!-- 所需设备 -->
                        <div class="flex-1">
                            <label for="editModalWorkOrderEquipment" class="block text-sm font-medium text-gray-700 mb-1">所需设备</label>
                            <select id="editModalWorkOrderEquipment" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                                <option value="">请选择设备</option>
                                <!-- 设备选项将通过JavaScript动态生成 -->
                            </select>
                        </div>
                    </div>
                    
                    <!-- 备注 -->
                    <div>
                        <label for="editModalWorkOrderRemarks" class="block text-sm font-medium text-gray-700 mb-1">备注</label>
                        <textarea id="editModalWorkOrderRemarks" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary" rows="3" placeholder="请输入备注信息"></textarea>
                    </div>
                </form>
            </div>
            
            <!-- 模态框底部 -->
            <div class="flex justify-end items-center border-t border-gray-200 px-6 py-4 gap-3">
                <button id="cancelEditWorkOrderModal" class="px-4 py-2 border border-gray-300 rounded-lg text-sm text-gray-700 hover:bg-gray-50">
                    取消
                </button>
                <button id="submitEditWorkOrderModal" class="px-4 py-2 bg-primary text-white rounded-lg text-sm hover:bg-primary/90">
                    保存修改
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // 工单管理功能
        const createWorkOrderModal = document.getElementById('createWorkOrderModal');
        const createWorkOrderBtn = document.getElementById('createWorkOrderBtn');
        const closeWorkOrderModal = document.getElementById('closeWorkOrderModal');
        const cancelWorkOrderModal = document.getElementById('cancelWorkOrderModal');
        const submitWorkOrderModal = document.getElementById('submitWorkOrderModal');
        const createWorkOrderForm = document.getElementById('createWorkOrderForm');
        
        // 编辑工单模态框元素
        const editWorkOrderModal = document.getElementById('editWorkOrderModal');
        const closeEditWorkOrderModal = document.getElementById('closeEditWorkOrderModal');
        const cancelEditWorkOrderModal = document.getElementById('cancelEditWorkOrderModal');
        const submitEditWorkOrderModal = document.getElementById('submitEditWorkOrderModal');
        const editWorkOrderForm = document.getElementById('editWorkOrderForm');
        const selectAllWorkOrders = document.getElementById('selectAllWorkOrders');
        const createDispatchOrderBtn = document.getElementById('createDispatchOrderBtn');
        
        // 生成工单编号函数
        function generateWorkOrderId() {
            // 获取当前日期（年月日）
            const date = new Date();
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const dateStr = `${year}${month}${day}`;
            
            // 生成5位随机数
            const randomNum = String(Math.floor(10000 + Math.random() * 90000));
            
            // 组合成工单编号（WJ+年月日+5位随机数）
            return `WJ${dateStr}${randomNum}`;
        }
        
        // 客户自动完成功能
        const customerInput = document.getElementById('modalWorkOrderCustomer');
        const customerSuggestions = document.getElementById('customerSuggestions');
        
        // 获取所有客户名称（去重）
        function getAllCustomers() {
            const customers = new Set();
            orderData.forEach(order => {
                if (order.customer) {
                    customers.add(order.customer);
                }
            });
            return Array.from(customers);
        }
        
        // 显示客户建议列表
        function showCustomerSuggestions(suggestions) {
            customerSuggestions.innerHTML = '';
            customerSuggestions.classList.remove('hidden');
            
            suggestions.forEach(customer => {
                const div = document.createElement('div');
                div.className = 'px-4 py-2 hover:bg-gray-100 cursor-pointer';
                div.textContent = customer;
                div.addEventListener('click', () => {
                    customerInput.value = customer;
                    customerSuggestions.classList.add('hidden');
                    // 清空订单号输入框，因为客户改变了
                    document.getElementById('modalWorkOrderOrderNumber').value = '';
                });
                customerSuggestions.appendChild(div);
            });
        }
        
        // 监听客户输入框事件
        if (customerInput) {
            customerInput.addEventListener('input', function() {
                const inputValue = this.value.toLowerCase();
                const allCustomers = getAllCustomers();
                
                if (inputValue === '') {
                    customerSuggestions.classList.add('hidden');
                    return;
                }
                
                const filteredCustomers = allCustomers.filter(customer => 
                    customer.toLowerCase().includes(inputValue)
                );
                
                if (filteredCustomers.length > 0) {
                    showCustomerSuggestions(filteredCustomers);
                } else {
                    customerSuggestions.classList.add('hidden');
                }
            });
            
            // 点击其他区域关闭建议列表
            document.addEventListener('click', function(event) {
                if (!customerInput.contains(event.target) && !customerSuggestions.contains(event.target)) {
                    customerSuggestions.classList.add('hidden');
                }
            });
        }
        
        // 订单号自动完成功能的相关变量
        let orderNumberInput, orderNumberSuggestions;
        
        // 根据客户获取非已完成状态的订单号
        function getOrderNumbersByCustomer(customer) {
            const orderNumbers = new Set();
            orderData.forEach(order => {
                // 只获取该客户的非已完成订单
                if (order.customer === customer && order.status !== '已完成') {
                    orderNumbers.add(order.orderNumber);
                }
            });
            return Array.from(orderNumbers);
        }
        
        // 工序自动完成功能
        const processInput = document.getElementById('modalWorkOrderProcess');
        const processSuggestions = document.getElementById('processSuggestions');
        
        // 获取所有工序名称
        function getAllProcessNames() {
            const processNames = new Set();
            processData.forEach(process => {
                processNames.add(process.name);
            });
            return Array.from(processNames);
        }
        
        // 显示工序建议列表
        function showProcessSuggestions(suggestions) {
            processSuggestions.innerHTML = '';
            processSuggestions.classList.remove('hidden');
            
            suggestions.forEach(processName => {
                const div = document.createElement('div');
                div.className = 'px-4 py-2 hover:bg-gray-100 cursor-pointer';
                div.textContent = processName;
                div.addEventListener('click', () => {
                    processInput.value = processName;
                    processSuggestions.classList.add('hidden');
                });
                processSuggestions.appendChild(div);
            });
        }
        
        // 监听工序输入框事件
        if (processInput) {
            processInput.addEventListener('input', function() {
                const inputValue = this.value.toLowerCase();
                
                if (inputValue === '') {
                    processSuggestions.classList.add('hidden');
                    return;
                }
                
                const allProcessNames = getAllProcessNames();
                const filteredProcesses = allProcessNames.filter(processName => 
                    processName.toLowerCase().includes(inputValue)
                );
                
                if (filteredProcesses.length > 0) {
                    showProcessSuggestions(filteredProcesses);
                } else {
                    processSuggestions.classList.add('hidden');
                }
            });
            
            // 点击其他区域关闭建议列表
            document.addEventListener('click', function(event) {
                if (processInput && processSuggestions && !processInput.contains(event.target) && !processSuggestions.contains(event.target)) {
                    processSuggestions.classList.add('hidden');
                }
            });
        }
        
        // 编辑模态框工序输入框处理
        const editProcessInput = document.getElementById('editModalWorkOrderProcess');
        const editProcessSuggestions = document.getElementById('editProcessSuggestions');
        
        // 显示编辑模态框工序建议列表
        function showEditProcessSuggestions(suggestions) {
            editProcessSuggestions.innerHTML = '';
            editProcessSuggestions.classList.remove('hidden');
            
            suggestions.forEach(processName => {
                const div = document.createElement('div');
                div.className = 'px-4 py-2 hover:bg-gray-100 cursor-pointer';
                div.textContent = processName;
                div.addEventListener('click', () => {
                    editProcessInput.value = processName;
                    editProcessSuggestions.classList.add('hidden');
                });
                editProcessSuggestions.appendChild(div);
            });
        }
        
        // 监听编辑模态框工序输入框事件
        if (editProcessInput) {
            editProcessInput.addEventListener('input', function() {
                const inputValue = this.value.toLowerCase();
                
                if (inputValue === '') {
                    editProcessSuggestions.classList.add('hidden');
                    return;
                }
                
                const allProcessNames = getAllProcessNames();
                const filteredProcesses = allProcessNames.filter(processName => 
                    processName.toLowerCase().includes(inputValue)
                );
                
                if (filteredProcesses.length > 0) {
                    showEditProcessSuggestions(filteredProcesses);
                } else {
                    editProcessSuggestions.classList.add('hidden');
                }
            });
            
            // 点击其他区域关闭编辑模态框建议列表
            document.addEventListener('click', function(event) {
                if (editProcessInput && editProcessSuggestions && !editProcessInput.contains(event.target) && !editProcessSuggestions.contains(event.target)) {
                    editProcessSuggestions.classList.add('hidden');
                }
            });
        }
        
        // 打开模态框
        if (createWorkOrderBtn) {
            createWorkOrderBtn.addEventListener('click', function() {
                createWorkOrderModal.classList.remove('hidden');
                createWorkOrderModal.classList.add('flex');
                // 设置默认日期为今天
                document.getElementById('modalWorkOrderDate').value = new Date().toISOString().split('T')[0];
                // 自动生成工单编号
                document.getElementById('modalWorkOrderId').value = generateWorkOrderId();
                // 动态生成设备选项
                populateEquipmentOptions();
                // 动态生成员工选项
                populateEmployeeOptions();
                // 重置工序下拉框
                const processSelect = document.getElementById('modalWorkOrderProcess');
                processSelect.innerHTML = '<option value="">请选择工序</option>';
                
                // 初始化订单号自动完成功能的变量
                orderNumberInput = document.getElementById('modalWorkOrderOrderNumber');
                orderNumberSuggestions = document.getElementById('orderNumberSuggestions');
                const productInput = document.getElementById('modalWorkOrderProduct');
                const specificationInput = document.getElementById('modalWorkOrderSpecification');
                const customerInput = document.getElementById('modalWorkOrderCustomer');
                
                // 显示订单号建议列表
                function showOrderNumberSuggestions(suggestions) {
                    orderNumberSuggestions.innerHTML = '';
                    orderNumberSuggestions.classList.remove('hidden');
                    
                    suggestions.forEach(orderNumber => {
                        const div = document.createElement('div');
                        div.className = 'px-4 py-2 hover:bg-gray-100 cursor-pointer';
                        div.textContent = orderNumber;
                        div.addEventListener('click', () => {
                            orderNumberInput.value = orderNumber;
                            orderNumberSuggestions.classList.add('hidden');
                            // 点击建议项时也触发自动填充
                            orderNumberInputHandler.call(orderNumberInput);
                        });
                        orderNumberSuggestions.appendChild(div);
                    });
                }
                
                // 定义订单号输入事件处理函数 - 同时处理自动填充和自动完成
                function orderNumberInputHandler() {
                    const orderNumber = this.value;
                    console.log('订单号输入:', orderNumber);
                    
                    // 1. 处理订单号自动完成建议
                    const inputValue = orderNumber.toLowerCase();
                    const selectedCustomer = customerInput.value;
                    
                    if (inputValue === '' || selectedCustomer === '') {
                        orderNumberSuggestions.classList.add('hidden');
                    } else {
                        const availableOrderNumbers = getOrderNumbersByCustomer(selectedCustomer);
                        const filteredOrderNumbers = availableOrderNumbers.filter(orderNum => 
                            orderNum.toLowerCase().includes(inputValue)
                        );
                        
                        if (filteredOrderNumbers.length > 0) {
                            showOrderNumberSuggestions(filteredOrderNumbers);
                        } else {
                            orderNumberSuggestions.classList.add('hidden');
                        }
                    }
                    
                    // 2. 处理产品和规格自动填充
                    if (orderNumber) {
                        // 强制重新从localStorage加载订单数据，确保数据是最新的
                        const storedOrders = localStorage.getItem(ORDER_STORAGE_KEY);
                        const latestOrderData = storedOrders ? JSON.parse(storedOrders) : [];
                        console.log('最新订单数据:', latestOrderData);
                        
                        // 从最新订单数据中查找匹配的订单
                        const matchingOrder = latestOrderData.find(order => order.orderNumber === orderNumber);
                        console.log('找到匹配的订单:', matchingOrder);
                        
                        if (matchingOrder) {
                            console.log('匹配的订单详细信息:', JSON.stringify(matchingOrder, null, 2));
                            // 只有当客户输入框为空时，才自动填充客户信息
                            if (!customerInput.value.trim()) {
                                customerInput.value = matchingOrder.customer || '';
                                console.log('自动填充客户信息:', matchingOrder.customer);
                            }
                            
                            // 确保产品和规格字段存在
                            const product = matchingOrder.product || '';
                            const specification = matchingOrder.specification || '';
                            
                            // 填充产品和规格信息
                            productInput.value = product;
                            specificationInput.value = specification;
                            console.log('自动填充产品信息:', product);
                            console.log('自动填充规格信息:', specification);
                            
                            // 更新工序下拉框选项
                            const processSelect = document.getElementById('modalWorkOrderProcess');
                            processSelect.innerHTML = '<option value="">请选择工序</option>';
                            
                            // 提取订单中的工序信息
                            if (matchingOrder.processes && matchingOrder.processes.length > 0) {
                                matchingOrder.processes.forEach(process => {
                                    if (process.name) {
                                        const option = document.createElement('option');
                                        option.value = process.name;
                                        option.textContent = process.name;
                                        processSelect.appendChild(option);
                                    }
                                });
                            }
                        } else {
                            // 只清空产品和规格，保留客户信息
                            console.log('未找到匹配订单，清空产品和规格');
                            productInput.value = '';
                            specificationInput.value = '';
                            
                            // 清空工序下拉框，只保留默认选项
                            const processSelect = document.getElementById('modalWorkOrderProcess');
                            processSelect.innerHTML = '<option value="">请选择工序</option>';
                        }
                    } else {
                        // 清空产品和规格，保留客户信息
                        console.log('订单号为空，清空产品和规格');
                        productInput.value = '';
                        specificationInput.value = '';
                    }
                }
                
                // 先移除可能存在的事件监听器，避免多次绑定
                // 注意：由于函数定义在前面，这里可以正确移除
                orderNumberInput.removeEventListener('input', orderNumberInputHandler);
                orderNumberInput.removeEventListener('change', orderNumberInputHandler);
                
                // 绑定订单号输入事件处理函数
                orderNumberInput.addEventListener('input', orderNumberInputHandler);
                
                // 额外添加一个变化事件监听器，确保在粘贴等操作时也能触发
                orderNumberInput.addEventListener('change', orderNumberInputHandler);
                
                // 添加点击其他区域关闭建议列表的功能
                function closeOrderNumberSuggestions(event) {
                    if (!orderNumberInput.contains(event.target) && !orderNumberSuggestions.contains(event.target)) {
                        orderNumberSuggestions.classList.add('hidden');
                    }
                }
                
                // 先移除可能存在的事件监听器
                document.removeEventListener('click', closeOrderNumberSuggestions);
                // 添加新的事件监听器
                document.addEventListener('click', closeOrderNumberSuggestions);
                
                // 立即触发一次事件，以便在打开模态框时如果已经有订单号就自动填充
                if (orderNumberInput.value.trim()) {
                    orderNumberInputHandler.call(orderNumberInput);
                } else {
                    // 初始时隐藏建议列表
                    orderNumberSuggestions.classList.add('hidden');
                }
                
                // 创建工序数量悬停提示元素
                const processInput = document.getElementById('modalWorkOrderProcess');
                const processQuantityInput = document.getElementById('modalWorkOrderProcessQuantity');
                
                // 添加悬停提示容器
                let tooltip = document.createElement('div');
                tooltip.className = 'process-quantity-tooltip';
                tooltip.style.cssText = `
                    position: absolute;
                    background-color: #1976d2;
                    color: white;
                    padding: 8px 12px;
                    border-radius: 4px;
                    font-size: 14px;
                    z-index: 1000;
                    display: none;
                    pointer-events: none;
                    white-space: nowrap;
                `;
                document.body.appendChild(tooltip);
                
                // 绑定工序数量输入框的mouseover事件，显示悬停提示
                processQuantityInput.addEventListener('mouseover', function(e) {
                    const orderNumber = orderNumberInput.value;
                    const process = processInput.value;
                    
                    if (orderNumber && process) {
                        // 查找该订单
                        const matchingOrder = orderData.find(order => order.orderNumber === orderNumber);
                        if (matchingOrder) {
                            // 查找该工序的已完成数量
                            const customer = customerInput.value;
                            let totalCompleted = 0;
                            workOrderData.forEach(workOrder => {
                                if (workOrder.customer === customer && 
                                    workOrder.orderNumber === orderNumber && 
                                    workOrder.process === process) {
                                    totalCompleted += workOrder.processQuantity;
                                }
                            });
                            
                            // 查找该订单中对应工序的数量
                            let processQuantity = 0;
                            if (matchingOrder.processes && Array.isArray(matchingOrder.processes)) {
                                const matchingProcess = matchingOrder.processes.find(p => p.name === process);
                                if (matchingProcess && matchingProcess.quantity) {
                                    processQuantity = matchingProcess.quantity;
                                }
                            }
                            
                            // 计算该工序的待完成数量：工序的数量减去该工序的已完成数量
                            const processPendingQuantity = processQuantity - totalCompleted;
                            
                            // 显示悬停提示，位置调整为输入框右侧，不挡住输入框
                            tooltip.textContent = `该订单${process}工序的待完成数量为：${processPendingQuantity}`;
                            tooltip.style.left = (e.target.offsetLeft + e.target.offsetWidth + 10) + 'px';
                            tooltip.style.top = (e.target.offsetTop) + 'px';
                            tooltip.style.display = 'block';
                        }
                    } else if (!orderNumber) {
                        tooltip.textContent = '请先输入订单号';
                        tooltip.style.left = (e.target.offsetLeft + e.target.offsetWidth + 10) + 'px';
                        tooltip.style.top = (e.target.offsetTop) + 'px';
                        tooltip.style.display = 'block';
                    } else if (!process) {
                        tooltip.textContent = '请先输入工序';
                        tooltip.style.left = (e.target.offsetLeft + e.target.offsetWidth + 10) + 'px';
                        tooltip.style.top = (e.target.offsetTop) + 'px';
                        tooltip.style.display = 'block';
                    }
                });
                
                // 绑定mouseout事件，隐藏悬停提示
                processQuantityInput.addEventListener('mouseout', function() {
                    tooltip.style.display = 'none';
                });
                
                // 当模态框关闭时，移除tooltip元素
                const closeModalButtons = document.querySelectorAll('[data-modal-close="createWorkOrderModal"]');
                closeModalButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        if (tooltip && tooltip.parentNode) {
                            tooltip.parentNode.removeChild(tooltip);
                        }
                    });
                });
            });
        }
        
        // 动态生成设备下拉框选项
        function populateEquipmentOptions() {
            // 处理新建工单模态框的设备下拉框
            const createEquipmentSelect = document.getElementById('modalWorkOrderEquipment');
            // 处理编辑工单模态框的设备下拉框
            const editEquipmentSelect = document.getElementById('editModalWorkOrderEquipment');
            
            // 为两个下拉框添加设备选项
            [createEquipmentSelect, editEquipmentSelect].forEach(select => {
                if (select) {
                    // 清空现有选项（保留第一个默认选项）
                    const defaultOption = select.children[0];
                    select.innerHTML = '';
                    select.appendChild(defaultOption);
                    
                    // 添加设备选项
                    equipmentData.forEach(equipment => {
                        const option = document.createElement('option');
                        option.value = equipment.name;
                        option.textContent = equipment.name;
                        select.appendChild(option);
                    });
                }
            });
        }
        
        // 动态生成员工下拉框选项
        function populateEmployeeOptions() {
            // 处理新建工单模态框的员工下拉框
            const createEmployeeSelect = document.getElementById('modalWorkOrderEmployeeName');
            // 处理编辑工单模态框的员工下拉框
            const editEmployeeSelect = document.getElementById('editModalWorkOrderEmployeeName');
            
            // 直接从localStorage获取员工数据
            const personnelData = JSON.parse(localStorage.getItem('factory_management_system_personnel_data_20240615')) || [];
            
            // 为两个下拉框添加员工选项
            [createEmployeeSelect, editEmployeeSelect].forEach(select => {
                if (select) {
                    // 清空现有选项（保留第一个默认选项）
                    const defaultOption = select.children[0];
                    select.innerHTML = '';
                    select.appendChild(defaultOption);
                    
                    // 添加员工选项
                    personnelData.forEach(employee => {
                        const option = document.createElement('option');
                        option.value = employee.employeeName;
                        option.textContent = employee.employeeName;
                        select.appendChild(option);
                    });
                }
            });
        }
        
        // 关闭模态框
        function closeWorkOrderModalFunc() {
            createWorkOrderModal.classList.add('hidden');
            createWorkOrderModal.classList.remove('flex');
            // 清空表单
            createWorkOrderForm.reset();
        }

        // 关闭编辑模态框
        function closeEditWorkOrderModalFunc() {
            editWorkOrderModal.classList.add('hidden');
            editWorkOrderModal.classList.remove('flex');
            // 清空表单
            editWorkOrderForm.reset();
        }
        
        // 绑定关闭事件
        if (closeWorkOrderModal) {
            closeWorkOrderModal.addEventListener('click', closeWorkOrderModalFunc);
        }
        
        if (cancelWorkOrderModal) {
            cancelWorkOrderModal.addEventListener('click', closeWorkOrderModalFunc);
        }
        
        // 点击模态框外部关闭
        createWorkOrderModal.addEventListener('click', function(e) {
            if (e.target === createWorkOrderModal) {
                closeWorkOrderModalFunc();
            }
        });

        // 绑定编辑模态框关闭事件
        if (closeEditWorkOrderModal) {
            closeEditWorkOrderModal.addEventListener('click', closeEditWorkOrderModalFunc);
        }
        
        if (cancelEditWorkOrderModal) {
            cancelEditWorkOrderModal.addEventListener('click', closeEditWorkOrderModalFunc);
        }
        
        // 点击编辑模态框外部关闭
        editWorkOrderModal.addEventListener('click', function(e) {
            if (e.target === editWorkOrderModal) {
                closeEditWorkOrderModalFunc();
            }
        });
        
        // 提交表单
        if (submitWorkOrderModal) {
            submitWorkOrderModal.addEventListener('click', function() {
                // 验证表单
                if (!createWorkOrderForm.checkValidity()) {
                    // 触发HTML5验证提示
                    createWorkOrderForm.reportValidity();
                    return;
                }
                
                // 获取表单数据
                const newWorkOrder = {
                    date: document.getElementById('modalWorkOrderDate').value,
                    id: document.getElementById('modalWorkOrderId').value,
                    customer: document.getElementById('modalWorkOrderCustomer').value,
                    orderNumber: document.getElementById('modalWorkOrderOrderNumber').value,
                    product: document.getElementById('modalWorkOrderProduct').value,
                    specification: document.getElementById('modalWorkOrderSpecification').value,
                    process: document.getElementById('modalWorkOrderProcess').value,
                    processQuantity: parseInt(document.getElementById('modalWorkOrderProcessQuantity').value),
                    equipment: document.getElementById('modalWorkOrderEquipment').value,
                    employeeName: document.getElementById('modalWorkOrderEmployeeName').value,
                    remarks: document.getElementById('modalWorkOrderRemarks').value,
                    status: 'pending' // 初始状态为待处理
                };
                
                // 添加新工单到数据中
                workOrderData.unshift(newWorkOrder); // 新工单添加到列表顶部
                
                // 保存到localStorage
                saveWorkOrderData();
                
                // 重新渲染表格
                renderWorkOrderTable();
                
                // 关闭模态框
                closeWorkOrderModalFunc();
                
                // 显示成功提示
                alert('工单创建成功！');
            });
        }

        // 编辑工单表单提交
        if (submitEditWorkOrderModal) {
            submitEditWorkOrderModal.addEventListener('click', function() {
                console.log('保存按钮被点击');
                console.log('submitEditWorkOrderModal:', submitEditWorkOrderModal);
                console.log('editWorkOrderForm:', editWorkOrderForm);
                
                // 检查表单是否存在
                if (!editWorkOrderForm) {
                    console.error('editWorkOrderForm未找到');
                    alert('系统错误：表单元素未找到');
                    return;
                }
                
                // 验证表单
                if (!editWorkOrderForm.checkValidity()) {
                    console.log('表单验证失败');
                    // 触发HTML5验证提示
                    editWorkOrderForm.reportValidity();
                    return;
                }
                console.log('表单验证通过');
                
                
                // 获取表单数据，修复ID不匹配问题
                const indexInput = document.getElementById('editWorkOrderIndex');
                console.log('indexInput:', indexInput);
                if (!indexInput) {
                    console.error('editWorkOrderIndex未找到');
                    alert('系统错误：索引元素未找到');
                    return;
                }
                const workOrderIndex = parseInt(indexInput.value);
                console.log('workOrderIndex:', workOrderIndex);
                
                // 检查索引是否有效
                if (isNaN(workOrderIndex) || workOrderIndex < 0 || workOrderIndex >= workOrderData.length) {
                    console.error('无效的工单索引:', workOrderIndex);
                    alert('系统错误：无效的工单索引');
                    return;
                }
                
                // 获取所有表单字段值
                const date = document.getElementById('editModalWorkOrderDate').value;
                const id = document.getElementById('editModalWorkOrderId').value;
                const customer = document.getElementById('editModalWorkOrderCustomer').value;
                const orderNumber = document.getElementById('editModalWorkOrderOrderNumber').value;
                const product = document.getElementById('editModalWorkOrderProduct').value;
                const specification = document.getElementById('editModalWorkOrderSpecification').value;
                const process = document.getElementById('editModalWorkOrderProcess').value;
                const processQuantity = parseInt(document.getElementById('editModalWorkOrderProcessQuantity').value);
                const repairQuantity = parseInt(document.getElementById('editModalWorkOrderRepairQuantity').value) || 0;
                const scrapQuantity = parseInt(document.getElementById('editModalWorkOrderScrapQuantity').value) || 0;
                const equipment = document.getElementById('editModalWorkOrderEquipment').value;
                const employeeName = document.getElementById('editModalWorkOrderEmployeeName').value;
                const remarks = document.getElementById('editModalWorkOrderRemarks').value;
                
                console.log('表单字段值:', { date, id, customer, orderNumber, product, specification, process, processQuantity, repairQuantity, scrapQuantity, equipment, employeeName, remarks });
                
                // 检查必填字段
                if (!date || !id || !customer || !orderNumber || !product || !specification || !process || isNaN(processQuantity) || !equipment || !employeeName) {
                    console.error('必填字段未填写完整');
                    alert('请填写完整的必填字段');
                    return;
                }
                
                const updatedWorkOrder = {
                    date,
                    id,
                    customer,
                    orderNumber,
                    product,
                    specification,
                    process,
                    processQuantity,
                    repairQuantity,
                    scrapQuantity,
                    equipment,
                    employeeName,
                    remarks,
                    status: workOrderData[workOrderIndex].status // 保留原状态
                };
                
                // 更新工单数据
                console.log('更新前的工单数据:', workOrderData[workOrderIndex]);
                workOrderData[workOrderIndex] = { ...workOrderData[workOrderIndex], ...updatedWorkOrder };
                console.log('更新后的工单数据:', workOrderData[workOrderIndex]);
                
                // 保存到localStorage
                console.log('保存到localStorage');
                saveWorkOrderData();
                
                // 验证是否保存成功
                const savedData = localStorage.getItem('workOrderData');
                console.log('localStorage中的数据:', savedData);
                
                // 重新渲染表格
                console.log('重新渲染表格');
                renderWorkOrderTable();
                
                // 关闭模态框
                console.log('关闭模态框');
                closeEditWorkOrderModalFunc();
                
                // 显示成功提示
                alert('工单编辑成功！');
                console.log('保存流程完成');
            });
        }

        // 全选/取消全选功能
        if (selectAllWorkOrders) {
            selectAllWorkOrders.addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('#orders-page table tbody input[type="checkbox"]');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
            });
        }

        // 派工单功能
        if (createDispatchOrderBtn) {
            createDispatchOrderBtn.addEventListener('click', function() {
                // 获取所有选中的工单
                const checkboxes = document.querySelectorAll('#orders-page table tbody input[type="checkbox"]:checked');
                if (checkboxes.length === 0) {
                    alert('请先选择要生成派工单的工单！');
                    return;
                }

                // 收集选中的工单数据
                const selectedWorkOrders = [];
                checkboxes.forEach(checkbox => {
                    const workOrderId = checkbox.dataset.workOrderId;
                    const workOrder = workOrderData.find(wo => wo.id === workOrderId);
                    if (workOrder) {
                        selectedWorkOrders.push(workOrder);
                    }
                });

                // 将选中的工单数据保存到localStorage中，以便派工单页面使用
                localStorage.setItem('selectedWorkOrdersForDispatch', JSON.stringify(selectedWorkOrders));

                // 跳转到派工单页面
                window.open('派工单.html', '_blank');
            });
        }
    </script>
</body>
</html>