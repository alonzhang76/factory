<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>生产派工单</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.544.0/dist/umd/lucide.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        :root {
            --primary-color: #2563eb;
            --secondary-color: #64748b;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --background-color: #f8fafc;
            --card-background: #ffffff;
            --border-color: #e2e8f0;
        }



        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
        }

        .card {
            background-color: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            transition: all 0.2s;
            cursor: pointer;
            border: 1px solid transparent;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #1d4ed8;
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #475569;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #059669;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #dc2626;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            background-color: var(--card-background);
            color: var(--text-color);
            transition: border-color 0.2s, box-shadow 0.2s;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgb(37 99 235 / 0.2);
        }

        /* 工单编号输入框样式，解决显示不全问题 */
        .work-order-id-input {
            font-size: 0.875rem; /* 缩小字体大小 */
            white-space: normal; /* 允许换行 */
            min-height: 2.5rem; /* 确保有足够的高度显示换行内容 */
            word-wrap: break-word; /* 长单词换行 */
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background-color: #f1f5f9;
            font-weight: 600;
        }



        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-pending {
            background-color: #fef3c7;
            color: #92400e;
        }

        .status-processing {
            background-color: #dbeafe;
            color: #1e40af;
        }

        .status-completed {
            background-color: #d1fae5;
            color: #065f46;
        }

        .status-rejected {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            font-weight: 500;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease-in-out;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            background-color: var(--success-color);
        }

        .toast.error {
            background-color: var(--danger-color);
        }

        .toast.info {
            background-color: var(--primary-color);
        }

        .signature-area {
            border: 1px dashed var(--border-color);
            min-height: 100px;
            border-radius: 0.375rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--secondary-color);
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .signature-area:hover {
            border-color: var(--primary-color);
        }

        @media print {
            .no-print {
                display: none !important;
            }
            
            .card {
                box-shadow: none;
                border: 1px solid #000;
            }
            
            body {
                background-color: white;
            }
            
            /* Hide placeholder text when printing */
            input::placeholder {
                color: transparent !important;
            }
            
            /* Show full content of input fields when printing */
            input, textarea, select {
                overflow: visible !important;
                white-space: normal !important;
                text-overflow: clip !important;
            }
        }
    </style>
</head>
<body class="antialiased">
    <div id="app" class="min-h-screen p-4 md:p-6 lg:p-8">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
            <div class="flex items-center gap-3">
                <h1 class="text-3xl font-bold text-gray-900">生产派工单</h1>
                <button id="print-btn" class="btn btn-primary no-print">
                    <i data-lucide="printer" class="w-4 h-4 mr-2"></i>
                    <span>打印</span>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Basic Info -->
            <div class="lg:col-span-2 space-y-6">
                <div class="card p-6">
                    <h2 class="text-xl font-semibold mb-4 flex items-center">
                        <i data-lucide="file-text" class="w-5 h-5 mr-2 text-blue-600"></i>
                        基本信息
                    </h2>
                    <!-- Basic Info Layout -->
                    <div class="space-y-3">
                        <!-- First row: Name, Date, Work Order ID -->
                        <div class="grid grid-cols-12 gap-4">
                            <div class="col-span-3">
                                <label class="block text-sm font-medium mb-1">姓名</label>
                                <input type="text" id="employee-name" class="form-input" placeholder="请输入员工姓名">
                            </div>
                            <div class="col-span-3">
                                <label class="block text-sm font-medium mb-1">日期</label>
                                <input type="text" id="date" class="form-input" placeholder="YYYY-MM-DD">
                            </div>
                            <div class="col-span-6">
                                <label class="block text-sm font-medium mb-1">工单编号</label>
                                <input type="text" id="work-order-id" class="form-input work-order-id-input" placeholder="请输入工单编号">
                            </div>
                        </div>
                        
                        <!-- Second row: Customer, Order Number, Product, Specification -->
                        <div class="grid grid-cols-4 gap-4">
                            <div class="col-span-1">
                                <label class="block text-sm font-medium mb-1">客户</label>
                                <input type="text" id="customer" class="form-input" placeholder="请输入客户名称">
                            </div>
                            <div class="col-span-1">
                                <label class="block text-sm font-medium mb-1">订单号</label>
                                <input type="text" id="order-number" class="form-input" placeholder="请输入订单号">
                            </div>
                            <div class="col-span-1">
                                <label class="block text-sm font-medium mb-1">产品</label>
                                <input type="text" id="product" class="form-input" placeholder="请输入产品名称">
                            </div>
                            <div class="col-span-1">
                                <label class="block text-sm font-medium mb-1">规格</label>
                                <input type="text" id="specification" class="form-input" placeholder="请输入产品规格">
                            </div>
                        </div>
                        
                        <!-- Third row: Notes -->
                        <div class="grid grid-cols-1 gap-4">
                            <div class="col-span-1">
                                <label class="block text-sm font-medium mb-1">备注</label>
                                <input type="text" id="notes" class="form-input" placeholder="请输入备注信息">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Process Steps -->
                <div class="card p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold flex items-center">
                            <i data-lucide="git-branch" class="w-5 h-5 mr-2 text-green-600"></i>
                            工序流转记录
                        </h2>

                    </div>
                    
                    <div class="table-container">
                        <table id="process-table">
                            <thead>
                                <tr>
                                    <th>序号</th>
                                    <th>工序名称</th>
                                    <th>所需设备</th>
                                    <th>工序数量</th>
                                    <th>返修数量</th>
                                    <th>报废数量</th>
                                </tr>
                            </thead>
                            <tbody id="process-body">
                                <!-- Process rows will be added here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Handwritten Notes Area -->
                    <div class="mt-6">
                        <div class="font-medium mb-2">员工手写记录区</div>
                        <div class="border-2 border-black min-h-[120px] p-4" style="background-color: white;">
                            <!-- 员工手写内容区域 -->
                        </div>
                    </div>
                    
                    <!-- Quality Inspector Signature -->
                    <div class="mt-6">
                        <div class="flex justify-end">
                            <div class="text-center w-48">
                                <div class="mb-1">质检员</div>
                                <div class="border-b-2 border-black pt-8"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


        </main>
        
        <!-- Footer with print date -->
        <footer class="mt-8 text-center text-sm text-gray-500">
            <div id="print-date-time">打印日期：</div>
        </footer>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Process Modal -->
    <div id="process-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="card p-6 w-full max-w-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold" id="modal-title">编辑工序</h3>
                <button id="close-modal" class="text-gray-500 hover:text-gray-700">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <form id="process-form">
                <input type="hidden" id="process-index">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">工序名称 *</label>
                        <input type="text" id="process-name" class="form-input" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">设备名称</label>
                        <input type="text" id="equipment-name" class="form-input">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">操作工 *</label>
                        <input type="text" id="operator" class="form-input" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">交接数量 *</label>
                        <input type="number" id="transfer-quantity" class="form-input" required min="0">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">良品数量 *</label>
                        <input type="number" id="good-quantity" class="form-input" required min="0">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">返修数量</label>
                        <input type="number" id="rework-quantity" class="form-input" min="0">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">报废数量</label>
                        <input type="number" id="scrap-quantity" class="form-input" min="0">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">完成时间</label>
                        <input type="datetime-local" id="completion-time" class="form-input">
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" id="cancel-process" class="btn btn-secondary">取消</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Application state - processes no longer saved to localStorage
        let processes = [];
        let editingIndex = -1;

        // DOM elements
        const processBody = document.getElementById('process-body');

        const processModal = document.getElementById('process-modal');
        const modalTitle = document.getElementById('modal-title');
        const closeModalBtn = document.getElementById('close-modal');
        const cancelProcessBtn = document.getElementById('cancel-process');
        const processForm = document.getElementById('process-form');
        const printBtn = document.getElementById('print-btn');

        // Initialize the application
        function initApp() {
            loadProcesses();
            updateSummary();
            setupEventListeners();
            generateWorkOrderId();
            setDefaultDate();
            
            // Load selected work orders from localStorage if available
            loadSelectedWorkOrders();
        }
        
        // Load selected work orders from localStorage
        function loadSelectedWorkOrders() {
            const selectedWorkOrders = localStorage.getItem('selectedWorkOrdersForDispatch');
            if (selectedWorkOrders) {
                const workOrders = JSON.parse(selectedWorkOrders);
                
                // If multiple work orders selected, combine the data
                if (workOrders.length > 0) {
                    // Set the first work order's data to the basic info fields
                    const firstOrder = workOrders[0];
                    
                    // Map fields from work order to dispatch form
                    if (firstOrder.customer) {
                        document.getElementById('customer').value = firstOrder.customer;
                    }
                    if (firstOrder.orderNumber) {
                        document.getElementById('order-number').value = firstOrder.orderNumber;
                    }
                    if (firstOrder.product) {
                        document.getElementById('product').value = firstOrder.product;
                    }
                    if (firstOrder.specification) {
                        document.getElementById('specification').value = firstOrder.specification;
                    }
                    if (firstOrder.date) {
                        document.getElementById('date').value = firstOrder.date;
                    }
                    if (firstOrder.employeeName) {
                        document.getElementById('employee-name').value = firstOrder.employeeName;
                    }
                    
                    // Combine all work order IDs
                    const workOrderIds = workOrders.map(wo => wo.id).join(', ');
                    document.getElementById('work-order-id').value = workOrderIds;
                    
                    // Add each work order as a process step
                    workOrders.forEach((workOrder, index) => {
                        addWorkOrderAsProcess(workOrder, index + 1);
                    });
                    
                    // Clear localStorage after loading
                    localStorage.removeItem('selectedWorkOrdersForDispatch');
                }
            }
        }
        
        // Add a work order as a process step
        function addWorkOrderAsProcess(workOrder, index) {
            // Create process data from work order
            const processData = {
                name: workOrder.process || `工序${index}`,
                equipment: workOrder.equipment || '',
                operator: workOrder.employeeName || '',
                transferQuantity: workOrder.processQuantity || 0,
                goodQuantity: 0,
                reworkQuantity: 0,
                scrapQuantity: 0,
                completionTime: new Date().toISOString().slice(0, 16),
                status: 'pending',
                timestamp: new Date().toISOString()
            };
            
            // Add to processes array
            processes.push(processData);
            
            // Update display - render processes to table
            loadProcesses();
            updateSummary();
        }

        // Generate work order ID
        function generateWorkOrderId() {
            const date = new Date();
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const random = String(Math.floor(Math.random() * 1000)).padStart(3, '0');
            document.getElementById('work-order-id').value = `WO-${year}${month}${day}-${random}`;
        }

        // Set default date
        function setDefaultDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
        }

        // Setup event listeners
        function setupEventListeners() {
            closeModalBtn.addEventListener('click', () => closeModal());
            cancelProcessBtn.addEventListener('click', () => closeModal());
            processForm.addEventListener('submit', (e) => handleProcessSubmit(e));
            printBtn.addEventListener('click', handlePrint);
            
            // Close modal when clicking outside
            processModal.addEventListener('click', (e) => {
                if (e.target === processModal) {
                    closeModal();
                }
            });

            // Auto-save for basic info
            const basicInfoInputs = ['employee-name', 'date', 'work-order-id', 'customer', 'order-number', 'notes'];
            basicInfoInputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', saveBasicInfo);
                    // Load saved values
                    const saved = localStorage.getItem(id);
                    if (saved) {
                        element.value = saved;
                    }
                }
            });
        }

        // Open modal for editing process
        function openModal(index) {
            editingIndex = index;
            
            modalTitle.textContent = '编辑工序';
            const process = processes[index];
            document.getElementById('process-index').value = index;
            document.getElementById('process-name').value = process.name;
            document.getElementById('equipment-name').value = process.equipment || '';
            document.getElementById('operator').value = process.operator;
            document.getElementById('transfer-quantity').value = process.transferQuantity;
            document.getElementById('good-quantity').value = process.goodQuantity;
            document.getElementById('rework-quantity').value = process.reworkQuantity || 0;
            document.getElementById('scrap-quantity').value = process.scrapQuantity || 0;
            document.getElementById('completion-time').value = process.completionTime || new Date().toISOString().slice(0, 16);
            
            processModal.classList.remove('hidden');
        }

        // Close modal
        function closeModal() {
            processModal.classList.add('hidden');
            processForm.reset();
            editingIndex = -1;
        }

        // Handle process form submission
        function handleProcessSubmit(e) {
            e.preventDefault();
            
            const processData = {
                name: document.getElementById('process-name').value,
                equipment: document.getElementById('equipment-name').value,
                operator: document.getElementById('operator').value,
                transferQuantity: parseInt(document.getElementById('transfer-quantity').value),
                goodQuantity: parseInt(document.getElementById('good-quantity').value),
                reworkQuantity: parseInt(document.getElementById('rework-quantity').value) || 0,
                scrapQuantity: parseInt(document.getElementById('scrap-quantity').value) || 0,
                completionTime: document.getElementById('completion-time').value,
                status: 'completed',
                timestamp: new Date().toISOString()
            };

            // Validate quantities
            const totalOutput = processData.goodQuantity + processData.reworkQuantity + processData.scrapQuantity;
            if (totalOutput > processData.transferQuantity) {
                showToast('产出数量不能大于交接数量', 'error');
                return;
            }

            if (editingIndex === -1) {
                processes.push(processData);
                showToast('工序添加成功', 'success');
            } else {
                processes[editingIndex] = processData;
                showToast('工序更新成功', 'success');
            }

            loadProcesses();
            updateSummary();
            closeModal();
        }

        // Load processes into table
        function loadProcesses() {
            processBody.innerHTML = '';
            
            if (processes.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `
                    <td colspan="6" class="text-center py-8 text-gray-500">
                        <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-2"></i>
                        <p>暂无工序记录</p>

                    </td>
                `;
                processBody.appendChild(emptyRow);
                lucide.createIcons();
                return;
            }

            processes.forEach((process, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors';
                
                const completionDate = process.completionTime ? new Date(process.completionTime).toLocaleString('zh-CN') : '-';
                
                row.innerHTML = `
                    <td class="text-center font-medium">${index + 1}</td>
                    <td>${process.name}</td>
                    <td>${process.equipment || '-'}</td>
                    <td>${process.transferQuantity}</td>
                    <td class="text-yellow-600">${process.reworkQuantity > 0 ? process.reworkQuantity : ''}</td>
                    <td class="text-red-600">${process.scrapQuantity > 0 ? process.scrapQuantity : ''}</td>
                `;
                
                processBody.appendChild(row);
            });
            
            lucide.createIcons();
        }

        // Delete process
        function deleteProcess(index) {
            if (confirm('确定要删除这个工序记录吗？')) {
                processes.splice(index, 1);
                loadProcesses();
                updateSummary();
                showToast('工序删除成功', 'success');
            }
        }

        // Update summary statistics
        function updateSummary() {
            const totalInput = processes.reduce((sum, p) => sum + p.transferQuantity, 0);
            const totalGood = processes.reduce((sum, p) => sum + p.goodQuantity, 0);
            const totalRework = processes.reduce((sum, p) => sum + p.reworkQuantity, 0);
            const totalScrap = processes.reduce((sum, p) => sum + p.scrapQuantity, 0);
            
            const passRate = totalInput > 0 ? ((totalGood / totalInput) * 100).toFixed(1) : 0;
            

        }

        // Save processes function removed - data no longer persisted to localStorage

        // Save basic info to localStorage
        function saveBasicInfo(e) {
            localStorage.setItem(e.target.id, e.target.value);
        }



        // Handle print
        function handlePrint() {
            // Update print date and time
            const now = new Date();
            const printDateTime = now.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('print-date-time').textContent = `打印日期：${printDateTime}`;
            
            window.print();
        }

        // Show toast notification
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            document.getElementById('toast-container').appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }



        // Clear all data (for testing)
        function clearAllData() {
            if (confirm('确定要清除所有数据吗？此操作不可恢复。')) {
                localStorage.clear();
                processes = [];
                loadProcesses();
                updateSummary();
                showToast('所有数据已清除', 'info');
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', initApp);

        // Add keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch (e.key) {
                    case 'p':
                        e.preventDefault();
                        handlePrint();
                        break;

                }
            }
        });
    </script>
</body>
</html>