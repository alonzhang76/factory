<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ç”Ÿäº§ç®¡ç†ç³»ç»Ÿ - å®Œæ•´ç‰ˆ</title>
  <!-- å›¾æ ‡åº“ -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <!-- Excel å¤„ç†åº“ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    font-family: "Microsoft YaHei", "Segoe UI", sans-serif;
     }

    body {
      display: flex;
      height: 100vh;
      background: linear-gradient(135deg, #f7f9fc 0%, #eef2f7 100%);
      color: #333;
      overflow: hidden;
    }

    /* å·¦ä¾§èœå• */
    .sidebar {
      width: 240px;
      background: linear-gradient(to bottom, #2c3e50, #1a2530);
      color: white;
      padding: 20px 0;
      box-shadow: 3px 0 10px rgba(0,0,0,0.2);
      z-index: 100;
      position: relative;
    }

    .sidebar h2 {
      text-align: center;
      padding: 20px;
      font-size: 1.4em;
  
      letter-spacing: 1px;
    }

    .menu-item {
      padding: 14px 24px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      font-size: 1.02em;
    }

    .menu-item i {
      margin-right: 12px;
      width: 20px;
      text-align: center;
    }

    .menu-item:hover {
      background: rgba(255,255,255,0.1);
      transform: translateX(4px);
    }

    .menu-item.active {
      background: #007bff;
      border-left: 4px solid white;
  
    }

    /* ä¾§è¾¹æ ç­¾åæ ·å¼ */
    .sidebar-signature {
      position: absolute;
      bottom: 20px;
      left: 0;
      right: 0;
      padding: 0 20px;
      text-align: center;
      font-style: italic;
      color: rgba(255, 255, 255, 0.8);
      font-size: 0.9em;
      line-height: 1.5;
      font-family: 'Comic Sans MS', cursive, sans-serif;
    }

    /* ä¸»å†…å®¹åŒº */
    .main-content {
      flex: 1;
      padding: 25px;
      overflow-y: auto;
    }

    .page-title {
      font-size: 1.8em;
      color: #2c3e50;
      margin-bottom: 25px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .page-title i {
      color: #007bff;
    }

    /* æ•°æ®å¤‡ä»½è¿˜åŸæŒ‰é’® */
    .backup-restore-tools {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      padding: 15px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      border-left: 4px solid #17a2b8;
    }

    /* ç»Ÿè®¡å¡ç‰‡ */
    .stats {
      display: flex;
      gap: 20px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }

    .stat-card {
      flex: 1;
    }
    
    /* è¡¨æ ¼æ ·å¼ - è‡ªé€‚åº”åˆ—å®½ä¸”ä¸æ¢è¡Œ */
    #piecework-table {
      width: 100%;
      border-collapse: collapse;
      table-layout: auto;
    }
    
    #piecework-table th,
    #piecework-table td {
      padding: 8px 12px;
      border: 1px solid #ddd;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    #piecework-table th {
      background-color: #f8f9fa;
      font-weight: 600;
    }
    
    #piecework-table tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    
    /* åˆè®¡è¡Œæ ·å¼ */
    .total-row {
      background-color: #e8f5e9;
      font-weight: bold;
    }
      min-width: 200px;
      background: white;
      border-radius: 12px;
      padding: 12px 18px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      transition: transform 0.3s;
    }

    .stat-card:hover {
      transform: translateY(-5px);
    }

    .stat-content {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .stat-card-icon {
      font-size: 1.8em;
      color: #007bff;
      flex-shrink: 0;
    }

    .stat-text {
      text-align: left;
    }

    .stat-card strong {
      display: block;
      font-size: 1.3em;
      color: #2c3e50;
      margin-bottom: 2px;
    }

    .stat-card small {
      color: #666;
      font-size: 0.9em;
      display: block;
    }

    /* å·¥å…·æ å¢å¼º */
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 20px;
      padding: 16px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      align-items: center;
    }

    input[type="text"], select, input[type="date"] {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 0.95em;
      min-width: 160px;
    }

    button {
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.95em;
      transition: all 0.2s;
    }

    button i { font-size: 0.9em; }

    button.primary { background: #007bff; color: white; }
    button.success { background: #28a745; color: white; }
    button.warning { background: #ffc107; color: #212529; }
    button.danger { background: #dc3545; color: white; }
    button.info { background: #17a2b8; color: white; }
    button.default { background: #6c757d; color: white; }

    button:hover { opacity: 0.9; transform: scale(1.02); }

    /* åç‰‡å®¹å™¨ */
    .cards-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
      gap: 20px;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      position: relative;
      border-top: 4px solid #007bff;
      transition: all 0.3s;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.12);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      font-size: 1.2em;
  
      color: #2c3e50;
      position: relative;
    }
    
    .status-badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8em;
  
      text-transform: uppercase;
    }
    
    .active-status {
      background-color: #28a745;
      color: white;
    }
    
    .inactive-status {
      background-color: #dc3545;
      color: white;
    }

    .card-field {
      font-size: 0.95em;
      margin-bottom: 6px;
      color: #555;
      display: flex;
    }

    .card-field strong {
      width: 90px;
      color: #333;
    }

    .card-actions {
      margin-top: 16px;
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    /* è¡¨æ ¼æ ·å¼å¢å¼º */
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      margin-top: 10px;
    }

    th {
      background: linear-gradient(to bottom, #007bff, #0056b3);
      color: white;
      padding: 12px;
      text-align: left;
      font-weight: 600;
    }

    td {
      padding: 8px 12px;
      border-bottom: 1px solid #eee;
      font-size: 0.95em;
    }

    tr:nth-child(even) {
      background-color: #f9fbfd;
    }

    tr:hover {
      background-color: #f0f7ff;
    }

    .table-actions {
      display: flex;
      gap: 6px;
      align-items: center;
    }
    .table-actions button {
      padding: 4px 8px;
      font-size: 0.8em;
      margin: 0;
    }

    /* æ¨¡æ€æ¡†é€šç”¨ - ç¡®ä¿é»˜è®¤éšè— */
    .modal {
      display: none !important;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
      backdrop-filter: blur(5px);
    }

    .modal-content {
      background: white;
      width: 90%;
      max-width: 800px;
      border-radius: 14px;
      padding: 25px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px dashed #eee;
    }

    .modal-header h3 {
      color: #2c3e50;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .close-btn {
      font-size: 1.8em;
      cursor: pointer;
      color: #aaa;
    }

    .close-btn:hover {
      color: #000;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: #2c3e50;
    }

    .form-control {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 0.95em;
    }

    .dynamic-table {
      width: 100%;
      margin-top: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      overflow: hidden;
    }

    .dynamic-table th, .dynamic-table td {
      padding: 8px;
      border: 1px solid #ddd;
    }

    .dynamic-table th {
      background-color: #f2f6fc;
    }

    /* éšè—ç±» */
    .hidden {
      display: none !important;
    }
    
    /* éšè—æ‰€æœ‰numberè¾“å…¥æ¡†çš„å¾®è°ƒæŒ‰é’® */
    input[type="number"] {
      -moz-appearance: textfield;
      appearance: textfield;
    }
    
    /* WebKitæµè§ˆå™¨ï¼ˆChromeã€Safariï¼‰å…¼å®¹æ ·å¼ */
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    /* æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ */
    .upload-area {
      border: 2px dashed #007bff;
      padding: 20px;
      text-align: center;
      margin: 20px 0;
      border-radius: 8px;
      cursor: pointer;
    }

    .upload-area.highlight {
      background-color: #e6f0ff;
    }

    /* åˆ†é¡µ */
    .pagination {
      text-align: right;
      margin-top: 20px;
      color: #666;
    }

    .pagination button {
      margin-left: 5px;
      padding: 6px 10px;
      font-size: 0.9em;
    }
  </style>
</head>
<body>

  <!-- å·¦ä¾§èœå• -->
  <div class="sidebar">
    <h2><i class="fas fa-calculator"></i> ç”Ÿäº§ç®¡ç†ç³»ç»Ÿ</h2>
    <div class="menu-item active" data-page="employee"><i class="fas fa-users"></i> å‘˜å·¥ç®¡ç†</div>
    <div class="menu-item" data-page="piecework"><i class="fas fa-tasks"></i> è®¡ä»¶å·¥èµ„</div>
    <div class="menu-item" data-page="order"><i class="fas fa-truck"></i> ç‚‰æ¶è®¢å•</div>
    <div class="menu-item" data-page="process"><i class="fas fa-wrench"></i> å·¥åºç®¡ç†</div>
    <div class="menu-item" data-page="wagesummary"><i class="fas fa-chart-line"></i> å·¥èµ„æ±‡æ€»</div>
    <div class="menu-item" data-page="multisearch"><i class="fas fa-search"></i> å¤šè§’åº¦æŸ¥è¯¢</div>
    <div class="menu-item" id="production-management-btn"><i class="fas fa-industry"></i> ç”Ÿäº§ç®¡ç†</div>
    <div class="menu-item" data-page="memo"><i class="fas fa-sticky-note"></i> å¤‡å¿˜å½•</div>
    <div style="height: 4px; background-color: #ff4757; margin: 15px 10px; border-radius: 2px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);"></div>
    <div style="padding: 8px 24px; font-size: 0.9em; color: #ff4757; font-weight: bold;">å¿«é€Ÿé“¾æ¥</div>
    <div class="menu-item" onclick="window.open('ç”µé•€ç®¡ç†.html', '_blank')"><i class="fas fa-industry"></i> ç”µé•€ç®¡ç†</div>
    <div class="sidebar-signature">
      <div>Designed By AlonZhang</div>
      <div>è”ç³»ï¼š136 6511 9291</div>
    </div>
  </div>

  <!-- ä¸»å†…å®¹åŒº -->
  <div class="main-content">
    
    <!-- å…¨å±€æ•°æ®å¤‡ä»½è¿˜åŸå·¥å…· -->
    <div class="backup-restore-tools">
      <h3 style="margin: 0; margin-right: 20px; color: #2c3e50;">ğŸ“Š æ•°æ®ç®¡ç†</h3>
      <button class="button success" id="export-json-btn" title="å¯¼å‡ºæ‰€æœ‰æ•°æ®ä¸ºJSONæ–‡ä»¶"><i class="fas fa-file-export"></i> å¯¼å‡ºJSON</button>
      <button class="button info" id="import-json-btn" title="ä»JSONæ–‡ä»¶å¯¼å…¥å¹¶æ¢å¤æ•°æ®"><i class="fas fa-file-import"></i> å¯¼å…¥JSON</button>
      <input type="file" id="json-file-input" accept=".json" style="display: none;"/>
    </div>

    <!-- ========== å‘˜å·¥ç®¡ç† ========== -->
    <div id="employee" class="page">
      <h1 class="page-title"><i class="fas fa-users"></i> å‘˜å·¥ç®¡ç†</h1>
      <div class="stats">
        <div class="stat-card">
          <div class="stat-content">
            <div class="stat-card-icon"><i class="fas fa-id-badge"></i></div>
            <div class="stat-text">
              <span id="total-count">0</span>
              <small>æ€»äººæ•°</small>
            </div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-content">
            <div class="stat-card-icon"><i class="fas fa-user-check"></i></div>
            <div class="stat-text">
              <span id="active-count">0</span>
              <small>åœ¨èŒ</small>
            </div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-content">
            <div class="stat-card-icon"><i class="fas fa-user-times"></i></div>
            <div class="stat-text">
              <span id="inactive-count">0</span>
              <small>ç¦»èŒ</small>
            </div>
          </div>
        </div>
      </div>

      <div class="toolbar">
        <input type="text" placeholder="ğŸ” æœç´¢å‘˜å·¥ä»»æ„å…³é”®è¯ï¼ˆæ”¯æŒå·¥å·ã€å§“åã€æ‰‹æœºå·ã€èº«ä»½è¯å·ç­‰æ‰€æœ‰ä¿¡æ¯ï¼‰" id="emp-search-input"/>
        
        <select id="status-filter"><option>å…¨éƒ¨çŠ¶æ€</option><option>åœ¨èŒ</option><option>ç¦»èŒ</option></select>
        <button class="button warning" id="import-emp-btn"><i class="fas fa-file-import"></i> å¯¼å…¥</button>
        <button class="button info" id="export-emp-btn"><i class="fas fa-file-export"></i> å¯¼å‡º</button>
        <button class="button danger" id="clear-emp-btn"><i class="fas fa-trash-alt"></i> æ¸…ç©º</button>
        <button class="button primary" id="add-employee-btn"><i class="fas fa-plus"></i> æ–°å¢å‘˜å·¥</button>
      </div>

      <div class="cards-container" id="employee-cards">
        <!-- JS æ¸²æŸ“ -->
      </div>
    </div>

    <!-- ========== è®¡ä»¶å·¥èµ„ ========== -->
    <div id="piecework" class="page hidden">
      <h1 class="page-title"><i class="fas fa-tasks"></i> è®¡ä»¶å·¥èµ„</h1>
      <div class="toolbar">
        <input type="text" placeholder="æœç´¢å§“å/è®¢å•å·..." id="pw-search"/>
        <input type="date" id="start-date"/> è‡³ <input type="date" id="end-date"/>
        <button class="button default" id="filter-pw"><i class="fas fa-filter"></i> ç­›é€‰</button>
        <button class="button default" id="reset-pw"><i class="fas fa-undo"></i> é‡ç½®</button>
        <button class="button danger" id="clear-all-pw"><i class="fas fa-trash-alt"></i> æ¸…ç©º</button>
      </div>
      <table id="piecework-table">
        <thead>
          <tr>
            <th>æ—¥æœŸ</th>
            <th>å§“å</th>
            <th>å®¢æˆ·</th>
            <th>è®¢å•å·</th>
            <th>å·¥åºåç§°</th>
            <th>å·¥ç§</th>
            <th>å•ä»·</th>
            <th>æ•°é‡</th>
            <th>è€ƒå‹¤å¥–</th>
            <th>æˆ¿è´´</th>
            <th>å…¶å®ƒè¡¥è´´</th>
            <th>é‡‘é¢</th>
            <th>å¤‡æ³¨</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="pagination">
        <span>å…± <span id="pw-total">0</span> æ¡è®°å½•</span>
      </div>
    </div>

    <!-- ========== ç‚‰æ¶è®¢å• ========== -->
    <div id="order" class="page hidden">
      <h1 class="page-title"><i class="fas fa-truck"></i> ç‚‰æ¶è®¢å•</h1>
      <div class="toolbar">
        <input type="text" placeholder="æœç´¢è®¢å•ä¿¡æ¯..." id="order-search"/>
        <select id="order-status"><option>å…¨éƒ¨çŠ¶æ€</option><option>å¾…ç”Ÿäº§</option><option>ç”Ÿäº§ä¸­</option><option>å·²å®Œæˆ</option></select>
        <input type="date" id="start-delivery-date" placeholder="å¼€å§‹æ—¥æœŸ"/>
        <input type="date" id="end-delivery-date" placeholder="ç»“æŸæ—¥æœŸ"/>
        <button class="button primary" id="query-order"><i class="fas fa-search"></i> æŸ¥è¯¢</button>
        <button class="button default" id="reset-order"><i class="fas fa-undo"></i> é‡ç½®</button>
        <button class="button primary" id="add-order-btn"><i class="fas fa-plus"></i> æ–°å¢è®¢å•</button>
      </div>
      <table id="order-table">
        <thead>
          <tr>
            <th>è®¢å•å·</th>
            <th>å®¢æˆ·</th>
            <th>äº§å“åç§°</th>
            <th>çŠ¶æ€</th>
            <th>è®¢å•æ•°é‡</th>
            <th>åŠ å·¥å•ä»·</th>
            <th>è®¢å•æ—¥æœŸ</th>
            <th>å¼€å§‹æ—¥æœŸ</th>
            <th>å‡ºè´§æ—¥æœŸ</th>
            <th>å¤‡æ³¨</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- ========== å·¥åºç®¡ç† ========== -->
    <div id="process" class="page hidden">
      <h1 class="page-title"><i class="fas fa-wrench"></i> å·¥åºç®¡ç†</h1>
      <div class="toolbar">
        <input type="text" placeholder="æœç´¢å·¥åºåç§°..." id="proc-search"/>
        <button class="button warning" id="import-proc"><i class="fas fa-file-import"></i> å¯¼å…¥</button>
        <button class="button info" id="export-proc"><i class="fas fa-file-export"></i> å¯¼å‡º</button>
        <button class="button danger" id="clear-proc"><i class="fas fa-trash-alt"></i> æ¸…ç©º</button>
        <button class="button primary" id="add-proc-btn"><i class="fas fa-plus"></i> æ–°å¢å·¥åº</button>
      </div>
      <table id="process-table">
        <thead>
          <tr>
            <th>å·¥åºID</th>
            <th>å·¥åºåç§°</th>
            <th>è®¡ä»¶å•ä»·</th>
            <th>è®¡æ—¶å•ä»·</th>
            <th>å®šé¢æ•°é‡</th>
            <th>å¤‡æ³¨</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- ========== å·¥èµ„æ±‡æ€» ========== -->
    <div id="wagesummary" class="page hidden">
      <h1 class="page-title"><i class="fas fa-chart-line"></i> å·¥èµ„æ±‡æ€»</h1>
      <div class="summary-cards" style="display: flex; justify-content: space-between; margin-bottom: 16px; gap: 16px;">
        <div class="summary-card" style="flex: 1; text-align: center;">
          <h4>æœ¬æœˆå·¥èµ„æ€»é¢</h4>
          <p>Â¥<span id="current-month">0.00</span></p>
        </div>
        <div class="summary-card" style="flex: 1; text-align: center;">
          <h4>ä¸Šæœˆå·¥èµ„æ€»é¢</h4>
          <p>Â¥<span id="last-month">0.00</span></p>
        </div>
        <div class="summary-card" style="flex: 1; text-align: center;">
          <h4>æœ¬å¹´ç´¯è®¡å·¥èµ„</h4>
          <p>Â¥<span id="year-total">0.00</span></p>
        </div>
        <div class="summary-card" style="flex: 1; text-align: center;">
          <h4>å»å¹´ç´¯è®¡å·¥èµ„</h4>
          <p>Â¥<span id="last-year">0.00</span></p>
        </div>
      </div>
      <div class="toolbar">
        <select id="year-select">
          <option>2025</option>
          <option selected>2026</option>
          <option>2027</option>
          <option>2028</option>
          <option>2029</option>
          <option>2030</option>
        </select>
        <select id="month-select">
          <option>å…¨å¹´</option>
          <option selected>1æœˆ</option>
          <option>2æœˆ</option>
          <option>3æœˆ</option>
          <option>4æœˆ</option>
          <option>5æœˆ</option>
          <option>6æœˆ</option>
          <option>7æœˆ</option>
          <option>8æœˆ</option>
          <option>9æœˆ</option>
          <option>10æœˆ</option>
          <option>11æœˆ</option>
          <option>12æœˆ</option>
        </select>
        <button class="button primary" id="query-wage" onclick="filterWageTable()"><i class="fas fa-search"></i> æŸ¥è¯¢</button>
      </div>
      <script>
      // ç­›é€‰å·¥èµ„è¡¨æ ¼æ•°æ®
      function filterWageTable() {
        const selectedYear = document.getElementById('year-select').value;
        const selectedMonth = document.getElementById('month-select').value;
        console.log(`ç­›é€‰æ¡ä»¶ï¼š${selectedYear}å¹´ ${selectedMonth}`);
        
        // è·å–å·¥èµ„æ±‡æ€»è¡¨æ ¼çš„tbody
        const tableBody = document.getElementById('wage-detail-table').querySelector('tbody');
        
        // ä»è®¡ä»¶å·¥èµ„è¡¨æ ¼æå–æ•°æ®å¹¶æŒ‰å¹´æœˆç­›é€‰
        const filteredData = extractAndProcessDataFromPiecework(selectedYear, selectedMonth);
        
        // æ¸…ç©ºè¡¨æ ¼
        tableBody.innerHTML = '';
        
        // æ·»åŠ å¤„ç†åçš„æ•°æ®åˆ°è¡¨æ ¼
        if (filteredData.length > 0) {
          filteredData.forEach(employee => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${employee.name}</td>
              <td>${employee.attendance}</td>
              <td>Â¥${employee.attendanceBonus.toFixed(2)}</td>
              <td>Â¥${employee.housingAllowance.toFixed(2)}</td>
              <td>Â¥${employee.otherAllowance.toFixed(2)}</td>
              <td>Â¥${employee.productionWage.toFixed(2)}</td>
              <td>Â¥${employee.totalWage.toFixed(2)}</td>
            `;
            tableBody.appendChild(row);
          });
        } else {
          // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
          const emptyRow = document.createElement('tr');
          emptyRow.innerHTML = `
              <td colspan="7" style="text-align: center; color: #666; padding: 20px;">
                è¯¥æ—¶é—´æ®µå†…æš‚æ— å·¥èµ„æ•°æ®
              </td>
            `;
          tableBody.appendChild(emptyRow);
        }
        
        // è®¡ç®—å¹¶æ˜¾ç¤ºåˆè®¡è¡Œ
        calculateAndDisplayTotals();
      }
      
      // ä»è®¡ä»¶å·¥èµ„è¡¨æ ¼æå–æ•°æ®å¹¶å¤„ç†
      function extractAndProcessDataFromPiecework(year, month) {
        // è·å–è®¡ä»¶å·¥èµ„è¡¨æ ¼
        const pieceworkTable = document.getElementById('piecework-table');
        const tableRows = pieceworkTable ? pieceworkTable.querySelectorAll('tbody tr') : [];
        
        // å¦‚æœè®¡ä»¶å·¥èµ„è¡¨æ ¼ä¸ºç©ºï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
        if (tableRows.length === 0) {
          return generateMockData(year, month);
        }
        
        // å‘˜å·¥æ•°æ®å¯¹è±¡ï¼Œç”¨äºç´¯è®¡ç»Ÿè®¡
        const employeeData = {};
        
        // éå†è®¡ä»¶å·¥èµ„è¡¨æ ¼è¡Œ
        tableRows.forEach(row => {
          const cells = row.querySelectorAll('td');
          if (cells.length >= 13) { // ç¡®ä¿æœ‰è¶³å¤Ÿçš„åˆ—
            const dateText = cells[0].textContent.trim();
            const employeeName = cells[1].textContent.trim();
            
            // è§£ææ—¥æœŸ
            const dateParts = dateText.split('-');
            if (dateParts.length < 3) return; // è·³è¿‡æ— æ•ˆæ—¥æœŸ
            
            const recordYear = dateParts[0];
            const recordMonth = dateParts[1];
            
            // æ£€æŸ¥æ˜¯å¦ç¬¦åˆç­›é€‰æ¡ä»¶
            if (recordYear !== year) return;
            
            // ä»æœˆä»½é€‰æ‹©å™¨å€¼ä¸­æå–æ•°å­—ï¼ˆå»é™¤'æœˆ'å­—ï¼‰
            let monthNumber = month;
            if (month !== 'å…¨å¹´') {
              // æå–æœˆä»½æ•°å­—éƒ¨åˆ†
              monthNumber = month.replace(/[^0-9]/g, '');
              // è½¬æ¢ä¸ºä¸¤ä½æ•°æ ¼å¼è¿›è¡ŒåŒ¹é…
              monthNumber = monthNumber.padStart(2, '0');
            }
            
            if (month !== 'å…¨å¹´' && recordMonth !== monthNumber) return;
            
            // è·å–å„é¡¹æ•°æ®
            const attendanceBonus = parseFloat(cells[8].textContent.replace(/[^0-9.-]/g, '')) || 0;
            const housingAllowance = parseFloat(cells[9].textContent.replace(/[^0-9.-]/g, '')) || 0;
            const otherAllowance = parseFloat(cells[10].textContent.replace(/[^0-9.-]/g, '')) || 0;
            const amount = parseFloat(cells[11].textContent.replace(/[^0-9.-]/g, '')) || 0;
            
            // åˆå§‹åŒ–æˆ–æ›´æ–°å‘˜å·¥æ•°æ®
            if (!employeeData[employeeName]) {
              employeeData[employeeName] = {
                name: employeeName,
                attendance: 0, // å‡ºå‹¤å¤©æ•°ï¼ˆè®°å½•å‡ºç°çš„ä¸åŒæ—¥æœŸæ•°é‡ï¼‰
                attendanceBonus: 0,
                housingAllowance: 0,
                otherAllowance: 0,
                productionWage: 0, // ç”Ÿäº§å·¥èµ„
                totalWage: 0,
                dates: new Set() // ç”¨äºè®°å½•å‘˜å·¥å‡ºç°çš„ä¸åŒæ—¥æœŸ
              };
            }
            
            // ç´¯è®¡æ•°æ®
            employeeData[employeeName].dates.add(dateText);
            employeeData[employeeName].attendanceBonus += attendanceBonus;
            employeeData[employeeName].housingAllowance += housingAllowance;
            employeeData[employeeName].otherAllowance += otherAllowance;
            employeeData[employeeName].totalWage += amount; // åº”å‘å·¥èµ„ç­‰äºè®¡ä»¶å·¥èµ„æ¨¡å—ä¸­çš„é‡‘é¢æ±‡æ€»åˆè®¡
          }
        });
        
        // è®¡ç®—å‡ºå‹¤å¤©æ•°å¹¶è½¬æ¢ä¸ºæ•°ç»„
        const result = Object.values(employeeData).map(emp => ({
          name: emp.name,
          attendance: emp.dates.size,
          attendanceBonus: emp.attendanceBonus,
          housingAllowance: emp.housingAllowance,
          otherAllowance: emp.otherAllowance,
          productionWage: emp.totalWage - emp.attendanceBonus - emp.housingAllowance - emp.otherAllowance, // ç”Ÿäº§å·¥èµ„ = åº”å‘å·¥èµ„ - è€ƒå‹¤å¥– - æˆ¿è´´ - å…¶å®ƒè¡¥è´´
          totalWage: emp.totalWage
        }));
        
        return result;
      }
      
      // ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®ï¼ˆå½“è®¡ä»¶å·¥èµ„è¡¨æ ¼ä¸ºç©ºæ—¶ä½¿ç”¨ï¼‰
      function generateMockData(year, month) {
        console.log('ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼Œå› ä¸ºè®¡ä»¶å·¥èµ„è¡¨æ ¼ä¸ºç©º');
        
        // æ¨¡æ‹Ÿå‘˜å·¥æ•°æ®
        const employees = [
          { name: 'å¼ ä¸‰', attendanceDays: 22 },
          { name: 'æå››', attendanceDays: 21 },
          { name: 'ç‹äº”', attendanceDays: 23 },
          { name: 'èµµå…­', attendanceDays: 20 },
          { name: 'é’±ä¸ƒ', attendanceDays: 22 },
          { name: 'å­™å…«', attendanceDays: 19 },
          { name: 'å‘¨ä¹', attendanceDays: 22 }
        ];
        
        // ä¸ºæ¯ä¸ªå‘˜å·¥ç”Ÿæˆæ•°æ®
        return employees.map(emp => {
          const attendanceBonus = emp.attendanceDays * 10; // æ¨¡æ‹Ÿè€ƒå‹¤å¥–ï¼šå‡ºå‹¤å¤©æ•° * 10å…ƒ
          const housingAllowance = 300; // å›ºå®šæˆ¿è´´
          const otherAllowance = 100; // å›ºå®šå…¶ä»–è¡¥è´´
          // æ¨¡æ‹Ÿé‡‘é¢æ±‡æ€»åˆè®¡ï¼ˆç›¸å½“äºè®¡ä»¶å·¥èµ„æ¨¡å—ä¸­çš„é‡‘é¢ï¼‰
          const amount = emp.attendanceDays * 300 + 400;
          const totalWage = amount; // åº”å‘å·¥èµ„ç­‰äºé‡‘é¢æ±‡æ€»åˆè®¡
          const productionWage = totalWage - attendanceBonus - housingAllowance - otherAllowance; // ç”Ÿäº§å·¥èµ„ = åº”å‘å·¥èµ„ - è€ƒå‹¤å¥– - æˆ¿è´´ - å…¶å®ƒè¡¥è´´
          return {
            name: emp.name,
            attendance: emp.attendanceDays,
            attendanceBonus: attendanceBonus,
            housingAllowance: housingAllowance,
            otherAllowance: otherAllowance,
            productionWage: productionWage,
            totalWage: totalWage
          };
        });
      }
      
      // è®¡ç®—å¹¶æ˜¾ç¤ºè¡¨æ ¼å„åˆ—çš„åˆè®¡
      function calculateAndDisplayTotals() {
        const table = document.getElementById('wage-detail-table');
        const tableBody = table.querySelector('tbody');
        
        // ç§»é™¤ç°æœ‰çš„åˆè®¡è¡Œ
        const existingTotalRow = table.querySelector('tfoot');
        if (existingTotalRow) {
          table.removeChild(existingTotalRow);
        }
        
        // å¦‚æœè¡¨æ ¼ä¸ºç©ºæˆ–åªæœ‰æç¤ºè¡Œï¼Œä¸æ·»åŠ åˆè®¡è¡Œ
        if (tableBody.children.length === 0 || 
            (tableBody.children.length === 1 && tableBody.children[0].querySelector('td[colspan]'))) {
          return;
        }
        
        // åˆå§‹åŒ–åˆè®¡å€¼
        let totalAttendance = 0;
        let totalAttendanceBonus = 0;
        let totalHousingAllowance = 0;
        let totalOtherAllowance = 0;
        let totalProductionWage = 0;
        let totalWage = 0;
        
        // éå†æ‰€æœ‰è¡Œè®¡ç®—åˆè®¡
        const rows = tableBody.querySelectorAll('tr');
        rows.forEach(row => {
          const cells = row.querySelectorAll('td');
          if (cells.length >= 6) {
            // æ³¨æ„ï¼šå®é™…åº”ç”¨ä¸­éœ€è¦å¤„ç†æ•°æ®æ ¼å¼
            totalAttendance += parseInt(cells[1].textContent) || 0;
            totalAttendanceBonus += parseFloat(cells[2].textContent.replace(/[^0-9.-]/g, '')) || 0;
            totalHousingAllowance += parseFloat(cells[3].textContent.replace(/[^0-9.-]/g, '')) || 0;
            totalOtherAllowance += parseFloat(cells[4].textContent.replace(/[^0-9.-]/g, '')) || 0;
            totalProductionWage += parseFloat(cells[5].textContent.replace(/[^0-9.-]/g, '')) || 0;
            totalWage += parseFloat(cells[6].textContent.replace(/[^0-9.-]/g, '')) || 0;
          }
        });
        
        // åˆ›å»ºåˆè®¡è¡Œ
        const tfoot = document.createElement('tfoot');
        const totalRow = document.createElement('tr');
        totalRow.style.backgroundColor = '#f8f9fa';
        totalRow.style.fontWeight = 'bold';
        
        totalRow.innerHTML = `
          <td>åˆè®¡</td>
          <td>${totalAttendance}</td>
          <td>Â¥${totalAttendanceBonus.toFixed(2)}</td>
          <td>Â¥${totalHousingAllowance.toFixed(2)}</td>
          <td>Â¥${totalOtherAllowance.toFixed(2)}</td>
          <td>Â¥${totalProductionWage.toFixed(2)}</td>
          <td>Â¥${totalWage.toFixed(2)}</td>
        `;
        
        tfoot.appendChild(totalRow);
        table.appendChild(tfoot);
        
        // æ›´æ–°ç»Ÿè®¡å¡ç‰‡æ•°æ®
        updateSummaryCards(totalWage);
      }
      
      // è®¡ç®—ç»™å®šå¹´æœˆçš„å‰ä¸€ä¸ªæœˆ
      function getPreviousMonth(year, month) {
        // æ·»åŠ ç±»å‹æ£€æŸ¥å’Œé˜²å¾¡æ€§ç¼–ç¨‹
        if (!year || !month) {
          console.error('å¹´æœˆå‚æ•°ä¸èƒ½ä¸ºç©º');
          return { year: '0', month: '00' };
        }
        
        let prevYear = parseInt(year);
        let prevMonth = parseInt(month) - 1;
        
        // å¤„ç†è¾¹ç•Œæƒ…å†µï¼šå¦‚æœæ˜¯1æœˆï¼Œåˆ™å‰ä¸€ä¸ªæœˆæ˜¯ä¸Šä¸€å¹´çš„12æœˆ
        if (prevMonth < 1) {
          prevYear -= 1;
          prevMonth = 12;
        }
        
        // è¿”å›æ ¼å¼åŒ–çš„å¹´æœˆå­—ç¬¦ä¸²
        const result = {
          year: prevYear.toString(),
          month: prevMonth.toString().padStart(2, '0')
        };
        
        console.log(`è®¡ç®—å‰ä¸€ä¸ªæœˆ: ${year}-${month.padStart(2, '0')} -> ${result.year}-${result.month}`);
        return result;
      }
      
      // ä»è®¡ä»¶å·¥èµ„è¡¨æ ¼æå–æŒ‡å®šå¹´æœˆçš„æ•°æ®å¹¶è®¡ç®—æ€»é¢
      function extractPreviousMonthTotal(year, month) {
        // ç¡®ä¿å¹´æœˆæ ¼å¼æ­£ç¡®
        const cleanMonth = month.toString().replace(/æœˆ/g, '').padStart(2, '0');
        const prevMonth = getPreviousMonth(year, cleanMonth);
        
        console.log(`æ­£åœ¨æå–å‰ä¸€ä¸ªæœˆ(${prevMonth.year}-${prevMonth.month})çš„æ•°æ®`);
        
        const table = document.getElementById('piecework-table');
        if (!table) {
          console.warn('æœªæ‰¾åˆ°è®¡ä»¶å·¥èµ„è¡¨æ ¼');
          return 0;
        }
        
        const rows = table.querySelectorAll('tbody tr');
        console.log(`æ‰¾åˆ° ${rows.length} è¡Œæ•°æ®`);
        
        let totalWage = 0;
        let matchedRows = 0;
        
        // éå†è¡¨æ ¼è¡Œï¼Œæå–åŒ¹é…å¹´æœˆçš„æ•°æ®
        rows.forEach(row => {
          const dateCell = row.querySelector('td:first-child');
          if (dateCell) {
            const dateText = dateCell.textContent.trim();
            // æ”¯æŒå¤šç§æ—¥æœŸæ ¼å¼
            let rowYear, rowMonth;
            
            // å°è¯•åŒ¹é…YYYY-MM-DDæ ¼å¼
            if (dateText.includes('-')) {
              const dateParts = dateText.split('-');
              if (dateParts.length >= 2) {
                rowYear = dateParts[0];
                rowMonth = dateParts[1].padStart(2, '0');
              }
            }
            // å°è¯•åŒ¹é…å…¶ä»–å¯èƒ½çš„æ—¥æœŸæ ¼å¼
            else if (dateText.match(/\d{4}/)) {
              // å¤„ç†å…¶ä»–æ ¼å¼ï¼Œå¦‚20251201
              const yearMatch = dateText.match(/\d{4}/);
              const monthMatch = dateText.match(/\d{4}(\d{2})/);
              if (yearMatch && monthMatch) {
                rowYear = yearMatch[0];
                rowMonth = monthMatch[1].padStart(2, '0');
              }
            }
            
            // æ£€æŸ¥æ˜¯å¦åŒ¹é…å‰ä¸€ä¸ªæœˆ
            if (rowYear && rowMonth && rowYear === prevMonth.year && rowMonth === prevMonth.month) {
              matchedRows++;
                  // ä½¿ç”¨å›ºå®šçš„é‡‘é¢åˆ—ç´¢å¼•(cells[11])
              const cells = row.querySelectorAll('td');
              if (cells.length >= 12) { // ç¡®ä¿æœ‰è¶³å¤Ÿçš„åˆ—
                const amountCell = cells[11]; // é‡‘é¢åˆ—å›ºå®šåœ¨ç´¢å¼•11
                const amount = parseFloat(amountCell.textContent.replace(/[^0-9.-]/g, '')) || 0;
                totalWage += amount;
                console.log(`åŒ¹é…åˆ°æ•°æ®è¡Œ: æ—¥æœŸ=${dateText}, é‡‘é¢=${amount}`);
              }
            }
          }
        });
        
        console.log(`å…±åŒ¹é…åˆ° ${matchedRows} è¡Œç¬¦åˆæ¡ä»¶çš„æ•°æ®ï¼Œæ€»é‡‘é¢: ${totalWage}`);
        return totalWage;
      }
      
      // ä»è®¡ä»¶å·¥èµ„è¡¨æ ¼æå–æŒ‡å®šå¹´ä»½çš„æ•°æ®å¹¶è®¡ç®—æ€»é¢
      function extractCurrentYearTotal(year) {
        console.log(`æ­£åœ¨æå–æœ¬å¹´(${year})çš„æ•°æ®`);
        
        const table = document.getElementById('piecework-table');
        if (!table) {
          console.warn('æœªæ‰¾åˆ°è®¡ä»¶å·¥èµ„è¡¨æ ¼');
          return 0;
        }
        
        const rows = table.querySelectorAll('tbody tr');
        console.log(`æ‰¾åˆ° ${rows.length} è¡Œæ•°æ®`);
        
        let totalWage = 0;
        let matchedRows = 0;
        
        // éå†è¡¨æ ¼è¡Œï¼Œæå–åŒ¹é…å¹´ä»½çš„æ•°æ®
        rows.forEach(row => {
          const dateCell = row.querySelector('td:first-child');
          if (dateCell) {
            const dateText = dateCell.textContent.trim();
            let rowYear = null;
            
            // å°è¯•åŒ¹é…YYYY-MM-DDæ ¼å¼
            if (dateText.includes('-')) {
              const dateParts = dateText.split('-');
              if (dateParts.length >= 1) {
                rowYear = dateParts[0];
              }
            }
            // å°è¯•åŒ¹é…å…¶ä»–å¯èƒ½çš„æ—¥æœŸæ ¼å¼
            else if (dateText.match(/\d{4}/)) {
              const yearMatch = dateText.match(/\d{4}/);
              if (yearMatch) {
                rowYear = yearMatch[0];
              }
            }
            
            // æ£€æŸ¥æ˜¯å¦åŒ¹é…æŒ‡å®šå¹´ä»½
            if (rowYear && rowYear === year.toString()) {
              matchedRows++;
              // ä½¿ç”¨å›ºå®šçš„é‡‘é¢åˆ—ç´¢å¼•(cells[11])
              const cells = row.querySelectorAll('td');
              if (cells.length >= 12) { // ç¡®ä¿æœ‰è¶³å¤Ÿçš„åˆ—
                const amountCell = cells[11]; // é‡‘é¢åˆ—å›ºå®šåœ¨ç´¢å¼•11
                const amount = parseFloat(amountCell.textContent.replace(/[^0-9.-]/g, '')) || 0;
                totalWage += amount;
              }
            }
          }
        });
        
        console.log(`å…±åŒ¹é…åˆ° ${matchedRows} è¡Œç¬¦åˆæ¡ä»¶çš„æ•°æ®ï¼Œæœ¬å¹´æ€»é‡‘é¢: ${totalWage}`);
        return totalWage;
      }
      
      // ä»è®¡ä»¶å·¥èµ„è¡¨æ ¼æå–æŒ‡å®šå¹´ä»½å‰ä¸€å¹´çš„æ•°æ®å¹¶è®¡ç®—æ€»é¢
      function extractLastYearTotal(year) {
        // è®¡ç®—å»å¹´çš„å¹´ä»½
        const lastYear = parseInt(year) - 1;
        console.log(`æ­£åœ¨æå–å»å¹´(${lastYear})çš„æ•°æ®`);
        
        const table = document.getElementById('piecework-table');
        if (!table) {
          console.warn('æœªæ‰¾åˆ°è®¡ä»¶å·¥èµ„è¡¨æ ¼');
          return 0;
        }
        
        const rows = table.querySelectorAll('tbody tr');
        console.log(`æ‰¾åˆ° ${rows.length} è¡Œæ•°æ®`);
        
        let totalWage = 0;
        let matchedRows = 0;
        
        // éå†è¡¨æ ¼è¡Œï¼Œæå–åŒ¹é…å¹´ä»½çš„æ•°æ®
        rows.forEach(row => {
          const dateCell = row.querySelector('td:first-child');
          if (dateCell) {
            const dateText = dateCell.textContent.trim();
            let rowYear = null;
            
            // å°è¯•åŒ¹é…YYYY-MM-DDæ ¼å¼
            if (dateText.includes('-')) {
              const dateParts = dateText.split('-');
              if (dateParts.length >= 1) {
                rowYear = dateParts[0];
              }
            }
            // å°è¯•åŒ¹é…å…¶ä»–å¯èƒ½çš„æ—¥æœŸæ ¼å¼
            else if (dateText.match(/\d{4}/)) {
              const yearMatch = dateText.match(/\d{4}/);
              if (yearMatch) {
                rowYear = yearMatch[0];
              }
            }
            
            // æ£€æŸ¥æ˜¯å¦åŒ¹é…æŒ‡å®šå¹´ä»½
            if (rowYear && rowYear === lastYear.toString()) {
              matchedRows++;
              // ä½¿ç”¨å›ºå®šçš„é‡‘é¢åˆ—ç´¢å¼•(cells[11])
              const cells = row.querySelectorAll('td');
              if (cells.length >= 12) { // ç¡®ä¿æœ‰è¶³å¤Ÿçš„åˆ—
                const amountCell = cells[11]; // é‡‘é¢åˆ—å›ºå®šåœ¨ç´¢å¼•11
                const amount = parseFloat(amountCell.textContent.replace(/[^0-9.-]/g, '')) || 0;
                totalWage += amount;
              }
            }
          }
        });
        
        console.log(`å…±åŒ¹é…åˆ° ${matchedRows} è¡Œç¬¦åˆæ¡ä»¶çš„æ•°æ®ï¼Œå»å¹´æ€»é‡‘é¢: ${totalWage}`);
        return totalWage;
      }
      
      // æ›´æ–°ç»Ÿè®¡å¡ç‰‡æ•°æ®
      function updateSummaryCards(currentMonthTotal) {
        try {
          console.log(`æ›´æ–°ç»Ÿè®¡å¡ç‰‡æ•°æ®ï¼Œå½“å‰æœˆæ€»é¢: ${currentMonthTotal}`);
          
          // æ›´æ–°æœ¬æœˆå·¥èµ„æ€»é¢
          const currentMonthElement = document.getElementById('current-month');
          if (currentMonthElement) {
            currentMonthElement.textContent = currentMonthTotal.toFixed(2);
            console.log('æˆåŠŸæ›´æ–°æœ¬æœˆå·¥èµ„æ€»é¢');
          } else {
            console.warn('æœªæ‰¾åˆ°æœ¬æœˆå·¥èµ„æ€»é¢å…ƒç´ ');
          }
          
          // è·å–å½“å‰é€‰æ‹©çš„å¹´æœˆ
          const yearSelect = document.getElementById('year-select');
          const monthSelect = document.getElementById('month-select');
          
          if (!yearSelect || !monthSelect) {
            console.error('æœªæ‰¾åˆ°å¹´æœˆé€‰æ‹©å™¨');
            return;
          }
          
          const selectedYear = yearSelect.value;
          const selectedMonth = monthSelect.value;
          
          console.log(`å½“å‰é€‰æ‹©çš„å¹´æœˆ: ${selectedYear}-${selectedMonth}`);
          
          // è®¡ç®—å¹¶æ›´æ–°ä¸Šæœˆå·¥èµ„æ€»é¢
          const lastMonthElement = document.getElementById('last-month');
          if (lastMonthElement) {
            const lastMonthTotal = extractPreviousMonthTotal(selectedYear, selectedMonth);
            lastMonthElement.textContent = lastMonthTotal.toFixed(2);
            console.log(`æˆåŠŸæ›´æ–°ä¸Šæœˆå·¥èµ„æ€»é¢: ${lastMonthTotal.toFixed(2)}`);
          } else {
            console.warn('æœªæ‰¾åˆ°ä¸Šæœˆå·¥èµ„æ€»é¢å…ƒç´ ');
          }
          
          // è®¡ç®—å¹¶æ›´æ–°æœ¬å¹´å·¥èµ„æ€»é¢
          const yearTotalElement = document.getElementById('year-total');
          if (yearTotalElement) {
            const yearTotal = extractCurrentYearTotal(selectedYear);
            yearTotalElement.textContent = yearTotal.toFixed(2);
            console.log(`æˆåŠŸæ›´æ–°æœ¬å¹´å·¥èµ„æ€»é¢: ${yearTotal.toFixed(2)}`);
          } else {
            console.warn('æœªæ‰¾åˆ°æœ¬å¹´å·¥èµ„æ€»é¢å…ƒç´ ');
          }
          
          // è®¡ç®—å¹¶æ›´æ–°å»å¹´å·¥èµ„æ€»é¢
          const lastYearElement = document.getElementById('last-year');
          if (lastYearElement) {
            const lastYearTotal = extractLastYearTotal(selectedYear);
            lastYearElement.textContent = lastYearTotal.toFixed(2);
            console.log(`æˆåŠŸæ›´æ–°å»å¹´å·¥èµ„æ€»é¢: ${lastYearTotal.toFixed(2)}`);
          } else {
            console.warn('æœªæ‰¾åˆ°å»å¹´å·¥èµ„æ€»é¢å…ƒç´ ');
          }
        } catch (error) {
          console.error('æ›´æ–°ç»Ÿè®¡å¡ç‰‡æ•°æ®æ—¶å‡ºé”™:', error);
        }
      }
      
      // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œä¸€æ¬¡è®¡ç®—åˆè®¡ï¼ˆå¦‚æœæœ‰æ•°æ®ï¼‰
      window.addEventListener('load', function() {
        // è¿™é‡Œå¯ä»¥æ£€æŸ¥æ˜¯å¦éœ€è¦åŠ è½½åˆå§‹æ•°æ®
        // calculateAndDisplayTotals();
      });
      </script>
      <table id="wage-detail-table">
        <thead>
          <tr>
            <th>å§“å</th>
            <th>å‡ºå‹¤å¤©æ•°</th>
            <th>è€ƒå‹¤å¥–</th>
            <th>æˆ¿è´´</th>
            <th>å…¶å®ƒè¡¥è´´</th>
            <th>ç”Ÿäº§å·¥èµ„</th>
            <th>åº”å‘å·¥èµ„</th>
          </tr>
        </thead>
        <tbody></tbody>
        <!-- åˆè®¡è¡Œå°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
      </table>
    </div>

    <!-- ========== æ–°å¢å·¥åºæ¨¡æ€æ¡† ========== -->
    <div id="add-process-modal" class="modal">
      <div class="modal-content" style="width: 800px; max-width: 90vw; border-radius: 8px; box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15); border: 1px solid rgba(0, 0, 0, 0.1); background-color: #fff; transform-origin: center; transition: transform 0.3s ease, opacity 0.3s ease;">
        <div class="modal-header" style="padding: 16px 20px; border-bottom: 1px solid #e9ecef; background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%); color: white; border-radius: 8px 8px 0 0;">
          <h3 style="margin: 0; font-size: 18px; font-weight: 600;">æ–°å¢å·¥åº</h3>
          <button class="close-btn" onclick="closeModal('add-process-modal')" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease;">&times;</button>
        </div>
        <div class="modal-body" style="padding: 20px; background-color: #fafbfc;">
          <form id="process-form">
            <!-- ç¬¬ä¸€è¡Œï¼šå·¥åºIDå’Œå·¥åºåç§° -->
            <div style="display: flex; gap: 15px; margin-bottom: 15px;">
              <div style="flex: 1;">
                <label for="process-id" style="display: block; margin-bottom: 5px; font-weight: 500; color: #495057;"><strong>å·¥åºID</strong> <span class="required" style="color: #dc3545;">*</span></label>
                <input type="text" id="process-id" placeholder="è‡ªåŠ¨ç”Ÿæˆ" required style="width: 100%; padding: 10px 12px; border: 2px solid #e9ecef; border-radius: 6px; transition: border-color 0.3s ease, box-shadow 0.3s ease; font-size: 14px;">
              </div>
              <div style="flex: 2;">
                <label for="process-name" style="display: block; margin-bottom: 5px; font-weight: 500; color: #495057;"><strong>å·¥åºåç§°</strong> <span class="required" style="color: #dc3545;">*</span></label>
                <input type="text" id="process-name" placeholder="è¯·è¾“å…¥å·¥åºåç§°" required style="width: 100%; padding: 10px 12px; border: 2px solid #e9ecef; border-radius: 6px; transition: border-color 0.3s ease, box-shadow 0.3s ease; font-size: 14px;">
              </div>
            </div>
            
            <!-- ç¬¬äºŒè¡Œï¼šè®¡ä»¶å•ä»·ã€è®¡æ—¶å•ä»·å’Œå®šé¢æ•°é‡ -->
            <div style="display: flex; gap: 15px; margin-bottom: 15px;">
              <div style="flex: 0.8;">
                <label for="process-piece-rate" style="display: block; margin-bottom: 5px; font-weight: 500; color: #495057;">è®¡ä»¶å•ä»·</label>
                <div style="display: flex; align-items: stretch;">
                  <input type="text" id="process-piece-rate" placeholder="0.00" value="0" style="width: 80px; padding: 10px 12px; border: 2px solid #e9ecef; border-radius: 6px 0 0 6px; border-right: none; transition: border-color 0.3s ease; font-size: 14px; appearance: none; -moz-appearance: textfield; box-sizing: border-box;">
                  <span style="padding: 10px 12px; background-color: #f8f9fa; border: 2px solid #e9ecef; border-radius: 0 6px 6px 0; border-left: none; font-size: 14px; display: flex; align-items: center; box-sizing: border-box; white-space: nowrap;">å…ƒ/ä»¶</span>
                </div>
              </div>
              <div style="flex: 0.8;">
                <label for="process-time-rate" style="display: block; margin-bottom: 5px; font-weight: 500; color: #495057;">è®¡æ—¶å•ä»·</label>
                <div style="display: flex; align-items: stretch; height: 40px;">
                  <input type="text" id="process-time-rate" placeholder="0.00" style="width: 80px; padding: 10px 12px; border: 2px solid #e9ecef; border-radius: 6px 0 0 6px; border-right: none; transition: border-color 0.3s ease; font-size: 14px; appearance: none; -moz-appearance: textfield; box-sizing: border-box; height: 100%;">
                  <span style="padding: 0 12px; background-color: #f8f9fa; border: 2px solid #e9ecef; border-radius: 0 6px 6px 0; border-left: none; font-size: 14px; display: flex; align-items: center; box-sizing: border-box; height: 100%; white-space: nowrap;">å…ƒ/å°æ—¶</span>
                </div>
              </div>
              <div style="flex: 1.4;">
                <label for="process-quota" style="display: block; margin-bottom: 5px; font-weight: 500; color: #495057;">å®šé¢æ•°é‡</label>
                <input type="number" id="process-quota" placeholder="0" min="0" step="1" value="0" style="width: 100%; padding: 10px 12px; border: 2px solid #e9ecef; border-radius: 6px; transition: border-color 0.3s ease, box-shadow 0.3s ease; font-size: 14px;">
              </div>
            </div>
            
            <!-- ç¬¬ä¸‰è¡Œï¼šå¤‡æ³¨ -->
            <div style="margin-bottom: 20px;">
              <label for="process-note" style="display: block; margin-bottom: 5px; font-weight: 500; color: #495057;">å¤‡æ³¨ä¿¡æ¯</label>
              <textarea id="process-note" placeholder="è¯·è¾“å…¥è¡¥å……è¯´æ˜" rows="3" style="width: 100%; padding: 10px 12px; border: 2px solid #e9ecef; border-radius: 6px; transition: border-color 0.3s ease, box-shadow 0.3s ease; font-size: 14px; resize: vertical;"></textarea>
            </div>
            
          </form>
        </div>
        <!-- é‡æ–°è®¾è®¡çš„æŒ‰é’®åŒºåŸŸï¼Œç§»è‡³æ¨¡æ€æ¡†åº•éƒ¨ -->
        <div class="modal-footer" style="display: flex; justify-content: flex-end; padding: 15px 20px; border-top: 1px solid #e9ecef; background-color: #f8f9fa; border-radius: 0 0 8px 8px; box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.5); gap: 12px;">
          <button type="button" class="button default" onclick="closeModal('add-process-modal')" style="padding: 10px 20px; cursor: pointer; border: none; background-color: #6c757d; color: white; border-radius: 6px; font-size: 14px; font-weight: 500; transition: all 0.3s ease, transform 0.2s; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);">
            <i class="fas fa-times"></i> å–æ¶ˆ
          </button>
          <button type="button" class="button primary" onclick="document.getElementById('process-form').dispatchEvent(new Event('submit'))" style="padding: 10px 20px; cursor: pointer; border: none; background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%); color: white; border-radius: 6px; font-size: 14px; font-weight: 500; transition: all 0.3s ease, transform 0.2s; box-shadow: 0 4px 10px rgba(76, 175, 80, 0.3);">
            <i class="fas fa-save"></i> ä¿å­˜å·¥åº
          </button>
        </div>
      </div>
    </div>

    <!-- ========== å¤šè§’åº¦æŸ¥è¯¢ ========== -->
    <div id="multisearch" class="page hidden">
      <h1 class="page-title"><i class="fas fa-search"></i> å¤šè§’åº¦æŸ¥è¯¢</h1>
      <div class="toolbar">
        <label><input type="radio" name="query-type" value="emp" checked> æŒ‰ã€å‘˜å·¥ã€‘</label>
        <label><input type="radio" name="query-type" value="proc"> æŒ‰ã€å·¥åºã€‘</label>
        <input type="text" id="multi-dim" placeholder="è¯·è¾“å…¥æŸ¥è¯¢å†…å®¹"/>
        <input type="date" value="2025-12-01"/> è‡³ <input type="date" value="2026-01-31"/>
        <button class="button primary" id="multisearch-query-btn"><i class="fas fa-search"></i> æŸ¥è¯¢</button>
        <button class="button default" id="multisearch-reset-btn"><i class="fas fa-undo"></i> é‡ç½®</button>
      </div>
      <table>
        <thead>
          <tr>
            <th>æ—¥æœŸ</th>
            <th>å§“å</th>
            <th>å·¥åºåç§°</th>
            <th>å·¥ç§</th>
            <th>å•ä»·</th>
            <th>æ•°é‡</th>
            <th>è€ƒå‹¤å¥–</th>
            <th>æˆ¿è´´</th>
            <th>å…¶å®ƒè¡¥è´´</th>
            <th>é‡‘é¢</th>
            <th>å¤‡æ³¨</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
    </div>

    <!-- ========== å¤‡å¿˜å½• ========== -->
    <div id="memo" class="page hidden">
      <h1 class="page-title"><i class="fas fa-sticky-note"></i> å¤‡å¿˜å½•</h1>
      
      <!-- å¤‡å¿˜å½•æœç´¢ -->
      <div style="margin-bottom: 15px;">
        <input type="text" id="memo-search" placeholder="æœç´¢å¤‡å¿˜å½•ï¼ˆæ ‡é¢˜æˆ–å†…å®¹ï¼‰" style="min-width: 200px; width: 100%; max-width: 600px; padding: 8px 12px; border: 2px solid #e9ecef; border-radius: 6px; font-size: 14px;">
      </div>
      
      <!-- å¤‡å¿˜å½•è¡¨å• -->
      <div class="toolbar" style="display: flex; flex-direction: column; align-items: flex-start; gap: 10px;">
        <input type="text" id="memo-title" placeholder="å¤‡å¿˜å½•æ ‡é¢˜" style="min-width: 200px; width: 100%; max-width: 600px;">
        <textarea id="memo-content" placeholder="å¤‡å¿˜å½•å†…å®¹" rows="3" style="min-width: 300px; width: 100%; max-width: 800px;"></textarea>
        <button class="button success" id="add-memo-btn"><i class="fas fa-plus"></i> æ·»åŠ å¤‡å¿˜å½•</button>
      </div>
      
      <!-- å¤‡å¿˜å½•åˆ—è¡¨ -->
      <div id="memo-list" style="margin-top: 20px;">
        <!-- å¤‡å¿˜å½•å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
      </div>
    </div>

    <!-- ========== å½•å…¥å·¥åºæ¨¡æ€æ¡† ========== -->
    <div id="process-entry-modal" class="modal" style="display: none;">
      <div class="modal-content" style="background-color: #fff; border-radius: 8px; max-width: 1200px; width: 98%; margin: 20px auto; box-shadow: 0 10px 30px rgba(0,0,0,0.1); max-height: 90vh; overflow-y: auto;">
        <div class="modal-header" style="background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 15px 20px; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center;">
          <h3 style="margin: 0; font-size: 1.2rem; font-weight: 600;">å½•å…¥å·¥åº</h3>
          <button id="close-process-entry-modal" class="modal-close" onclick="closeProcessEntryModal()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">&times;</button>
        </div>
        
        <div class="modal-body" style="padding: 20px;">
          <form id="process-entry-form">
            <input type="hidden" id="entry-employee-code">
            
            <!-- åŸºæœ¬ä¿¡æ¯éƒ¨åˆ† -->
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
              <div>
                <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333; font-size: 0.9rem;">æ—¥æœŸ <span style="color: #28a745;">*</span></label>
                <input type="date" id="entry-date" required style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; transition: border-color 0.3s;">
              </div>
              
              <div>
                <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333; font-size: 0.9rem;">å§“å <span style="color: #28a745;">*</span></label>
                <input type="text" id="entry-employee-name" readonly style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; background-color: #f8f9fa;">
              </div>
              
              <div style="position: relative;">
                <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333; font-size: 0.9rem;">å®¢æˆ·</label>
                <input type="text" id="entry-client" style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;">
                <div id="client-dropdown" class="autocomplete-dropdown" style="display: none; position: absolute; z-index: 1000; width: 100%; max-height: 200px; overflow-y: auto; background: white; border: 1px solid #ddd; border-top: none; border-radius: 0 0 4px 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"></div>
              </div>
              
              <div style="position: relative;">
                <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333; font-size: 0.9rem;">è®¢å•å·</label>
                <input type="text" id="entry-order-number" style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;">
                <div id="order-dropdown" class="autocomplete-dropdown" style="display: none; position: absolute; z-index: 1000; width: 100%; max-height: 200px; overflow-y: auto; background: white; border: 1px solid #ddd; border-top: none; border-radius: 0 0 4px 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"></div>
              </div>
            </div>
            
            <div style="margin-bottom: 20px;">
              <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333; font-size: 0.9rem;">å¤‡æ³¨</label>
              <textarea id="entry-remark" rows="2" style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; resize: vertical;"></textarea>
            </div>
            
            <!-- å·¥åºä¿¡æ¯éƒ¨åˆ† -->
            <div style="margin-bottom: 20px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0;">
                <h4 style="margin: 0; font-size: 1rem; font-weight: 600; color: #333;">å·¥åºä¿¡æ¯</h4>
                <button type="button" id="add-process-btn" class="button success" style="padding: 6px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; background-color: #28a745; color: white; transition: background-color 0.3s; display: flex; align-items: center; gap: 5px;">
                  <i class="fas fa-plus"></i> æ·»åŠ å·¥åº
                </button>
              </div>
              
              <!-- å·¥åºè¡¨å•æ ‡é¢˜è¡Œ - ä½¿ç”¨è“è‰²èƒŒæ™¯ -->
              <div style="background-color: #17a2b8; color: white; padding: 12px 12px; border-radius: 6px 6px 0 0; font-weight: 600; display: grid; grid-template-columns: 2fr 1.5fr 1fr 1fr 1fr 1fr 1fr 1fr auto; gap: 15px;">
                <div style="padding-left: 12px; text-align: left;">å·¥åº <span style="color: #ffd700;">*</span></div>
                <div style="padding-left: 12px; text-align: left;">å·¥ç§ <span style="color: #ffd700;">*</span></div>
                <div style="padding-left: 12px; text-align: left;">æ•°é‡ <span style="color: #ffd700;">*</span></div>
                <div style="padding-left: 12px; text-align: left;">å•ä»· <span style="color: #ffd700;">*</span></div>
                <div style="padding-left: 12px; text-align: left;">è€ƒå‹¤å¥–</div>
                <div style="padding-left: 12px; text-align: left;">æˆ¿è´´</div>
                <div style="padding-left: 12px; text-align: left;">å…¶å®ƒè¡¥è´´</div>
                <div style="padding-left: 12px; text-align: left;">åˆè®¡</div>
                <div style="padding-left: 12px; text-align: left;">æ“ä½œ</div>
              </div>
              
              <!-- å·¥åºè¡¨å•å®¹å™¨ -->
              <div id="process-forms-container" style="border: 1px solid #ddd; border-radius: 0 0 6px 6px; border-top: none;">
                <!-- ç¬¬ä¸€è¡Œå·¥åºè¡¨å• -->
                <div class="process-form-row" data-index="0" style="padding: 15px; border-bottom: 1px solid #eee; display: grid; grid-template-columns: 2fr 1.5fr 1fr 1fr 1fr 1fr 1fr 1fr; gap: 10px; align-items: end;">
                  <div style="position: relative;">
                    <input type="text" class="process-name" required style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; background-color: white; min-width: 120px;">
                    <div class="process-dropdown" style="display: none; position: absolute; z-index: 1000; width: 100%; max-height: 200px; overflow-y: auto; background: white; border: 1px solid #ddd; border-top: none; border-radius: 0 0 4px 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"></div>
                  </div>
                  
                  <div>
                    <select class="work-type" required style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; background-color: white; min-width: 100px;">
                      <option value="">è¯·é€‰æ‹©å·¥ç§</option>
                      <!-- å·¥ç§é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                    </select>
                  </div>
                  
                  <div>
                    <input type="number" class="quantity" step="1" min="1" required style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; min-width: 80px;">
                  </div>
                  
                  <div>
                    <div style="position: relative;">
                      <input type="number" class="piece-rate" step="0.01" min="0" required style="width: 100%; padding: 8px 35px 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; min-width: 80px;">
                      <span class="unit-label" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #666; font-size: 0.85rem;">å…ƒ</span>
                    </div>
                  </div>
                  
                  <div>
                    <div style="position: relative;">
                      <input type="number" class="attendance-bonus" step="0.01" min="0" value="0" style="width: 100%; padding: 8px 35px 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; min-width: 80px;">
                      <span style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #666; font-size: 0.85rem;">å…ƒ</span>
                    </div>
                  </div>
                  
                  <div>
                    <div style="position: relative;">
                      <input type="number" class="housing-allowance" step="0.01" min="0" value="0" style="width: 100%; padding: 8px 35px 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; min-width: 80px;">
                      <span style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #666; font-size: 0.85rem;">å…ƒ</span>
                    </div>
                  </div>
                  
                  <div>
                    <div style="position: relative;">
                      <input type="number" class="other-subsidy" step="0.01" min="0" value="0" style="width: 100%; padding: 8px 35px 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; min-width: 80px;">
                      <span style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #666; font-size: 0.85rem;">å…ƒ</span>
                    </div>
                  </div>
                  
                  <div>
                    <input type="number" class="total-amount" readonly style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; background-color: #f8f9fa; color: #28a745; font-weight: 600; min-width: 100px;">
                  </div>
                </div>
                <!-- åŠ¨æ€æ·»åŠ çš„å·¥åºè¡¨å•è¡Œå°†åœ¨è¿™é‡Œ -->
              </div>
            </div>
            

            
            <!-- æ±‡æ€»åˆè®¡ -->
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; padding: 15px; background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: 6px;">
              <span style="font-weight: bold; color: #495057; font-size: 1rem;">æ±‡æ€»åˆè®¡ï¼š</span>
              <span id="total-summary-amount" style="font-weight: bold; color: #dc3545; font-size: 1.2rem;">Â¥0.00</span>
            </div>
            
            <!-- æ“ä½œæŒ‰é’® -->
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
              <button type="button" id="clear-process-list" class="button default" style="padding: 8px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; background-color: #6c757d; color: white; transition: background-color 0.3s;">æ¸…ç©ºåˆ—è¡¨</button>
              <button type="button" id="cancel-process-entry" class="button default" onclick="closeModal('process-entry-modal')" style="padding: 8px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; background-color: #6c757d; color: white; transition: background-color 0.3s;">å–æ¶ˆ</button>
              <button type="button" id="batch-save-processes" class="button primary" style="padding: 8px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; background-color: #28a745; color: white; transition: background-color 0.3s;">æ‰¹é‡ä¿å­˜</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <!-- ========== å½•å…¥å·¥åºæ¨¡æ€æ¡†ç»“æŸ ========== -->





    <!-- ========== å¼¹çª—ï¼šæ–°å¢è®¢å• ========== -->
    <div class="modal" id="add-order-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3><i class="fas fa-file-invoice"></i> æ–°å¢è®¢å•</h3>
          <span class="close-btn" onclick="closeModal('add-order-modal')">&times;</span>
        </div>
        <form id="order-form">
          <!-- ç¬¬ä¸€è¡Œï¼šè®¢å•å·å’Œå®¢æˆ· -->
          <div class="form-row" style="display:flex; gap:15px; flex-wrap:wrap; margin-bottom:15px;">
            <div class="form-group" style="flex:1; min-width:150px;">
              <label><i class="fas fa-hashtag"></i> è®¢å•å· <span style="color:red;">*</span></label>
              <input type="text" class="form-control" id="order-number" placeholder="è¯·è¾“å…¥è®¢å•å·" required>
            </div>
            <div class="form-group" style="flex:1; min-width:150px; position:relative;">
              <label><i class="fas fa-user-tie"></i> å®¢æˆ· <span style="color:red;">*</span></label>
              <input type="text" class="form-control" id="order-customer" placeholder="è¯·è¾“å…¥å®¢æˆ·åç§°" required>
              <div id="customer-suggestions" class="suggestions-list" style="position:absolute; top:100%; left:0; width:100%; max-height:200px; overflow-y:auto; background-color:#fff; border:1px solid #ddd; border-top:none; z-index:1000; display:none;"></div>
            </div>
          </div>
          
          <!-- ç¬¬äºŒè¡Œï¼šäº§å“åç§°å’Œè®¢å•æ•°é‡ -->
          <div class="form-row" style="display:flex; gap:15px; flex-wrap:wrap; margin-bottom:15px;">
            <div class="form-group" style="flex:1; min-width:150px;">
              <label><i class="fas fa-box"></i> äº§å“åç§° <span style="color:red;">*</span></label>
              <select class="form-control" id="order-product" required>
                <option value="">è¯·é€‰æ‹©äº§å“åç§°</option>
                <option value="æ§½é’¢ç‚‰æ¶">æ§½é’¢ç‚‰æ¶</option>
                <option value="æ§½é’¢å¸¦è½´ç‚‰æ¶">æ§½é’¢å¸¦è½´ç‚‰æ¶</option>
                <option value="æ‰ä¸ç‚‰æ¶">æ‰ä¸ç‚‰æ¶</option>
                <option value="æ‰ä¸å¸¦è½´ç‚‰æ¶">æ‰ä¸å¸¦è½´ç‚‰æ¶</option>
                <option value="è¿ä½“ç‚‰æ¶">è¿ä½“ç‚‰æ¶</option>
                <option value="ç®¡å­ç‚‰æ¶">ç®¡å­ç‚‰æ¶</option>
                <option value="ç‰¹æ®Šç‚‰æ¶">ç‰¹æ®Šç‚‰æ¶</option>
              </select>
            </div>
            <div class="form-group" style="flex:1; min-width:150px;">
              <label><i class="fas fa-calculator"></i> è®¢å•æ•°é‡ <span style="color:red;">*</span></label>
              <input type="number" class="form-control" id="order-quantity" placeholder="è¯·è¾“å…¥è®¢å•æ•°é‡" required min="1">
            </div>
          </div>
          <div class="form-row" style="display:flex; gap:15px; flex-wrap:wrap;">
            <div class="form-group" style="flex:1; min-width:200px;">
              <label><i class="fas fa-calendar-check"></i> è®¢å•æ—¥æœŸ <span style="color:red;">*</span></label>
              <input type="date" class="form-control" id="order-date" required>
            </div>
            <div class="form-group" style="flex:1; min-width:200px;">
              <label><i class="fas fa-truck-fast"></i> å‡ºè´§æ—¥æœŸ <span style="color:red;">*</span></label>
              <input type="date" class="form-control" id="delivery-date" required>
            </div>
          </div>
          <div class="form-group">
            <label><i class="fas fa-sticky-note"></i> å¤‡æ³¨</label>
            <textarea class="form-control" id="order-note" rows="3" placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯"></textarea>
          </div>
          <div class="form-actions" style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
            <button type="button" class="button default" onclick="closeModal('add-order-modal')">å–æ¶ˆ</button>
            <button type="submit" class="button primary">ä¿å­˜è®¢å•</button>
          </div>
        </form>
      </div>
    </div>

    <!-- ========== å¼¹çª—ï¼šæ–°å¢å‘˜å·¥ ========== -->
    <div class="modal" id="add-employee-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3><i class="fas fa-user-plus"></i> æ–°å¢å‘˜å·¥</h3>
          <span class="close-btn" onclick="closeModal('add-employee-modal')">&times;</span>
        </div>
        <form id="employee-form">
          <!-- ç¬¬ä¸€è¡Œï¼šå·¥å·å’Œå§“å -->
          <div class="form-row" style="display:flex; gap:15px; margin-bottom:15px;">
            <div class="form-group" style="flex:1;">
              <label><i class="fas fa-id-card"></i> å·¥å· <span style="color:red;">*</span></label>
              <input type="text" class="form-control" id="emp-code" placeholder="è¯·è¾“å…¥å·¥å·" disabled required>
            </div>
            <div class="form-group" style="flex:1;">
              <label><i class="fas fa-user"></i> å§“å <span style="color:red;">*</span></label>
              <input type="text" class="form-control" id="emp-name" placeholder="è¯·è¾“å…¥å§“å" required>
            </div>
          </div>
          
          <!-- ç¬¬äºŒè¡Œï¼šæ‰‹æœºå’Œèº«ä»½è¯å· -->
          <div class="form-row" style="display:flex; gap:15px; margin-bottom:15px;">
            <div class="form-group" style="flex:1;">
              <label><i class="fas fa-phone"></i> æ‰‹æœº</label>
              <input type="tel" class="form-control" id="emp-phone" placeholder="è¯·è¾“å…¥æ‰‹æœºå·ç ">
            </div>
            <div class="form-group" style="flex:1;">
              <label><i class="fas fa-id-card-alt"></i> èº«ä»½è¯å·</label>
              <input type="text" class="form-control" id="emp-idcard" placeholder="è¯·è¾“å…¥èº«ä»½è¯å·">
            </div>
          </div>
          
          <!-- ç¬¬ä¸‰è¡Œï¼šå…¥èŒæ—¥æœŸå’Œç¦»èŒæ—¥æœŸ -->
          <div class="form-row" style="display:flex; gap:15px; margin-bottom:15px;">
            <div class="form-group" style="flex:1;">
              <label><i class="fas fa-calendar-plus"></i> å…¥èŒæ—¥æœŸ</label>
              <input type="date" class="form-control" id="emp-joindate">
            </div>
            <div class="form-group" style="flex:1;">
              <label><i class="fas fa-calendar-minus"></i> ç¦»èŒæ—¥æœŸ</label>
              <input type="date" class="form-control" id="emp-leavedate">
            </div>
          </div>
          
          <!-- ç¬¬å››è¡Œï¼šæ‰€å±å…¬å¸ã€æ‰€å±éƒ¨é—¨å’ŒèŒä½ -->
          <div class="form-row" style="display:flex; gap:15px; margin-bottom:15px;">
            <div class="form-group" style="flex:1;">
              <label><i class="fas fa-building"></i> æ‰€å±å…¬å¸ <span style="color:red;">*</span></label>
              <select class="form-control" id="emp-company" required onchange="generateEmpCode()">
                <option value="">è¯·é€‰æ‹©å…¬å¸</option>
                <option value="æ™®åˆ©ç¾å¸¸å·">æ™®åˆ©ç¾å¸¸å·</option>
                <option value="æ— é”¡é¾™åŠ›">æ— é”¡é¾™åŠ›</option>
                <option value="æ™®åˆ©ç¾åŠ³åŠ¡æ´¾é£">æ™®åˆ©ç¾åŠ³åŠ¡æ´¾é£</option>
                <option value="å¤–æ¥äºº">å¤–æ¥äºº</option>
              </select>
            </div>
            <div class="form-group" style="flex:1;">
              <label><i class="fas fa-sitemap"></i> æ‰€å±éƒ¨é—¨</label>
              <select class="form-control" id="emp-dept">
                <option value="">è¯·é€‰æ‹©éƒ¨é—¨</option>
                <option value="è¡Œæ”¿éƒ¨">è¡Œæ”¿éƒ¨</option>
                <option value="ç”Ÿäº§éƒ¨">ç”Ÿäº§éƒ¨</option>
                <option value="å¤–æ¥äºº">å¤–æ¥äºº</option>
              </select>
            </div>
            <div class="form-group" style="flex:1;">
              <label><i class="fas fa-briefcase"></i> èŒä½</label>
              <select class="form-control" id="emp-job">
                <option value="">è¯·é€‰æ‹©èŒä½</option>
                <option value="ç”Ÿäº§å‚é•¿">ç”Ÿäº§å‚é•¿</option>
                <option value="æ“ä½œå·¥">æ“ä½œå·¥</option>
                <option value="æ¸…æ´å·¥">æ¸…æ´å·¥</option>
                <option value="å¤–æ¥äºº">å¤–æ¥äºº</option>
              </select>
            </div>
          </div>
          
          <!-- ç¬¬äº”è¡Œï¼šå¼€æˆ·è¡Œå’Œé“¶è¡Œå¡å· -->
          <div class="form-row" style="display:flex; gap:15px; margin-bottom:15px;">
            <div class="form-group" style="flex:1;">
              <label><i class="fas fa-building"></i> å¼€æˆ·è¡Œ</label>
              <input type="text" class="form-control" id="emp-bank" placeholder="è¯·è¾“å…¥å¼€æˆ·è¡Œ">
            </div>
            <div class="form-group" style="flex:1;">
              <label><i class="fas fa-credit-card"></i> é“¶è¡Œå¡å·</label>
              <input type="text" class="form-control" id="emp-card" placeholder="è¯·è¾“å…¥é“¶è¡Œå¡å·">
            </div>
          </div>
          
          <div class="form-group">
            <label><i class="fas fa-sticky-note"></i> å¤‡æ³¨</label>
            <textarea class="form-control" id="emp-note" rows="3" placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯"></textarea>
          </div>
          <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
            <button type="button" class="button default" onclick="closeModal('add-employee-modal')" style="margin-right:10px;">å–æ¶ˆ</button>
            <button type="submit" class="button primary">ä¿å­˜</button>
          </div>
        </form>
      </div>
    </div>

    <!-- ========== å¼¹çª—ï¼šå¯¼å…¥å‘˜å·¥æ–‡ä»¶ ========== -->
    <div class="modal" id="import-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3><i class="fas fa-file-import"></i> å¯¼å…¥å‘˜å·¥ä¿¡æ¯</h3>
          <span class="close-btn" onclick="closeModal('import-modal')">&times;</span>
        </div>
        <p>è¯·ä¸Šä¼  CSV æ–‡ä»¶ï¼ˆæ¨¡æ¿å­—æ®µï¼šå·¥å·,å§“å,æ‰‹æœº,èº«ä»½è¯,å…¥èŒæ—¥æœŸ,ç¦»èŒæ—¥æœŸ,å…¬å¸,éƒ¨é—¨,èŒä½,å¼€æˆ·è¡Œ,å¡å·,å¤‡æ³¨ï¼‰</p>
        <div class="upload-area" id="drop-zone">
          <i class="fas fa-cloud-upload-alt" style="font-size:3em;"></i>
          <p>æ‹–æ‹½æ–‡ä»¶åˆ°è¿™é‡Œï¼Œæˆ–ç‚¹å‡»é€‰æ‹©</p>
          <input type="file" id="file-input" accept=".csv" style="display:none;">
        </div>
        <button class="button default" onclick="closeModal('import-modal')">å–æ¶ˆ</button>
      </div>
    </div>

  </div>

  <!-- ========= JavaScript æ•°æ®ä¸é€»è¾‘ ========= -->
  <script>
    // æ¨¡æ‹Ÿæ•°æ®
    let employees = [
      { id: 1, code: '00123', name: 'å¼ ä¸‰', phone: '138****1234', idCard: '330***********', joinDate: '2022-03-01', leaveDate: '', company: 'Aæœ‰é™å…¬å¸', dept: 'ç”Ÿäº§éƒ¨', job: 'ç„Šå·¥', bankName: 'å·¥å•†é“¶è¡ŒXXæ”¯è¡Œ', bankAccount: '6222******123', remark: 'ç†Ÿç»ƒå·¥', status: 'active' },
      { id: 2, code: '00124', name: 'æå››', phone: '139****5678', idCard: '330***********', joinDate: '2021-06-10', leaveDate: '', company: 'Bæœ‰é™å…¬å¸', dept: 'è´¨æ£€éƒ¨', job: 'æ£€éªŒå‘˜', bankName: 'å»ºè®¾é“¶è¡Œ', bankAccount: '6222******456', remark: '', status: 'active' },
      { id: 3, code: '00125', name: 'ç‹äº”', phone: '137****9012', idCard: '330***********', joinDate: '2020-01-05', leaveDate: '2023-12-31', company: 'Aæœ‰é™å…¬å¸', dept: 'ç”Ÿäº§éƒ¨', job: 'æ‰“ç£¨å·¥', bankName: '', bankAccount: '', remark: 'å·²ç¦»èŒ', status: 'inactive' }
    ];

    let pieceworkData = [];
    let orderData = [];
    // å·¥åºåˆ—è¡¨ - ä»localStorageåŠ è½½çœŸå®æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨ç©ºæ•°ç»„
    let processList = [];
    const storedProcesses = JSON.parse(localStorage.getItem('savedProcessData'));
    if (storedProcesses && Array.isArray(storedProcesses)) {
      processList = storedProcesses;
    }

    // åˆå§‹åŒ–
    window.onload = function() {
      // ä»localStorageåŠ è½½å‘˜å·¥æ•°æ®
      const storedEmployees = JSON.parse(localStorage.getItem('employees'));
      if (storedEmployees && Array.isArray(storedEmployees)) {
        // åªè¦localStorageä¸­æœ‰employeesä¸”æ˜¯æ•°ç»„ï¼Œå°±ä½¿ç”¨å®ƒï¼ˆåŒ…æ‹¬ç©ºæ•°ç»„ï¼‰
        employees = storedEmployees;
      }
      
      setupEventListeners();
      renderEmployees();
      renderPiecework();
      renderOrders();
      renderProcesses();
      
      // ç»‘å®šå·¥åºå½•å…¥è¡¨å•æäº¤äº‹ä»¶
      document.getElementById('process-entry-form')?.addEventListener('submit', saveProcessEntry);
      
      // ç¡®ä¿é¡µé¢åŠ è½½å®Œæˆåå§‹ç»ˆæ˜¾ç¤ºä¸€ä¸ªé»˜è®¤é¡µé¢
      const visiblePage = document.querySelector('.page:not(.hidden)');
      if (!visiblePage) {
        // é»˜è®¤æ˜¾ç¤ºå‘˜å·¥ç®¡ç†é¡µé¢
        document.querySelectorAll('.page').forEach(page => page.classList.add('hidden'));
        document.getElementById('employee').classList.remove('hidden');
        
        // æ›´æ–°èœå•é¡¹çš„activeçŠ¶æ€
        document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
        document.querySelector(`[data-page="employee"]`).classList.add('active');
      }
    };

    // å½“å‰ç¼–è¾‘çš„å‘˜å·¥IDï¼ˆåœ¨å…¨å±€ä½œç”¨åŸŸå¯ç”¨ï¼‰
     window.currentEditEmpCode = null;

    // æ˜¾ç¤ºå½•å…¥å·¥åºæ¨¡æ€æ¡†
    function showProcessEntryModal(employeeCode) {
      // è·å–å‘˜å·¥ä¿¡æ¯
      const employees = JSON.parse(localStorage.getItem('employees') || '[]');
      const employee = employees.find(emp => emp.code === employeeCode);
      
      // æ£€æŸ¥å‘˜å·¥æ˜¯å¦ä¸ºç¦»èŒçŠ¶æ€
      if (employee && employee.status === 'inactive') {
        alert('ç¦»èŒå‘˜å·¥ä¸èƒ½å·¥ä½œ');
        return; // é˜»æ­¢åç»­ä»£ç æ‰§è¡Œï¼Œä¸æ‰“å¼€æ¨¡æ€æ¡†
      }
      
      // é‡ç½®å·¥åºè¡¨å•å®¹å™¨
      const processContainer = document.getElementById('process-forms-container');
      processContainer.innerHTML = '';
      addNewProcessRow(); // æ·»åŠ ä¸€è¡Œç©ºç™½å·¥åº
      
      // è®¾ç½®å½“å‰æ—¥æœŸä¸ºé»˜è®¤æ—¥æœŸ
      const dateInput = document.getElementById('entry-date');
      dateInput.valueAsDate = new Date();
      
      // æ·»åŠ æ—¥æœŸå˜æ›´äº‹ä»¶ç›‘å¬ï¼Œå½“æ—¥æœŸå˜æ›´æ—¶æ›´æ–°æ‰€æœ‰è¡Œçš„å¥–é‡‘è¾“å…¥æ¡†å¯ç¼–è¾‘çŠ¶æ€
      // å…ˆç§»é™¤å¯èƒ½å­˜åœ¨çš„äº‹ä»¶ç›‘å¬å™¨ï¼Œé¿å…é‡å¤æ·»åŠ 
      dateInput.onchange = null;
      dateInput.onchange = function() {
        const rows = document.querySelectorAll('.process-form-row');
        rows.forEach(row => {
          setBonusInputsEditableState(row);
        });
      };
      
      // é‡æ–°è·å–å‘˜å·¥ä¿¡æ¯ï¼ˆç¡®ä¿ä»£ç é€»è¾‘ä¸€è‡´æ€§ï¼‰
      const updatedEmployees = JSON.parse(localStorage.getItem('employees') || '[]');
      const updatedEmployee = updatedEmployees.find(emp => emp.code === employeeCode);
      
      if (updatedEmployee) {
        document.getElementById('entry-employee-code').value = updatedEmployee.code;
        document.getElementById('entry-employee-name').value = updatedEmployee.name;
      }
      
      // æ¸…ç©ºåŸºæœ¬ä¿¡æ¯
      document.getElementById('entry-client').value = '';
      document.getElementById('entry-order-number').value = '';
      document.getElementById('entry-remark').value = '';
      
      // é‡ç½®å·¥åºè¡¨å•å®¹å™¨ï¼Œåªä¿ç•™ç¬¬ä¸€è¡Œ
      const container = document.getElementById('process-forms-container');
      container.innerHTML = '';
      addNewProcessRow();
      
      // åˆå§‹åŒ–è‡ªåŠ¨å®ŒæˆåŠŸèƒ½
      initAutocomplete();
      
      // å¡«å……å·¥åºå’Œå·¥ç§é€‰é¡¹
      populateAllProcessOptions();
      populateAllWorkTypeOptions();
      
      // ç»‘å®šäº‹ä»¶ç›‘å¬
      bindProcessFormEvents();
      
      // æ˜¾ç¤ºæ¨¡æ€æ¡†
      const processModal = document.getElementById('process-entry-modal');
      processModal.setAttribute('style', 'display: flex !important; justify-content: center; align-items: center; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000;');
    }
    
    // ä¸ºæ‰€æœ‰å·¥åºè¡¨å•è¡Œåˆå§‹åŒ–å·¥åºè‡ªåŠ¨å®ŒæˆåŠŸèƒ½
    function populateAllProcessOptions() {
      const processInputs = document.querySelectorAll('.process-name');
      
      processInputs.forEach((input, index) => {
        // åˆå§‹åŒ–æ¯ä¸ªå·¥åºè¾“å…¥æ¡†çš„è‡ªåŠ¨å®ŒæˆåŠŸèƒ½
        initProcessAutocomplete(input, index);
      });
    }
    
    // åˆå§‹åŒ–å·¥åºè¾“å…¥æ¡†çš„è‡ªåŠ¨å®ŒæˆåŠŸèƒ½
    function initProcessAutocomplete(inputElement, rowIndex) {
      const dropdown = inputElement.nextElementSibling;
      
      inputElement.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase().trim();
        // ä»å·¥åºç®¡ç†æ¨¡å—è¯»å–æ•°æ®
        const processes = JSON.parse(localStorage.getItem('savedProcessData') || '[]');
        
        // è¿‡æ»¤å·¥åºæ•°æ®ï¼Œç¡®ä¿åç§°å­˜åœ¨ä¸”åŒ…å«æœç´¢è¯
        const filteredProcesses = processes.filter(process => 
          process && process.name && typeof process.name === 'string' && 
          process.name.toLowerCase().includes(searchTerm)
        );
        
        // æ˜¾ç¤ºæˆ–éšè—ä¸‹æ‹‰æ¡†
        if (searchTerm && filteredProcesses.length > 0) {
          // æ¸…ç©ºä¸‹æ‹‰æ¡†
          dropdown.innerHTML = '';
          
          // ç¡®ä¿æ²¡æœ‰é‡å¤çš„å·¥åºåç§°
          const uniqueProcessNames = new Set();
          filteredProcesses.forEach(process => {
            // ç¡®ä¿å·¥åºåç§°å”¯ä¸€
            if (!uniqueProcessNames.has(process.name)) {
              uniqueProcessNames.add(process.name);
              
              const item = document.createElement('div');
              item.textContent = process.name;
              item.style.padding = '8px 12px';
              item.style.cursor = 'pointer';
              item.style.borderBottom = '1px solid #eee';
              item.setAttribute('data-process-id', process.id);
              
              // å­˜å‚¨å·¥åºçš„å®Œæ•´æ•°æ®ï¼Œæ–¹ä¾¿åç»­ä½¿ç”¨
              item.dataset.processData = JSON.stringify(process);
              
              // é¼ æ ‡æ‚¬åœæ•ˆæœ
              item.onmouseover = function() {
                this.style.backgroundColor = '#f8f9fa';
              };
              
              item.onmouseout = function() {
                this.style.backgroundColor = 'transparent';
              };
              
              // ç‚¹å‡»é€‰æ‹©å·¥åº
              item.onclick = function() {
                inputElement.value = process.name;
                dropdown.setAttribute('style', 'display: none !important;');
                
                // è·å–å½“å‰è¡Œ
                const row = inputElement.closest('.process-form-row');
                
                // è§¦å‘å·¥ç§é€‰æ‹©äº‹ä»¶ä»¥æ›´æ–°å•ä»·
                const workTypeSelect = row.querySelector('.work-type');
                if (workTypeSelect && workTypeSelect.value) {
                  // æ›´æ–°å•ä»·
                  updateUnitPrice(row, process, workTypeSelect.value);
                } else {
                  // å¦‚æœæ²¡æœ‰é€‰æ‹©å·¥ç§ï¼Œæ¸…é™¤å•ä»·
                  const rateInput = row.querySelector('.piece-rate');
                  if (rateInput) {
                    rateInput.value = '';
                  }
                }
                
                // é‡æ–°è®¡ç®—åˆè®¡
                calculateRowTotal(row);
              };
              
              dropdown.appendChild(item);
            }
          });
          
          dropdown.setAttribute('style', 'display: block !important;');
        } else {
            dropdown.setAttribute('style', 'display: none !important;');
        }
      });
      
      // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­ä¸‹æ‹‰æ¡†
      document.addEventListener('click', function(event) {
        if (!inputElement.contains(event.target) && !dropdown.contains(event.target)) {
          dropdown.style.display = 'none';
        }
      });
    }
    
    // æ ¹æ®å·¥åºå’Œå·¥ç§è‡ªåŠ¨å¡«å……å•ä»·
    function updateUnitPrice(row, process, workType) {
      if (!row || !process || !workType) return;
      
      const rateInput = row.querySelector('.piece-rate');
      if (!rateInput) return;
      
      // æ ¹æ®å·¥ç§é€‰æ‹©ä¸åŒçš„å•ä»·
      let price = '';
      
      switch (workType) {
        case 'è®¡ä»¶':
          price = process.pieceRate !== undefined ? process.pieceRate : '';
          break;
        case 'è®¡æ—¶':
          price = process.timeRate !== undefined ? process.timeRate : '';
          break;
        case 'å›ºå®š':
          // å›ºå®šå·¥ç§çš„å•ä»·å¯èƒ½æ˜¯ä¸€ä¸ªå›ºå®šå€¼æˆ–ç©º
          price = '';
          break;
        default:
          price = '';
      }
      
      // è®¾ç½®å•ä»·è¾“å…¥æ¡†çš„å€¼
      rateInput.value = price;
      
      // æ›´æ–°å•ä»·å•ä½æ˜¾ç¤º
      updateRowUnitDisplay(row);
      
      // é‡æ–°è®¡ç®—åˆè®¡
      calculateRowTotal(row);
    }
    
    // ä¸ºæ‰€æœ‰å·¥åºè¡¨å•è¡Œå¡«å……å·¥ç§é€‰é¡¹
    function populateAllWorkTypeOptions() {
      const workTypes = ['è®¡ä»¶', 'è®¡æ—¶', 'å›ºå®š'];
      const workTypeSelects = document.querySelectorAll('.work-type');
      
      workTypeSelects.forEach(select => {
        select.innerHTML = '<option value="">è¯·é€‰æ‹©å·¥ç§</option>';
        workTypes.forEach(type => {
          const option = document.createElement('option');
          option.value = type;
          option.textContent = type;
          select.appendChild(option);
        });
      });
    }
    
    // ç»‘å®šå·¥åºè¡¨å•äº‹ä»¶
    function bindProcessFormEvents() {
      // æ·»åŠ å·¥åºæŒ‰é’®ç‚¹å‡»äº‹ä»¶
      document.getElementById('add-process-btn').onclick = addNewProcessRow;
      
      // æ¸…ç©ºåˆ—è¡¨æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      document.getElementById('clear-process-list').onclick = clearProcessList;
      
      // æ‰¹é‡ä¿å­˜æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      document.getElementById('batch-save-processes').onclick = batchSaveProcesses;
      
      // ä¸ºæ‰€æœ‰è¾“å…¥æ¡†ç»‘å®šäº‹ä»¶
      bindEventsToAllRows();
      
      // ä¸ºå·¥ç§é€‰æ‹©æ¡†æ·»åŠ æ”¹å˜äº‹ä»¶ï¼Œå½“é€‰æ‹©æ”¹å˜æ—¶æ›´æ–°å•ä»·
      document.addEventListener('change', function(event) {
        if (event.target.classList.contains('work-type')) {
          const row = event.target.closest('.process-form-row');
          const processInput = row.querySelector('.process-name');
          const workType = event.target.value;
          
          if (processInput && processInput.value.trim()) {
            // ä»localStorageä¸­æŸ¥æ‰¾åŒ¹é…çš„å·¥åºæ•°æ®
            const processes = JSON.parse(localStorage.getItem('savedProcessData') || '[]');
            const processName = processInput.value.trim();
            const matchedProcess = processes.find(p => p && p.name === processName);
            
            if (matchedProcess) {
              updateUnitPrice(row, matchedProcess, workType);
            }
          }
        }
      });
    }
    
    // ä¸ºæ‰€æœ‰å·¥åºè¡Œç»‘å®šäº‹ä»¶
    function bindEventsToAllRows() {
      const rows = document.querySelectorAll('.process-form-row');
      
      rows.forEach(row => {
        // æ•°é‡ã€å•ä»·ç­‰è¾“å…¥å˜åŒ–æ—¶è‡ªåŠ¨è®¡ç®—åˆè®¡
        const quantityInput = row.querySelector('.quantity');
        const rateInput = row.querySelector('.piece-rate');
        const attendanceBonusInput = row.querySelector('.attendance-bonus');
        const housingAllowanceInput = row.querySelector('.housing-allowance');
        const otherSubsidyInput = row.querySelector('.other-subsidy');
        
        [quantityInput, rateInput, attendanceBonusInput, housingAllowanceInput, otherSubsidyInput].forEach(input => {
          if (input) {
            input.oninput = () => calculateRowTotal(row);
          }
        });
        
        // å·¥ç§å˜åŒ–æ—¶æ›´æ–°å•ä»·å•ä½å’Œè¾“å…¥æ¡†å¯ç¼–è¾‘çŠ¶æ€
        const workTypeSelect = row.querySelector('.work-type');
        if (workTypeSelect) {
          workTypeSelect.onchange = function() {
            updateRowUnitDisplay(row);
            toggleInputsByWorkType(row);
            
            // å¦‚æœå·¥åºåç§°å·²å¡«å†™ï¼Œæ›´æ–°å•ä»·
            const processInput = row.querySelector('.process-name');
            if (processInput && processInput.value.trim()) {
              const processes = JSON.parse(localStorage.getItem('savedProcessData') || '[]');
              const processName = processInput.value.trim();
              const matchedProcess = processes.find(p => p && p.name === processName);
              
              if (matchedProcess) {
                updateUnitPrice(row, matchedProcess, this.value);
              }
            }
          };
          
          // åˆå§‹è°ƒç”¨ä¸€æ¬¡ï¼Œç¡®ä¿æ­£ç¡®çš„å¯ç¼–è¾‘çŠ¶æ€
          toggleInputsByWorkType(row);
        }
      });
    }
    
    // è®¡ç®—å•è¡Œå·¥åºåˆè®¡é‡‘é¢
    function calculateRowTotal(row) {
      const workType = row.querySelector('.work-type').value;
      const quantity = parseFloat(row.querySelector('.quantity').value) || 0;
      const rate = parseFloat(row.querySelector('.piece-rate').value) || 0;
      const attendanceBonus = parseFloat(row.querySelector('.attendance-bonus').value) || 0;
      const housingAllowance = parseFloat(row.querySelector('.housing-allowance').value) || 0;
      const otherSubsidy = parseFloat(row.querySelector('.other-subsidy').value) || 0;
      const totalAmountInput = row.querySelector('.total-amount');
      
      // åªæœ‰éå›ºå®šå·¥ç§æ—¶æ‰è®¡ç®—åˆè®¡ï¼Œå›ºå®šå·¥ç§çš„åˆè®¡ç”±ç”¨æˆ·æ‰‹åŠ¨è¾“å…¥
      if (workType !== 'å›ºå®š') {
        let totalAmount = 0;
        
        // æ ¹æ®å·¥ç§ä½¿ç”¨ä¸åŒçš„è®¡ç®—å…¬å¼
        switch (workType) {
          case 'è®¡æ—¶':
            // è®¡æ—¶å·¥ç§ï¼šæ•°é‡ * å•ä»·
            totalAmount = quantity * rate;
            break;
          case 'è®¡ä»¶':
            // è®¡ä»¶å·¥ç§ï¼š(æ•°é‡ - å®šé¢æ•°é‡) * å•ä»· * 1.4 + 90
            // ä»å·¥åºæ•°æ®ä¸­è·å–å®šé¢æ•°é‡
            const processName = row.querySelector('.process-name').value.trim();
            const processes = JSON.parse(localStorage.getItem('savedProcessData') || '[]');
            const process = processes.find(p => p && p.name === processName);
            const quota = process && process.quota ? parseFloat(process.quota) : 0;
            
            totalAmount = (quantity - quota) * rate * 1.4 + 90;
            // ç¡®ä¿åˆè®¡ä¸å°äº0
            totalAmount = Math.max(0, totalAmount);
            break;
          default:
            // å…¶ä»–æƒ…å†µé»˜è®¤è®¡ç®—
            totalAmount = quantity * rate;
        }
        
        // åŠ ä¸Šå„é¡¹è¡¥è´´
        totalAmount += attendanceBonus + housingAllowance + otherSubsidy;
        
        // è®¾ç½®åˆè®¡é‡‘é¢ï¼Œä¿ç•™2ä½å°æ•°
        totalAmountInput.value = totalAmount.toFixed(2);
        
        // æ›´æ–°æ±‡æ€»åˆè®¡
        calculateTotalSummary();
      }
    }
    
    // æ ¹æ®å·¥ç§åˆ‡æ¢è¾“å…¥æ¡†çš„å¯ç¼–è¾‘çŠ¶æ€
    function toggleInputsByWorkType(row) {
      const workType = row.querySelector('.work-type').value;
      const quantityInput = row.querySelector('.quantity');
      const rateInput = row.querySelector('.piece-rate');
      const attendanceBonusInput = row.querySelector('.attendance-bonus');
      const housingAllowanceInput = row.querySelector('.housing-allowance');
      const otherSubsidyInput = row.querySelector('.other-subsidy');
      const totalAmountInput = row.querySelector('.total-amount');
      
      // ç§»é™¤ä¹‹å‰å¯èƒ½å­˜åœ¨çš„äº‹ä»¶ç›‘å¬å™¨ï¼Œé¿å…é‡å¤ç»‘å®š
      if (totalAmountInput) {
        // ä½¿ç”¨äº‹ä»¶å§”æ‰˜æˆ–æ›¿æ¢äº‹ä»¶å¤„ç†å‡½æ•°çš„æ–¹å¼
        const newTotalAmountInput = totalAmountInput.cloneNode(true);
        totalAmountInput.parentNode.replaceChild(newTotalAmountInput, totalAmountInput);
      }
      
      if (workType === 'å›ºå®š') {
          // å›ºå®šå·¥ç§ï¼šæ•°é‡ã€å•ä»·ã€è€ƒå‹¤å¥–ã€æˆ¿è´´ã€å…¶å®ƒè¡¥è´´ä¸å¯ç¼–è¾‘ï¼Œé‡‘é¢å¯ç¼–è¾‘
          if (quantityInput) quantityInput.disabled = true;
          if (rateInput) rateInput.disabled = true;
          if (attendanceBonusInput) attendanceBonusInput.disabled = true;
          if (housingAllowanceInput) housingAllowanceInput.disabled = true;
          if (otherSubsidyInput) otherSubsidyInput.disabled = true;
          
          // ä¸ºå›ºå®šå·¥ç§çš„é‡‘é¢è¾“å…¥æ¡†æ·»åŠ è¾“å…¥äº‹ä»¶
          const newTotalAmountInput = row.querySelector('.total-amount');
          if (newTotalAmountInput) {
            newTotalAmountInput.disabled = false;
            // ç§»é™¤readonlyå±æ€§ç¡®ä¿å¯ç¼–è¾‘
            newTotalAmountInput.removeAttribute('readonly');
            newTotalAmountInput.addEventListener('input', function() {
              // éªŒè¯è¾“å…¥å€¼ä¸ºæœ‰æ•ˆçš„æ•°å­—
              if (this.value !== '' && isNaN(parseFloat(this.value))) {
                this.value = '';
              }
              // æ›´æ–°æ±‡æ€»åˆè®¡
              calculateTotalSummary();
            });
          }
      } else {
        // éå›ºå®šå·¥ç§ï¼šæ•°é‡ã€å•ä»·ã€å…¶å®ƒè¡¥è´´å¯ç¼–è¾‘ï¼Œé‡‘é¢ä¸å¯ç¼–è¾‘
        if (quantityInput) quantityInput.disabled = false;
        if (rateInput) rateInput.disabled = false;
        if (otherSubsidyInput) otherSubsidyInput.disabled = false;
        if (totalAmountInput) totalAmountInput.disabled = true;
        
        // è€ƒå‹¤å¥–å’Œæˆ¿è´´è¾“å…¥æ¡†çš„å¯ç¼–è¾‘çŠ¶æ€ç”±æ—¥æœŸå†³å®šï¼Œé€šè¿‡setBonusInputsEditableStateå‡½æ•°è®¾ç½®
        setBonusInputsEditableState(row);
        
        // é‡æ–°è®¡ç®—åˆè®¡
        calculateRowTotal(row);
      }
    }
    
    // æ›´æ–°å•è¡Œå•ä»·å•ä½æ˜¾ç¤º
    function updateRowUnitDisplay(row) {
      const workType = row.querySelector('.work-type').value;
      const unitLabel = row.querySelector('.unit-label');
      
      if (unitLabel) {
        if (workType === 'è®¡æ—¶') {
          unitLabel.textContent = 'å…ƒ/å°æ—¶';
        } else if (workType === 'å›ºå®š') {
          unitLabel.textContent = 'å…ƒ';
        } else {
          unitLabel.textContent = 'å…ƒ/ä»¶';
        }
      }
    }
    
    // åˆ¤æ–­å½“å‰æ—¥æœŸæ˜¯å¦æ˜¯å½“æœˆæœ€åä¸€å¤©
    function isLastDayOfMonth(date) {
      const currentDay = date.getDate();
      const currentMonth = date.getMonth();
      const currentYear = date.getFullYear();
      // åˆ›å»ºä¸‹ä¸ªæœˆçš„ç¬¬ä¸€å¤©
      const nextMonthFirstDay = new Date(currentYear, currentMonth + 1, 1);
      // å‡å»ä¸€å¤©å¾—åˆ°å½“æœˆæœ€åä¸€å¤©
      const lastDayOfCurrentMonth = new Date(nextMonthFirstDay - 1);
      // è·å–å½“æœˆæœ€åä¸€å¤©çš„æ—¥æœŸå·
      const lastDayNumber = lastDayOfCurrentMonth.getDate();
      // æ¯”è¾ƒå½“å‰æ—¥æœŸå’Œå½“æœˆæœ€åä¸€å¤©
      return currentDay === lastDayNumber;
    }
    
    // è®¾ç½®è€ƒå‹¤å¥–å’Œæˆ¿è´´è¾“å…¥æ¡†çš„å¯ç¼–è¾‘çŠ¶æ€
    function setBonusInputsEditableState(row) {
      const currentDate = document.getElementById('entry-date').valueAsDate || new Date();
      const isLastDay = isLastDayOfMonth(currentDate);
      
      const attendanceBonusInput = row.querySelector('.attendance-bonus');
      const housingAllowanceInput = row.querySelector('.housing-allowance');
      
      if (attendanceBonusInput) {
        // å¦‚æœä¸æ˜¯å½“æœˆæœ€åä¸€å¤©ï¼Œç¦ç”¨è¾“å…¥æ¡†
        attendanceBonusInput.disabled = !isLastDay;
        // åªæœ‰éå›ºå®šå·¥ç§æ—¶æ‰åº”ç”¨æ­¤è§„åˆ™ï¼Œå›ºå®šå·¥ç§çš„å¯ç¼–è¾‘çŠ¶æ€ç”±toggleInputsByWorkTypeå‡½æ•°å¤„ç†
        const workType = row.querySelector('.work-type').value;
        if (workType === 'å›ºå®š') {
          attendanceBonusInput.disabled = true;
        }
      }
      
      if (housingAllowanceInput) {
        // å¦‚æœä¸æ˜¯å½“æœˆæœ€åä¸€å¤©ï¼Œç¦ç”¨è¾“å…¥æ¡†
        housingAllowanceInput.disabled = !isLastDay;
        // åªæœ‰éå›ºå®šå·¥ç§æ—¶æ‰åº”ç”¨æ­¤è§„åˆ™ï¼Œå›ºå®šå·¥ç§çš„å¯ç¼–è¾‘çŠ¶æ€ç”±toggleInputsByWorkTypeå‡½æ•°å¤„ç†
        const workType = row.querySelector('.work-type').value;
        if (workType === 'å›ºå®š') {
          housingAllowanceInput.disabled = true;
        }
      }
    }
    
    // æ·»åŠ æ–°çš„å·¥åºè¡¨å•è¡Œ
    function addNewProcessRow() {
      const container = document.getElementById('process-forms-container');
      const newIndex = container.querySelectorAll('.process-form-row').length;
      
      const newRow = document.createElement('div');
      newRow.className = 'process-form-row';
      newRow.dataset.index = newIndex;
      newRow.style.padding = '15px';
      newRow.style.borderBottom = '1px solid #eee';
      newRow.style.display = 'grid';
      newRow.style.gridTemplateColumns = '2fr 1.5fr 1fr 1fr 1fr 1fr 1fr 1fr 60px'; // æ·»åŠ åˆ é™¤æŒ‰é’®çš„åˆ—å®½
      newRow.style.gap = '10px';
      newRow.style.alignItems = 'end';
      
      newRow.innerHTML = `
        <div style="position: relative;">
          <input type="text" class="process-name" required style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; background-color: white; min-width: 120px;">
          <div class="process-dropdown" style="display: none; position: absolute; z-index: 1000; width: 100%; max-height: 200px; overflow-y: auto; background: white; border: 1px solid #ddd; border-top: none; border-radius: 0 0 4px 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"></div>
        </div>
        
        <div>
          <select class="work-type" required style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; background-color: white; min-width: 100px;">
            <option value="">è¯·é€‰æ‹©å·¥ç§</option>
            <!-- å·¥ç§é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
          </select>
        </div>
        
        <div>
          <input type="number" class="quantity" step="1" min="1" required style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; min-width: 80px; -moz-appearance: textfield; appearance: textfield;">
        </div>
        
        <div>
          <div style="position: relative;">
            <input type="number" class="piece-rate" step="0.01" min="0" required style="width: 100%; padding: 8px 35px 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; min-width: 80px; -moz-appearance: textfield; appearance: textfield;">
            <span class="unit-label" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #666; font-size: 0.85rem;">å…ƒ</span>
          </div>
        </div>
        
        <div>
          <div style="position: relative;">
            <input type="number" class="attendance-bonus" step="0.01" min="0" value="0" style="width: 100%; padding: 8px 35px 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; min-width: 80px; -moz-appearance: textfield; appearance: textfield;">
            <span style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #666; font-size: 0.85rem;">å…ƒ</span>
          </div>
        </div>
        
        <div>
          <div style="position: relative;">
            <input type="number" class="housing-allowance" step="0.01" min="0" value="0" style="width: 100%; padding: 8px 35px 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; min-width: 80px; -moz-appearance: textfield; appearance: textfield;">
            <span style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #666; font-size: 0.85rem;">å…ƒ</span>
          </div>
        </div>
        
        <div>
          <div style="position: relative;">
            <input type="number" class="other-subsidy" step="0.01" min="0" value="0" style="width: 100%; padding: 8px 35px 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; min-width: 80px; -moz-appearance: textfield; appearance: textfield;">
            <span style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #666; font-size: 0.85rem;">å…ƒ</span>
          </div>
        </div>
        
        <div>
            <input type="number" class="total-amount" readonly style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; background-color: #f8f9fa; color: #28a745; font-weight: 600; min-width: 100px;">
          </div>
        
        <div style="text-align: center;">
          <button type="button" class="remove-row-btn" style="padding: 6px 12px; background-color: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
            <i class="fas fa-trash-alt"></i>
          </button>
        </div>
      `;
      
      container.appendChild(newRow);
      
      // å¡«å……å·¥åºå’Œå·¥ç§é€‰é¡¹
      populateProcessOptionsForRow(newRow);
      populateWorkTypeOptionsForRow(newRow);
      
      // è®¾ç½®è€ƒå‹¤å¥–å’Œæˆ¿è´´è¾“å…¥æ¡†çš„å¯ç¼–è¾‘çŠ¶æ€
      setBonusInputsEditableState(newRow);
      
      // ç»‘å®šäº‹ä»¶
      const removeBtn = newRow.querySelector('.remove-row-btn');
      removeBtn.onclick = function() {
        if (container.querySelectorAll('.process-form-row').length > 1) {
          container.removeChild(newRow);
          // é‡æ–°ç´¢å¼•æ‰€æœ‰è¡Œ
          updateRowIndices();
          // æ›´æ–°æ±‡æ€»åˆè®¡
          calculateTotalSummary();
        } else {
          showToast('è‡³å°‘ä¿ç•™ä¸€è¡Œå·¥åº', 'info');
        }
      };
      
      // ç»‘å®šè¾“å…¥äº‹ä»¶
      bindEventsToAllRows();
      
      // æ›´æ–°æ±‡æ€»åˆè®¡
      calculateTotalSummary();
    }
    
    // ä¸ºæŒ‡å®šè¡Œåˆå§‹åŒ–è‡ªåŠ¨å®ŒæˆåŠŸèƒ½
    function populateProcessOptionsForRow(row) {
      const processInput = row.querySelector('.process-name');
      const rowIndex = parseInt(row.dataset.index);
      // åˆå§‹åŒ–å·¥åºè¾“å…¥æ¡†çš„è‡ªåŠ¨å®ŒæˆåŠŸèƒ½
      initProcessAutocomplete(processInput, rowIndex);
    }
    
    // è®¡ç®—æ‰€æœ‰å·¥åºçš„æ±‡æ€»åˆè®¡é‡‘é¢
    function calculateTotalSummary() {
      const rows = document.querySelectorAll('.process-form-row');
      let totalSummary = 0;
      
      rows.forEach(row => {
        const totalAmountInput = row.querySelector('.total-amount');
        if (totalAmountInput && !isNaN(parseFloat(totalAmountInput.value))) {
          totalSummary += parseFloat(totalAmountInput.value);
        }
      });
      
      // æ›´æ–°æ±‡æ€»åˆè®¡æ˜¾ç¤º
      const summaryElement = document.getElementById('total-summary-amount');
      if (summaryElement) {
        summaryElement.textContent = `Â¥${totalSummary.toFixed(2)}`;
      }
      
      return totalSummary;
    }
    
    // ä¸ºæŒ‡å®šè¡Œå¡«å……å·¥ç§é€‰é¡¹
    function populateWorkTypeOptionsForRow(row) {
      const workTypeSelect = row.querySelector('.work-type');
      workTypeSelect.innerHTML = '<option value="">è¯·é€‰æ‹©å·¥ç§</option>';
      
      const workTypes = ['è®¡ä»¶', 'è®¡æ—¶', 'å›ºå®š'];
      workTypes.forEach(type => {
        const option = document.createElement('option');
        option.value = type;
        option.textContent = type;
        workTypeSelect.appendChild(option);
      });
    }
    
    // æ›´æ–°æ‰€æœ‰è¡Œçš„ç´¢å¼•
    function updateRowIndices() {
      const rows = document.querySelectorAll('.process-form-row');
      rows.forEach((row, index) => {
        row.dataset.index = index;
      });
    }
    

    
    // æ¸…ç©ºå·¥åºåˆ—è¡¨
    function clearProcessList() {
      if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å·¥åºå—ï¼Ÿ')) {
        const container = document.getElementById('process-forms-container');
        container.innerHTML = '';
        addNewProcessRow(); // ä¿ç•™ä¸€è¡Œç©ºç™½å·¥åº
        showToast('å·¥åºåˆ—è¡¨å·²æ¸…ç©º', 'success');
      }
    }
    
    // æ‰¹é‡ä¿å­˜å·¥åº
    let isProcessing = false; // æ·»åŠ å¤„ç†çŠ¶æ€æ ‡å¿—
    function batchSaveProcesses() {
      // å¦‚æœæ­£åœ¨å¤„ç†ä¸­ï¼Œç›´æ¥è¿”å›ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
      if (isProcessing) return;
      
      // è®¾ç½®ä¸ºæ­£åœ¨å¤„ç†ä¸­
      isProcessing = true;
      
      // è·å–æ‰¹é‡ä¿å­˜æŒ‰é’®å¹¶ä¿®æ”¹çŠ¶æ€
      const saveButton = document.getElementById('batch-save-processes');
      if (saveButton) {
        saveButton.disabled = true;
        saveButton.textContent = 'ä¿å­˜ä¸­...';
      }
      // å…ˆè®¡ç®—æ±‡æ€»åˆè®¡ï¼Œç¡®ä¿æ•°æ®å‡†ç¡®
      calculateTotalSummary();
      // æ”¶é›†æ‰€æœ‰å·¥åºè¡¨å•æ•°æ®
      const processRows = document.querySelectorAll('.process-form-row');
      const processesToSave = [];
      
      // éªŒè¯å¹¶æ”¶é›†æ¯è¡Œæ•°æ®
      let hasEmptyRequired = false;
      let hasEmptyRemarkForFixedType = false;
      processRows.forEach(row => {
        const processName = row.querySelector('.process-name').value;
        const workType = row.querySelector('.work-type').value;
        const quantity = row.querySelector('.quantity').value;
        const rate = row.querySelector('.piece-rate').value;
        const remark = document.getElementById('entry-remark').value;
        
        // æ£€æŸ¥å¿…å¡«é¡¹
        if (!processName || !workType || !quantity || !rate) {
          hasEmptyRequired = true;
          // æ ‡è®°æœªå¡«å†™çš„å¿…å¡«é¡¹
          if (!processName) row.querySelector('.process-name').style.borderColor = '#dc3545';
          if (!workType) row.querySelector('.work-type').style.borderColor = '#dc3545';
          if (!quantity) row.querySelector('.quantity').style.borderColor = '#dc3545';
          if (!rate) row.querySelector('.piece-rate').style.borderColor = '#dc3545';
        } 
        
        // å›ºå®šå·¥ç§æ—¶ï¼Œå¤‡æ³¨ä¸ºå¿…é€‰é¡¹
        if (workType === 'å›ºå®š' && !remark.trim()) {
          hasEmptyRemarkForFixedType = true;
          document.getElementById('entry-remark').style.borderColor = '#dc3545';
        }
        
        if (!hasEmptyRequired && !(workType === 'å›ºå®š' && !remark.trim())) {
          // æ¸…é™¤é”™è¯¯æ ‡è®°
          row.querySelector('.process-name').style.borderColor = '#ddd';
          row.querySelector('.work-type').style.borderColor = '#ddd';
          row.querySelector('.quantity').style.borderColor = '#ddd';
          row.querySelector('.piece-rate').style.borderColor = '#ddd';
          
          // æ”¶é›†æœ‰æ•ˆæ•°æ®
          processesToSave.push({
            processName,
            workType,
            quantity: parseFloat(quantity),
            rate: parseFloat(rate),
            attendanceBonus: parseFloat(row.querySelector('.attendance-bonus').value) || 0,
            housingAllowance: parseFloat(row.querySelector('.housing-allowance').value) || 0,
            otherSubsidy: parseFloat(row.querySelector('.other-subsidy').value) || 0,
            totalAmount: parseFloat(row.querySelector('.total-amount').value) || 0
          });
        }
      });
      
      // éªŒè¯æ‰€æœ‰å¿…å¡«é¡¹
      if (hasEmptyRequired) {
        showToast('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹ï¼ˆå·¥åºã€å·¥ç§ã€æ•°é‡ã€å•ä»·ï¼‰', 'error');
        return;
      }
      
      // éªŒè¯å›ºå®šå·¥ç§çš„å¤‡æ³¨
      if (hasEmptyRemarkForFixedType) {
        showToast('å›ºå®šå·¥ç§æ—¶å¤‡æ³¨ä¸ºå¿…é€‰é¡¹ï¼Œè¯·å¡«å†™å¤‡æ³¨ä¿¡æ¯', 'error');
        return;
      }
      
      if (processesToSave.length === 0) {
        showToast('è¯·æ·»åŠ å·¥åº', 'error');
        return;
      }
      
      // è·å–åŸºæœ¬ä¿¡æ¯
      const date = document.getElementById('entry-date').value;
      const employeeCode = document.getElementById('entry-employee-code').value;
      const employeeName = document.getElementById('entry-employee-name').value;
      const client = document.getElementById('entry-client').value;
      const orderNumber = document.getElementById('entry-order-number').value;
      const remark = document.getElementById('entry-remark').value;
      
      // åŸºæœ¬ä¿¡æ¯éªŒè¯
      if (!date || !employeeCode || !employeeName) {
        showToast('è¯·å¡«å†™å®Œæ•´çš„åŸºæœ¬ä¿¡æ¯', 'error');
        return;
      }
      
      // æ¸…é™¤å¤‡æ³¨è¾“å…¥æ¡†çš„é”™è¯¯æ ‡è®°
      document.getElementById('entry-remark').style.borderColor = '#ddd';
      
      try {
        
        // ä»localStorageè·å–ç°æœ‰æ•°æ®
        const wageDetails = JSON.parse(localStorage.getItem('wageDetails') || '[]');
        
        // ä¸ºæ¯ä¸ªå·¥åºåˆ›å»ºæ•°æ®å¯¹è±¡å¹¶æ·»åŠ åˆ°wageDetails
        processesToSave.forEach(process => {
          const entryData = {
            id: Date.now().toString() + '-' + Math.random().toString(36).substr(2, 9), // ç”Ÿæˆå”¯ä¸€ID
            date: date,
            employeeCode: employeeCode,
            employeeName: employeeName,
            processName: process.processName,
            workType: process.workType, // ä¿å­˜å·¥ç§ä¿¡æ¯
            pieceRate: process.rate,
            quantity: process.quantity,
            attendanceBonus: process.attendanceBonus,
            housingAllowance: process.housingAllowance,
            otherSubsidy: process.otherSubsidy,
            amount: process.totalAmount,
            client: client,
            orderNumber: orderNumber,
            remark: remark
          };
          wageDetails.push(entryData);
        });
        
        // ä¿å­˜å›localStorage
        localStorage.setItem('wageDetails', JSON.stringify(wageDetails));
        
        // åˆ·æ–°è®¡ä»¶å·¥èµ„é¡µé¢è¡¨æ ¼ï¼ˆå¦‚æœå½“å‰åœ¨è¯¥é¡µé¢ï¼‰
        if (!document.getElementById('wage')?.classList.contains('hidden')) {
          renderPiecework();
        }
        
        // ç«‹å³å…³é—­æ¨¡æ€æ¡†ï¼Œé˜²æ­¢å¤šæ¬¡ç‚¹å‡»
        try {
          // ç›´æ¥è°ƒç”¨ä¸“ç”¨çš„å…³é—­å‡½æ•°
          closeProcessEntryModal();
          
          // æ¸…ç†èƒŒæ™¯é®ç½©
          const backdrops = document.querySelectorAll('.modal-backdrop, .modal-overlay');
          backdrops.forEach(backdrop => backdrop.remove());
        } catch (closeError) {
          console.error('ç«‹å³å…³é—­æ¨¡æ€æ¡†æ—¶å‘ç”Ÿé”™è¯¯:', closeError);
        }
        
        // æ˜¾ç¤ºæˆåŠŸæç¤º
        showToast(`æˆåŠŸä¿å­˜ ${processesToSave.length} æ¡å·¥åºè®°å½•`, 'success');
        
        // å…³é—­æ¨¡æ€æ¡† - å¢å¼ºç‰ˆæœ¬ï¼Œç¡®ä¿æ¨¡æ€æ¡†èƒ½å¤Ÿå…³é—­
        try {
          // æ–¹æ¡ˆ1ï¼šä½¿ç”¨ä¸“é—¨çš„å…³é—­å‡½æ•°
          if (typeof closeProcessEntryModal === 'function') {
            console.log('å°è¯•æ–¹æ¡ˆ1ï¼šä½¿ç”¨closeProcessEntryModalå‡½æ•°');
            closeProcessEntryModal();
            console.log('æ–¹æ¡ˆ1æ‰§è¡Œå®Œæˆ');
          } 
          
          // æ–¹æ¡ˆ2ï¼šåŒæ—¶å°è¯•ç›´æ¥æ“ä½œæ¨¡æ€æ¡†å…ƒç´ ï¼ˆæ— è®ºæ–¹æ¡ˆ1æ˜¯å¦æˆåŠŸï¼‰
          console.log('å°è¯•æ–¹æ¡ˆ2ï¼šç›´æ¥æ“ä½œæ¨¡æ€æ¡†å…ƒç´ ');
          const modal = document.getElementById('process-entry-modal');
          if (modal) {
            // ä½¿ç”¨setAttributeå¹¶æ·»åŠ !importantç¡®ä¿èƒ½è¦†ç›–CSSæ ·å¼
            modal.setAttribute('style', 'display: none !important; visibility: hidden !important; z-index: 1040; pointer-events: none;');
            
            // åŒæ—¶éšè—æ¨¡æ€æ¡†å†…å®¹
            const modalContent = modal.querySelector('.modal-content');
            if (modalContent) {
              modalContent.setAttribute('style', 'display: none !important;');
            }
            
            // ç§»é™¤bodyä¸Šçš„modal-openç±»
            document.body.classList.remove('modal-open');
            
            console.log('æ–¹æ¡ˆ2æ‰§è¡ŒæˆåŠŸï¼šæ¨¡æ€æ¡†å·²å¼ºåˆ¶å…³é—­');
          } else {
            console.error('æ–¹æ¡ˆ2å¤±è´¥ï¼šæœªæ‰¾åˆ°æ¨¡æ€æ¡†å…ƒç´ ');
          }
          
          // æ–¹æ¡ˆ3ï¼šæ¸…ç†èƒŒæ™¯é®ç½©
          console.log('å°è¯•æ–¹æ¡ˆ3ï¼šæ¸…ç†æ¨¡æ€æ¡†èƒŒæ™¯é®ç½©');
          const backdrops = document.querySelectorAll('.modal-backdrop, .modal-overlay');
          backdrops.forEach(backdrop => {
            backdrop.remove();
            console.log('å·²ç§»é™¤èƒŒæ™¯é®ç½©');
          });
          
        } catch (closeError) {
          console.error('å…³é—­æ¨¡æ€æ¡†æ—¶å‘ç”Ÿé”™è¯¯:', closeError);
        }
        
      } catch (error) {
        console.error('æ‰¹é‡ä¿å­˜å¤±è´¥:', error);
        showToast('æ‰¹é‡ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
      } finally {
        // æ— è®ºæˆåŠŸå¤±è´¥ï¼Œéƒ½æ¢å¤æŒ‰é’®çŠ¶æ€
        setTimeout(() => {
          isProcessing = false;
          const saveButton = document.getElementById('batch-save-processes');
          if (saveButton) {
            saveButton.disabled = false;
            saveButton.textContent = 'æ‰¹é‡ä¿å­˜';
          }
        }, 500); // ç¨å¾®å»¶è¿Ÿä¸€ä¸‹ï¼Œç¡®ä¿ç”¨æˆ·ä½“éªŒ
      }
    }
    
    // ä¿å­˜å½•å…¥çš„å·¥åºæ•°æ®
    function saveProcessEntry(event) {
      event.preventDefault();
      
      // è·å–è¡¨å•æ•°æ®
      const entryData = {
        id: Date.now().toString(), // ä½¿ç”¨æ—¶é—´æˆ³ä½œä¸ºå”¯ä¸€ID
        date: document.getElementById('entry-date').value,
        employeeCode: document.getElementById('entry-employee-code').value,
        employeeName: document.getElementById('entry-employee-name').value,
        processName: document.getElementById('entry-process-name').value,
        pieceRate: parseFloat(document.getElementById('entry-piece-rate').value),
        quantity: parseInt(document.getElementById('entry-quantity').value),
        attendanceBonus: parseFloat(document.getElementById('entry-attendance-bonus').value) || 0,
        housingAllowance: parseFloat(document.getElementById('entry-housing-allowance').value) || 0,
        otherSubsidy: parseFloat(document.getElementById('entry-other-subsidy').value) || 0,
        client: document.getElementById('entry-client').value,
        orderNumber: document.getElementById('entry-order-number').value,
        remark: document.getElementById('entry-remark').value,
        // è®¡ç®—é‡‘é¢ï¼ˆå•ä»·Ã—æ•°é‡ + å„ç§è¡¥è´´ï¼‰
        amount: parseFloat((parseFloat(document.getElementById('entry-piece-rate').value) * parseInt(document.getElementById('entry-quantity').value) + 
                       parseFloat(document.getElementById('entry-attendance-bonus').value || 0) + 
                       parseFloat(document.getElementById('entry-housing-allowance').value || 0) + 
                       parseFloat(document.getElementById('entry-other-subsidy').value || 0)).toFixed(2))
      };
      
      // ä»localStorageè·å–ç°æœ‰æ•°æ®
      const wageDetails = JSON.parse(localStorage.getItem('wageDetails') || '[]');
      
      // æ·»åŠ æ–°æ•°æ®
      wageDetails.push(entryData);
      
      // ä¿å­˜å›localStorage
      localStorage.setItem('wageDetails', JSON.stringify(wageDetails));
      
      // åˆ·æ–°è®¡ä»¶å·¥èµ„é¡µé¢è¡¨æ ¼ï¼ˆå¦‚æœå½“å‰åœ¨è¯¥é¡µé¢ï¼‰
      if (!document.getElementById('wage')?.classList.contains('hidden')) {
        renderPiecework(); // å‡è®¾è¿™æ˜¯æ¸²æŸ“è®¡ä»¶å·¥èµ„è¡¨æ ¼çš„å‡½æ•°
      }
      
      // æ˜¾ç¤ºæˆåŠŸæç¤º
      alert('å·¥åºå½•å…¥æˆåŠŸï¼');
      
      // å…³é—­æ¨¡æ€æ¡†
      document.getElementById('process-entry-modal').style.display = 'none';
    }

    // è®¾ç½®äº‹ä»¶ç›‘å¬
    function setupEventListeners() {
      // èœå•åˆ‡æ¢
      document.querySelectorAll('.menu-item').forEach(item => {
        item.addEventListener('click', function () {
          // ç‰¹æ®Šå¤„ç†ç”Ÿäº§ç®¡ç†æŒ‰é’®ï¼Œåœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€ç”Ÿäº§è®¡åˆ’å®‰æ’.html
          if (this.id === 'production-management-btn') {
            // è¯»å–ç‚‰æ¶è®¢å•æ•°æ®
            const allOrders = JSON.parse(localStorage.getItem('orders')) || [];
            // è½¬æ¢ä¸ºç”Ÿäº§è®¡åˆ’å®‰æ’é¡µé¢éœ€è¦çš„æ ¼å¼
            const productionOrders = allOrders.map(order => {
              return {
                customer: order.customer,
                orderNumber: order.orderNo, // æ­£ç¡®çš„å­—æ®µåæ˜¯orderNoè€Œä¸æ˜¯orderNumber
                quantity: order.qty, // æ­£ç¡®çš„å­—æ®µåæ˜¯qtyè€Œä¸æ˜¯quantity
                status: order.status || 'å¾…ç”Ÿäº§' // æ·»åŠ è®¢å•çŠ¶æ€ä¿¡æ¯
              };
            });
            // ä¿å­˜åˆ°localStorageä¾›ç”Ÿäº§è®¡åˆ’å®‰æ’é¡µé¢ä½¿ç”¨
            localStorage.setItem('productionOrderList', JSON.stringify(productionOrders));
            // åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€ç”Ÿäº§è®¡åˆ’å®‰æ’.html
            window.open('ç”Ÿäº§è®¡åˆ’å®‰æ’.html', '_blank');
            return;
          }
          
          const pageId = this.getAttribute('data-page');
          document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
          document.getElementById(pageId).classList.remove('hidden');
          document.querySelector('.menu-item.active')?.classList.remove('active');
          this.classList.add('active');
          
          // å¦‚æœåˆ‡æ¢åˆ°å¤‡å¿˜å½•é¡µé¢ï¼ŒåŠ è½½å¤‡å¿˜å½•åˆ—è¡¨å¹¶åˆå§‹åŒ–æœç´¢åŠŸèƒ½
          if (pageId === 'memo') {
            loadMemos();
            setupMemoSearch();
          }
        });
        
        // æ£€æŸ¥æ˜¯å¦æœ‰é¡µé¢æ˜¾ç¤ºï¼Œå¦‚æœæ²¡æœ‰åˆ™é»˜è®¤æ˜¾ç¤ºå‘˜å·¥ç®¡ç†é¡µé¢
        const visiblePage = document.querySelector('.page:not(.hidden)');
        if (!visiblePage) {
          document.getElementById('employee').classList.remove('hidden');
          document.querySelector('.menu-item[data-page="employee"]').classList.add('active');
        }
      });
      
      // å¤‡å¿˜å½•åŠŸèƒ½
      // ä»localStorageåŠ è½½å¤‡å¿˜å½•
      function loadMemos(searchKeyword = '') {
        const memos = JSON.parse(localStorage.getItem('memos') || '[]');
        const memoList = document.getElementById('memo-list');
        memoList.innerHTML = '';
        
        // è¿‡æ»¤å¤‡å¿˜å½•
        const filteredMemos = memos.filter(memo => {
          if (!searchKeyword) return true;
          const keyword = searchKeyword.toLowerCase();
          return memo.title.toLowerCase().includes(keyword) || memo.content.toLowerCase().includes(keyword);
        });
        
        filteredMemos.forEach((memo, index) => {
          const memoCard = document.createElement('div');
          memoCard.className = 'card';
          memoCard.style.textAlign = 'left';
          memoCard.style.marginBottom = '15px';
          memoCard.dataset.memoId = memo.id;
          
          // åˆ›å»ºå¡ç‰‡å¤´éƒ¨
          const cardHeader = document.createElement('div');
          cardHeader.className = 'card-header';
          cardHeader.style.backgroundColor = '#007bff';
          cardHeader.style.color = 'white';
          cardHeader.style.padding = '8px 12px';
          cardHeader.style.borderRadius = '4px 4px 0 0';
          cardHeader.style.display = 'flex';
          cardHeader.style.alignItems = 'center';
          cardHeader.style.justifyContent = 'space-between';
          
          const headerLeft = document.createElement('div');
          headerLeft.style.display = 'flex';
          headerLeft.style.alignItems = 'center';
          
          const indexSpan = document.createElement('span');
          indexSpan.style.marginRight = '10px';
          indexSpan.style.fontWeight = 'bold';
          indexSpan.textContent = `${index + 1}.`;
          
          const titleSpan = document.createElement('span');
          titleSpan.className = 'memo-title';
          titleSpan.style.fontWeight = 'bold';
          titleSpan.textContent = memo.title;
          
          headerLeft.appendChild(indexSpan);
          headerLeft.appendChild(titleSpan);
          
          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'button danger';
          deleteBtn.style.padding = '4px 8px';
          deleteBtn.style.fontSize = '0.8em';
          deleteBtn.innerHTML = '<i class="fas fa-trash"></i> åˆ é™¤';
          deleteBtn.onclick = function() {
            deleteMemo(memo.id);
          };
          
          cardHeader.appendChild(headerLeft);
          cardHeader.appendChild(deleteBtn);
          
          // åˆ›å»ºå¡ç‰‡å†…å®¹
          const cardContent = document.createElement('div');
          cardContent.className = 'card-content';
          cardContent.style.marginTop = '0';
          cardContent.style.padding = '12px';
          cardContent.style.whiteSpace = 'pre-wrap';
          cardContent.style.lineHeight = '1.5';
          cardContent.style.backgroundColor = '#f8f9fa';
          cardContent.style.borderRadius = '0 0 4px 4px';
          cardContent.style.wordWrap = 'break-word';
          
          const contentDiv = document.createElement('div');
          contentDiv.className = 'memo-content';
          contentDiv.textContent = memo.content;
          
          cardContent.appendChild(contentDiv);
          
          // åˆ›å»ºå¡ç‰‡åº•éƒ¨
          const cardFooter = document.createElement('div');
          cardFooter.className = 'card-footer';
          cardFooter.style.marginTop = '5px';
          cardFooter.style.fontSize = '0.9em';
          cardFooter.style.color = '#666';
          cardFooter.style.padding = '0 12px';
          cardFooter.textContent = `åˆ›å»ºæ—¶é—´: ${new Date(memo.createdAt).toLocaleString()}`;
          
          // ç»„è£…å¡ç‰‡
          memoCard.appendChild(cardHeader);
          memoCard.appendChild(cardContent);
          memoCard.appendChild(cardFooter);
          
          // æ·»åŠ åŒå‡»äº‹ä»¶åˆ°æ•´ä¸ªå¡ç‰‡ï¼ˆé»˜è®¤èšç„¦æ ‡é¢˜ï¼‰
          memoCard.addEventListener('dblclick', function() {
            editMemo(this, memo.id, 'title');
          });
          
          // ç¡®ä¿å†…å®¹åŒºåŸŸä¹Ÿèƒ½å“åº”åŒå‡»ï¼ˆèšç„¦å†…å®¹ï¼‰
          contentDiv.addEventListener('dblclick', function(e) {
            e.stopPropagation();
            editMemo(memoCard, memo.id, 'content');
          });
          
          // æ·»åŠ åŒå‡»äº‹ä»¶åˆ°æ ‡é¢˜åŒºåŸŸ
          titleSpan.addEventListener('dblclick', function(e) {
            e.stopPropagation();
            editMemo(memoCard, memo.id, 'title');
          });
          
          memoList.appendChild(memoCard);
        });
      }
      
      // æœç´¢åŠŸèƒ½
      function setupMemoSearch() {
        const searchInput = document.getElementById('memo-search');
        if (searchInput) {
          searchInput.addEventListener('input', function() {
            loadMemos(this.value);
          });
        }
      }
      
      // å…ˆç§»é™¤å¯èƒ½å­˜åœ¨çš„äº‹ä»¶ç›‘å¬å™¨ï¼Œé¿å…é‡å¤ç»‘å®š
      const addMemoBtn = document.getElementById('add-memo-btn');
      if (addMemoBtn) {
        // ç§»é™¤æ‰€æœ‰ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
        addMemoBtn.replaceWith(addMemoBtn.cloneNode(true));
        
        // é‡æ–°ç»‘å®šç‚¹å‡»äº‹ä»¶
        document.getElementById('add-memo-btn').addEventListener('click', function() {
          const title = document.getElementById('memo-title').value;
          const content = document.getElementById('memo-content').value;
          
          if (!title.trim() || !content.trim()) {
            alert('è¯·è¾“å…¥æ ‡é¢˜å’Œå†…å®¹ï¼');
            return;
          }
          
          // ä»localStorageè¯»å–ç°æœ‰å¤‡å¿˜å½•
          const memos = JSON.parse(localStorage.getItem('memos') || '[]');
          
          // åˆ›å»ºæ–°å¤‡å¿˜å½•
          const newMemo = {
            id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
            title: title,
            content: content,
            createdAt: new Date().toISOString()
          };
          
          // æ·»åŠ åˆ°å¤‡å¿˜å½•æ•°ç»„
          memos.push(newMemo);
          
          // ä¿å­˜åˆ°localStorage
          localStorage.setItem('memos', JSON.stringify(memos));
          
          // æ¸…ç©ºè¡¨å•
          document.getElementById('memo-title').value = '';
          document.getElementById('memo-content').value = '';
          
          // é‡æ–°åŠ è½½å¤‡å¿˜å½•åˆ—è¡¨
          loadMemos();
        });
      }
      
      // åˆ é™¤å¤‡å¿˜å½•
      window.deleteMemo = function(id) {
        let memos = JSON.parse(localStorage.getItem('memos') || '[]');
        memos = memos.filter(memo => memo.id !== id);
        localStorage.setItem('memos', JSON.stringify(memos));
        loadMemos();
      };
      
      // ç¼–è¾‘å¤‡å¿˜å½•
      function editMemo(memoCard, memoId, focusTarget = 'title') {
        console.log('å¼€å§‹ç¼–è¾‘å¤‡å¿˜å½•ï¼ŒID:', memoId, 'èšç„¦ç›®æ ‡:', focusTarget);
        
        // è·å–å½“å‰æ ‡é¢˜å’Œå†…å®¹
        const titleElement = memoCard.querySelector('.memo-title');
        const contentElement = memoCard.querySelector('.memo-content');
        
        console.log('æ‰¾åˆ°çš„å…ƒç´ :', {
          titleElement: titleElement,
          contentElement: contentElement
        });
        
        if (!titleElement || !contentElement) {
          console.error('æœªèƒ½æ‰¾åˆ°æ ‡é¢˜æˆ–å†…å®¹å…ƒç´ ');
          return;
        }
        
        const currentTitle = titleElement.textContent;
        const currentContent = contentElement.textContent;
        
        console.log('å½“å‰å†…å®¹:', {
          title: currentTitle,
          content: currentContent
        });
        
        // å°†æ ‡é¢˜è½¬æ¢ä¸ºå¯ç¼–è¾‘çŠ¶æ€
        titleElement.innerHTML = `<input type="text" class="edit-title" value="${currentTitle}" style="width: 200px; padding: 2px; border: 1px solid #ccc; border-radius: 3px; font-weight: bold;" />`;
        
        // å°†å†…å®¹è½¬æ¢ä¸ºå¯ç¼–è¾‘çŠ¶æ€
        contentElement.innerHTML = `<textarea class="edit-content" style="width: 100%; height: 100px; padding: 8px; border: 1px solid #ccc; border-radius: 3px; resize: vertical;" >${currentContent}</textarea>`;
        
        console.log('å·²è½¬æ¢ä¸ºå¯ç¼–è¾‘çŠ¶æ€');
        
        // è·å–ç¼–è¾‘å…ƒç´ 
        const editTitleInput = memoCard.querySelector('.edit-title');
        const editContentTextarea = memoCard.querySelector('.edit-content');
        
        // æ ¹æ®èšç„¦ç›®æ ‡è®¾ç½®å…‰æ ‡ä½ç½®
        if (focusTarget === 'content') {
          editContentTextarea.focus();
          // å°†å…‰æ ‡ç§»åŠ¨åˆ°æ–‡æœ¬æœ«å°¾
          editContentTextarea.selectionStart = editContentTextarea.selectionEnd = editContentTextarea.value.length;
        } else {
          editTitleInput.focus();
          // å°†å…‰æ ‡ç§»åŠ¨åˆ°æ–‡æœ¬æœ«å°¾
          editTitleInput.selectionStart = editTitleInput.selectionEnd = editTitleInput.value.length;
        }
        
        // ä¿å­˜ç¼–è¾‘åçš„å†…å®¹
        function saveEdit() {
          console.log('å¼€å§‹ä¿å­˜ç¼–è¾‘å†…å®¹');
          
          const newTitle = editTitleInput.value.trim();
          const newContent = editContentTextarea.value.trim();
          
          console.log('æ–°å†…å®¹:', {
            title: newTitle,
            content: newContent
          });
          
          if (newTitle || newContent) {
            console.log('å†…å®¹æœ‰å˜åŒ–ï¼Œå‡†å¤‡ä¿å­˜');
            
            // æ›´æ–°localStorageä¸­çš„å¤‡å¿˜å½•
            let memos = JSON.parse(localStorage.getItem('memos') || '[]');
            const memoIndex = memos.findIndex(memo => memo.id === memoId);
            
            console.log('æ‰¾åˆ°çš„å¤‡å¿˜å½•ç´¢å¼•:', memoIndex);
            
            if (memoIndex !== -1) {
              memos[memoIndex].title = newTitle;
              memos[memoIndex].content = newContent;
              console.log('æ›´æ–°åçš„å¤‡å¿˜å½•:', memos[memoIndex]);
              
              localStorage.setItem('memos', JSON.stringify(memos));
              console.log('å·²ä¿å­˜åˆ°localStorage');
              
              // é‡æ–°åŠ è½½å¤‡å¿˜å½•åˆ—è¡¨
              loadMemos();
            }
          } else {
            console.log('æ ‡é¢˜å’Œå†…å®¹éƒ½ä¸ºç©ºï¼Œä¸ä¿å­˜');
          }
        }
        
        // å¤±å»ç„¦ç‚¹æ—¶ä¿å­˜
        editTitleInput.addEventListener('blur', saveEdit);
        editContentTextarea.addEventListener('blur', saveEdit);
        
        // æŒ‰ä¸‹Enteré”®æ—¶ä¿å­˜
        editTitleInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            editContentTextarea.focus();
          }
        });
        
        editContentTextarea.addEventListener('keypress', function(e) {
          if (e.key === 'Enter' && e.shiftKey) {
            // æŒ‰ä¸‹Shift+Enteræ—¶æ¢è¡Œ
            return;
          } else if (e.key === 'Enter') {
            e.preventDefault();
            saveEdit();
          }
        });
      };
      
      // å¤šè§’åº¦æŸ¥è¯¢ - å®ç°æŸ¥è¯¢é€»è¾‘
      document.getElementById('multisearch-query-btn').addEventListener('click', function() {
        // è·å–æŸ¥è¯¢æ¡ä»¶
        const queryType = document.querySelector('input[name="query-type"]:checked').value;
        const searchText = document.getElementById('multi-dim').value.trim().toLowerCase();
        const dateInputs = document.querySelectorAll('#multisearch input[type="date"]');
        const startDate = dateInputs[0].value;
        const endDate = dateInputs[1].value;
        
        // æ¸…ç©ºè¡¨æ ¼å†…å®¹
        const tableBody = document.querySelector('#multisearch table tbody');
        if (tableBody) {
          tableBody.innerHTML = '';
        }
        
        // ä»è®¡ä»¶å·¥èµ„è¡¨æ ¼æå–æ•°æ®
        const pieceworkRows = document.querySelectorAll('#piecework-table tbody tr');
        let filteredData = [];
        
        pieceworkRows.forEach(row => {
          const cells = row.querySelectorAll('td');
          if (cells.length >= 12) {
            const date = cells[0].textContent.trim();
            const empName = cells[1].textContent.trim().toLowerCase();
            const procName = cells[4].textContent.trim().toLowerCase();
            const workType = cells[5].textContent.trim();
            // ä¿®å¤æ•°å€¼è§£æé—®é¢˜ï¼Œå»é™¤å¯èƒ½å­˜åœ¨çš„éæ•°å­—å­—ç¬¦
            const unitPrice = parseFloat(cells[6].textContent.trim().replace(/[^\d.-]/g, '')) || 0;
            const quantity = parseFloat(cells[7].textContent.trim().replace(/[^\d.-]/g, '')) || 0;
            const attendanceBonus = parseFloat(cells[8].textContent.trim().replace(/[^\d.-]/g, '')) || 0;
            const housingAllowance = parseFloat(cells[9].textContent.trim().replace(/[^\d.-]/g, '')) || 0;
            const otherSubsidy = parseFloat(cells[10].textContent.trim().replace(/[^\d.-]/g, '')) || 0;
            const amount = parseFloat(cells[11].textContent.trim().replace(/[^\d.-]/g, '')) || 0;
            const remark = cells[12].textContent.trim();
            
            // æ ¹æ®æŸ¥è¯¢ç±»å‹å’Œæœç´¢å†…å®¹è¿‡æ»¤
            let match = false;
            if (queryType === 'emp') {
              match = empName.includes(searchText);
            } else if (queryType === 'proc') {
              match = procName.includes(searchText);
            }
            
            // æ—¶é—´èŒƒå›´è¿‡æ»¤
            if (match && startDate && endDate) {
              const rowDate = new Date(date);
              const start = new Date(startDate);
              const end = new Date(endDate);
              end.setHours(23, 59, 59, 999); // è®¾ç½®ä¸ºå½“å¤©ç»“æŸæ—¶é—´
              match = rowDate >= start && rowDate <= end;
            }
            
            if (match) {
              filteredData.push({
                date, empName, procName, workType, unitPrice, quantity, 
                attendanceBonus, housingAllowance, otherSubsidy, amount, remark
              });
            }
          }
        });
        
        // è®¡ç®—åˆè®¡å€¼
        const totals = filteredData.reduce((acc, item) => {
          acc.attendanceBonus += item.attendanceBonus;
          acc.housingAllowance += item.housingAllowance;
          acc.otherSubsidy += item.otherSubsidy;
          acc.amount += item.amount;
          return acc;
        }, { attendanceBonus: 0, housingAllowance: 0, otherSubsidy: 0, amount: 0 });
        
        // æ˜¾ç¤ºè¿‡æ»¤åçš„æ•°æ®
        if (tableBody) {
          filteredData.forEach(item => {
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
              <td>${item.date}</td>
              <td>${item.empName}</td>
              <td>${item.procName}</td>
              <td>${item.workType}</td>
              <td>${item.unitPrice}</td>
              <td>${item.quantity}</td>
              <td>${item.attendanceBonus}</td>
              <td>${item.housingAllowance}</td>
              <td>${item.otherSubsidy}</td>
              <td>${item.amount}</td>
              <td>${item.remark}</td>
            `;
            tableBody.appendChild(newRow);
          });
          
          // æ·»åŠ åˆè®¡è¡Œ
          if (filteredData.length > 0) {
            const totalRow = document.createElement('tr');
            totalRow.className = 'total-row';
            totalRow.innerHTML = `
              <td colspan="6" style="text-align: right; font-weight: bold;">åˆè®¡ï¼š</td>
              <td style="font-weight: bold;">${totals.attendanceBonus.toFixed(2)}</td>
              <td style="font-weight: bold;">${totals.housingAllowance.toFixed(2)}</td>
              <td style="font-weight: bold;">${totals.otherSubsidy.toFixed(2)}</td>
              <td style="font-weight: bold;">${totals.amount.toFixed(2)}</td>
              <td></td>
            `;
            tableBody.appendChild(totalRow);
          }
        }
      });
      
      // å¤šè§’åº¦æŸ¥è¯¢ - é‡ç½®æŒ‰é’®åŠŸèƒ½
      document.getElementById('multisearch-reset-btn').addEventListener('click', function() {
        // æ¸…ç©ºæŸ¥è¯¢è¾“å…¥æ¡†
        document.getElementById('multi-dim').value = '';
        
        // æ¸…ç©ºè¡¨æ ¼å†…å®¹
        const tableBody = document.querySelector('#multisearch table tbody');
        if (tableBody) {
          tableBody.innerHTML = '';
        }
        
        // æ¢å¤é»˜è®¤æ—¥æœŸèŒƒå›´
        const dateInputs = document.querySelectorAll('#multisearch input[type="date"]');
        dateInputs[0].value = '2024-05-01';
        dateInputs[1].value = '2024-05-31';
      });

      // å‘˜å·¥ç®¡ç† - æœç´¢ç­›é€‰
      ['emp-search-input', 'status-filter'].forEach(id => {
        document.getElementById(id)?.addEventListener('input', applyEmployeeFilter);
      });
      document.getElementById('export-emp-btn').addEventListener('click', exportEmployees);
      document.getElementById('import-emp-btn').addEventListener('click', () => {
  const importModal = document.getElementById('import-modal');
  importModal.setAttribute('style', 'display: flex !important; justify-content: center; align-items: center; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000;');
});
      document.getElementById('add-employee-btn').addEventListener('click', showAddEmployeeModal);
      document.getElementById('clear-emp-btn').addEventListener('click', clearAllEmployees);
      document.getElementById('employee-form').addEventListener('submit', function(e) {
        e.preventDefault();
        saveEmployee();
      });

      // æ–‡ä»¶ä¸Šä¼ 
      const dropZone = document.getElementById('drop-zone');
      const fileInput = document.getElementById('file-input');
      dropZone.addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', handleFileUpload);

      dropZone.addEventListener('dragover', e => {
        e.preventDefault();
        dropZone.classList.add('highlight');
      });
      dropZone.addEventListener('dragleave', () => dropZone.classList.remove('highlight'));
      dropZone.addEventListener('drop', e => {
        e.preventDefault();
        dropZone.classList.remove('highlight');
        if (e.dataTransfer.files.length > 0) {
          fileInput.files = e.dataTransfer.files;
          handleFileUpload({ target: fileInput });
        }
      });

      // å…¶ä»–æŒ‰é’®å ä½æç¤º
      document.querySelectorAll('[id$="-btn"]:not(#import-emp-btn):not(#add-employee-btn):not(#export-json-btn):not(#import-json-btn):not(#multisearch-query-btn):not(#add-memo-btn)').forEach(btn => {
        // åªå¯¹æœªå®ç°çš„æŒ‰é’®æ·»åŠ åŠŸèƒ½å¼€å‘ä¸­çš„æç¤º
      if (btn.id !== 'add-order-btn' && btn.id !== 'employee-export-btn' && btn.id !== 'employee-import-btn' && btn.id !== 'import-btn' && btn.id !== 'export-btn' && btn.id !== 'export-csv-btn' && btn.id !== 'import-proc' && btn.id !== 'export-proc' && btn.id !== 'add-proc-btn' && btn.id !== 'add-process-btn' && btn.id !== 'production-management-btn' && btn.id !== 'clear-emp-btn') {
        btn.addEventListener('click', () => alert(`åŠŸèƒ½å¼€å‘ä¸­ï¼š${btn.textContent}`));
      }
      });
      
      // å·¥åºç®¡ç† - å¯¼å…¥å¯¼å‡ºåŠŸèƒ½ç»‘å®š
      document.getElementById('import-proc').addEventListener('click', importProcesses);
      document.getElementById('export-proc').addEventListener('click', exportProcesses);
      // ç»‘å®šæ¸…ç©ºæŒ‰é’®äº‹ä»¶
      document.getElementById('clear-proc').addEventListener('click', clearProcessData);
      // ç»‘å®šæ–°å¢å·¥åºæŒ‰é’®äº‹ä»¶
      document.getElementById('add-proc-btn').addEventListener('click', showAddProcessModal);
      
      // å·¥åºæœç´¢åŠŸèƒ½
      const procSearch = document.getElementById('proc-search');
      if (procSearch) {
        procSearch.addEventListener('input', function() {
          const searchTerm = this.value.toLowerCase().trim();
          renderProcesses(searchTerm);
        });
      }
      
      // ä¸ºå·¥åºè¡¨å•ç»‘å®šæäº¤äº‹ä»¶
      document.getElementById('process-form').addEventListener('submit', function(e) {
        e.preventDefault();
        saveProcess();
      });
    }

    // ========== å‘˜å·¥ç®¡ç† ==========    
    // æ—¥æœŸæ ¼å¼åŒ–å‡½æ•° - å°†å„ç§æ ¼å¼çš„æ—¥æœŸè½¬æ¢ä¸ºYYYY-MM-DDæ ¼å¼
    function formatDate(dateStr) {
      if (!dateStr) return '-';
      
      // å°è¯•è§£ææ—¥æœŸ
      const date = new Date(dateStr);
      
      // æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆæ—¥æœŸ
      if (isNaN(date.getTime())) {
        // å°è¯•ä¸åŒçš„æ—¥æœŸæ ¼å¼
        const formats = [
          /^(\d{4})(\d{2})(\d{2})$/, // 20251231
          /^(\d{4})\/(\d{1,2})\/(\d{1,2})$/, // 2025/12/31
          /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/, // 12/31/2025
          /^(\d{4})-(\d{1,2})-(\d{1,2})$/, // 2025-12-31
          /^(\d{1,2})-(\d{1,2})-(\d{4})$/ // 31-12-2025
        ];
        
        for (const format of formats) {
          const match = dateStr.match(format);
          if (match) {
            let year, month, day;
            if (format === formats[0]) { // 20251231
              year = match[1];
              month = match[2];
              day = match[3];
            } else if (format === formats[1] || format === formats[3]) { // 2025/12/31 æˆ– 2025-12-31
              year = match[1];
              month = match[2].padStart(2, '0');
              day = match[3].padStart(2, '0');
            } else { // 12/31/2025 æˆ– 31-12-2025
              year = match[3];
              month = match[1].padStart(2, '0');
              day = match[2].padStart(2, '0');
            }
            return `${year}-${month}-${day}`;
          }
        }
        
        return dateStr; // å¦‚æœæ— æ³•è§£æï¼Œè¿”å›åŸå§‹å­—ç¬¦ä¸²
      }
      
      // æ ¼å¼åŒ–æœ‰æ•ˆæ—¥æœŸä¸ºYYYY-MM-DD
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }
    
    function renderEmployees(filter = {}) {
      const container = document.getElementById('employee-cards');
      container.innerHTML = '';

      let filtered = employees.filter(emp => {
        if (filter.status && emp.status !== filter.status) return false;
        if (filter.search) {
          const s = filter.search.toLowerCase();
          // æœç´¢æ‰€æœ‰å¯èƒ½çš„å­—æ®µ
          const allFields = [
            emp.name,
            emp.code,
            emp.phone,
            emp.idCard,
            emp.joinDate,
            emp.leaveDate,
            emp.company,
            emp.dept,
            emp.job,
            emp.bankName,
            emp.bankAccount,
            emp.remark
          ];
          // æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä¸€å­—æ®µåŒ…å«æœç´¢æ–‡æœ¬
          const foundInAnyField = allFields.some(field => 
            field && field.toString().toLowerCase().includes(s)
          );
          if (!foundInAnyField) return false;
        }
        return true;
      });

      document.getElementById('total-count').textContent = employees.length;
      document.getElementById('active-count').textContent = employees.filter(e => e.status === 'active').length;
      document.getElementById('inactive-count').textContent = employees.filter(e => e.status === 'inactive').length;

      filtered.forEach(emp => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="card-header"><span style="font-size: 1.5em;">${emp.name}</span><span class="status-badge ${emp.status === 'active' ? 'active-status' : 'inactive-status'}">${emp.status === 'active' ? 'åœ¨èŒ' : 'ç¦»èŒ'}</span></div>
          <div class="card-field">å·¥å·ï¼š${emp.code}</div>
          <div class="card-field">å§“åï¼š${emp.name}</div>
          <div class="card-field">æ‰‹æœºå·ï¼š${emp.phone}</div>
          <div class="card-field">èº«ä»½è¯å·ï¼š${emp.idCard || '-'}</div>
          <div class="card-field">å…¥èŒæ—¥æœŸï¼š${formatDate(emp.joinDate)}</div>
          <div class="card-field">ç¦»èŒæ—¥æœŸï¼š${formatDate(emp.leaveDate)}</div>
          <div class="card-field">æ‰€å±å…¬å¸ï¼š${emp.company}</div>
          <div class="card-field">æ‰€å±éƒ¨é—¨ï¼š${emp.dept || '-'}</div>
          <div class="card-field">èŒä½ï¼š${emp.job || '-'}</div>
          <div class="card-field">å¼€æˆ·è¡Œï¼š${emp.bankName || '-'}</div>
          <div class="card-field">å¡å·ï¼š${emp.bankAccount || '-'}</div>
          <div class="card-field">å¤‡æ³¨ï¼š${emp.remark || '-'}</div>
          <div class="card-actions">
            <button class="button primary" onclick="showProcessEntryModal('${emp.code}')"><i class="fas fa-plus-circle"></i> å½•å…¥å·¥åº</button>
            <button class="button default" onclick="editEmployee('${emp.code}')"><i class="fas fa-edit"></i> ç¼–è¾‘</button>
            <button class="button danger" onclick="deleteEmployee(${emp.id})"><i class="fas fa-trash"></i> åˆ é™¤</button>
          </div>
        `;
        container.appendChild(card);
      });
    }

    function applyEmployeeFilter() {
      const search = document.getElementById('emp-search-input').value.trim().toLowerCase();
      const statusVal = document.getElementById('status-filter').value;
      const status = statusVal === 'åœ¨èŒ' ? 'active' : statusVal === 'ç¦»èŒ' ? 'inactive' : null;

      renderEmployees({ search, status });
    }



    function deleteEmployee(id) {
      if (confirm("ç¡®å®šè¦åˆ é™¤è¯¥å‘˜å·¥å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚")) {
        // ä»å†…å­˜ä¸­åˆ é™¤
        employees = employees.filter(e => e.id !== id);
        
        // åŒæ­¥æ›´æ–°localStorage
        let allEmployees = JSON.parse(localStorage.getItem('employees')) || [];
        allEmployees = allEmployees.filter(e => e.id !== id);
        localStorage.setItem('employees', JSON.stringify(allEmployees));
        
        renderEmployees();
      }
    }

    // è·å–æ‰€æœ‰å”¯ä¸€çš„å®¢æˆ·åç§°
    function getAllCustomers() {
      // ä»localStorageè¯»å–è®¢å•æ•°æ®
      let allOrders = JSON.parse(localStorage.getItem('orders')) || [];
      if (!Array.isArray(allOrders)) {
        allOrders = [];
      }
      
      // æå–æ‰€æœ‰å®¢æˆ·åç§°å¹¶å»é‡
      const customers = [...new Set(allOrders.map(order => order.customer).filter(Boolean))];
      return customers;
    }
    
    // æ˜¾ç¤ºå®¢æˆ·åç§°å»ºè®®åˆ—è¡¨
    function showCustomerSuggestions(inputValue) {
      const suggestionsList = document.getElementById('customer-suggestions');
      const allCustomers = getAllCustomers();
      
      // ç­›é€‰åŒ¹é…çš„å®¢æˆ·åç§°
      const filteredCustomers = allCustomers.filter(customer => 
        customer.toLowerCase().includes(inputValue.toLowerCase())
      );
      
      // æ¸…ç©ºå»ºè®®åˆ—è¡¨
      suggestionsList.innerHTML = '';
      
      if (filteredCustomers.length > 0 && inputValue.trim() !== '') {
        // åˆ›å»ºå»ºè®®åˆ—è¡¨é¡¹
        filteredCustomers.forEach(customer => {
          const item = document.createElement('div');
          item.className = 'suggestion-item';
          item.style.padding = '8px 12px';
          item.style.cursor = 'pointer';
          item.style.borderBottom = '1px solid #eee';
          item.style.transition = 'background-color 0.2s';
          item.textContent = customer;
          
          // æ·»åŠ é¼ æ ‡æ‚¬åœæ•ˆæœ
          item.addEventListener('mouseover', function() {
            this.style.backgroundColor = '#f5f5f5';
          });
          
          item.addEventListener('mouseout', function() {
            this.style.backgroundColor = '#fff';
          });
          
          // æ·»åŠ ç‚¹å‡»äº‹ä»¶
          item.addEventListener('click', function() {
            // å¡«å……å®¢æˆ·åç§°åˆ°è¾“å…¥æ¡†
            document.getElementById('order-customer').value = customer;
            // éšè—å»ºè®®åˆ—è¡¨
            suggestionsList.style.display = 'none';
          });
          
          suggestionsList.appendChild(item);
        });
        
        // æ˜¾ç¤ºå»ºè®®åˆ—è¡¨
        suggestionsList.style.display = 'block';
      } else {
        // éšè—å»ºè®®åˆ—è¡¨
        suggestionsList.style.display = 'none';
      }
    }
    
    // åˆå§‹åŒ–å®¢æˆ·è¾“å…¥æ¡†è‡ªåŠ¨å®ŒæˆåŠŸèƒ½
    function initCustomerAutoComplete() {
      const customerInput = document.getElementById('order-customer');
      const suggestionsList = document.getElementById('customer-suggestions');
      
      // ä¸ºå®¢æˆ·è¾“å…¥æ¡†æ·»åŠ inputäº‹ä»¶ç›‘å¬å™¨
      customerInput.addEventListener('input', function() {
        showCustomerSuggestions(this.value);
      });
      
      // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹éšè—å»ºè®®åˆ—è¡¨
      document.addEventListener('click', function(event) {
        if (!event.target.closest('.form-group')) {
          suggestionsList.style.display = 'none';
        }
      });
      
      // æ·»åŠ é”®ç›˜å¯¼èˆªæ”¯æŒ
      customerInput.addEventListener('keydown', function(event) {
        const items = suggestionsList.querySelectorAll('.suggestion-item');
        let activeItemIndex = -1;
        
        // æ‰¾åˆ°å½“å‰æ¿€æ´»çš„é¡¹
        items.forEach((item, index) => {
          if (item.classList.contains('active')) {
            activeItemIndex = index;
          }
        });
        
        switch (event.key) {
          case 'ArrowDown':
            event.preventDefault();
            // ç§»é™¤å½“å‰æ¿€æ´»é¡¹çš„æ ·å¼
            if (activeItemIndex !== -1) {
              items[activeItemIndex].classList.remove('active');
            }
            // æ¿€æ´»ä¸‹ä¸€é¡¹
            activeItemIndex = (activeItemIndex + 1) % items.length;
            items[activeItemIndex].classList.add('active');
            items[activeItemIndex].scrollIntoView({ block: 'nearest' });
            break;
            
          case 'ArrowUp':
            event.preventDefault();
            // ç§»é™¤å½“å‰æ¿€æ´»é¡¹çš„æ ·å¼
            if (activeItemIndex !== -1) {
              items[activeItemIndex].classList.remove('active');
            }
            // æ¿€æ´»ä¸Šä¸€é¡¹
            activeItemIndex = (activeItemIndex - 1 + items.length) % items.length;
            items[activeItemIndex].classList.add('active');
            items[activeItemIndex].scrollIntoView({ block: 'nearest' });
            break;
            
          case 'Enter':
            event.preventDefault();
            // é€‰æ‹©å½“å‰æ¿€æ´»çš„é¡¹
            if (activeItemIndex !== -1) {
              items[activeItemIndex].click();
            }
            break;
            
          case 'Escape':
            // éšè—å»ºè®®åˆ—è¡¨
            suggestionsList.style.display = 'none';
            break;
        }
      });
    }
    
    // æ˜¾ç¤ºæ–°å¢è®¢å•æ¨¡æ€æ¡†
    function showAddOrderModal() {
      // é‡ç½®è¡¨å•
      document.getElementById('order-form').reset();
      
      // è®¾ç½®é»˜è®¤è®¢å•æ—¥æœŸä¸ºä»Šå¤©
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('order-date').value = today;
      
      // æ¸…é™¤ç¼–è¾‘çŠ¶æ€ï¼ˆå¦‚æœæœ‰ï¼‰
      window.currentEditOrderId = null;
      document.querySelector('#add-order-modal h3').innerHTML = '<i class="fas fa-file-invoice"></i> æ–°å¢è®¢å•';
      
      // ç¡®ä¿æ¨¡æ€æ¡†æ ·å¼æ­£ç¡®
      const modal = document.getElementById('add-order-modal');
      // ä½¿ç”¨setAttributeæ¥æ·»åŠ !important
      modal.setAttribute('style', 'display: flex !important; justify-content: center; align-items: center; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000;');
      
      // åˆå§‹åŒ–å®¢æˆ·è¾“å…¥æ¡†è‡ªåŠ¨å®ŒæˆåŠŸèƒ½
      initCustomerAutoComplete();
    }

    // ä¿å­˜è®¢å•æ•°æ®
    function saveOrder() {
      // æ”¶é›†è¡¨å•æ•°æ®
      
      const orderData = {
        orderNo: document.getElementById('order-number').value.trim(),
        customer: document.getElementById('order-customer').value.trim(),
        product: document.getElementById('order-product').value,
        qty: parseInt(document.getElementById('order-quantity').value),
        price: 0, // è®¾ç½®é»˜è®¤ä»·æ ¼ä¸º0
        orderDate: document.getElementById('order-date').value,
        deliveryDate: document.getElementById('delivery-date').value,
        note: document.getElementById('order-note').value.trim()
      };
      
      // è‡ªåŠ¨è®¡ç®—è®¢å•çŠ¶æ€
      const today = new Date();
      const deliveryDate = new Date(orderData.deliveryDate);
      
      if (deliveryDate < today) {
        orderData.status = 'å·²äº¤ä»˜';
      } else {
        orderData.status = 'å¾…ç”Ÿäº§';
      }
      
      // æ•°æ®éªŒè¯
      if (!orderData.orderNo) {
        alert('è¯·è¾“å…¥è®¢å•å·ï¼');
        return;
      }
      if (!orderData.customer) {
        alert('è¯·è¾“å…¥å®¢æˆ·åç§°ï¼');
        return;
      }
      if (!orderData.product) {
        alert('è¯·é€‰æ‹©äº§å“åç§°ï¼');
        return;
      }
      if (isNaN(orderData.qty) || orderData.qty <= 0) {
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„è®¢å•æ•°é‡ï¼');
        return;
      }
      if (!orderData.orderDate) {
        alert('è¯·é€‰æ‹©è®¢å•æ—¥æœŸï¼');
        return;
      }
      if (!orderData.deliveryDate) {
        alert('è¯·é€‰æ‹©å‡ºè´§æ—¥æœŸï¼');
        return;
      }
      
      // è·å–ç°æœ‰è®¢å•æ•°æ®
      let allOrders = JSON.parse(localStorage.getItem('orders')) || [];
      if (!Array.isArray(allOrders)) {
        allOrders = [];
      }
      
      // æ£€æŸ¥è®¢å•å·æ˜¯å¦å·²å­˜åœ¨
      const existingOrderIndex = allOrders.findIndex(order => order.orderNo === orderData.orderNo);
      if (existingOrderIndex !== -1 && !window.currentEditOrderId) {
        alert('è®¢å•å·å·²å­˜åœ¨ï¼Œè¯·æ›´æ¢è®¢å•å·ï¼');
        return;
      }
      
      if (window.currentEditOrderId) {
        // ç¼–è¾‘æ¨¡å¼
        const editIndex = allOrders.findIndex(order => order.id === window.currentEditOrderId);
        if (editIndex !== -1) {
          // ç¡®ä¿ä¸ä¼šå› ä¸ºç¼–è¾‘è€Œåˆ›å»ºé‡å¤è®¢å•å·
          if (existingOrderIndex !== -1 && existingOrderIndex !== editIndex) {
            alert('ç¼–è¾‘åçš„è®¢å•å·å·²å­˜åœ¨ï¼');
            return;
          }
          allOrders[editIndex] = {...allOrders[editIndex], ...orderData};
        }
      } else {
        // æ–°å¢æ¨¡å¼
        // æ·»åŠ å”¯ä¸€ID
        orderData.id = allOrders.length > 0 ? Math.max(...allOrders.map(o => o.id || 0)) + 1 : 1;
        allOrders.push(orderData);
      }
      
      // ä¿å­˜åˆ°localStorage
      localStorage.setItem('orders', JSON.stringify(allOrders));
      
      // æ›´æ–°å…¨å±€orderDataå˜é‡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      if (typeof window.orderData !== 'undefined') {
        window.orderData = allOrders;
      }
      
      // åˆ·æ–°è®¢å•è¡¨æ ¼
      renderOrders();
      
      // å…³é—­æ¨¡æ€æ¡†
      closeModal('add-order-modal');
      
      // æç¤ºä¿å­˜æˆåŠŸ
      alert(window.currentEditOrderId ? 'è®¢å•ä¿¡æ¯æ›´æ–°æˆåŠŸï¼' : 'è®¢å•æ·»åŠ æˆåŠŸï¼');
    }

    // æ˜¾ç¤ºæ–°å¢å‘˜å·¥æ¨¡æ€æ¡†
     function showAddEmployeeModal() {
       // é‡ç½®è¡¨å•
       document.getElementById('employee-form').reset();
        
       // è®¾ç½®é»˜è®¤å…¥èŒæ—¥æœŸä¸ºä»Šå¤©
       const today = new Date().toISOString().split('T')[0];
       document.getElementById('emp-joindate').value = today;
        
       // æ¸…é™¤ç¼–è¾‘çŠ¶æ€
       window.currentEditEmpCode = null;
       document.querySelector('#add-employee-modal h3').innerHTML = '<i class="fas fa-user-plus"></i> æ–°å¢å‘˜å·¥';
       
       // åœ¨æ–°å¢æ¨¡å¼ä¸‹ï¼Œå·¥å·è¾“å…¥æ¡†è®¾ä¸ºä¸å¯ç¼–è¾‘
       const empCodeInput = document.getElementById('emp-code');
       empCodeInput.disabled = true;
        
       // ç¡®ä¿æ¨¡æ€æ¡†æ ·å¼æ­£ç¡®
       const modal = document.getElementById('add-employee-modal');
       // ä½¿ç”¨setAttributeæ¥æ·»åŠ !importantå¹¶åŒ…å«æ‰€æœ‰æ ·å¼
       modal.setAttribute('style', 'display: flex !important; justify-content: center; align-items: center; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000;')
     }
    
    // ç”Ÿæˆå‘˜å·¥å·¥å·
     function generateEmpCode() {
       // è·å–æ‰€å±å…¬å¸
       const company = document.getElementById('emp-company').value;
       
       // è·å–ç°æœ‰å‘˜å·¥æ•°æ®
       let allEmployees = JSON.parse(localStorage.getItem('employees'));
       if (!allEmployees || !Array.isArray(allEmployees)) {
         allEmployees = [...employees];
       }
       
       let newCode = '';
       
       if (company === 'å¤–æ¥äºº') {
         // å¤–æ¥äººå·¥å·ä»OTD001å¼€å§‹
         const otdCodes = allEmployees.filter(emp => emp.code && emp.code.startsWith('OTD'));
         if (otdCodes.length === 0) {
           newCode = 'OTD001';
         } else {
           // æå–æœ€å¤§çš„ç¼–å·
           const maxNumber = Math.max(...otdCodes.map(emp => {
             const number = emp.code.replace('OTD', '');
             return parseInt(number) || 0;
           }));
           newCode = 'OTD' + (maxNumber + 1).toString().padStart(3, '0');
         }
       } else if (company === 'æ— é”¡é¾™åŠ›') {
         // æ— é”¡é¾™åŠ›å·¥å·ä»00Xå¼€å§‹
         // è·å–æ‰€æœ‰3ä½æ•°å­—ä¸”å°äº100çš„å·¥å·
         const wxlCodes = allEmployees.filter(emp => {
           const code = emp.code;
           if (!code || code.startsWith('OTD')) return false;
           const num = parseInt(code);
           return !isNaN(num) && num >= 0 && num < 100;
         });
         if (wxlCodes.length === 0) {
           newCode = '001';
         } else {
           // æå–æœ€å¤§çš„ç¼–å·
           const maxNumber = Math.max(...wxlCodes.map(emp => parseInt(emp.code)));
           newCode = (maxNumber + 1).toString().padStart(3, '0');
         }
       } else if (company === 'æ™®åˆ©ç¾å¸¸å·') {
         // æ™®åˆ©ç¾å¸¸å·å·¥å·ä»10Xå¼€å§‹
         // è·å–æ‰€æœ‰3ä½æ•°å­—ä¸”åœ¨100-199ä¹‹é—´çš„å·¥å·
         const plmczCodes = allEmployees.filter(emp => {
           const code = emp.code;
           if (!code || code.startsWith('OTD')) return false;
           const num = parseInt(code);
           return !isNaN(num) && num >= 100 && num < 200;
         });
         if (plmczCodes.length === 0) {
           newCode = '101';
         } else {
           // æå–æœ€å¤§çš„ç¼–å·
           const maxNumber = Math.max(...plmczCodes.map(emp => parseInt(emp.code)));
           newCode = (maxNumber + 1).toString().padStart(3, '0');
         }
       } else if (company === 'æ™®åˆ©ç¾åŠ³åŠ¡æ´¾é£') {
         // æ™®åˆ©ç¾åŠ³åŠ¡æ´¾é£å·¥å·ä»20Xå¼€å§‹
         // è·å–æ‰€æœ‰3ä½æ•°å­—ä¸”åœ¨200-299ä¹‹é—´çš„å·¥å·
         const plmlsCodes = allEmployees.filter(emp => {
           const code = emp.code;
           if (!code || code.startsWith('OTD')) return false;
           const num = parseInt(code);
           return !isNaN(num) && num >= 200 && num < 300;
         });
         if (plmlsCodes.length === 0) {
           newCode = '201';
         } else {
           // æå–æœ€å¤§çš„ç¼–å·
           const maxNumber = Math.max(...plmlsCodes.map(emp => parseInt(emp.code)));
           newCode = (maxNumber + 1).toString().padStart(3, '0');
         }
       }
       
       // è®¾ç½®å·¥å·
       document.getElementById('emp-code').value = newCode;
     }

    // ä¿å­˜å‘˜å·¥ä¿¡æ¯
     function saveEmployee() {
       // æ”¶é›†è¡¨å•æ•°æ®
       const employeeData = {
         code: document.getElementById('emp-code').value.trim(),
         name: document.getElementById('emp-name').value.trim(),
         phone: document.getElementById('emp-phone').value.trim(),
         idCard: document.getElementById('emp-idcard').value.trim(),
         joinDate: document.getElementById('emp-joindate').value || '',
         leaveDate: document.getElementById('emp-leavedate').value || '',
         company: document.getElementById('emp-company').value,
         dept: document.getElementById('emp-dept').value.trim(),
         job: document.getElementById('emp-job').value.trim(),
         bankName: document.getElementById('emp-bank').value.trim(),
         bankAccount: document.getElementById('emp-card').value.trim(),
         remark: document.getElementById('emp-note').value.trim(),
         status: document.getElementById('emp-leavedate').value ? 'inactive' : 'active'
       };
        
       // è·å–ç°æœ‰å‘˜å·¥æ•°æ® - ä½¿ç”¨å…¨å±€employeeså˜é‡ä½œä¸ºé»˜è®¤å€¼
       let allEmployees = JSON.parse(localStorage.getItem('employees'));
       if (!allEmployees || !Array.isArray(allEmployees)) {
         // åªæœ‰å½“localStorageä¸­çš„employeesä¸å­˜åœ¨æˆ–ä¸æ˜¯æ•°ç»„æ—¶ï¼Œæ‰ä½¿ç”¨é»˜è®¤æ•°æ®
         allEmployees = [...employees];
       }
       
       if (window.currentEditEmpCode) {
          // ç¼–è¾‘æ¨¡å¼
          const index = allEmployees.findIndex(emp => emp.code === window.currentEditEmpCode);
          if (index !== -1) {
            allEmployees[index] = {...allEmployees[index], ...employeeData};
          } else {
            alert('æœªæ‰¾åˆ°è¦ç¼–è¾‘çš„å‘˜å·¥ä¿¡æ¯');
            return;
          }
        } else {
          // æ–°å¢æ¨¡å¼ - æ£€æŸ¥å·¥å·æ˜¯å¦å·²å­˜åœ¨
          if (allEmployees.some(emp => emp.code === employeeData.code)) {
            alert('å·¥å·å·²å­˜åœ¨ï¼Œè¯·æ›´æ¢å·¥å·ï¼');
            return;
          }
          // æ·»åŠ å”¯ä¸€ID
          employeeData.id = Math.max(...allEmployees.map(e => e.id || 0), 0) + 1;
          allEmployees.push(employeeData);
        }
       
       // ä¿å­˜åˆ°localStorage
       localStorage.setItem('employees', JSON.stringify(allEmployees));
       
       // æ›´æ–°å…¨å±€employeeså˜é‡
       employees = allEmployees;
       
       // åˆ·æ–°å‘˜å·¥åˆ—è¡¨
       renderEmployees();
       
       // å…³é—­æ¨¡æ€æ¡†
       closeModal('add-employee-modal');
       
       // æç¤ºä¿å­˜æˆåŠŸ
       alert(window.currentEditEmpCode ? 'å‘˜å·¥ä¿¡æ¯æ›´æ–°æˆåŠŸï¼' : 'å‘˜å·¥æ·»åŠ æˆåŠŸï¼');
     }

    // ä½¿å…¶åœ¨å…¨å±€ä½œç”¨åŸŸå¯ç”¨
     window.editEmployee = function(empCode) {
         // è·å–å‘˜å·¥æ•°æ® - ä¼˜å…ˆä»å…¨å±€employeeså˜é‡è·å–
         const employee = employees.find(emp => emp.code === empCode);
         
         if (employee) {
           // è®¾ç½®ç¼–è¾‘çŠ¶æ€
           currentEditEmpCode = empCode;
           document.querySelector('#add-employee-modal h3').innerHTML = '<i class="fas fa-edit"></i> ç¼–è¾‘å‘˜å·¥';
           
           // åœ¨ç¼–è¾‘æ¨¡å¼ä¸‹ï¼Œå·¥å·è¾“å…¥æ¡†è®¾ä¸ºå¯ç¼–è¾‘
           const empCodeInput = document.getElementById('emp-code');
           empCodeInput.disabled = false;
           
           // å¡«å……è¡¨å•æ•°æ®
           empCodeInput.value = employee.code;
           document.getElementById('emp-name').value = employee.name || '';
           document.getElementById('emp-phone').value = employee.phone || '';
           document.getElementById('emp-idcard').value = employee.idCard || '';
           document.getElementById('emp-joindate').value = employee.joinDate || '';
           document.getElementById('emp-leavedate').value = employee.leaveDate || '';
           document.getElementById('emp-company').value = employee.company || '';
           document.getElementById('emp-dept').value = employee.dept || '';
           document.getElementById('emp-job').value = employee.job || '';
           document.getElementById('emp-bank').value = employee.bankName || '';
           document.getElementById('emp-card').value = employee.bankAccount || '';
           document.getElementById('emp-note').value = employee.remark || '';
           
           // ç¡®ä¿æ¨¡æ€æ¡†æ ·å¼æ­£ç¡®
           const modal = document.getElementById('add-employee-modal');
           modal.setAttribute('style', 'display: flex !important; justify-content: center; align-items: center; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000;')
         } else {
           alert('æœªæ‰¾åˆ°è¯¥å‘˜å·¥ä¿¡æ¯');
         }
        }

    // ========== å¯¼å‡ºå‘˜å·¥ï¼ˆCSVæ ¼å¼ï¼‰ ==========
    function exportEmployees() {
      // æä¾›å¯¼å‡ºæ ¼å¼é€‰æ‹©
      const format = prompt('è¯·é€‰æ‹©å¯¼å‡ºæ ¼å¼ï¼š\n1. Excelæ ¼å¼ (æ¨è)\n2. CSVæ ¼å¼', '1');
      
      // å‡†å¤‡å¯¼å‡ºæ•°æ®
      const exportData = employees.map(e => ({
        'å·¥å·': e.code,
        'å§“å': e.name,
        'æ‰‹æœº': e.phone,
        'èº«ä»½è¯': e.idCard,
        'å…¥èŒæ—¥æœŸ': e.joinDate,
        'ç¦»èŒæ—¥æœŸ': e.leaveDate || '',
        'å…¬å¸': e.company,
        'éƒ¨é—¨': e.dept || 'æœªçŸ¥',
        'èŒä½': e.job || '',
        'å¼€æˆ·è¡Œ': e.bankName || '',
        'é“¶è¡Œå¡å·': e.bankAccount || '',
        'å¤‡æ³¨': e.remark || ''
      }));
      
      if (format === '1') {
        // Excelæ ¼å¼å¯¼å‡º
        try {
          // åˆ›å»ºå·¥ä½œç°¿
          const ws = XLSX.utils.json_to_sheet(exportData);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, "å‘˜å·¥ä¿¡æ¯");
          
          // å¯¼å‡ºæ–‡ä»¶
          const currentDate = new Date().toISOString().split('T')[0];
          XLSX.writeFile(wb, `å‘˜å·¥ä¿¡æ¯_${currentDate}.xlsx`);
          alert('Excelæ–‡ä»¶å¯¼å‡ºæˆåŠŸï¼');
        } catch (error) {
          console.error('Excelå¯¼å‡ºå¤±è´¥:', error);
          alert('Excelå¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
        }
      } else {
        // CSVæ ¼å¼å¯¼å‡º - æ·»åŠ UTF-8 BOMæ ‡è®°ä»¥è§£å†³ä¸­æ–‡ä¹±ç é—®é¢˜
        let csvContent = ["\uFEFFå·¥å·,å§“å,æ‰‹æœº,èº«ä»½è¯,å…¥èŒæ—¥æœŸ,ç¦»èŒæ—¥æœŸ,å…¬å¸,éƒ¨é—¨,èŒä½,å¼€æˆ·è¡Œ,é“¶è¡Œå¡å·,å¤‡æ³¨"].join('\n');
        
        // æ·»åŠ æ•°æ®è¡Œ
        employees.forEach(e => {
          // è½¬ä¹‰CSVä¸­çš„ç‰¹æ®Šå­—ç¬¦
          function escapeCSV(value) {
            if (value === null || value === undefined) return '';
            value = value.toString();
            if (value.includes(',') || value.includes('"') || value.includes('\n')) {
              return '"' + value.replace(/"/g, '""') + '"';
            }
            return value;
          }
          
          const row = [
            escapeCSV(e.code),
            escapeCSV(e.name),
            escapeCSV(e.phone),
            escapeCSV(e.idCard),
            escapeCSV(e.joinDate),
            escapeCSV(e.leaveDate || ''),
            escapeCSV(e.company),
            escapeCSV(e.dept),
            escapeCSV(e.job),
            escapeCSV(e.bankName),
            escapeCSV(e.bankAccount),
            escapeCSV(e.remark)
          ];
          csvContent += '\n' + row.join(',');
        });
        
        // åˆ›å»ºBlobå¹¶ä¸‹è½½
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", "å‘˜å·¥ä¿¡æ¯.csv");
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
    }

    // ========== å¯¼å…¥å‘˜å·¥ï¼ˆæ”¯æŒCSVã€XLSã€XLSXã€XLSMæ ¼å¼ï¼‰ ==========
    function handleFileUpload(e) {
      const file = e.target.files[0];
      if (!file) return;

      // æ£€æŸ¥æ–‡ä»¶ç±»å‹
      const fileType = file.name.split('.').pop().toLowerCase();
      if (!['csv', 'xlsx', 'xls', 'xlsm'].includes(fileType)) {
        alert('è¯·é€‰æ‹©CSVã€XLSã€XLSXæˆ–XLSMæ–‡ä»¶');
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          let data = [];
          
          if (fileType === 'csv') {
            // å¤„ç†CSVæ–‡ä»¶
            const text = e.target.result;
            // æŒ‰è¡Œåˆ†å‰²
            const rows = text.split(/\r\n|\r|\n/).filter(row => row.trim());
            
            if (rows.length > 0) {
              // è§£æè¡¨å¤´
              const headers = parseCSVLine(rows[0]).map(h => h.trim());
              
              // è§£ææ•°æ®è¡Œ
              for (let i = 1; i < rows.length; i++) {
                const rowData = parseCSVLine(rows[i]);
                if (rowData.length > 0) {
                  const record = {};
                  headers.forEach((header, index) => {
                    record[header] = rowData[index] || '';
                  });
                  data.push(record);
                }
              }
            }
          } else {
            // å¤„ç†Excelæ–‡ä»¶ï¼ˆXLSã€XLSXã€XLSMï¼‰
            const dataBuffer = new Uint8Array(e.target.result);
            const workbook = XLSX.read(dataBuffer, { type: 'array' });
            
            // è·å–ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            
            // è½¬æ¢ä¸ºJSON
            data = XLSX.utils.sheet_to_json(worksheet);
          }

          // CSVè§£æå‡½æ•°ï¼ˆç”¨äºCSVå¯¼å…¥ï¼‰
          function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let j = 0; j < line.length; j++) {
              const char = line[j];
              
              if (char === '"' && line[j+1] === '"') {
                // å¤„ç†åŒå¼•å·è½¬ä¹‰
                current += '"';
                j++; // è·³è¿‡ä¸‹ä¸€ä¸ªåŒå¼•å·
              } else if (char === '"') {
                inQuotes = !inQuotes;
              } else if (char === ',' && !inQuotes) {
                // åˆ†éš”ç¬¦ï¼Œç»“æŸå½“å‰å­—æ®µ
                result.push(current.trim());
                current = '';
              } else {
                current += char;
              }
            }
            result.push(current.trim());
            return result;
          }
          
          // è§£ææ•°æ®
          let importedCount = 0;
          let duplicateCount = 0;
          let skippedCount = 0;
          
          // è·å–ç°æœ‰æ•°æ®å¹¶ç¡®ä¿æ˜¯æ•°ç»„
          let allEmployees = JSON.parse(localStorage.getItem('employees')) || [];
          if (!Array.isArray(allEmployees)) {
            allEmployees = [];
          }
          
          // ç”¨äºæ£€æŸ¥å·¥å·é‡å¤
          const existingCodes = new Set(allEmployees.map(emp => emp.code));
          
          // è®¡ç®—æœ€å¤§ID
          const maxId = allEmployees.length > 0 ? Math.max(...allEmployees.map(emp => emp.id || 0)) : 0;
          
          // å­—æ®µæ˜ å°„è¡¨ï¼ˆæ”¯æŒä¸åŒè¡¨å¤´åç§°ï¼‰
          const fieldMap = {
            'å·¥å·': 'code',
            'å‘˜å·¥å·': 'code',
            'ç¼–å·': 'code',
            'å§“å': 'name',
            'å‘˜å·¥å§“å': 'name',
            'æ‰‹æœº': 'phone',
            'æ‰‹æœºå·': 'phone',
            'ç”µè¯': 'phone',
            'èº«ä»½è¯': 'idCard',
            'èº«ä»½è¯å·': 'idCard',
            'å…¥èŒæ—¥æœŸ': 'joinDate',
            'å…¥èŒ': 'joinDate',
            'ç¦»èŒæ—¥æœŸ': 'leaveDate',
            'ç¦»èŒ': 'leaveDate',
            'å…¬å¸': 'company',
            'æ‰€å±å…¬å¸': 'company',
            'éƒ¨é—¨': 'dept',
            'æ‰€å±éƒ¨é—¨': 'dept',
            'èŒä½': 'job',
            'å²—ä½': 'job',
            'å¼€æˆ·è¡Œ': 'bankName',
            'é“¶è¡Œ': 'bankName',
            'é“¶è¡Œå¡å·': 'bankAccount',
            'å¡å·': 'bankAccount',
            'å¤‡æ³¨': 'remark',
            'è¯´æ˜': 'remark'
          };
          
          // å¤„ç†æ¯æ¡è®°å½•
          for (let i = 0; i < data.length; i++) {
            const record = data[i];
            const newEmployee = {
              id: maxId + importedCount + 1,
              code: '',
              name: '',
              phone: '',
              idCard: '',
              joinDate: '',
              leaveDate: '',
              company: 'æœªçŸ¥',
              dept: 'æœªçŸ¥',
              job: '',
              bankName: '',
              bankAccount: '',
              remark: '',
              status: 'active'
            };
            
            // å°†Excelæ—¥æœŸåºåˆ—å·è½¬æ¢ä¸ºæ ‡å‡†æ—¥æœŸæ ¼å¼çš„å‡½æ•°
            function convertExcelDate(dateValue) {
              // æ£€æŸ¥æ˜¯å¦ä¸ºæ•°å­—æ ¼å¼çš„æ—¥æœŸï¼ˆExcelåºåˆ—å·ï¼‰
              if (typeof dateValue === 'number' && !isNaN(dateValue) && dateValue > 0 && dateValue < 100000) {
                // Excelæ—¥æœŸåºåˆ—å·è½¬æ¢ä¸ºJavaScriptæ—¥æœŸ
                const date = new Date(Math.round((dateValue - 25569) * 86400 * 1000));
                return date.toISOString().split('T')[0]; // è¿”å›YYYY-MM-DDæ ¼å¼
              }
              return dateValue;
            }
            
            // æ ¹æ®è¡¨å¤´è‡ªåŠ¨åŒ¹é…å­—æ®µ
            let hasCode = false;
            for (const [header, value] of Object.entries(record)) {
              const cleanHeader = header.trim();
              const fieldName = fieldMap[cleanHeader];
              
              if (fieldName) {
                let processedValue = value;
                
                // å¯¹æ—¥æœŸå­—æ®µè¿›è¡ŒExcelåºåˆ—å·è½¬æ¢
                if (fieldName === 'joinDate' || fieldName === 'leaveDate') {
                  processedValue = convertExcelDate(value);
                }
                
                const cleanValue = typeof processedValue === 'string' ? processedValue.trim() : String(processedValue || '');
                newEmployee[fieldName] = cleanValue;
                
                // æ£€æŸ¥æ˜¯å¦æœ‰å·¥å·
                if (fieldName === 'code' && cleanValue) {
                  hasCode = true;
                }
              }
            }
            
            // å¿…é¡»æœ‰å·¥å·æ‰å¯¼å…¥
            if (!hasCode || !newEmployee.code) {
              skippedCount++;
              continue;
            }
            
            // æ£€æŸ¥å·¥å·æ˜¯å¦é‡å¤
            if (existingCodes.has(newEmployee.code)) {
              duplicateCount++;
              continue;
            }
            
            // è®¾ç½®çŠ¶æ€ï¼ˆæœ‰ç¦»èŒæ—¥æœŸåˆ™ä¸ºç¦»èŒï¼‰
            if (newEmployee.leaveDate) {
              newEmployee.status = 'inactive';
            }
            
            // æ·»åŠ åˆ°æ•°ç»„
            employees.push(newEmployee);
            allEmployees.push(newEmployee);
            existingCodes.add(newEmployee.code);
            importedCount++;
          }
          
          // ä¿å­˜åˆ°localStorage
          localStorage.setItem('employees', JSON.stringify(allEmployees));
          
          closeModal('import-modal');
          renderEmployees();
          
          let message = `æˆåŠŸå¯¼å…¥ ${importedCount} æ¡å‘˜å·¥æ•°æ®ï¼`;
          if (duplicateCount > 0) {
            message += `ï¼ˆè·³è¿‡ ${duplicateCount} æ¡é‡å¤å·¥å·çš„è®°å½•ï¼‰`;
          }
          if (skippedCount > 0) {
            message += `ï¼ˆè·³è¿‡ ${skippedCount} æ¡æ— æ•ˆæˆ–ç¼ºå°‘å·¥å·çš„è®°å½•ï¼‰`;
          }
          alert(message);
        } catch (err) {
          alert("æ–‡ä»¶è§£æå¤±è´¥ï¼š" + err.message);
        }
      };
      
      // å¯¹äºCSVæ–‡ä»¶ï¼Œä½¿ç”¨æ–‡æœ¬æ¨¡å¼è¯»å–
      if (fileType === 'csv') {
        reader.readAsText(file, 'UTF-8');
      } else {
        reader.readAsArrayBuffer(file);
      }
    }



    // ========== æ¸²æŸ“å…¶ä»–è¡¨æ ¼ï¼ˆç®€åŒ–ï¼‰==========
    // åˆ›å»ºç¼–è¾‘å·¥èµ„è®°å½•çš„æ¨¡æ€æ¡†HTML
    const editWageModalHTML = `
    <div id="edit-wage-modal" class="modal" style="display: none;">
      <div class="modal-content">
        <div class="modal-header">
          <h3><i class="fas fa-edit"></i> ç¼–è¾‘å·¥èµ„è®°å½•</h3>
          <button class="close-btn" onclick="closeEditWageModal()">&times;</button>
        </div>
        <div class="modal-body">
          <form id="edit-wage-form">
            <input type="hidden" id="edit-wage-id">
            <div class="form-row">
              <div class="form-group">
                <label>æ—¥æœŸ</label>
                <input type="date" id="edit-date" required>
              </div>
              <div class="form-group">
                <label>å§“å</label>
                <input type="text" id="edit-employee-name" required>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>å®¢æˆ·</label>
                <input type="text" id="edit-client">
              </div>
              <div class="form-group">
                <label>è®¢å•å·</label>
                <input type="text" id="edit-order-number">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>å·¥åºåç§°</label>
                <input type="text" id="edit-process-name" required>
              </div>
              <div class="form-group">
                <label>å·¥ç§</label>
                <input type="text" id="edit-work-type">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>å•ä»·</label>
                <input type="number" id="edit-piece-rate" step="0.01" min="0" required>
              </div>
              <div class="form-group">
                <label>æ•°é‡</label>
                <input type="number" id="edit-quantity" min="1" required>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>è€ƒå‹¤å¥–</label>
                <input type="number" id="edit-attendance-bonus" step="0.01" min="0" value="0">
              </div>
              <div class="form-group">
                <label>æˆ¿è´´</label>
                <input type="number" id="edit-housing-allowance" step="0.01" min="0" value="0">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>å…¶å®ƒè¡¥è´´</label>
                <input type="number" id="edit-other-subsidy" step="0.01" min="0" value="0">
              </div>
            </div>
            <div class="form-group">
              <label>å¤‡æ³¨</label>
              <textarea id="edit-remark" rows="3"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="button default" onclick="closeEditWageModal()">å–æ¶ˆ</button>
          <button class="button primary" onclick="saveEditedWage()">ä¿å­˜</button>
        </div>
      </div>
    </div>
    `;

    // å°†æ¨¡æ€æ¡†æ·»åŠ åˆ°body
    document.body.insertAdjacentHTML('beforeend', editWageModalHTML);

    // æ·»åŠ æ¨¡æ€æ¡†æ ·å¼
    const modalStyles = document.createElement('style');
    modalStyles.textContent = `
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: white;
      border-radius: 8px;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    .modal-header {
      padding: 15px 20px;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-header h3 {
      margin: 0;
      color: #2c3e50;
    }
    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #999;
    }
    .close-btn:hover {
      color: #333;
    }
    .modal-body {
      padding: 20px;
    }
    .modal-footer {
      padding: 15px 20px;
      border-top: 1px solid #ddd;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    .form-row {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
    }
    .form-group {
      flex: 1;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #555;
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .form-group textarea {
      resize: vertical;
    }
    `;
    document.head.appendChild(modalStyles);

    // ç¼–è¾‘å·¥èµ„è®°å½•
    function editWage(id) {
      const wageDetails = JSON.parse(localStorage.getItem('wageDetails') || '[]');
      const record = wageDetails.find(r => r.id === id);
      if (record) {
        // å¡«å……è¡¨å•æ•°æ®
        document.getElementById('edit-wage-id').value = record.id;
        document.getElementById('edit-date').value = record.date;
        document.getElementById('edit-employee-name').value = record.employeeName;
        document.getElementById('edit-client').value = record.client || '';
        document.getElementById('edit-order-number').value = record.orderNumber || '';
        document.getElementById('edit-process-name').value = record.processName;
        document.getElementById('edit-work-type').value = record.workType || '';
        document.getElementById('edit-piece-rate').value = record.pieceRate;
        document.getElementById('edit-quantity').value = record.quantity;
        document.getElementById('edit-attendance-bonus').value = record.attendanceBonus || 0;
        document.getElementById('edit-housing-allowance').value = record.housingAllowance || 0;
        document.getElementById('edit-other-subsidy').value = record.otherSubsidy || 0;
        document.getElementById('edit-remark').value = record.remark || '';
        
        // æ˜¾ç¤ºæ¨¡æ€æ¡†
      const modal = document.getElementById('edit-wage-modal');
      modal.setAttribute('style', 'display: flex !important; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); justify-content: center; align-items: center; z-index: 1000;')
      }
    }

    // å…³é—­ç¼–è¾‘å·¥èµ„æ¨¡æ€æ¡†
    window.closeEditWageModal = function() {
      const modal = document.getElementById('edit-wage-modal');
      modal.setAttribute('style', 'display: none !important;');
    }

    // ä¿å­˜ç¼–è¾‘åçš„å·¥èµ„è®°å½•
    window.saveEditedWage = function() {
      const id = document.getElementById('edit-wage-id').value;
      const wageDetails = JSON.parse(localStorage.getItem('wageDetails') || '[]');
      const recordIndex = wageDetails.findIndex(r => r.id === id);
      
      if (recordIndex !== -1) {
        const pieceRate = parseFloat(document.getElementById('edit-piece-rate').value);
        const quantity = parseInt(document.getElementById('edit-quantity').value);
        const attendanceBonus = parseFloat(document.getElementById('edit-attendance-bonus').value);
        const housingAllowance = parseFloat(document.getElementById('edit-housing-allowance').value);
        const otherSubsidy = parseFloat(document.getElementById('edit-other-subsidy').value);
        
        // è®¡ç®—é‡‘é¢
        const amount = pieceRate * quantity + attendanceBonus + housingAllowance + otherSubsidy;
        
        // æ›´æ–°è®°å½•
        wageDetails[recordIndex] = {
          ...wageDetails[recordIndex],
          date: document.getElementById('edit-date').value,
          employeeName: document.getElementById('edit-employee-name').value,
          client: document.getElementById('edit-client').value,
          orderNumber: document.getElementById('edit-order-number').value,
          processName: document.getElementById('edit-process-name').value,
          workType: document.getElementById('edit-work-type').value,
          pieceRate: pieceRate,
          quantity: quantity,
          attendanceBonus: attendanceBonus,
          housingAllowance: housingAllowance,
          otherSubsidy: otherSubsidy,
          amount: amount,
          remark: document.getElementById('edit-remark').value
        };
        
        // ä¿å­˜åˆ°localStorage
        localStorage.setItem('wageDetails', JSON.stringify(wageDetails));
        
        // é‡æ–°æ¸²æŸ“è¡¨æ ¼
        renderPiecework();
        
        // å…³é—­æ¨¡æ€æ¡†
        closeEditWageModal();
        
        // æ˜¾ç¤ºæˆåŠŸæç¤º
        showToast('è®°å½•å·²æˆåŠŸæ›´æ–°', 'success');
      } else {
        showToast('æœªæ‰¾åˆ°è¦æ›´æ–°çš„è®°å½•', 'error');
      }
    }
    
    // åˆ é™¤å·¥èµ„è®°å½•
    function deleteWage(id) {
      if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) {
        try {
          const wageDetails = JSON.parse(localStorage.getItem('wageDetails') || '[]');
          const updatedDetails = wageDetails.filter(r => r.id !== id);
          localStorage.setItem('wageDetails', JSON.stringify(updatedDetails));
          renderPiecework(); // é‡æ–°æ¸²æŸ“è¡¨æ ¼
          showToast('è®°å½•å·²åˆ é™¤', 'success');
        } catch (error) {
          console.error('åˆ é™¤å¤±è´¥:', error);
          showToast('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
        }
      }
    }
    
    // æ¸…ç©ºæ‰€æœ‰è®¡ä»¶å·¥èµ„è®°å½•
    function clearAllPiecework() {
      // æ·»åŠ ç¡®è®¤å¯¹è¯æ¡†é˜²æ­¢è¯¯æ“ä½œ
      if (confirm('è­¦å‘Šï¼šæ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤æ‰€æœ‰è®¡ä»¶å·¥èµ„è®°å½•ï¼Œä¸”æ— æ³•æ¢å¤ã€‚ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
        try {
          // æ¸…ç©ºlocalStorageä¸­çš„wageDetailsæ•°æ®
          localStorage.removeItem('wageDetails');
          // é‡æ–°æ¸²æŸ“è¡¨æ ¼ï¼Œæ˜¾ç¤ºä¸ºç©º
          renderPiecework();
          // æ˜¾ç¤ºæ“ä½œæˆåŠŸæç¤º
          showToast('æ‰€æœ‰è®°å½•å·²æ¸…ç©º', 'success');
        } catch (error) {
          console.error('æ¸…ç©ºå¤±è´¥:', error);
          showToast('æ¸…ç©ºå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
        }
      }
    }
    
    // ç»‘å®šæ¸…ç©ºæŒ‰é’®äº‹ä»¶
      document.getElementById('clear-all-pw').onclick = clearAllPiecework;
      
      function renderPiecework(searchKeyword = '', startDate = '', endDate = '') {
        // ä»localStorageè¯»å–wageDetailsæ•°æ®
        let wageDetails = JSON.parse(localStorage.getItem('wageDetails') || '[]');
        
        // æŒ‰æ—¥æœŸå€’åºæ’åºæ•°æ®
        wageDetails.sort((a, b) => {
          const dateA = new Date(a.date);
          const dateB = new Date(b.date);
          return dateB - dateA; // å€’åºæ’åˆ—
        });
        
        // åº”ç”¨æ—¥æœŸèŒƒå›´ç­›é€‰
        if (startDate || endDate) {
          wageDetails = wageDetails.filter(record => {
            if (!record.date) return false;
            const recordDate = new Date(record.date);
            if (startDate && recordDate < new Date(startDate)) return false;
            if (endDate && recordDate > new Date(endDate)) return false;
            return true;
          });
        }
        
        // å¦‚æœæœ‰æœç´¢å…³é”®è¯ï¼Œè¿›è¡Œç­›é€‰
        if (searchKeyword.trim()) {
          const keyword = searchKeyword.toLowerCase().trim();
          wageDetails = wageDetails.filter(record => {
            // æœç´¢æ‰€æœ‰å­—æ®µ
            return (
              (record.date && record.date.toLowerCase().includes(keyword)) ||
              (record.employeeName && record.employeeName.toLowerCase().includes(keyword)) ||
              (record.client && record.client.toLowerCase().includes(keyword)) ||
              (record.orderNumber && record.orderNumber.toLowerCase().includes(keyword)) ||
              (record.processName && record.processName.toLowerCase().includes(keyword)) ||
              (record.workType && record.workType.toLowerCase().includes(keyword)) ||
              (record.pieceRate !== undefined && record.pieceRate.toString().includes(keyword)) ||
              (record.quantity !== undefined && record.quantity.toString().includes(keyword)) ||
              (record.attendanceBonus !== undefined && record.attendanceBonus.toString().includes(keyword)) ||
              (record.housingAllowance !== undefined && record.housingAllowance.toString().includes(keyword)) ||
              (record.otherSubsidy !== undefined && record.otherSubsidy.toString().includes(keyword)) ||
              (record.amount !== undefined && record.amount.toString().includes(keyword)) ||
              (record.remark && record.remark.toLowerCase().includes(keyword))
            );
          });
        }
        
        // ç­›é€‰æŒ‰é’®äº‹ä»¶å¤„ç†
        document.getElementById('filter-pw').onclick = function() {
          const searchInput = document.getElementById('pw-search').value;
          const startDate = document.getElementById('start-date').value;
          const endDate = document.getElementById('end-date').value;
          renderPiecework(searchInput, startDate, endDate);
        };
        
        // é‡ç½®æŒ‰é’®äº‹ä»¶å¤„ç†
        document.getElementById('reset-pw').onclick = function() {
          document.getElementById('pw-search').value = '';
          document.getElementById('start-date').value = '';
          document.getElementById('end-date').value = '';
          renderPiecework(); // æ— å‚æ•°è°ƒç”¨è¡¨ç¤ºæ˜¾ç¤ºæ‰€æœ‰æ•°æ®
        };
        
        // æœç´¢è¾“å…¥æ¡†å›è½¦äº‹ä»¶
        document.getElementById('pw-search').onkeypress = function(e) {
          if (e.key === 'Enter') {
            const searchInput = document.getElementById('pw-search').value;
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            renderPiecework(searchInput, startDate, endDate);
          }
        };
        
        const tbody = document.querySelector('#piecework-table tbody');
        
        // å¤„ç†ç©ºæ•°æ®æƒ…å†µ
        if (wageDetails.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="14" style="text-align: center; padding: 20px; color: #999;">
                ${searchKeyword ? 'æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„è®°å½•' : 'æš‚æ— æ•°æ®'}
              </td>
            </tr>
          `;
        } else {
          tbody.innerHTML = wageDetails.map(p => `
          <tr>
            <td>${p.date || '-'}</td>
            <td>${p.employeeName || '-'}</td>
            <td>${p.client || '-'}</td>
            <td>${p.orderNumber || '-'}</td>
            <td>${p.processName || '-'}</td>
            <td>${p.workType || '-'}</td>
            <td>Â¥${p.pieceRate ? p.pieceRate.toFixed(2) : '0.00'}</td>
            <td>${p.quantity || '0'}</td>
            <td>Â¥${p.attendanceBonus ? p.attendanceBonus.toFixed(2) : '0.00'}</td>
            <td>Â¥${p.housingAllowance ? p.housingAllowance.toFixed(2) : '0.00'}</td>
            <td>Â¥${p.otherSubsidy ? p.otherSubsidy.toFixed(2) : '0.00'}</td>
            <td>Â¥${p.amount ? p.amount.toFixed(2) : '0.00'}</td>
            <td>${p.remark || '-'}</td>
            <td class="table-actions">
              <button class="button default" onclick="editWage('${p.id}')" title="ç¼–è¾‘"><i class="fas fa-edit"></i></button>
              <button class="button danger" onclick="deleteWage('${p.id}')" title="åˆ é™¤"><i class="fas fa-trash"></i></button>
            </td>
          </tr>
        `).join('');
        }
        
        // è®¡ç®—åˆè®¡å€¼
        let totalQuantity = 0;
        let totalAttendanceBonus = 0;
        let totalHousingAllowance = 0;
        let totalOtherSubsidy = 0;
        let totalAmount = 0;
        
        wageDetails.forEach(p => {
          totalQuantity += parseFloat(p.quantity) || 0;
          totalAttendanceBonus += parseFloat(p.attendanceBonus) || 0;
          totalHousingAllowance += parseFloat(p.housingAllowance) || 0;
          totalOtherSubsidy += parseFloat(p.otherSubsidy) || 0;
          totalAmount += parseFloat(p.amount) || 0;
        });
        
        // æ·»åŠ åˆè®¡è¡Œ
        const totalRow = document.createElement('tr');
        totalRow.className = 'total-row';
        totalRow.innerHTML = `
          <td colspan="7" style="text-align: right; font-weight: bold; padding: 8px 12px; background-color: #f8f9fa;">åˆè®¡ï¼š</td>
          <td style="text-align: left; font-weight: bold; padding: 8px 12px; background-color: #f8f9fa;">${totalQuantity}</td>
          <td style="text-align: left; font-weight: bold; padding: 8px 12px; background-color: #f8f9fa;">Â¥${totalAttendanceBonus.toFixed(2)}</td>
          <td style="text-align: left; font-weight: bold; padding: 8px 12px; background-color: #f8f9fa;">Â¥${totalHousingAllowance.toFixed(2)}</td>
          <td style="text-align: left; font-weight: bold; padding: 8px 12px; background-color: #f8f9fa;">Â¥${totalOtherSubsidy.toFixed(2)}</td>
          <td style="text-align: left; font-weight: bold; padding: 8px 12px; background-color: #f8f9fa;">Â¥${totalAmount.toFixed(2)}</td>
          <td colspan="2" style="background-color: #f8f9fa;"></td>
        `;
        
        tbody.appendChild(totalRow);
        
        document.getElementById('pw-total').textContent = wageDetails.length;
      }

      // æœç´¢è¾“å…¥æ¡†äº‹ä»¶å¤„ç†
      document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('pw-search');
        if (searchInput) {
          // è¾“å…¥äº‹ä»¶å¤„ç†
          searchInput.addEventListener('input', function(e) {
            const searchKeyword = e.target.value;
            renderPiecework(searchKeyword);
          });
          
          // ç­›é€‰æŒ‰é’®äº‹ä»¶å¤„ç†
          const filterButton = document.getElementById('filter-pw');
          if (filterButton) {
            filterButton.addEventListener('click', function() {
              const searchKeyword = searchInput.value;
              renderPiecework(searchKeyword);
            });
          }
        }
      });

    // æ ¹æ®è®¢å•çŠ¶æ€è¿”å›ç›¸åº”çš„æ ·å¼
    function getOrderStatusStyle(status) {
      switch(status) {
        case 'å¾…ç”Ÿäº§':
          return 'background-color: #ffcccc; color: #cc0000; padding: 4px 8px; border-radius: 4px;';
        case 'ç”Ÿäº§ä¸­':
          return 'background-color: #ccccff; color: #0000cc; padding: 4px 8px; border-radius: 4px;';
        case 'å·²å®Œæˆ':
          return 'background-color: #ccffcc; color: #006600; padding: 4px 8px; border-radius: 4px;';
        default:
          return '';
      }
    }

    function renderOrders() {
      // ä»localStorageè¯»å–è®¢å•æ•°æ®
      let allOrders = JSON.parse(localStorage.getItem('orders')) || [];
      if (!Array.isArray(allOrders)) {
        allOrders = [];
      }
      
      // ä»localStorageè¯»å–è®¡ä»¶å·¥èµ„æ•°æ®
      const wageDetails = JSON.parse(localStorage.getItem('wageDetails')) || [];
      
      // ä¸ºæ¯ä¸ªè®¢å•æŸ¥æ‰¾åœ¨è®¡ä»¶å·¥èµ„ä¸­å¯¹åº”è®¢å•å·çš„æœ€æ—©æ—¥æœŸã€è®¡ç®—çŠ¶æ€å’ŒåŠ å·¥å•ä»·
      allOrders = allOrders.map(order => {
        // æŸ¥æ‰¾æ‰€æœ‰åŒ¹é…å½“å‰è®¢å•å·çš„å·¥èµ„è®°å½•
        const matchingWages = wageDetails.filter(
          wage => wage.orderNumber && wage.orderNumber === order.orderNo
        );
        
        // è®¡ç®—è¯¥è®¢å•å·ä¸‹æ‰€æœ‰è®¡ä»¶å·¥èµ„çš„é‡‘é¢æ€»å’Œ
        let totalAmount = 0;
        if (matchingWages.length > 0) {
          totalAmount = matchingWages.reduce((sum, wage) => {
            // ä»å·¥èµ„è®°å½•ä¸­è·å–é‡‘é¢ï¼ˆå¯èƒ½ä½¿ç”¨ä¸åŒçš„å­—æ®µåï¼‰
            const amount = parseFloat(wage.amount || wage.é‡‘é¢ || 0);
            return sum + (isNaN(amount) ? 0 : amount);
          }, 0);
        }
        
        // è®¡ç®—åŠ å·¥å•ä»·ï¼šé‡‘é¢æ€»å’Œ / è®¢å•æ•°é‡
        const orderQuantity = parseInt(order.qty || 0);
        const processingPrice = orderQuantity > 0 ? totalAmount / orderQuantity : 0;
        
        // è®¡ç®—å¼€å§‹æ—¥æœŸ
        let startDate = order.startDate;
        if (matchingWages.length > 0) {
          // æŒ‰æ—¥æœŸå‡åºæ’åºï¼ˆæœ€æ—©çš„åœ¨å‰ï¼‰
          matchingWages.sort((a, b) => new Date(a.date) - new Date(b.date));
          // æ›´æ–°è®¢å•çš„å¼€å§‹æ—¥æœŸä¸ºæœ€æ—©çš„æ—¥æœŸ
          startDate = matchingWages[0].date;
        }
        
        // è®¡ç®—è®¢å•çŠ¶æ€
        let status = 'å¾…ç”Ÿäº§'; // é»˜è®¤çŠ¶æ€
        
        if (startDate) { // å¼€å§‹æ—¥æœŸä¸ä¸ºç©º
          // æ£€æŸ¥æ˜¯å¦åŒ…å«å¸¦"ç®±"å­—çš„å·¥åº
          const hasBoxProcess = matchingWages.some(
            wage => wage.processName && wage.processName.includes('ç®±')
          );
          
          if (hasBoxProcess) {
            status = 'å·²å®Œæˆ';
          } else {
            status = 'ç”Ÿäº§ä¸­';
          }
        }
        
        // è¿”å›æ›´æ–°åçš„è®¢å•ä¿¡æ¯
        return {
          ...order,
          startDate: startDate,
          status: status,
          price: processingPrice // ä½¿ç”¨è®¡ç®—å¾—åˆ°çš„åŠ å·¥å•ä»·
        };
      });
      
      // æ›´æ–°localStorageä¸­çš„è®¢å•æ•°æ®ï¼Œä¿å­˜åŠ¨æ€è®¡ç®—çš„çŠ¶æ€
      localStorage.setItem('orders', JSON.stringify(allOrders));
      
      // åŒæ—¶æ›´æ–°productionOrderListï¼Œç¡®ä¿ç”Ÿäº§è®¡åˆ’å®‰æ’é¡µé¢èƒ½è·å–æœ€æ–°çŠ¶æ€
      const productionOrders = allOrders.map(order => ({
        orderNumber: order.orderNo,
        quantity: order.qty,
        status: order.status
      }));
      localStorage.setItem('productionOrderList', JSON.stringify(productionOrders));
      
      // æœç´¢å’Œç­›é€‰åŠŸèƒ½
      const searchTerm = document.getElementById('order-search').value.toLowerCase().trim();
      const statusFilter = document.getElementById('order-status').value;
      const startDateFilter = document.getElementById('start-delivery-date').value;
      const endDateFilter = document.getElementById('end-delivery-date').value;
      
      // è¿‡æ»¤è®¢å•æ•°æ®
      let filteredOrders = allOrders;
      
      // åº”ç”¨æœç´¢ç­›é€‰
      if (searchTerm) {
        filteredOrders = filteredOrders.filter(order => {
          // å¯¹æ‰€æœ‰å¯èƒ½çš„å­—æ®µè¿›è¡Œæœç´¢
          return (
            (order.orderNo && order.orderNo.toLowerCase().includes(searchTerm)) ||
            (order.customer && order.customer.toLowerCase().includes(searchTerm)) ||
            (order.product && order.product.toLowerCase().includes(searchTerm)) ||
            (order.status && order.status.toLowerCase().includes(searchTerm)) ||
            (order.qty && order.qty.toString().includes(searchTerm)) ||
            (order.price && order.price.toString().includes(searchTerm)) ||
            (order.orderDate && order.orderDate.toLowerCase().includes(searchTerm)) ||
            (order.startDate && order.startDate.toLowerCase().includes(searchTerm)) ||
            (order.deliveryDate && order.deliveryDate.toLowerCase().includes(searchTerm)) ||
            (order.note && order.note.toLowerCase().includes(searchTerm))
          );
        });
      }
      
      // åº”ç”¨çŠ¶æ€ç­›é€‰
      if (statusFilter && statusFilter !== 'å…¨éƒ¨çŠ¶æ€') {
        filteredOrders = filteredOrders.filter(order => order.status === statusFilter);
      }
      
      // åº”ç”¨æ—¥æœŸç­›é€‰
      if (startDateFilter || endDateFilter) {
        filteredOrders = filteredOrders.filter(order => {
          // ç¡®ä¿order.deliveryDateæ˜¯æœ‰æ•ˆçš„æ—¥æœŸå­—ç¬¦ä¸²
          if (!order.deliveryDate) return false;
          
          const deliveryDate = new Date(order.deliveryDate);
          let startDate = null;
          let endDate = null;
          
          if (startDateFilter) {
            startDate = new Date(startDateFilter);
            // è®¾ç½®ä¸ºå½“å¤©çš„å¼€å§‹æ—¶é—´
            startDate.setHours(0, 0, 0, 0);
          }
          
          if (endDateFilter) {
            endDate = new Date(endDateFilter);
            // è®¾ç½®ä¸ºå½“å¤©çš„ç»“æŸæ—¶é—´
            endDate.setHours(23, 59, 59, 999);
          }
          
          // æ£€æŸ¥äº¤è´§æ—¥æœŸæ˜¯å¦åœ¨ç­›é€‰èŒƒå›´å†…
          let isInRange = true;
          if (startDate) {
            isInRange = isInRange && deliveryDate >= startDate;
          }
          if (endDate) {
            isInRange = isInRange && deliveryDate <= endDate;
          }
          
          return isInRange;
        });
      }
      
      // è®¡ç®—è®¢å•æ•°é‡åˆè®¡
      const totalQuantity = filteredOrders.reduce((sum, o) => sum + (parseInt(o.qty || 0) || 0), 0);
      
      const tbody = document.querySelector('#order-table tbody');
      tbody.innerHTML = filteredOrders.map(o => `
        <tr>
          <td>${o.orderNo || ''}</td>
          <td>${o.customer || ''}</td>
          <td>${o.product || ''}</td>
          <td style="${getOrderStatusStyle(o.status || 'å¾…ç”Ÿäº§')}">${o.status || 'å¾…ç”Ÿäº§'}</td>
          <td>${o.qty || 0}</td>
          <td>Â¥${(o.price || 0).toFixed(2)}</td>
          <td>${o.orderDate || ''}</td>
          <td>${o.startDate || '-'}</td>
          <td>${o.deliveryDate || ''}</td>
          <td>${o.note || ''}</td>
          <td class="table-actions">
            <button class="button default" onclick="editOrder(${o.id})" title="ç¼–è¾‘"><i class="fas fa-edit"></i></button>
            <button class="button danger" onclick="deleteOrder(${o.id})" title="åˆ é™¤"><i class="fas fa-trash-alt"></i></button>
          </td>
        </tr>
      `).join('');
      
      // æ·»åŠ åˆè®¡è¡Œ
      if (filteredOrders.length > 0) {
        const totalRow = document.createElement('tr');
        totalRow.style.backgroundColor = '#f5f5f5';
        totalRow.style.fontWeight = 'bold';
        
        // åˆ›å»ºç©ºå•å…ƒæ ¼å’Œåˆè®¡å•å…ƒæ ¼
        for (let i = 0; i < 4; i++) {
          const td = document.createElement('td');
          if (i === 0) {
            td.textContent = 'åˆè®¡';
            td.colSpan = 4;
            td.style.textAlign = 'right';
            td.style.paddingRight = '10px';
            i = 3; // è·³è¿‡åé¢3ä¸ªå•å…ƒæ ¼
          }
          totalRow.appendChild(td);
        }
        
        // è®¢å•æ•°é‡åˆè®¡å•å…ƒæ ¼
        const qtyTd = document.createElement('td');
        qtyTd.textContent = totalQuantity;
        qtyTd.style.textAlign = 'left';
        totalRow.appendChild(qtyTd);
        
        // å‰©ä½™ç©ºå•å…ƒæ ¼
        for (let i = 0; i < 6; i++) {
          const td = document.createElement('td');
          totalRow.appendChild(td);
        }
        
        tbody.appendChild(totalRow);
      }
    }

    function renderProcesses(searchTerm = '') {
      const tbody = document.querySelector('#process-table tbody');
      
      // æ ¹æ®æœç´¢è¯è¿‡æ»¤å·¥åºæ•°æ®
      let filteredProcesses = processList;
      if (searchTerm) {
        filteredProcesses = processList.filter(p => {
          // æœç´¢æ‰€æœ‰å¯èƒ½çš„å­—æ®µ
          return (
            (p.id && p.id.toString().toLowerCase().includes(searchTerm)) ||
            (p.name && p.name.toLowerCase().includes(searchTerm)) ||
            (p.pieceRate && p.pieceRate.toString().includes(searchTerm)) ||
            (p.timeRate && p.timeRate.toString().includes(searchTerm)) ||
            (p.quota && p.quota.toString().includes(searchTerm)) ||
            (p.note && p.note.toLowerCase().includes(searchTerm))
          );
        });
      }
      
      tbody.innerHTML = filteredProcesses.map(p => `
        <tr>
          <td>${p.id}</td>
          <td>${p.name}</td>
          <td>Â¥${p.pieceRate.toFixed(2)}</td>
          <td>${p.timeRate !== null ? `Â¥${p.timeRate.toFixed(2)}/h` : '-'}</td>
          <td>${p.quota}</td>
          <td>${p.note || ''}</td>
          <td class="table-actions">
            <button class="button default btn-icon" title="ç¼–è¾‘" onclick="editProcess('${p.id}')">
              <i class="fas fa-edit"></i>
            </button>
            <button class="button danger btn-icon" title="åˆ é™¤" onclick="deleteProcess('${p.id}')">
              <i class="fas fa-trash-alt"></i>
            </button>
          </td>
        </tr>
      `).join('');
    }

    // å…³é—­æ¨¡æ€æ¡†
    function closeModal(id) {
      const modal = document.getElementById(id);
      if (modal) {
        // ä½¿ç”¨setAttributeå¹¶æ·»åŠ !importantç¡®ä¿èƒ½è¦†ç›–CSSæ ·å¼
        modal.setAttribute('style', 'display: none !important;');
        // å¦‚æœæ˜¯å‘˜å·¥è¡¨å•æ¨¡æ€æ¡†ï¼ŒåŒæ—¶é‡ç½®è¡¨å•
        if (id === 'add-employee-modal') {
          const form = document.getElementById('employee-form');
          if (form) {
            form.reset();
          }
        }
        // å¦‚æœæ˜¯è®¢å•è¡¨å•æ¨¡æ€æ¡†ï¼ŒåŒæ—¶é‡ç½®è¡¨å•å¹¶æ¸…é™¤ç¼–è¾‘çŠ¶æ€
        else if (id === 'add-order-modal') {
          const form = document.getElementById('order-form');
          if (form) {
            form.reset();
          }
          // æ¸…é™¤ç¼–è¾‘çŠ¶æ€
          window.currentEditOrderId = null;
        }
      }
    }
    
    // å…³é—­å·¥åºå½•å…¥æ¨¡æ€æ¡†çš„ä¸“ç”¨å‡½æ•°
    function closeProcessEntryModal() {
      const modal = document.getElementById('process-entry-modal');
      if (modal) {
        // ä½¿ç”¨setAttributeå¹¶æ·»åŠ !importantç¡®ä¿èƒ½è¦†ç›–CSSæ ·å¼
        modal.setAttribute('style', 'display: none !important;');
        
        // åŒæ—¶éšè—æ¨¡æ€æ¡†å†…å®¹
        const modalContent = modal.querySelector('.modal-content');
        if (modalContent) {
          modalContent.setAttribute('style', 'display: none !important;');
        }
        
        // ç§»é™¤bodyä¸Šçš„modal-openç±»
        document.body.classList.remove('modal-open');
      }
    }
    
    // ç¼–è¾‘è®¢å•
    window.editOrder = function(orderId) {
      // ä»localStorageè¯»å–è®¢å•æ•°æ®
      let allOrders = JSON.parse(localStorage.getItem('orders')) || [];
      const order = allOrders.find(o => o.id === orderId);
      
      if (order) {
        // è®¾ç½®ç¼–è¾‘çŠ¶æ€
        window.currentEditOrderId = orderId;
        document.querySelector('#add-order-modal h3').innerHTML = '<i class="fas fa-edit"></i> ç¼–è¾‘è®¢å•';
        
        // å¡«å……è¡¨å•æ•°æ®
        document.getElementById('order-number').value = order.orderNo || '';
        document.getElementById('order-customer').value = order.customer || '';
        // ä¸ºä¸‹æ‹‰æ¡†è®¾ç½®é€‰ä¸­å€¼
        const productSelect = document.getElementById('order-product');
        if (productSelect) {
          productSelect.value = order.product || '';
        }
        document.getElementById('order-quantity').value = order.qty || '';
        document.getElementById('order-date').value = order.orderDate || '';
        document.getElementById('delivery-date').value = order.deliveryDate || '';
        document.getElementById('order-note').value = order.note || '';
        
        // æ˜¾ç¤ºæ¨¡æ€æ¡†
      const modal = document.getElementById('add-order-modal');
      modal.setAttribute('style', 'display: flex !important; justify-content: center; align-items: center; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000;')
      } else {
        alert('æœªæ‰¾åˆ°è¯¥è®¢å•ä¿¡æ¯');
      }
    };
    
    // åˆ é™¤è®¢å•
    window.deleteOrder = function(orderId) {
      if (confirm('ç¡®å®šè¦åˆ é™¤è¯¥è®¢å•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
        // ä»localStorageè¯»å–è®¢å•æ•°æ®
        let allOrders = JSON.parse(localStorage.getItem('orders')) || [];
        
        // è¿‡æ»¤æ‰è¦åˆ é™¤çš„è®¢å•
        allOrders = allOrders.filter(o => o.id !== orderId);
        
        // ä¿å­˜åˆ°localStorage
        localStorage.setItem('orders', JSON.stringify(allOrders));
        
        // åˆ·æ–°è®¢å•è¡¨æ ¼
        renderOrders();
        
        alert('è®¢å•å·²æˆåŠŸåˆ é™¤ï¼');
      }
    };
    
    // å·¥åºç®¡ç† - å¯¼å‡ºEXCELåŠŸèƒ½
    function exportProcesses() {
      try {
        console.log('å¼€å§‹å¯¼å‡ºå·¥åºæ•°æ®...');
        console.log('å½“å‰å·¥åºæ•°æ®:', processList);
        console.log('XLSXåº“æ˜¯å¦å¯ç”¨:', typeof XLSX !== 'undefined');
        
        // æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®å¯å¯¼å‡º
        if (!processList || processList.length === 0) {
          alert('æš‚æ— å·¥åºæ•°æ®å¯ä¾›å¯¼å‡ºï¼');
          return;
        }
        
        // å‡†å¤‡å¯¼å‡ºæ•°æ®
        const exportData = processList.map(p => ({
          'å·¥åºID': p.id,
          'å·¥åºåç§°': p.name,
          'è®¡ä»¶å•ä»·': p.pieceRate,
          'è®¡æ—¶å•ä»·': p.timeRate,
          'å®šé¢æ•°é‡': p.quota,
          'å¤‡æ³¨': p.note || ''
        }));
        
        console.log('å¯¼å‡ºæ•°æ®å‡†å¤‡å®Œæˆ:', exportData);
        
        // åˆ›å»ºå·¥ä½œç°¿
        const wb = XLSX.utils.book_new();
        
        // åˆ›å»ºå·¥ä½œè¡¨
        const ws = XLSX.utils.json_to_sheet(exportData, {
          header: ['å·¥åºID', 'å·¥åºåç§°', 'è®¡ä»¶å•ä»·', 'è®¡æ—¶å•ä»·', 'å®šé¢æ•°é‡', 'å¤‡æ³¨']
        });
        
        // è®¾ç½®åˆ—å®½
        ws['!cols'] = [
          { wch: 10 }, // å·¥åºID
          { wch: 15 }, // å·¥åºåç§°
          { wch: 10 }, // è®¡ä»¶å•ä»·
          { wch: 10 }, // è®¡æ—¶å•ä»·
          { wch: 10 }, // å®šé¢æ•°é‡
          { wch: 20 }  // å¤‡æ³¨
        ];
        
        // å°†å·¥ä½œè¡¨æ·»åŠ åˆ°å·¥ä½œç°¿
        XLSX.utils.book_append_sheet(wb, ws, 'å·¥åºæ•°æ®');
        
        // ç”Ÿæˆæ–‡ä»¶å
        const fileName = `å·¥åºæ•°æ®_${new Date().toLocaleDateString('zh-CN').replace(/\//g, '-')}.xlsx`;
        
        console.log('å‡†å¤‡å¯¼å‡ºæ–‡ä»¶:', fileName);
        
        // å¯¼å‡ºæ–‡ä»¶
        XLSX.writeFile(wb, fileName);
        
        alert(`å·¥åºæ•°æ®å·²æˆåŠŸå¯¼å‡ºä¸ºExcelæ–‡ä»¶ï¼`);
      } catch (error) {
        console.error('å¯¼å‡ºå¤±è´¥:', error);
        alert(`å¯¼å‡ºå¤±è´¥: ${error.message}\nè¯·æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ã€‚`);
      }
    }
    
    // å·¥åºç®¡ç† - å¯¼å…¥EXCELåŠŸèƒ½
    function importProcesses() {
      // åˆ›å»ºæ–‡ä»¶è¾“å…¥å…ƒç´ 
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = '.xlsx, .xls';
      
      // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
      fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        // æ£€æŸ¥æ–‡ä»¶ç±»å‹
        if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
          alert('è¯·é€‰æ‹©Excelæ–‡ä»¶ï¼ˆ.xlsxæˆ–.xlsæ ¼å¼ï¼‰ï¼');
          return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            // è¯»å–Excelæ–‡ä»¶
            const data = new Uint8Array(e.target.result);
            const wb = XLSX.read(data, { type: 'array' });
            
            // è·å–ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨
            const wsname = wb.SheetNames[0];
            const ws = wb.Sheets[wsname];
            
            // è½¬æ¢ä¸ºJSONæ ¼å¼
            const jsonData = XLSX.utils.sheet_to_json(ws);
            
            if (jsonData.length === 0) {
              alert('Excelæ–‡ä»¶ä¸­æ²¡æœ‰æ•°æ®ï¼');
              return;
            }
            
            // éªŒè¯è¡¨å¤´ï¼ˆå¢åŠ å®¹é”™å¤„ç†ï¼‰
            const requiredHeaders = ['å·¥åºID', 'å·¥åºåç§°', 'è®¡ä»¶å•ä»·', 'è®¡æ—¶å•ä»·', 'å®šé¢æ•°é‡'];
            const headers = Object.keys(jsonData[0]);
            
            // è¾“å‡ºè°ƒè¯•ä¿¡æ¯
            console.log('Excelæ–‡ä»¶ä¸­çš„è¡¨å¤´:', headers);
            
            // ä½¿ç”¨æ¨¡ç³ŠåŒ¹é…å’Œå®¹é”™å¤„ç†ï¼Œå»é™¤å¯èƒ½çš„ç©ºæ ¼å’Œä¸å¯è§å­—ç¬¦
            const missingHeaders = [];
            const headerMap = {};
            
            // é¢„å¤„ç†è¡¨å¤´ï¼Œå»é™¤ç©ºæ ¼å’Œä¸å¯è§å­—ç¬¦
            const normalizedHeaders = headers.map(h => h.trim().replace(/[\s\u00A0\u2000-\u200A\u2028\u2029]+/g, ''));
            console.log('æ ‡å‡†åŒ–åçš„è¡¨å¤´:', normalizedHeaders);
            
            // æ£€æŸ¥æ¯ä¸ªå¿…éœ€çš„è¡¨å¤´
            requiredHeaders.forEach(requiredHeader => {
              // æ ‡å‡†åŒ–å¿…éœ€çš„è¡¨å¤´
              const normalizedRequiredHeader = requiredHeader.trim().replace(/[\s\u00A0\u2000-\u200A\u2028\u2029]+/g, '');
              
              // æŸ¥æ‰¾åŒ¹é…çš„è¡¨å¤´
              const foundIndex = normalizedHeaders.findIndex(h => 
                h.includes(normalizedRequiredHeader) || 
                normalizedRequiredHeader.includes(h)
              );
              
              if (foundIndex === -1) {
                missingHeaders.push(requiredHeader);
              } else {
                // å­˜å‚¨åŸå§‹è¡¨å¤´å’ŒåŒ¹é…çš„è¡¨å¤´ä¹‹é—´çš„æ˜ å°„
                headerMap[requiredHeader] = headers[foundIndex];
              }
            });
            
            if (missingHeaders.length > 0) {
              alert(`Excelæ–‡ä»¶è¡¨å¤´éªŒè¯å¤±è´¥ï¼š${missingHeaders.join('ã€')}\n\nè¯·æ£€æŸ¥Excelæ–‡ä»¶è¡¨å¤´æ˜¯å¦æ­£ç¡®ï¼Œå¹¶ç¡®ä¿æ²¡æœ‰é¢å¤–çš„ç©ºæ ¼æˆ–æ ¼å¼é—®é¢˜ã€‚\n\nExcelä¸­çš„è¡¨å¤´ï¼š${headers.join('ã€')}`);
              return;
            }
            
            console.log('è¡¨å¤´æ˜ å°„å…³ç³»:', headerMap);
            
            // å¤„ç†å¯¼å…¥çš„æ•°æ®
            const importedProcesses = jsonData.map(row => {
              // ä½¿ç”¨headerMapè·å–æ­£ç¡®çš„åˆ—åï¼Œæˆ–å›é€€åˆ°åŸå§‹åˆ—å
              const getColumnValue = (headerKey, defaultValue = '') => {
                const actualHeader = headerMap[headerKey] || headerKey;
                const value = row[actualHeader];
                return value !== undefined ? value : defaultValue;
              };
              
              return {
                id: getColumnValue('å·¥åºID', '').toString().trim(),
                name: getColumnValue('å·¥åºåç§°', '').toString().trim(),
                pieceRate: parseFloat(getColumnValue('è®¡ä»¶å•ä»·', 0)) || 0,
                // å…è®¸è®¡æ—¶å•ä»·ä¸ºç©ºï¼Œåªæœ‰åœ¨æœ‰å€¼æ—¶æ‰è½¬æ¢ä¸ºæ•°å­—
                timeRate: getColumnValue('è®¡æ—¶å•ä»·') === undefined || getColumnValue('è®¡æ—¶å•ä»·') === '' ? null : parseFloat(getColumnValue('è®¡æ—¶å•ä»·')),
                quota: parseInt(getColumnValue('å®šé¢æ•°é‡', 0)) || 0,
                note: row['å¤‡æ³¨'] ? row['å¤‡æ³¨'].toString().trim() : ''
              };
            });
            
            console.log('å¤„ç†åçš„å¯¼å…¥æ•°æ®ç¤ºä¾‹:', importedProcesses[0]);
            
            // æç¤ºç”¨æˆ·æ˜¯å¦è¦†ç›–ç°æœ‰æ•°æ®
            if (processList.length > 0) {
              if (confirm('æ£€æµ‹åˆ°ç³»ç»Ÿä¸­å·²å­˜åœ¨å·¥åºæ•°æ®ï¼Œæ˜¯å¦è¦†ç›–ï¼Ÿ\né€‰æ‹©"ç¡®å®š"å°†æ›¿æ¢æ‰€æœ‰ç°æœ‰æ•°æ®ï¼Œé€‰æ‹©"å–æ¶ˆ"å°†è¿½åŠ åˆ°ç°æœ‰æ•°æ®ä¸­ã€‚')) {
                processList = importedProcesses;
              } else {
                // è¿½åŠ æ•°æ®ï¼Œé¿å…IDé‡å¤
                importedProcesses.forEach(newProc => {
                  // æ£€æŸ¥IDæ˜¯å¦å·²å­˜åœ¨
                  const existingIndex = processList.findIndex(p => p.id === newProc.id);
                  if (existingIndex >= 0) {
                    // å¦‚æœIDå­˜åœ¨ï¼Œæç¤ºç”¨æˆ·
                    if (confirm(`å·¥åºID ${newProc.id} (${newProc.name}) å·²å­˜åœ¨ï¼Œæ˜¯å¦æ›¿æ¢ï¼Ÿ`)) {
                      processList[existingIndex] = newProc;
                    }
                  } else {
                    // å¦‚æœIDä¸å­˜åœ¨ï¼Œç›´æ¥æ·»åŠ 
                    processList.push(newProc);
                  }
                });
              }
            } else {
              // å¦‚æœæ²¡æœ‰ç°æœ‰æ•°æ®ï¼Œç›´æ¥ä½¿ç”¨å¯¼å…¥çš„æ•°æ®
              processList = importedProcesses;
            }
            
            // ä¿å­˜åˆ°localStorage
            localStorage.setItem('savedProcessData', JSON.stringify(processList));
            
            // åˆ·æ–°è¡¨æ ¼
            renderProcesses();
            
            alert(`æˆåŠŸå¯¼å…¥ ${importedProcesses.length} æ¡å·¥åºæ•°æ®ï¼`);
            
          } catch (error) {
              console.error('å¯¼å…¥å¤±è´¥:', error);
              // æä¾›æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
              let errorMessage = 'å¯¼å…¥Excelæ–‡ä»¶å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®ï¼';
              
              if (error.message) {
                errorMessage += '\né”™è¯¯è¯¦æƒ…: ' + error.message;
              }
              
              errorMessage += '\n\nè¯·ç¡®ä¿:\n1. é€‰æ‹©çš„æ˜¯Excelæ–‡ä»¶(.xlsxæˆ–.xls)\n2. æ–‡ä»¶è¡¨å¤´åŒ…å«: å·¥åºID, å·¥åºåç§°, è®¡ä»¶å•ä»·, è®¡æ—¶å•ä»·, å®šé¢æ•°é‡\n3. æ•°å€¼å­—æ®µä½¿ç”¨æ­£ç¡®çš„æ•°å­—æ ¼å¼';
              
              alert(errorMessage);
            }
        };
        
        reader.readAsArrayBuffer(file);
      });
      
      // è§¦å‘æ–‡ä»¶é€‰æ‹©å¯¹è¯æ¡†
      fileInput.click();
    }
    
    // æ˜¾ç¤ºæ–°å¢å·¥åºæ¨¡æ€æ¡†
    function showAddProcessModal() {
      // é‡ç½®è¡¨å•
      document.getElementById('process-form').reset();
      
      // æ¸…é™¤ç¼–è¾‘çŠ¶æ€
      window.currentEditProcessId = null;
      
      // è®¾ç½®æ ‡é¢˜
      document.querySelector('#add-process-modal h3').textContent = 'æ–°å¢å·¥åº';
      
      // å®ç°å·¥åºIDè‡ªåŠ¨ç¼–å·åŠŸèƒ½
      generateNextProcessId();
      
      // æ˜¾ç¤ºæ¨¡æ€æ¡†
      const modal = document.getElementById('add-process-modal');
      // ä½¿ç”¨setAttributeæ¥æ·»åŠ !important
      modal.setAttribute('style', 'display: flex !important; justify-content: center; align-items: center; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000;');
    }
    
    // ç”Ÿæˆä¸‹ä¸€ä¸ªå·¥åºIDçš„å‡½æ•°
    function generateNextProcessId() {
      // è·å–è¡¨æ ¼ä¸­çš„æœ€åä¸€è¡ŒID
      const table = document.getElementById('process-table');
      const rows = table ? table.querySelectorAll('tbody tr') : [];
      let maxId = 0;
      
      if (rows.length > 0) {
        // éå†æ‰€æœ‰è¡Œï¼Œæ‰¾å‡ºæœ€å¤§çš„ID
        rows.forEach(row => {
          // å‡è®¾ç¬¬ä¸€åˆ—æ˜¯IDåˆ—
          const idCell = row.querySelector('td:first-child');
          if (idCell) {
            const idText = idCell.textContent.trim();
            const idNum = parseInt(idText.replace(/[^0-9]/g, ''));
            if (!isNaN(idNum) && idNum > maxId) {
              maxId = idNum;
            }
          }
        });
      }
      
      // ç”Ÿæˆä¸‹ä¸€ä¸ªIDï¼Œä¿æŒ3ä½æ•°å­—æ ¼å¼å¹¶æ·»åŠ MIPTå‰ç¼€
      const nextId = 'MIPT' + String(maxId + 1).padStart(3, '0');
      
      // è®¾ç½®åˆ°è¾“å…¥æ¡†
      document.getElementById('process-id').value = nextId;
    }
    
    // ä¿å­˜å·¥åºæ•°æ®
    function saveProcess() {
      // è·å–è¡¨å•æ•°æ®
      const form = document.getElementById('process-form');
      const processId = document.getElementById('process-id').value.trim();
      const processName = document.getElementById('process-name').value.trim();
      
      // éªŒè¯ä»·æ ¼å­—æ®µåªèƒ½åŒ…å«æ•°å­—å’Œå°æ•°ç‚¹
      let pieceRateValue = document.getElementById('process-piece-rate').value.trim();
      let timeRateValue = document.getElementById('process-time-rate').value.trim();
      
      // æ•°å­—éªŒè¯æ­£åˆ™è¡¨è¾¾å¼
      const numberPattern = /^\d*\.?\d*$/;
      
      if (!numberPattern.test(pieceRateValue)) {
        alert('è®¡ä»¶å•ä»·åªèƒ½åŒ…å«æ•°å­—å’Œå°æ•°ç‚¹ï¼');
        document.getElementById('process-piece-rate').focus();
        return;
      }
      
      if (!numberPattern.test(timeRateValue)) {
        alert('è®¡æ—¶å•ä»·åªèƒ½åŒ…å«æ•°å­—å’Œå°æ•°ç‚¹ï¼');
        document.getElementById('process-time-rate').focus();
        return;
      }
      
      // è‡ªåŠ¨ä¿ç•™2ä½å°æ•°
      pieceRateValue = pieceRateValue ? parseFloat(pieceRateValue).toFixed(2) : '0.00';
      timeRateValue = timeRateValue ? parseFloat(timeRateValue).toFixed(2) : '0.00';
      
      // æ›´æ–°è¾“å…¥æ¡†æ˜¾ç¤ºçš„å€¼
      document.getElementById('process-piece-rate').value = pieceRateValue;
      document.getElementById('process-time-rate').value = timeRateValue;
      
      // è½¬æ¢ä¸ºæ•°å­—ç±»å‹
      const pieceRate = parseFloat(pieceRateValue) || 0;
      const timeRate = parseFloat(timeRateValue) || 0;
      const quota = parseInt(document.getElementById('process-quota').value) || 0;
      const note = document.getElementById('process-note').value.trim();
      
      // éªŒè¯å¿…å¡«å­—æ®µ
      if (!processId) {
        alert('è¯·è¾“å…¥å·¥åºIDï¼');
        return;
      }
      
      if (!processName) {
        alert('è¯·è¾“å…¥å·¥åºåç§°ï¼');
        return;
      }
      
      // æ£€æŸ¥å·¥åºåç§°æ˜¯å¦å·²å­˜åœ¨
      const table = document.getElementById('process-table');
      if (table) {
        const rows = table.querySelectorAll('tbody tr');
        let isDuplicate = false;
        
        rows.forEach(row => {
          // è·å–å½“å‰è¡Œçš„å·¥åºID
          const idCell = row.querySelector('td:nth-child(1)');
          const rowProcessId = idCell ? idCell.textContent.trim() : '';
          
          // å‡è®¾ç¬¬äºŒåˆ—æ˜¯å·¥åºåç§°åˆ—
          const nameCell = row.querySelector('td:nth-child(2)');
          
          // åœ¨ç¼–è¾‘æ¨¡å¼ä¸‹ï¼Œæ’é™¤å½“å‰æ­£åœ¨ç¼–è¾‘çš„å·¥åº
          if (nameCell && nameCell.textContent.trim() === processName && 
              (!window.currentEditProcessId || rowProcessId !== window.currentEditProcessId)) {
            isDuplicate = true;
          }
        });
        
        if (isDuplicate) {
          alert('è¯¥å·¥åºåç§°å·²å­˜åœ¨ï¼Œè¯·æ¢ä¸ªåç§°ï¼');
          document.getElementById('process-name').focus();
          return;
        }
      }
      
      // æ£€æŸ¥IDæ˜¯å¦å·²å­˜åœ¨ï¼ˆç¼–è¾‘æ—¶é™¤å¤–ï¼‰
      const existingIndex = processList.findIndex(p => p.id === processId);
      if (existingIndex >= 0 && window.currentEditProcessId !== processId) {
        alert(`å·¥åºID ${processId} å·²å­˜åœ¨ï¼`);
        return;
      }
      
      // å‡†å¤‡å·¥åºæ•°æ®
      const processData = {
        id: processId,
        name: processName,
        pieceRate: pieceRate,
        timeRate: timeRate,
        quota: quota,
        note: note
      };
      
      // ç¼–è¾‘æ¨¡å¼
      if (window.currentEditProcessId) {
        // æ›´æ–°ç°æœ‰æ•°æ®
        processList[existingIndex] = processData;
        alert('å·¥åºä¿¡æ¯å·²æˆåŠŸæ›´æ–°ï¼');
      } else {
        // æ·»åŠ æ–°æ•°æ®
        processList.push(processData);
        alert('æ–°å·¥åºå·²æˆåŠŸæ·»åŠ ï¼');
      }
      
      // ä¿å­˜åˆ°localStorage
      localStorage.setItem('savedProcessData', JSON.stringify(processList));
      
      // åˆ·æ–°è¡¨æ ¼
      renderProcesses();
      
      // å…³é—­æ¨¡æ€æ¡†
      closeModal('add-process-modal');
    }
    
    // ç¼–è¾‘å·¥åº
    window.editProcess = function(processId) {
      // æŸ¥æ‰¾å·¥åºæ•°æ®
      const process = processList.find(p => p.id === processId);
      
      if (process) {
        // è®¾ç½®ç¼–è¾‘çŠ¶æ€
        window.currentEditProcessId = processId;
        
        // è®¾ç½®æ ‡é¢˜
        document.querySelector('#add-process-modal h3').textContent = 'ç¼–è¾‘å·¥åº';
        
        // å¡«å……è¡¨å•æ•°æ®
        document.getElementById('process-id').value = process.id;
        document.getElementById('process-name').value = process.name;
        document.getElementById('process-piece-rate').value = process.pieceRate;
        document.getElementById('process-time-rate').value = process.timeRate;
        document.getElementById('process-quota').value = process.quota;
        document.getElementById('process-note').value = process.note || '';
        
        // æ˜¾ç¤ºæ¨¡æ€æ¡†
      const modal = document.getElementById('add-process-modal');
      modal.setAttribute('style', 'display: flex !important; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); justify-content: center; align-items: center; z-index: 1000;')
      } else {
        alert('æœªæ‰¾åˆ°è¯¥å·¥åºä¿¡æ¯ï¼');
      }
    };
    
    // åˆ é™¤å·¥åº
    window.deleteProcess = function(processId) {
      if (confirm('ç¡®å®šè¦åˆ é™¤è¯¥å·¥åºå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
        // è¿‡æ»¤æ‰è¦åˆ é™¤çš„å·¥åº
        processList = processList.filter(p => p.id !== processId);
        
        // ä¿å­˜åˆ°localStorage
        localStorage.setItem('savedProcessData', JSON.stringify(processList));
        
        // åˆ·æ–°è¡¨æ ¼
        renderProcesses();
        
        alert('å·¥åºå·²æˆåŠŸåˆ é™¤ï¼');
      }
    };

    // æ¸…ç©ºå·¥åºæ•°æ®
    function clearProcessData() {
      if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å·¥åºæ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
        // æ¸…ç©ºå·¥åºåˆ—è¡¨
        processList = [];
        // æ›´æ–°localStorage
        localStorage.setItem('savedProcessData', JSON.stringify(processList));
        // é‡æ–°æ¸²æŸ“è¡¨æ ¼
        renderProcesses();
        // æ˜¾ç¤ºæˆåŠŸæç¤º
        alert('æ‰€æœ‰å·¥åºæ•°æ®å·²æˆåŠŸæ¸…ç©ºï¼');
      }
    }

    // åˆå§‹åŒ–å®¢æˆ·å’Œè®¢å•å·è‡ªåŠ¨å®ŒæˆåŠŸèƒ½
    function initAutocomplete() {
      const clientInput = document.getElementById('entry-client');
      const clientDropdown = document.getElementById('client-dropdown');
      const orderInput = document.getElementById('entry-order-number');
      const orderDropdown = document.getElementById('order-dropdown');
      
      // å®¢æˆ·è¾“å…¥æ¡†è‡ªåŠ¨å®Œæˆ
      clientInput.addEventListener('input', function() {
        const keyword = this.value.toLowerCase().trim();
        if (keyword.length < 1) {
          clientDropdown.setAttribute('style', 'display: none !important;');
          return;
        }
        
        // ä»localStorageè·å–è®¢å•æ•°æ®
        const allOrders = JSON.parse(localStorage.getItem('orders')) || [];
        
        // è·å–å”¯ä¸€çš„å®¢æˆ·åˆ—è¡¨å¹¶ç­›é€‰
        const uniqueClients = [...new Set(allOrders
          .filter(order => order.customer && order.customer.toLowerCase().includes(keyword))
          .map(order => order.customer))];
        
        // æ˜¾ç¤ºä¸‹æ‹‰åˆ—è¡¨
        if (uniqueClients.length > 0) {
          clientDropdown.innerHTML = uniqueClients.map(client => `
            <div class="dropdown-item" style="padding: 8px 12px; cursor: pointer;" onmouseover="this.style.backgroundColor='#f8f9fa'" onmouseout="this.style.backgroundColor='transparent'" onclick="selectClient('${client}')">
              ${client}
            </div>
          `).join('');
          clientDropdown.setAttribute('style', 'display: block !important;');
        } else {
            clientDropdown.setAttribute('style', 'display: none !important;');
        }
      });
      
      // è®¢å•å·è¾“å…¥æ¡†è‡ªåŠ¨å®Œæˆ
      orderInput.addEventListener('input', function() {
        const keyword = this.value.toLowerCase().trim();
        const clientName = clientInput.value.trim();
        
        if (keyword.length < 1 && clientName.length < 1) {
          orderDropdown.setAttribute('style', 'display: none !important;');
          return;
        }
        
        // ä»localStorageè·å–è®¢å•æ•°æ®
        const allOrders = JSON.parse(localStorage.getItem('orders')) || [];
        
        // ç­›é€‰è®¢å•
        const filteredOrders = allOrders.filter(order => {
          const matchesKeyword = order.orderNo && order.orderNo.toLowerCase().includes(keyword);
          const matchesClient = clientName ? (order.customer && order.customer === clientName) : true;
          return matchesKeyword && matchesClient;
        });
        
        // æ˜¾ç¤ºä¸‹æ‹‰åˆ—è¡¨
        if (filteredOrders.length > 0) {
          orderDropdown.innerHTML = filteredOrders.map(order => `
            <div class="dropdown-item" style="padding: 8px 12px; cursor: pointer;" onmouseover="this.style.backgroundColor='#f8f9fa'" onmouseout="this.style.backgroundColor='transparent'" onclick="selectOrder('${order.orderNo}', '${order.customer}')">
              ${order.orderNo} - ${order.customer}
            </div>
          `).join('');
          orderDropdown.setAttribute('style', 'display: block !important;');
        } else {
            orderDropdown.setAttribute('style', 'display: none !important;');
        }
      });
      
      // å½“å®¢æˆ·è¾“å…¥æ¡†å†…å®¹å˜åŒ–æ—¶ï¼Œé‡ç½®è®¢å•å·å¹¶è§¦å‘è®¢å•å·ç­›é€‰
      clientInput.addEventListener('change', function() {
        orderInput.value = '';
        if (this.value.trim()) {
          const event = new Event('input');
          orderInput.dispatchEvent(event);
        }
      });
      
      // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­ä¸‹æ‹‰æ¡†
      document.addEventListener('click', function(event) {
        if (!clientInput.contains(event.target) && !clientDropdown.contains(event.target)) {
          clientDropdown.style.display = 'none';
        }
        if (!orderInput.contains(event.target) && !orderDropdown.contains(event.target)) {
          orderDropdown.style.display = 'none';
        }
      });
    }
    
    // é€‰æ‹©å®¢æˆ·
    window.selectClient = function(clientName) {
      document.getElementById('entry-client').value = clientName;
      document.getElementById('client-dropdown').style.display = 'none';
      
      // è§¦å‘è®¢å•å·ç­›é€‰
      const orderInput = document.getElementById('entry-order-number');
      orderInput.value = '';
      const event = new Event('input');
      orderInput.dispatchEvent(event);
    };
    
    // é€‰æ‹©è®¢å•
    window.selectOrder = function(orderNo, clientName) {
      document.getElementById('entry-order-number').value = orderNo;
      document.getElementById('entry-client').value = clientName;
      document.getElementById('order-dropdown').style.display = 'none';
    };
    
    // é¡µé¢åŠ è½½æ—¶ç»‘å®šæ–°å¢è®¢å•æŒ‰é’®äº‹ä»¶
    document.addEventListener('DOMContentLoaded', function() {
      // æ³¨é‡Šæ‰æ¸…é™¤è®¢å•æ•°æ®çš„ä»£ç ï¼Œä¿ç•™å†å²è®¢å•ä¿¡æ¯
      
      // ä¸ºæ–°å¢è®¢å•æŒ‰é’®ç»‘å®šç‚¹å‡»äº‹ä»¶
      if (document.getElementById('add-order-btn')) {
        document.getElementById('add-order-btn').addEventListener('click', showAddOrderModal);
      }
      // ä¸ºè®¢å•è¡¨å•ç»‘å®šæäº¤äº‹ä»¶
      if (document.getElementById('order-form')) {
        document.getElementById('order-form').addEventListener('submit', function(e) {
          e.preventDefault();
          saveOrder();
        });
      }
      // åˆå§‹åŒ–è®¢å•è¡¨æ ¼
      if (document.getElementById('order-table')) {
        renderOrders();
      }
      
      // ä¸ºæœç´¢æ¡†æ·»åŠ è¾“å…¥äº‹ä»¶ç›‘å¬
      if (document.getElementById('order-search')) {
        document.getElementById('order-search').addEventListener('input', renderOrders);
      }
      
      // ä¸ºçŠ¶æ€ç­›é€‰ä¸‹æ‹‰æ¡†æ·»åŠ å˜åŒ–äº‹ä»¶ç›‘å¬
      if (document.getElementById('order-status')) {
        document.getElementById('order-status').addEventListener('change', renderOrders);
      }
      
      // ä¸ºæŸ¥è¯¢æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
      if (document.getElementById('query-order')) {
        document.getElementById('query-order').addEventListener('click', renderOrders);
      }
      
      // ä¸ºé‡ç½®æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
      if (document.getElementById('reset-order')) {
        document.getElementById('reset-order').addEventListener('click', function() {
          if (document.getElementById('order-search')) {
            document.getElementById('order-search').value = '';
          }
          if (document.getElementById('order-status')) {
            document.getElementById('order-status').value = 'å…¨éƒ¨çŠ¶æ€';
          }
          if (document.getElementById('start-delivery-date')) {
            document.getElementById('start-delivery-date').value = '';
          }
          if (document.getElementById('end-delivery-date')) {
            document.getElementById('end-delivery-date').value = '';
          }
          renderOrders();
        });
      }
    });

    // æ¸…ç©ºæ‰€æœ‰å‘˜å·¥ä¿¡æ¯
    function clearAllEmployees() {
      if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å‘˜å·¥ä¿¡æ¯å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
        // æ¸…ç©ºlocalStorageä¸­çš„å‘˜å·¥æ•°æ® - è®¾ç½®ä¸ºç©ºæ•°ç»„è€Œä¸æ˜¯ç§»é™¤ï¼Œé˜²æ­¢é‡æ–°åŠ è½½é»˜è®¤æ•°æ®
        localStorage.setItem('employees', JSON.stringify([]));
        
        // æ¸…ç©ºå†…å­˜ä¸­çš„å‘˜å·¥æ•°ç»„
        employees = [];
        
        // é‡æ–°æ¸²æŸ“å‘˜å·¥åˆ—è¡¨
        renderEmployees();
        
        // æ˜¾ç¤ºæ“ä½œæˆåŠŸæç¤º
        alert('æ‰€æœ‰å‘˜å·¥ä¿¡æ¯å·²æˆåŠŸæ¸…ç©ºï¼');
      }
    }
  </script>
<script>
    // å¯¼å‡ºJSONåŠŸèƒ½
    // å…ˆç§»é™¤å¯èƒ½å­˜åœ¨çš„æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨ï¼Œé¿å…é‡å¤ç»‘å®š
    const exportBtn = document.getElementById('export-json-btn');
    const newExportBtn = exportBtn.cloneNode(true);
    exportBtn.parentNode.replaceChild(newExportBtn, exportBtn);
    
    // é‡æ–°ç»‘å®šç‚¹å‡»äº‹ä»¶
    newExportBtn.addEventListener('click', function() {
      // ç³»ç»Ÿä½¿ç”¨çš„localStorageé”®ååˆ—è¡¨
      const storageKeys = [
                'filteredMealRecords', 
                'mealRecords', 
                'pieceworkData', 
                'paymentRecords', 
                'furnaceOrders', 
                'employees', 
                'savedProcessData', 
                'customerOrders', 
                'wageDetails', 
                'orders',
                // ç”Ÿäº§è®¡åˆ’å®‰æ’æ–‡ä»¶æ•°æ®
                'orderProcesses', 
                'productionProcesses', 
                'processData', 
                'productionOrderList', 
                'productionSchedule',
                // å¤‡å¿˜å½•æ•°æ®
                'memos',
                // ç”µé•€ç®¡ç†æ–‡ä»¶æ•°æ®
                'electroplate_management_system_orders',
                'electroplate_management_system_ordersCleared',
                'electroplate_management_system_bills',
                'electroplate_management_system_payments',
                'electroplate_management_system_deliveries',
                'electroplate_management_system_receipts'
      ];
      
      // æ”¶é›†æ‰€æœ‰æ•°æ®
      const exportData = {
        exportDate: new Date().toLocaleString('zh-CN'),
        version: '1.0',
        data: {}
      };
      
      // ä»localStorageè·å–æ‰€æœ‰æ•°æ®
      storageKeys.forEach(key => {
        try {
          const value = localStorage.getItem(key);
          if (value !== null) {
            exportData.data[key] = JSON.parse(value);
          } else {
            exportData.data[key] = null;
          }
        } catch (error) {
          console.error(`å¯¼å‡ºé”® ${key} æ—¶å‡ºé”™:`, error);
          exportData.data[key] = { error: 'æ•°æ®è§£æå¤±è´¥' };
        }
      });
      
      // åˆ›å»ºJSONå­—ç¬¦ä¸²
      const jsonContent = JSON.stringify(exportData, null, 2);
      
      // åˆ›å»ºBlobå¯¹è±¡
      const blob = new Blob([jsonContent], { type: 'application/json' });
      
      // åˆ›å»ºä¸‹è½½é“¾æ¥
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `ç”Ÿäº§ç®¡ç†ç³»ç»Ÿå¤‡ä»½_${new Date().toLocaleDateString('zh-CN').replace(/\//g, '-')}.json`;
      
      // è§¦å‘ä¸‹è½½
      document.body.appendChild(a);
      a.click();
      
      // æ¸…ç†
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      // æ˜¾ç¤ºæˆåŠŸæç¤º
      alert('æ•°æ®å¯¼å‡ºæˆåŠŸï¼å·²ä¿å­˜ä¸ºJSONæ–‡ä»¶ã€‚');
    });
    
    // å¯¼å…¥JSONåŠŸèƒ½
    document.getElementById('import-json-btn').addEventListener('click', function() {
      // æ˜¾ç¤ºæ–‡ä»¶é€‰æ‹©å¯¹è¯æ¡†
      document.getElementById('json-file-input').click();
    });
    
    // æ–‡ä»¶é€‰æ‹©å˜åŒ–æ—¶è§¦å‘å¯¼å…¥
    document.getElementById('json-file-input').addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      // éªŒè¯æ–‡ä»¶ç±»å‹
      if (!file.name.endsWith('.json')) {
        alert('è¯·é€‰æ‹©JSONæ ¼å¼çš„å¤‡ä»½æ–‡ä»¶ï¼');
        this.value = ''; // æ¸…ç©ºé€‰æ‹©
        return;
      }
      
      // å†æ¬¡ç¡®è®¤å¯¼å…¥æ“ä½œ
      if (!confirm('å¯¼å…¥å°†è¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ')) {
        this.value = ''; // æ¸…ç©ºé€‰æ‹©
        return;
      }
      
      // è¯»å–æ–‡ä»¶
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          // è§£æJSONæ•°æ®
          const importData = JSON.parse(e.target.result);
          
          // éªŒè¯æ•°æ®æ ¼å¼
          if (!importData.data || typeof importData.data !== 'object') {
            throw new Error('å¤‡ä»½æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼Œç¼ºå°‘æ•°æ®éƒ¨åˆ†');
          }
          
          // å¯¼å…¥æ•°æ®åˆ°localStorage
          let importCount = 0;
          Object.keys(importData.data).forEach(key => {
            try {
              if (importData.data[key] !== null && importData.data[key] !== undefined) {
                localStorage.setItem(key, JSON.stringify(importData.data[key]));
                importCount++;
              }
            } catch (error) {
              console.error(`å¯¼å…¥é”® ${key} æ—¶å‡ºé”™:`, error);
            }
          });
          
          // æ˜¾ç¤ºæˆåŠŸæç¤º
          alert(`æ•°æ®å¯¼å…¥æˆåŠŸï¼å·²æ¢å¤ ${importCount} ä¸ªæ•°æ®æ¨¡å—ã€‚`);
          
          // åˆ·æ–°é¡µé¢ä»¥åº”ç”¨æ–°æ•°æ®
          location.reload();
          
        } catch (error) {
          console.error('JSONè§£æå¤±è´¥:', error);
          alert('å¯¼å…¥å¤±è´¥ï¼š' + error.message);
        } finally {
          // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
          document.getElementById('json-file-input').value = '';
        }
      };
      
      reader.onerror = function() {
        alert('æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æŸå');
        document.getElementById('json-file-input').value = '';
      };
      
      // å¼€å§‹è¯»å–æ–‡ä»¶
      reader.readAsText(file, 'utf-8');
    });
    
    // é¡µé¢å…³é—­æ—¶è‡ªåŠ¨ä¿å­˜å¤‡ä»½åŠŸèƒ½å·²ç¦ç”¨
    /*
    window.addEventListener('beforeunload', function() {
      // æ”¶é›†æ‰€æœ‰æ•°æ®è¿›è¡Œè‡ªåŠ¨å¤‡ä»½
      const storageKeys = [
        'filteredMealRecords', 
        'mealRecords', 
        'pieceworkData', 
        'paymentRecords', 
        'furnaceOrders', 
        'employees', 
        'savedProcessData', 
        'customerOrders', 
        'wageDetails', 
        'orders',
        // ç”Ÿäº§è®¡åˆ’å®‰æ’æ–‡ä»¶æ•°æ®
        'orderProcesses', 
        'productionProcesses', 
        'processData', 
        'productionOrderList', 
        'productionSchedule',
        // å¤‡å¿˜å½•æ•°æ®
        'memos',
        // ç”µé•€ç®¡ç†æ–‡ä»¶æ•°æ®
        'electroplate_management_system_orders',
        'electroplate_management_system_ordersCleared',
        'electroplate_management_system_bills',
        'electroplate_management_system_payments',
        'electroplate_management_system_deliveries',
        'electroplate_management_system_receipts'
      ];
      
      const autoBackupData = {
        backupDate: new Date().toLocaleString('zh-CN'),
        version: '1.0',
        data: {}
      };
      
      // ä»localStorageè·å–æ‰€æœ‰æ•°æ®
      storageKeys.forEach(key => {
        try {
          const value = localStorage.getItem(key);
          if (value !== null) {
            autoBackupData.data[key] = JSON.parse(value);
          }
        } catch (error) {
          console.error(`è‡ªåŠ¨å¤‡ä»½é”® ${key} æ—¶å‡ºé”™:`, error);
        }
      });
      
      // å­˜å‚¨è‡ªåŠ¨å¤‡ä»½æ•°æ®åˆ°localStorageï¼ˆæ³¨æ„ï¼šé¿å…æ— é™é€’å½’ï¼‰
      // æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªç‰¹æ®Šçš„é”®ï¼Œä¸åŒ…å«åœ¨å¤‡ä»½åˆ—è¡¨ä¸­
      try {
        localStorage.setItem('autoBackupData', JSON.stringify(autoBackupData));
        console.log('è‡ªåŠ¨å¤‡ä»½å·²ä¿å­˜åˆ°localStorage');
        
        // åˆ›å»ºå¤‡ä»½JSONæ–‡ä»¶å¹¶è§¦å‘ä¸‹è½½
        // æ³¨æ„ï¼šåœ¨beforeunloadäº‹ä»¶ä¸­ï¼ŒæŸäº›æµè§ˆå™¨å¯èƒ½é™åˆ¶è‡ªåŠ¨ä¸‹è½½æ“ä½œ
        // ä½†æˆ‘ä»¬ä»å°è¯•å®ç°è¿™ä¸€åŠŸèƒ½ï¼ŒåŒæ—¶ä¿ç•™localStorageå¤‡ä»½ä½œä¸ºå¤‡é€‰
        const jsonContent = JSON.stringify(autoBackupData, null, 2);
        const blob = new Blob([jsonContent], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        // ä½¿ç”¨å¼‚æ­¥æ–¹å¼å°è¯•ä¸‹è½½ï¼Œä»¥æé«˜åœ¨beforeunloadäº‹ä»¶ä¸­çš„å…¼å®¹æ€§
        setTimeout(() => {
          try {
            const a = document.createElement('a');
            a.href = url;
            a.download = `ç”Ÿäº§ç®¡ç†ç³»ç»Ÿè‡ªåŠ¨å¤‡ä»½_${new Date().toLocaleDateString('zh-CN').replace(/\//g, '-')}_${new Date().toLocaleTimeString('zh-CN').replace(/:/g, '-')}.json`;
            a.style.display = 'none';
            document.body.appendChild(a);
            
            // ä½¿ç”¨dispatchEventè€Œä¸æ˜¯ç›´æ¥è°ƒç”¨click()ï¼Œå¯èƒ½åœ¨æŸäº›æµè§ˆå™¨ä¸­æ›´æœ‰æ•ˆ
            const event = new MouseEvent('click', {
              bubbles: true,
              cancelable: true,
              view: window
            });
            a.dispatchEvent(event);
            
            // æ¸…ç†
            setTimeout(() => {
              document.body.removeChild(a);
              URL.revokeObjectURL(url);
            }, 100);
            
            console.log('è‡ªåŠ¨å¤‡ä»½æ–‡ä»¶å·²å°è¯•ä¸‹è½½');
          } catch (downloadError) {
            console.warn('è‡ªåŠ¨ä¸‹è½½å¤‡ä»½æ–‡ä»¶å¤±è´¥ï¼ˆæµè§ˆå™¨å¯èƒ½é™åˆ¶ï¼‰:', downloadError);
          }
        }, 0);
      } catch (error) {
        console.error('è‡ªåŠ¨å¤‡ä»½å­˜å‚¨å¤±è´¥:', error);
      }
    });
    */
    
    // é¡µé¢åŠ è½½æ—¶æ·»åŠ å¤‡ä»½æç¤ºä¿¡æ¯
    window.addEventListener('load', function() {
      // æ˜¾ç¤ºè‡ªåŠ¨å¤‡ä»½åŠŸèƒ½æç¤º
      setTimeout(() => {
        try {
          const backupTools = document.querySelector('.backup-restore-tools');
          if (backupTools) {
            // æ·»åŠ æç¤ºå…ƒç´ 
            const backupHint = document.createElement('div');
            backupHint.id = 'backup-system-hint';
            backupHint.style.fontSize = '0.85em';
            backupHint.style.color = '#888';
            backupHint.style.marginTop = '5px';
            backupHint.style.padding = '8px';
            backupHint.style.background = '#f5f5f5';
            backupHint.style.borderRadius = '4px';
            backupHint.style.textAlign = 'center';
            backupHint.textContent = 'ç³»ç»Ÿå·²å…³é—­é¡µé¢å…³é—­æ—¶çš„è‡ªåŠ¨å¤‡ä»½åŠŸèƒ½';
            
            // æ’å…¥åˆ°å¤‡ä»½å·¥å…·å®¹å™¨ä¸­
            backupTools.appendChild(backupHint);
            
            // 3ç§’åæ·¡å‡ºæç¤º
            setTimeout(() => {
              backupHint.style.transition = 'opacity 0.5s';
              backupHint.style.opacity = '0';
              setTimeout(() => {
                backupHint.remove();
              }, 500);
            }, 3000);
          }
        } catch (e) {
          console.log('æ— æ³•æ˜¾ç¤ºå¤‡ä»½æç¤ºä¿¡æ¯');
        }
      }, 1000);
      
      // æ£€æŸ¥æ˜¯å¦æœ‰è‡ªåŠ¨å¤‡ä»½ï¼Œå¹¶æä¾›æ¢å¤é€‰é¡¹
      try {
        const autoBackup = localStorage.getItem('autoBackupData');
        if (autoBackup) {
          const backupInfo = JSON.parse(autoBackup);
          const lastBackupTime = backupInfo.backupDate;
          
          // åœ¨å¤‡ä»½è¿˜åŸå·¥å…·åŒºåŸŸæ·»åŠ è‡ªåŠ¨å¤‡ä»½ä¿¡æ¯
          const backupTools = document.querySelector('.backup-restore-tools');
          if (backupTools) {
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è‡ªåŠ¨å¤‡ä»½ä¿¡æ¯å…ƒç´ 
            let autoBackupInfo = document.getElementById('auto-backup-info');
            if (!autoBackupInfo) {
              autoBackupInfo = document.createElement('div');
              autoBackupInfo.id = 'auto-backup-info';
              autoBackupInfo.style.marginLeft = 'auto';
              autoBackupInfo.style.display = 'flex';
              autoBackupInfo.style.alignItems = 'center';
              autoBackupInfo.style.gap = '10px';
              autoBackupInfo.style.fontSize = '0.9em';
              backupTools.appendChild(autoBackupInfo);
            }
            
            // æ›´æ–°è‡ªåŠ¨å¤‡ä»½ä¿¡æ¯
            autoBackupInfo.innerHTML = `
              <span style="color: #666;">æœ€è¿‘è‡ªåŠ¨å¤‡ä»½: ${lastBackupTime}</span>
              <button class="button small" id="download-auto-backup" style="padding: 4px 12px;">ä¸‹è½½è‡ªåŠ¨å¤‡ä»½</button>
              <button class="button small warning" id="restore-auto-backup" style="padding: 4px 12px;">æ¢å¤è‡ªåŠ¨å¤‡ä»½</button>
              <button class="button small primary" id="force-auto-backup" style="padding: 4px 12px;">ç«‹å³åˆ›å»ºå¹¶ä¸‹è½½å¤‡ä»½</button>
            `;
            
            // ä¸‹è½½è‡ªåŠ¨å¤‡ä»½æŒ‰é’®äº‹ä»¶
            document.getElementById('download-auto-backup').addEventListener('click', function() {
              const jsonContent = JSON.stringify(JSON.parse(autoBackup), null, 2);
              const blob = new Blob([jsonContent], { type: 'application/json' });
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = `ç”Ÿäº§ç®¡ç†ç³»ç»Ÿè‡ªåŠ¨å¤‡ä»½_${lastBackupTime.replace(/:/g, '-')}.json`;
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              URL.revokeObjectURL(url);
              alert('è‡ªåŠ¨å¤‡ä»½æ–‡ä»¶å·²ä¸‹è½½ï¼');
            });
            
            // æ¢å¤è‡ªåŠ¨å¤‡ä»½æŒ‰é’®äº‹ä»¶
            document.getElementById('restore-auto-backup').addEventListener('click', function() {
              if (confirm('ç¡®å®šè¦æ¢å¤æœ€è¿‘çš„è‡ªåŠ¨å¤‡ä»½æ•°æ®å—ï¼Ÿè¿™å°†è¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®ï¼')) {
                try {
                  const importData = JSON.parse(autoBackup);
                  let restoreCount = 0;
                  
                  Object.keys(importData.data).forEach(key => {
                    try {
                      if (importData.data[key] !== null && importData.data[key] !== undefined) {
                        localStorage.setItem(key, JSON.stringify(importData.data[key]));
                        restoreCount++;
                      }
                    } catch (error) {
                      console.error(`æ¢å¤é”® ${key} æ—¶å‡ºé”™:`, error);
                    }
                  });
                  
                  alert(`è‡ªåŠ¨å¤‡ä»½æ¢å¤æˆåŠŸï¼å·²æ¢å¤ ${restoreCount} ä¸ªæ•°æ®æ¨¡å—ã€‚`);
                  location.reload();
                } catch (error) {
                  alert('æ¢å¤å¤±è´¥ï¼š' + error.message);
                }
              }
            });
            
            // ç«‹å³åˆ›å»ºå¹¶ä¸‹è½½å¤‡ä»½æŒ‰é’®äº‹ä»¶
            document.getElementById('force-auto-backup').addEventListener('click', function() {
              // æ”¶é›†æ‰€æœ‰æ•°æ®è¿›è¡Œå¤‡ä»½
            const storageKeys = [
              'filteredMealRecords', 
              'mealRecords', 
              'pieceworkData', 
              'paymentRecords', 
              'furnaceOrders', 
              'employees', 
              'savedProcessData', 
              'customerOrders', 
              'wageDetails', 
              'orders',
              // ç”Ÿäº§è®¡åˆ’å®‰æ’æ–‡ä»¶æ•°æ®
              'orderProcesses', 
              'productionProcesses', 
              'processData', 
              'productionOrderList', 
              'productionSchedule',
              // å¤‡å¿˜å½•æ•°æ®
              'memos',
              // ç”µé•€ç®¡ç†æ–‡ä»¶æ•°æ®
              'electroplate_management_system_orders',
              'electroplate_management_system_ordersCleared',
              'electroplate_management_system_bills',
              'electroplate_management_system_payments',
              'electroplate_management_system_deliveries',
              'electroplate_management_system_receipts'
            ];
              
              const manualBackupData = {
                backupDate: new Date().toLocaleString('zh-CN'),
                version: '1.0',
                data: {},
                manualBackup: true
              };
              
              // ä»localStorageè·å–æ‰€æœ‰æ•°æ®
              storageKeys.forEach(key => {
                try {
                  const value = localStorage.getItem(key);
                  if (value !== null) {
                    manualBackupData.data[key] = JSON.parse(value);
                  }
                } catch (error) {
                  console.error(`æ‰‹åŠ¨å¤‡ä»½é”® ${key} æ—¶å‡ºé”™:`, error);
                }
              });
              
              try {
                // ä¿å­˜åˆ°localStorage
                localStorage.setItem('autoBackupData', JSON.stringify(manualBackupData));
                
                // åˆ›å»ºå¤‡ä»½JSONæ–‡ä»¶å¹¶è§¦å‘ä¸‹è½½
                const jsonContent = JSON.stringify(manualBackupData, null, 2);
                const blob = new Blob([jsonContent], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ç”Ÿäº§ç®¡ç†ç³»ç»Ÿæ‰‹åŠ¨å¤‡ä»½_${new Date().toLocaleDateString('zh-CN').replace(/\//g, '-')}_${new Date().toLocaleTimeString('zh-CN').replace(/:/g, '-')}.json`;
                document.body.appendChild(a);
                a.click();
                
                // æ¸…ç†
                setTimeout(() => {
                  document.body.removeChild(a);
                  URL.revokeObjectURL(url);
                }, 100);
                
                alert('å¤‡ä»½æˆåŠŸï¼å¤‡ä»½æ–‡ä»¶å·²ä¸‹è½½åˆ°æ‚¨çš„ç”µè„‘ã€‚');
              } catch (error) {
                alert('å¤‡ä»½å¤±è´¥ï¼š' + error.message);
                console.error('æ‰‹åŠ¨å¤‡ä»½å¤±è´¥:', error);
              }
            });
            }
          }
        } catch (error) {
          console.error('æ£€æŸ¥è‡ªåŠ¨å¤‡ä»½æ—¶å‡ºé”™:', error);
        }
      });
  </script>
  </body>
</html>
